<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ğ—Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ñ‹ â€” Keep1R CRM</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="nav.css">
<script src="nav.js"></script>
<style>
:root {
  --font:        -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
  --bg:          #eef2f9;
  --surface:     #ffffff;
  --border:      rgba(15,23,42,0.08);
  --text:        #0f172a;
  --text-muted:  #64748b;
  --text-dim:    #94a3b8;
  --primary:     #2563eb;
  --primary-dk:  #1d4ed8;
  --success:     #059669;
  --success-bg:  rgba(5,150,105,0.08);
  --danger:      #dc2626;
  --danger-bg:   rgba(220,38,38,0.07);
  --warning:     #d97706;
  --radius:      14px;
  --radius-sm:   9px;
  --shadow:      0 1px 3px rgba(0,0,0,0.04), 0 4px 14px rgba(0,0,0,0.06);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--font);
  -webkit-font-smoothing: antialiased;
  background: var(--bg);
  color: var(--text);
  min-height: 100svh;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px 20px 48px;
}

/* â”€â”€ Ğ¡Ğ²Ğ¾Ğ´ĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.summary {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 20px;
}

.summary-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px 20px;
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
}

.summary-card::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: var(--accent, var(--primary));
}

.summary-card:nth-child(1) { --accent: var(--warning); }
.summary-card:nth-child(2) { --accent: var(--success); }
.summary-card:nth-child(3) { --accent: var(--primary); }

.summary-label {
  font-size: 0.68rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.07em;
  color: var(--text-muted);
  margin-bottom: 6px;
}

.summary-value {
  font-size: 1.65rem;
  font-weight: 800;
  color: var(--text);
  letter-spacing: -0.5px;
  line-height: 1;
}

.summary-card:nth-child(1) .summary-value { color: var(--warning); }
.summary-card:nth-child(2) .summary-value { color: var(--success); }

/* â”€â”€ Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolbar {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.filter-select {
  padding: 9px 13px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 0.85rem;
  font-family: var(--font);
  cursor: pointer;
  outline: none;
  transition: border-color 0.15s, box-shadow 0.15s;
  box-shadow: 0 1px 2px rgba(0,0,0,0.03);
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2394a3b8' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 32px;
}

.filter-select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37,99,235,0.08);
}

/* â”€â”€ Ğ¢Ğ°Ğ±Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs {
  display: flex;
  gap: 3px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 3px;
  margin-bottom: 16px;
  width: fit-content;
  box-shadow: 0 1px 2px rgba(0,0,0,0.03);
}

.tab {
  padding: 8px 18px;
  background: transparent;
  border: none;
  border-radius: 7px;
  color: var(--text-muted);
  font-size: 0.82rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s;
  font-family: var(--font);
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 6px;
}

.tab:hover { background: var(--bg); color: var(--text); }

.tab.active {
  background: var(--primary);
  color: #fff;
  box-shadow: 0 2px 8px rgba(37,99,235,0.22);
}

.tab-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 18px;
  height: 18px;
  padding: 0 5px;
  background: rgba(255,255,255,0.25);
  border-radius: 10px;
  font-size: 0.68rem;
  font-weight: 800;
}

.tab:not(.active) .tab-badge {
  background: var(--bg);
  color: var(--text-muted);
}

/* â”€â”€ Bulk-actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bulk-actions {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 12px;
  padding: 10px 14px;
  background: rgba(37,99,235,0.05);
  border: 1px solid rgba(37,99,235,0.15);
  border-radius: var(--radius-sm);
}

/* â”€â”€ Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-wrap {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 540px;
}

thead {
  background: var(--bg);
  border-bottom: 1px solid var(--border);
}

th {
  padding: 11px 14px;
  text-align: left;
  font-size: 0.68rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.07em;
  color: var(--text-muted);
  white-space: nowrap;
}

tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background 0.12s;
}

tbody tr:hover { background: #f8fafc; }
tbody tr:last-child { border-bottom: none; }

td {
  padding: 13px 14px;
  font-size: 0.85rem;
  vertical-align: middle;
}

.executor-name { font-weight: 700; color: var(--text); }

.car-name {
  color: var(--text-muted);
  font-size: 0.82rem;
  max-width: 160px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.service-name {
  font-size: 0.82rem;
  color: var(--text-muted);
  max-width: 180px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.salary {
  font-weight: 800;
  font-size: 0.95rem;
  color: var(--success);
  letter-spacing: -0.2px;
  white-space: nowrap;
}

.month-badge {
  display: inline-block;
  padding: 3px 9px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 0.72rem;
  font-weight: 700;
  color: var(--text-muted);
  white-space: nowrap;
}

/* Ğ§ĞµĞºĞ±Ğ¾ĞºÑÑ‹ */
.checkbox-cell { width: 36px; padding-left: 16px; }
.checkbox-cell input {
  cursor: pointer;
  width: 16px; height: 16px;
  accent-color: var(--primary);
}

/* â”€â”€ ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 7px 14px;
  border-radius: var(--radius-sm);
  font-size: 0.78rem; font-weight: 700;
  font-family: var(--font); cursor: pointer;
  border: none; transition: all 0.15s; text-decoration: none;
  white-space: nowrap;
}
.btn-primary  { background: var(--primary); color: #fff; }
.btn-primary:hover  { background: var(--primary-dk); }
.btn-success  { background: var(--success); color: #fff; }
.btn-success:hover  { background: #047857; }
.btn-secondary {
  background: transparent;
  color: var(--text-muted);
  border: 1px solid var(--border);
}
.btn-secondary:hover { background: var(--bg); color: var(--text); }

.btn-pay {
  background: var(--success-bg);
  color: var(--success);
  border: 1px solid rgba(5,150,105,0.2);
}
.btn-pay:hover { background: var(--success); color: #fff; border-color: var(--success); }

.btn-unpay {
  background: var(--danger-bg);
  color: var(--danger);
  border: 1px solid rgba(220,38,38,0.15);
}
.btn-unpay:hover { background: var(--danger); color: #fff; border-color: var(--danger); }

/* â”€â”€ Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state {
  text-align: center;
  padding: 56px 20px;
  color: var(--text-muted);
}
.empty-state-icon { font-size: 2.4rem; margin-bottom: 10px; opacity: 0.35; }
.empty-state h3   { font-size: 0.95rem; font-weight: 700; color: var(--text); }

.loading {
  text-align: center;
  padding: 56px;
  color: var(--text-muted);
  font-size: 0.88rem;
}

/* â”€â”€ ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 768px) {
  .container { padding: 16px 14px 40px; }
  .summary { grid-template-columns: 1fr; gap: 8px; }
  .summary-value { font-size: 1.4rem; }
  .tabs { width: 100%; }
  .tab { flex: 1; justify-content: center; padding: 8px 10px; }
  .toolbar { flex-direction: column; align-items: stretch; }
  .filter-select { width: 100%; }
  .bulk-actions { flex-direction: column; align-items: stretch; }
}

@media (max-width: 480px) {
  .summary { grid-template-columns: 1fr 1fr; }
  .summary-card:last-child { grid-column: 1 / -1; }
}
</style>
</head>
<body>

<div class="container">

  <!-- Ğ¡Ğ²Ğ¾Ğ´ĞºĞ° -->
  <div class="summary">
    <div class="summary-card">
      <div class="summary-label">Ğš Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ğµ</div>
      <div class="summary-value" id="summaryPending">0</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">Ğ’Ñ‹Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾</div>
      <div class="summary-value" id="summaryPaid">0</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">Ğ’ÑĞµĞ³Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚</div>
      <div class="summary-value" id="summaryTotal">0</div>
    </div>
  </div>

  <!-- Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ -->
  <div class="toolbar">
    <select class="filter-select" id="monthFilter">
      <option value="all">Ğ’ÑĞµ Ğ¼ĞµÑÑÑ†Ñ‹</option>
    </select>
    <select class="filter-select" id="executorFilter">
      <option value="all">Ğ’ÑĞµ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ğ¸</option>
    </select>
  </div>

  <!-- Ğ¢Ğ°Ğ±Ñ‹ -->
  <div class="tabs">
    <button class="tab active" data-tab="pending" onclick="switchTab('pending')">
      â³ Ğš Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ğµ
      <span class="tab-badge" id="badgePending">0</span>
    </button>
    <button class="tab" data-tab="paid" onclick="switchTab('paid')">
      âœ… Ğ’Ñ‹Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾
      <span class="tab-badge" id="badgePaid">0</span>
    </button>
    <button class="tab" data-tab="cancelled" onclick="switchTab('cancelled')">
      âŒ ĞÑ‚Ğ¼ĞµĞ½ĞµĞ½Ğ¾
      <span class="tab-badge" id="badgeCancelled">0</span>
    </button>
  </div>

  <!-- ĞœĞ°ÑÑĞ¾Ğ²Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ -->
  <div class="bulk-actions" id="bulkActions" style="display:none">
    <span id="selectedCount" style="font-size:0.82rem;color:var(--text-muted);font-weight:600">Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾: 0</span>
    <button class="btn btn-success" onclick="paySelected()">ğŸ’° Ğ’Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ</button>
  </div>

  <!-- ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ -->
  <div id="tabContent">
    <div class="loading">â³ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
  </div>

</div>

<script src="footer.js"></script>
<script>
(function() {
'use strict';

const SUPABASE_URL = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window._crmSb = sb;

let currentUser     = null;
let currentStudio   = null;
let allAssignments  = [];
let currentTab      = 'pending';
let selectedIds     = new Set();

function fmt(n) {
  return new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n || 0);
}

function fmtMonth(str) {
  if (!str) return '';
  const [y, m] = str.split('-');
  const months = ['Ğ¯Ğ½Ğ²','Ğ¤ĞµĞ²','ĞœĞ°Ñ€','ĞĞ¿Ñ€','ĞœĞ°Ğ¹','Ğ˜ÑĞ½','Ğ˜ÑĞ»','ĞĞ²Ğ³','Ğ¡ĞµĞ½','ĞĞºÑ‚','ĞĞ¾Ñ','Ğ”ĞµĞº'];
  return `${months[parseInt(m)-1]} ${y}`;
}

async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'welcome.html'; return false; }
  currentUser = session.user;
  return true;
}

async function getStudio() {
  const { data, error } = await sb
    .from('studio_members')
    .select('studio_id, role')
    .eq('user_id', currentUser.id)
    .eq('is_active', true)
    .single();
  if (error || !data) { alert('âŒ Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°'); return false; }
  currentStudio = data;
  return true;
}

async function loadAssignments() {
  const { data, error } = await sb
    .from('work_assignments')
    .select(`
      id,
      calculation_id,
      executor_id,
      executor_name,
      service_name,
      salary,
      status,
      payment_month,
      is_admin_sale,
      admin_percent,
      calculations ( car_name ),
      executors ( full_name )
    `)
    .eq('studio_id', currentStudio.studio_id)
    .order('created_at', { ascending: false });

  if (error) {
    console.error(error);
    document.getElementById('tabContent').innerHTML = '<div class="empty-state">âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸</div>';
    return;
  }

  allAssignments = (data || []).map(a => ({
    ...a,
    executor_display: a.executors?.full_name || a.executor_name || 'ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾',
    car_display:      a.calculations?.car_name || 'ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾'
  }));

  populateFilters();
  updateSummary();
  renderTab();
}

function populateFilters() {
  const months = [...new Set(allAssignments.map(a => a.payment_month).filter(Boolean))].sort().reverse();
  const monthFilter = document.getElementById('monthFilter');
  monthFilter.innerHTML = '<option value="all">Ğ’ÑĞµ Ğ¼ĞµÑÑÑ†Ñ‹</option>';
  months.forEach(m => {
    monthFilter.innerHTML += `<option value="${m}">${fmtMonth(m)}</option>`;
  });

  const executors = [...new Set(allAssignments.map(a => a.executor_display))].sort();
  const execFilter = document.getElementById('executorFilter');
  execFilter.innerHTML = '<option value="all">Ğ’ÑĞµ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ğ¸</option>';
  executors.forEach(e => {
    execFilter.innerHTML += `<option value="${e}">${e}</option>`;
  });
}

document.getElementById('monthFilter').addEventListener('change', renderTab);
document.getElementById('executorFilter').addEventListener('change', renderTab);

function updateSummary() {
  const pending = allAssignments.filter(a => a.status === 'pending').reduce((acc, a) => acc + (a.salary || 0), 0);
  const paid    = allAssignments.filter(a => a.status === 'paid').reduce((acc, a) => acc + (a.salary || 0), 0);
  const total   = allAssignments.length;

  document.getElementById('summaryPending').textContent = fmt(pending) ;
  document.getElementById('summaryPaid').textContent    = fmt(paid) ;
  document.getElementById('summaryTotal').textContent   = total;

  document.getElementById('badgePending').textContent   = allAssignments.filter(a => a.status === 'pending').length;
  document.getElementById('badgePaid').textContent      = allAssignments.filter(a => a.status === 'paid').length;
  document.getElementById('badgeCancelled').textContent = allAssignments.filter(a => a.status === 'cancelled').length;
}

window.switchTab = function(tab) {
  currentTab = tab;
  selectedIds.clear();
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
  renderTab();
};

function renderTab() {
  const month    = document.getElementById('monthFilter').value;
  const executor = document.getElementById('executorFilter').value;

  let filtered = allAssignments.filter(a => a.status === currentTab);
  if (month    !== 'all') filtered = filtered.filter(a => a.payment_month    === month);
  if (executor !== 'all') filtered = filtered.filter(a => a.executor_display === executor);

  const content = document.getElementById('tabContent');

  if (filtered.length === 0) {
    content.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“­</div>
        <h3>ĞĞµÑ‚ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹</h3>
      </div>
    `;
    document.getElementById('bulkActions').style.display = 'none';
    return;
  }

  document.getElementById('bulkActions').style.display = currentTab === 'pending' ? 'flex' : 'none';

  let html = '<div class="table-wrap"><table><thead><tr>';
  if (currentTab === 'pending') html += '<th class="checkbox-cell"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>';
  html += '<th>Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒ</th><th>ĞœĞ°ÑˆĞ¸Ğ½Ğ°</th><th>Ğ£ÑĞ»ÑƒĞ³Ğ°</th><th>ĞœĞµÑÑÑ†</th><th>Ğ¡ÑƒĞ¼Ğ¼Ğ°</th>';
  if (currentTab === 'pending' || currentTab === 'paid') html += '<th></th>';
  html += '</tr></thead><tbody>';

  filtered.forEach(a => {
    html += '<tr>';
    if (currentTab === 'pending') {
      html += `<td class="checkbox-cell"><input type="checkbox" class="row-checkbox" data-id="${a.id}" onchange="updateSelection()"></td>`;
    }
    html += `
      <td class="executor-name">${a.executor_display}</td>
      <td class="car-name">${a.car_display}</td>
      <td class="service-name">${a.service_name || (a.is_admin_sale ? `ğŸ’° ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶Ğ° (${a.admin_percent}%)` : 'â€”')}</td>
      <td><span class="month-badge">${fmtMonth(a.payment_month)}</span></td>
      <td class="salary">${fmt(a.salary)}</td>
    `;
    if (currentTab === 'pending') {
      html += `<td><button class="btn btn-pay" onclick="paySingle('${a.id}')">ğŸ’° Ğ’Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ÑŒ</button></td>`;
    }
    if (currentTab === 'paid') {
      html += `<td><button class="btn btn-unpay" onclick="unpaySingle('${a.id}')">â†© ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ</button></td>`;
    }
    html += '</tr>';
  });

  html += '</tbody></table></div>';
  content.innerHTML = html;
}

window.toggleSelectAll = function() {
  const checked = document.getElementById('selectAll').checked;
  document.querySelectorAll('.row-checkbox').forEach(cb => {
    cb.checked = checked;
    if (checked) selectedIds.add(cb.dataset.id);
    else selectedIds.delete(cb.dataset.id);
  });
  updateSelection();
};

window.updateSelection = function() {
  selectedIds.clear();
  document.querySelectorAll('.row-checkbox:checked').forEach(cb => selectedIds.add(cb.dataset.id));
  document.getElementById('selectedCount').textContent = `Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾: ${selectedIds.size}`;
};

window.paySingle = async function(id) {
  if (!confirm('ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ñƒ?')) return;
  await markAsPaid([id]);
};

window.paySelected = async function() {
  if (selectedIds.size === 0) { alert('Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸'); return; }
  if (!confirm(`Ğ’Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ÑŒ ${selectedIds.size} Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹?`)) return;
  await markAsPaid([...selectedIds]);
};

window.unpaySingle = async function(id) {
  if (!confirm('ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ñƒ? Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ²ĞµÑ€Ğ½Ñ‘Ñ‚ÑÑ Ğ² Â«Ğš Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚ĞµÂ».')) return;
  const { error } = await sb.from('work_assignments').update({ status: 'pending' }).eq('id', id);
  if (error) { alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.message); return; }
  await loadAssignments();
};

async function markAsPaid(ids) {
  const { error } = await sb.from('work_assignments').update({ status: 'paid' }).in('id', ids);
  if (error) { console.error(error); alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°'); return; }
  selectedIds.clear();
  await loadAssignments();
}

async function init() {
  initNav();
  if (!await checkAuth()) return;
  if (!await getStudio()) return;
  await loadAssignments();
}

init();

})();
</script>

</body>
</html>
