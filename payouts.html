<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ó–∞—Ä–ø–ª–∞—Ç—ã ‚Äî CRM</title>
<script>document.documentElement.setAttribute('data-theme', 'light');</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="nav.css">
<script src="nav.js"></script>
<style>
:root {
  --bg-primary: #080f1e;
  --bg-secondary: #0e1829;
  --bg-card: #131f35;
  --bg-input: #1a2844;
  --text: #eef2ff;
  --text-muted: #8aa0c0;
  --text-label: #b0c4de;
  --border: rgba(120, 160, 220, 0.22);
  --border-focus: rgba(99, 160, 255, 0.6);
  --primary: #5b9cf6;
  --primary-dark: #2563eb;
  --success: #22d3a0;
  --success-dark: #059669;
  --success-bg: rgba(34, 211, 160, 0.12);
  --danger: #f87171;
  --danger-bg: rgba(248, 113, 113, 0.14);
  --warning: #fbbf24;
  --shadow: 0 4px 24px rgba(0,0,0,0.5);
  --shadow-lg: 0 8px 40px rgba(0,0,0,0.6);
}

[data-theme="light"] {
  --bg-primary: #f0f4fb;
  --bg-secondary: #ffffff;
  --bg-card: #ffffff;
  --bg-input: #f8faff;
  --text: #0f172a;
  --text-muted: #64748b;
  --text-label: #475569;
  --border: rgba(15, 23, 42, 0.1);
  --border-focus: rgba(79, 142, 247, 0.5);
  --shadow: 0 4px 16px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Inter', -apple-system, sans-serif;
  background: var(--bg-primary);
  color: var(--text);
  line-height: 1.5;
  min-height: 100vh;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 24px;
}

/* Top Bar */
.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow);
}

.top-bar h1 {
  font-size: 1.3rem;
  font-weight: 800;
  background: linear-gradient(120deg, var(--primary), var(--success));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: -0.5px;
}

.top-bar-right {
  display: flex;
  gap: 10px;
  align-items: center;
}

.global-nav {
  display: flex;
  gap: 6px;
  align-items: center;
}

.nav-link {
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 0.88rem;
  font-weight: 600;
  color: var(--text-muted);
  text-decoration: none;
  transition: all 0.2s;
  border: 1px solid transparent;
  white-space: nowrap;
}

.nav-link:hover {
  background: var(--bg-input);
  color: var(--text);
}

.nav-link.active {
  background: var(--primary);
  color: #fff;
  border-color: var(--primary);
}

.theme-toggle {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 1.1rem;
  transition: all 0.2s;
}

.btn {
  background: var(--primary);
  color: #fff;
  border: none;
  padding: 9px 20px;
  border-radius: 10px;
  font-size: 0.88rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 7px;
  font-family: 'Inter', sans-serif;
}

.btn:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: var(--shadow);
}

.btn-success {
  background: var(--success);
}

.btn-success:hover {
  background: var(--success-dark);
}

.btn-secondary {
  background: transparent;
  color: var(--text-muted);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  background: var(--bg-input);
  color: var(--text);
  border-color: var(--border-focus);
}

/* Filters */
.filters {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
  flex-wrap: wrap;
  align-items: center;
}

.filters select {
  padding: 10px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-size: 0.9rem;
  font-family: 'Inter', sans-serif;
  cursor: pointer;
}

.filters select:focus {
  outline: none;
  border-color: var(--border-focus);
}

/* Tabs */
.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 24px;
  border-bottom: 2px solid var(--border);
  padding-bottom: 0;
}

.tab {
  padding: 12px 24px;
  background: transparent;
  border: none;
  border-bottom: 3px solid transparent;
  color: var(--text-muted);
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  font-family: 'Inter', sans-serif;
  position: relative;
  margin-bottom: -2px;
}

.tab:hover {
  color: var(--text);
  background: var(--bg-secondary);
}

.tab.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}

.tab-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 24px;
  height: 20px;
  padding: 0 6px;
  background: var(--bg-input);
  border-radius: 10px;
  font-size: 0.75rem;
  font-weight: 700;
  margin-left: 6px;
}

.tab.active .tab-badge {
  background: var(--primary);
  color: #fff;
}

/* Summary */
.summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.summary-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.summary-label {
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  font-weight: 600;
}

.summary-value {
  font-size: 1.8rem;
  font-weight: 800;
  color: var(--success);
  letter-spacing: -0.5px;
}

/* Table */
.table-wrap {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 14px;
  overflow: hidden;
}

table {
  width: 100%;
  border-collapse: collapse;
}

thead {
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
}

th {
  padding: 14px 16px;
  text-align: left;
  font-size: 0.8rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-label);
}

tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background 0.2s;
}

tbody tr:hover {
  background: var(--bg-secondary);
}

tbody tr:last-child {
  border-bottom: none;
}

td {
  padding: 16px;
  font-size: 0.9rem;
}

.executor-name {
  font-weight: 600;
}

.car-name {
  color: var(--text-muted);
  font-size: 0.85rem;
}

.service-name {
  font-size: 0.85rem;
  color: var(--text-muted);
}

.salary {
  font-weight: 700;
  font-size: 1rem;
  color: var(--success);
}

.month-badge {
  display: inline-block;
  padding: 4px 10px;
  background: var(--bg-input);
  border-radius: 6px;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-muted);
}

.btn-unpay {
  padding: 5px 12px;
  border-radius: 7px;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid rgba(220,38,38,0.25);
  background: rgba(220,38,38,0.07);
  color: #dc2626;
  transition: all 0.15s;
  font-family: inherit;
}
.btn-unpay:hover {
  background: #dc2626;
  color: #fff;
  border-color: #dc2626;
}

.btn-pay {
  padding: 6px 14px;
  font-size: 0.85rem;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-muted);
}

.empty-state-icon {
  font-size: 3rem;
  margin-bottom: 16px;
}

.loading {
  text-align: center;
  padding: 60px;
  color: var(--text-muted);
}

/* Actions */
.bulk-actions {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 16px;
}

.checkbox-cell {
  width: 40px;
}

.checkbox-cell input {
  cursor: pointer;
  width: 18px;
  height: 18px;
  accent-color: var(--primary);
}

/* Mobile */
@media (max-width: 768px) {
  .container {
    padding: 16px 12px;
  }

  .top-bar {
    flex-direction: column;
    gap: 12px;
    padding: 14px 16px;
  }

  .top-bar h1 {
    font-size: 1.15rem;
    text-align: center;
  }

  .top-bar-right {
    flex-direction: column;
    width: 100%;
    gap: 10px;
  }

  .global-nav {
    width: 100%;
    justify-content: center;
    flex-wrap: wrap;
  }

  .nav-link {
    font-size: 0.8rem;
    padding: 6px 12px;
  }

  .filters {
    flex-direction: column;
    align-items: stretch;
  }

  .filters select {
    width: 100%;
  }

  .summary {
    grid-template-columns: 1fr;
  }

  .tabs {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 2px;
  }

  .tab {
    padding: 10px 16px;
    font-size: 0.85rem;
    white-space: nowrap;
  }

  .bulk-actions {
    flex-direction: column;
    align-items: stretch;
  }

  .table-wrap {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  table {
    min-width: 600px;
  }

  th, td {
    padding: 10px 8px;
    font-size: 0.8rem;
  }

  .btn-unpay {
  padding: 5px 12px;
  border-radius: 7px;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid rgba(220,38,38,0.25);
  background: rgba(220,38,38,0.07);
  color: #dc2626;
  transition: all 0.15s;
  font-family: inherit;
}
.btn-unpay:hover {
  background: #dc2626;
  color: #fff;
  border-color: #dc2626;
}

.btn-pay {
    padding: 5px 10px;
    font-size: 0.75rem;
  }
}

@media (max-width: 480px) {
  .top-bar h1 {
    font-size: 1rem;
  }

  .theme-toggle {
    padding: 6px 10px;
    font-size: 1rem;
  }

  .nav-link {
    font-size: 0.75rem;
    padding: 5px 10px;
  }

  .summary-card {
    padding: 16px;
  }

  .summary-label {
    font-size: 0.75rem;
  }

  .summary-value {
    font-size: 1.5rem;
  }

  .tab {
    padding: 8px 12px;
    font-size: 0.8rem;
  }

  .tab-badge {
    font-size: 0.7rem;
    min-width: 20px;
    height: 18px;
  }

  table {
    min-width: 500px;
  }

  th, td {
    padding: 8px 6px;
    font-size: 0.75rem;
  }

  .month-badge {
    font-size: 0.7rem;
    padding: 3px 8px;
  }

  .salary {
    font-size: 0.9rem;
  }

  .btn {
    font-size: 0.85rem;
    padding: 8px 16px;
  }

  .global-nav {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
    flex-wrap: nowrap;
  }

  .global-nav::-webkit-scrollbar {
    display: none;
  }

  .nav-link {
    flex-shrink: 0;
  }
}

/* Footer */
.page-footer {
  margin-top: 60px;
  padding: 32px 24px;
  background: var(--bg-card);
  border-top: 1px solid var(--border);
  text-align: center;
}

.footer-content {
  max-width: 800px;
  margin: 0 auto;
}

.footer-theme {
  margin-bottom: 20px;
}

.footer-theme button {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 20px;
  cursor: pointer;
  font-size: 1.1rem;
  transition: all 0.2s;
  font-family: 'Inter', sans-serif;
  color: var(--text);
}

.footer-theme button:hover {
  border-color: var(--border-focus);
  transform: translateY(-2px);
}

.footer-desc {
  color: var(--text-muted);
  font-size: 0.9rem;
  line-height: 1.6;
  max-width: 600px;
  margin: 0 auto;
}

.footer-desc strong {
  color: var(--text);
  font-weight: 600;
}

@media (max-width: 600px) {
  .page-footer {
    padding: 24px 16px;
    margin-top: 40px;
  }

  .footer-desc {
    font-size: 0.85rem;
  }
}
</style>
</head>
<body>

<div class="container">
  <!-- Filters -->
  <div class="filters">
    <select id="monthFilter">
      <option value="all">–í—Å–µ –º–µ—Å—è—Ü—ã</option>
    </select>
    <select id="executorFilter">
      <option value="all">–í—Å–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</option>
    </select>
  </div>

  <!-- Summary -->
  <div class="summary">
    <div class="summary-card">
      <div class="summary-label">–ö –≤—ã–ø–ª–∞—Ç–µ</div>
      <div class="summary-value" id="summaryPending">0 ‚ÇΩ</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">–í—ã–ø–ª–∞—á–µ–Ω–æ</div>
      <div class="summary-value" id="summaryPaid">0 ‚ÇΩ</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">–í—Å–µ–≥–æ —Ä–∞–±–æ—Ç</div>
      <div class="summary-value" id="summaryTotal" style="color:var(--text)">0</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="pending" onclick="switchTab('pending')">
      ‚è≥ –ö –≤—ã–ø–ª–∞—Ç–µ
      <span class="tab-badge" id="badgePending">0</span>
    </button>
    <button class="tab" data-tab="paid" onclick="switchTab('paid')">
      ‚úÖ –í—ã–ø–ª–∞—á–µ–Ω–æ
      <span class="tab-badge" id="badgePaid">0</span>
    </button>
    <button class="tab" data-tab="cancelled" onclick="switchTab('cancelled')">
      ‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ
      <span class="tab-badge" id="badgeCancelled">0</span>
    </button>
  </div>

  <!-- Bulk Actions -->
  <div class="bulk-actions" id="bulkActions" style="display:none">
    <span id="selectedCount" style="color:var(--text-muted);font-size:0.9rem">–í—ã–±—Ä–∞–Ω–æ: 0</span>
    <button class="btn btn-success" onclick="paySelected()">üí∞ –í—ã–ø–ª–∞—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
  </div>

  <!-- Content -->
  <div id="tabContent">
    <div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>
</div>

<footer class="page-footer">
  <div class="footer-content">
    <div class="footer-desc">
      <strong>–ó–∞—Ä–ø–ª–∞—Ç—ã</strong> ‚Äî —É—á—ë—Ç –≤—ã–ø–ª–∞—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º. –í–∫–ª–∞–¥–∫–∏: –ö –≤—ã–ø–ª–∞—Ç–µ –∏ –í—ã–ø–ª–∞—á–µ–Ω–æ. –í—ã–ø–ª–∞—Ç—É –º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –∏ –≤–µ—Ä–Ω—É—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å.
    </div>
  </div>
</footer>

<script>
(function() {
'use strict';

const SUPABASE_URL = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window._crmSb = sb;

let currentUser = null;
let currentStudio = null;
let allAssignments = [];
let currentTab = 'pending';
let selectedIds = new Set();

// Theme


// Format
function fmt(n) {
  return new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n || 0);
}

function fmtMonth(str) {
  if (!str) return '';
  const [y, m] = str.split('-');
  const months = ['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'];
  return `${months[parseInt(m)-1]} ${y}`;
}

// Auth
async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'welcome.html'; return false; }
  currentUser = session.user;
  return true;
}

async function getStudio() {
  const { data, error } = await sb
    .from('studio_members')
    .select('studio_id, role')
    .eq('user_id', currentUser.id)
    .eq('is_active', true)
    .single();
  if (error || !data) { alert('‚ùå –°—Ç—É–¥–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); return false; }
  currentStudio = data;
  return true;
}

// Load
async function loadAssignments() {
  const { data, error } = await sb
    .from('work_assignments')
    .select(`
      id,
      calculation_id,
      executor_id,
      executor_name,
      service_name,
      salary,
      status,
      payment_month,
      is_admin_sale,
      admin_percent,
      calculations (
        car_name
      ),
      executors (
        full_name
      )
    `)
    .eq('studio_id', currentStudio.studio_id)
    .order('created_at', { ascending: false });

  if (error) {
    console.error(error);
    document.getElementById('tabContent').innerHTML = '<div class="empty-state">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
    return;
  }

  allAssignments = (data || []).map(a => ({
    ...a,
    executor_display: a.executors?.full_name || a.executor_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
    car_display: a.calculations?.car_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
  }));

  populateFilters();
  updateSummary();
  renderTab();
}

// Filters
function populateFilters() {
  // Months
  const months = [...new Set(allAssignments.map(a => a.payment_month).filter(Boolean))].sort().reverse();
  const monthFilter = document.getElementById('monthFilter');
  monthFilter.innerHTML = '<option value="all">–í—Å–µ –º–µ—Å—è—Ü—ã</option>';
  months.forEach(m => {
    monthFilter.innerHTML += `<option value="${m}">${fmtMonth(m)}</option>`;
  });

  // Executors
  const executors = [...new Set(allAssignments.map(a => a.executor_display))].sort();
  const execFilter = document.getElementById('executorFilter');
  execFilter.innerHTML = '<option value="all">–í—Å–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</option>';
  executors.forEach(e => {
    execFilter.innerHTML += `<option value="${e}">${e}</option>`;
  });
}

document.getElementById('monthFilter').addEventListener('change', renderTab);
document.getElementById('executorFilter').addEventListener('change', renderTab);

// Summary
function updateSummary() {
  const pending = allAssignments.filter(a => a.status === 'pending').reduce((acc, a) => acc + (a.salary || 0), 0);
  const paid = allAssignments.filter(a => a.status === 'paid').reduce((acc, a) => acc + (a.salary || 0), 0);
  const total = allAssignments.length;

  document.getElementById('summaryPending').textContent = fmt(pending) + ' ‚ÇΩ';
  document.getElementById('summaryPaid').textContent = fmt(paid) + ' ‚ÇΩ';
  document.getElementById('summaryTotal').textContent = total;

  document.getElementById('badgePending').textContent = allAssignments.filter(a => a.status === 'pending').length;
  document.getElementById('badgePaid').textContent = allAssignments.filter(a => a.status === 'paid').length;
  document.getElementById('badgeCancelled').textContent = allAssignments.filter(a => a.status === 'cancelled').length;
}

// Tabs
window.switchTab = function(tab) {
  currentTab = tab;
  selectedIds.clear();
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
  renderTab();
};

// Render
function renderTab() {
  const month = document.getElementById('monthFilter').value;
  const executor = document.getElementById('executorFilter').value;

  let filtered = allAssignments.filter(a => a.status === currentTab);
  if (month !== 'all') filtered = filtered.filter(a => a.payment_month === month);
  if (executor !== 'all') filtered = filtered.filter(a => a.executor_display === executor);

  const content = document.getElementById('tabContent');

  if (filtered.length === 0) {
    content.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üì≠</div>
        <h3>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</h3>
      </div>
    `;
    document.getElementById('bulkActions').style.display = 'none';
    return;
  }

  // Show bulk actions only for pending
  document.getElementById('bulkActions').style.display = currentTab === 'pending' ? 'flex' : 'none';

  let html = '<div class="table-wrap"><table><thead><tr>';
  if (currentTab === 'pending') html += '<th class="checkbox-cell"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>';
  html += '<th>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th><th>–ú–∞—à–∏–Ω–∞</th><th>–£—Å–ª—É–≥–∞</th><th>–ú–µ—Å—è—Ü</th><th>–°—É–º–º–∞</th>';
  if (currentTab === 'pending' || currentTab === 'paid') html += '<th>–î–µ–π—Å—Ç–≤–∏—è</th>';
  html += '</tr></thead><tbody>';

  filtered.forEach(a => {
    html += '<tr>';
    if (currentTab === 'pending') {
      html += `<td class="checkbox-cell"><input type="checkbox" class="row-checkbox" data-id="${a.id}" onchange="updateSelection()"></td>`;
    }
    html += `
      <td class="executor-name">${a.executor_display}</td>
      <td class="car-name">${a.car_display}</td>
      <td class="service-name">${a.service_name || (a.is_admin_sale ? `üí∞ –ü—Ä–æ–¥–∞–∂–∞ (${a.admin_percent}%)` : '-')}</td>
      <td><span class="month-badge">${fmtMonth(a.payment_month)}</span></td>
      <td class="salary">${fmt(a.salary)} ‚ÇΩ</td>
    `;
    if (currentTab === 'pending') {
      html += `<td><button class="btn btn-success btn-pay" onclick="paySingle('${a.id}')">üí∞ –í—ã–ø–ª–∞—Ç–∏—Ç—å</button></td>`;
    }
    if (currentTab === 'paid') {
      html += `<td><button class="btn btn-unpay" onclick="unpaySingle('${a.id}')">‚Ü© –û—Ç–º–µ–Ω–∏—Ç—å</button></td>`;
    }
    html += '</tr>';
  });

  html += '</tbody></table></div>';
  content.innerHTML = html;
}

// Selection
window.toggleSelectAll = function() {
  const checked = document.getElementById('selectAll').checked;
  document.querySelectorAll('.row-checkbox').forEach(cb => {
    cb.checked = checked;
    if (checked) selectedIds.add(cb.dataset.id);
    else selectedIds.delete(cb.dataset.id);
  });
  updateSelection();
};

window.updateSelection = function() {
  selectedIds.clear();
  document.querySelectorAll('.row-checkbox:checked').forEach(cb => {
    selectedIds.add(cb.dataset.id);
  });
  document.getElementById('selectedCount').textContent = `–í—ã–±—Ä–∞–Ω–æ: ${selectedIds.size}`;
};

// Actions
window.paySingle = async function(id) {
  if (!confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É?')) return;
  await markAsPaid([id]);
};

window.paySelected = async function() {
  if (selectedIds.size === 0) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å–∏'); return; }
  if (!confirm(`–í—ã–ø–ª–∞—Ç–∏—Ç—å ${selectedIds.size} –∑–∞–ø–∏—Å–µ–π?`)) return;
  await markAsPaid([...selectedIds]);
};

window.unpaySingle = async function(id) {
  if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É? –ó–∞–ø–∏—Å—å –≤–µ—Ä–Ω—ë—Ç—Å—è –≤ "–ö –≤—ã–ø–ª–∞—Ç–µ".')) return;
  const { error } = await sb.from('work_assignments').update({ status: 'pending' }).eq('id', id);
  if (error) { alert('–û—à–∏–±–∫–∞: ' + error.message); return; }
  await loadAssignments();
};

async function markAsPaid(ids) {
  const { error } = await sb
    .from('work_assignments')
    .update({ status: 'paid' })
    .in('id', ids);

  if (error) {
    console.error(error);
    alert('‚ùå –û—à–∏–±–∫–∞');
    return;
  }

  selectedIds.clear();
  await loadAssignments();
}

// Init
async function init() {
  initNav();
  if (!await checkAuth()) return;
  if (!await getStudio()) return;
  await loadAssignments();
}

init();

})();
</script>

<script src="footer.js"></script>
</body>
</html>
