<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¸ â€” Keep1R CRM</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="nav.css">
<script src="nav.js"></script>
<style>
:root {
  --font:       -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
  --bg:         #eef2f9;
  --surface:    #ffffff;
  --border:     rgba(15,23,42,0.08);
  --text:       #0f172a;
  --text-muted: #64748b;
  --text-dim:   #94a3b8;
  --primary:    #2563eb;
  --primary-dk: #1d4ed8;
  --success:    #059669;
  --danger:     #dc2626;
  --warning:    #d97706;
  --radius:     14px;
  --radius-sm:  9px;
  --shadow:     0 1px 3px rgba(0,0,0,0.04), 0 4px 14px rgba(0,0,0,0.06);
  --shadow-modal: 0 8px 40px rgba(0,0,0,0.14);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--font);
  -webkit-font-smoothing: antialiased;
  background: var(--bg);
  color: var(--text);
  min-height: 100svh;
}

.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 24px 20px 48px;
}

/* â”€â”€ ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ (ÑĞºÑ€Ñ‹Ñ‚Ğ°Ñ â€” Ğ½Ğ°Ğ²ĞµÑˆĞ¸Ğ²Ğ°ĞµÑ‚ÑÑ JS-Ğ¾Ğ¼) â”€â”€ */
#btnAddExecutor { display: none; }

/* â”€â”€ ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ°-ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 18px 22px;
  border-bottom: 1px solid var(--border);
  gap: 14px;
  flex-wrap: wrap;
}

.card-title {
  font-size: 0.95rem;
  font-weight: 700;
  letter-spacing: -0.1px;
}

.card-actions-row {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

/* â”€â”€ Ğ§ĞµĞºĞ±Ğ¾ĞºÑ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.checkbox-label {
  display: inline-flex;
  align-items: center;
  gap: 7px;
  cursor: pointer;
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--text-muted);
  user-select: none;
}
.checkbox-label input[type="checkbox"] {
  width: 16px; height: 16px;
  cursor: pointer;
  accent-color: var(--primary);
}
.checkbox-label:hover { color: var(--text); }

/* â”€â”€ Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.executors-table {
  width: 100%;
  border-collapse: collapse;
}

.executors-table thead {
  background: var(--bg);
  border-bottom: 1px solid var(--border);
}

.executors-table th {
  padding: 11px 16px;
  text-align: left;
  font-size: 0.67rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.07em;
  color: var(--text-muted);
  white-space: nowrap;
}

.executors-table tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background 0.12s;
}
.executors-table tbody tr:last-child { border-bottom: none; }
.executors-table tbody tr:hover { background: #f8fafc; }

.executors-table td {
  padding: 14px 16px;
  font-size: 0.85rem;
  vertical-align: middle;
}

.executor-name {
  font-weight: 700;
  font-size: 0.9rem;
  color: var(--text);
}

.executor-role {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 6px;
  font-size: 0.73rem;
  font-weight: 700;
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--text-muted);
}

.executor-phone {
  color: var(--text-muted);
  font-size: 0.82rem;
}

/* Ğ‘ĞµĞ¹Ğ´Ğ¶Ğ¸ */
.badge {
  display: inline-block;
  padding: 3px 9px;
  border-radius: 20px;
  font-size: 0.68rem;
  font-weight: 700;
  letter-spacing: 0.04em;
}
.badge-success  { background: rgba(5,150,105,0.10); color: var(--success); border: 1px solid rgba(5,150,105,0.2); }
.badge-inactive { background: var(--bg); color: var(--text-dim); border: 1px solid var(--border); }

.row-actions {
  display: flex;
  gap: 6px;
  align-items: center;
}

/* â”€â”€ ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 8px 16px;
  border-radius: var(--radius-sm);
  font-size: 0.81rem; font-weight: 700;
  font-family: var(--font); cursor: pointer;
  border: none; transition: all 0.15s; text-decoration: none;
  white-space: nowrap;
}
.btn-primary   { background: var(--primary); color: #fff; }
.btn-primary:hover   { background: var(--primary-dk); }
.btn-success   { background: var(--success); color: #fff; }
.btn-success:hover   { background: #047857; }
.btn-secondary {
  background: transparent; color: var(--text-muted);
  border: 1px solid var(--border);
}
.btn-secondary:hover { background: var(--bg); color: var(--text); }
.btn-danger {
  background: rgba(220,38,38,0.07);
  color: var(--danger);
  border: 1px solid rgba(220,38,38,0.15);
}
.btn-danger:hover { background: var(--danger); color: #fff; border-color: var(--danger); }
.btn-icon { padding: 7px 10px; font-size: 0.85rem; }

/* â”€â”€ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ½Ğ¾Ğ¿ĞºĞ° Ğ² ÑˆĞ°Ğ¿ĞºĞµ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-add {
  background: var(--primary);
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: var(--radius-sm);
  font-size: 0.81rem;
  font-weight: 700;
  font-family: var(--font);
  cursor: pointer;
  transition: all 0.15s;
  display: inline-flex;
  align-items: center;
  gap: 5px;
}
.btn-add:hover { background: var(--primary-dk); }

/* â”€â”€ Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading {
  text-align: center;
  padding: 52px 20px;
  color: var(--text-muted);
  font-size: 0.88rem;
}
.empty-state {
  text-align: center;
  padding: 56px 20px;
  color: var(--text-muted);
}
.empty-state-icon { font-size: 2.5rem; margin-bottom: 10px; opacity: 0.3; }
.empty-state h3   { font-size: 0.95rem; font-weight: 700; color: var(--text); }
.empty-state p    { font-size: 0.82rem; margin-top: 4px; }

/* â”€â”€ ĞœĞ¾Ğ´Ğ°Ğ» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.5);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal.active { display: flex; animation: fadeIn 0.15s ease; }

@keyframes fadeIn  { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { transform: translateY(12px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.modal-content {
  background: var(--surface);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  padding: 26px 28px 24px;
  max-width: 460px;
  width: 100%;
  max-height: 90svh;
  overflow-y: auto;
  box-shadow: var(--shadow-modal);
  animation: slideUp 0.18s ease;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.modal-header h3 {
  font-size: 1.05rem;
  font-weight: 700;
  letter-spacing: -0.2px;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.4rem;
  cursor: pointer;
  color: var(--text-dim);
  width: 32px; height: 32px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 7px;
  transition: all 0.15s;
  line-height: 1;
}
.modal-close:hover { background: var(--bg); color: var(--text); }

.form-group { margin-bottom: 14px; }

.form-group label {
  display: block;
  font-size: 0.69rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.07em;
  color: var(--text-muted);
  margin-bottom: 5px;
}

.form-group input,
.form-group select {
  width: 100%;
  padding: 10px 13px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 16px;
  font-family: var(--font);
  transition: border-color 0.15s, box-shadow 0.15s;
  outline: none;
  -webkit-appearance: none;
}
.form-group input:focus,
.form-group select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37,99,235,0.10);
  background: var(--surface);
}

.form-group small {
  display: block;
  margin-top: 4px;
  color: var(--text-dim);
  font-size: 0.72rem;
}

.checkbox-group {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 14px;
  background: var(--bg);
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  cursor: pointer;
}
.checkbox-group input[type="checkbox"] {
  width: 17px; height: 17px;
  cursor: pointer;
  accent-color: var(--success);
  flex-shrink: 0;
}
.checkbox-group label {
  font-size: 0.83rem;
  font-weight: 600;
  cursor: pointer;
  color: var(--text);
  text-transform: none;
  letter-spacing: 0;
  margin: 0;
}

.modal-footer {
  display: flex;
  gap: 8px;
  margin-top: 20px;
  justify-content: flex-end;
}

/* â”€â”€ ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 768px) {
  .container { padding: 16px 14px 40px; }

  /* ĞœĞ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ */
  .executors-table thead { display: none; }
  .executors-table, .executors-table tbody { display: block; }
  .executors-table tr {
    display: block;
    margin: 0;
    border-bottom: 1px solid var(--border);
    padding: 14px 16px;
  }
  .executors-table tr:last-child { border-bottom: none; }
  .executors-table td {
    display: inline-block;
    padding: 0;
    border: none;
    font-size: 0.82rem;
  }
  .executors-table td[data-label="Ğ¤Ğ˜Ğ"]      { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .executors-table td[data-label="Ğ Ğ¾Ğ»ÑŒ"]     { margin-right: 8px; }
  .executors-table td[data-label="Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½"]  { display: block; color: var(--text-muted); font-size: 0.78rem; margin-bottom: 6px; }
  .executors-table td[data-label="Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ"]   { display: inline-block; margin-bottom: 10px; }
  .executors-table td[data-label="Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ"] { display: flex; gap: 6px; }

  .modal-content { padding: 22px 18px 20px; }
  .modal-footer  { flex-direction: column-reverse; gap: 7px; }
  .modal-footer .btn { width: 100%; justify-content: center; }
}
</style>
</head>
<body>

<div class="container">
  <!-- Ğ¡ĞºÑ€Ñ‹Ñ‚Ğ°Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ° â€” js Ğ½Ğ°Ğ²ĞµÑˆĞ¸Ğ²Ğ°ĞµÑ‚ Ñ‡ĞµÑ€ĞµĞ· btnAddExecutor -->
  <button class="btn btn-primary" id="btnAddExecutor" style="display:none">â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>

  <div class="card">
    <div class="card-header">
      <span class="card-title">ğŸ‘¥ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ²</span>
      <div class="card-actions-row">
        <label class="checkbox-label">
          <input type="checkbox" id="showInactive">
          <span>ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ½ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…</span>
        </label>
        <button class="btn-add" onclick="document.getElementById('btnAddExecutor').click()">â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
      </div>
    </div>

    <div id="executorsContainer">
      <div class="loading">â³ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
    </div>
  </div>
</div>

<!-- ĞœĞ¾Ğ´Ğ°Ğ»: Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ / Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ -->
<div class="modal" id="executorModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ°</h3>
      <button class="modal-close" id="modalClose">Ã—</button>
    </div>

    <form id="executorForm">
      <input type="hidden" id="executorId">

      <div class="form-group">
        <label for="executorName">Ğ¤Ğ˜Ğ *</label>
        <input type="text" id="executorName" required placeholder="Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ² Ğ˜Ğ²Ğ°Ğ½ Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‡" autocomplete="name">
      </div>

      <div class="form-group">
        <label for="executorRole">Ğ Ğ¾Ğ»ÑŒ *</label>
        <select id="executorRole" required>
          <option value="">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ€Ğ¾Ğ»ÑŒ</option>
          <option value="wrapper">ĞĞºĞ»ĞµĞ¹Ñ‰Ğ¸Ğº</option>
          <option value="preparer">ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‰Ğ¸Ğº</option>
          <option value="armature">ĞÑ€Ğ¼Ğ°Ñ‚ÑƒÑ€Ñ‰Ğ¸Ğº</option>
          <option value="detailer">Ğ”ĞµÑ‚ĞµĞ¹Ğ»ĞµÑ€</option>
          <option value="universal">Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»</option>
        </select>
      </div>

      <div class="form-group">
        <label for="executorPhone">Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</label>
        <input type="tel" id="executorPhone" placeholder="+7 (999) 123-45-67" autocomplete="tel">
        <small>ĞĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾</small>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="executorIsAdmin">
        <label for="executorIsAdmin">âœ… ĞœĞ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ (Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ % Ğ¾Ñ‚ Ñ‡ĞµĞºĞ°)</label>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="btnCancel">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
        <button type="submit" class="btn btn-success" id="btnSave">ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
      </div>
    </form>
  </div>
</div>

<script src="footer.js"></script>
<script>
(function() {
'use strict';

const SUPABASE_URL = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window._crmSb = sb;

let currentUser = null;
let currentStudio = null;
let editingExecutorId = null;

const roleNames = {
  wrapper:   'ĞĞºĞ»ĞµĞ¹Ñ‰Ğ¸Ğº',
  preparer:  'ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‰Ğ¸Ğº',
  armature:  'ĞÑ€Ğ¼Ğ°Ñ‚ÑƒÑ€Ñ‰Ğ¸Ğº',
  detailer:  'Ğ”ĞµÑ‚ĞµĞ¹Ğ»ĞµÑ€',
  universal: 'Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»'
};

async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'welcome.html'; return false; }
  currentUser = session.user;
  return true;
}

async function getStudio() {
  const { data, error } = await sb
    .from('studio_members')
    .select('studio_id, role')
    .eq('user_id', currentUser.id)
    .eq('is_active', true)
    .single();
  if (error || !data) { alert('âŒ Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°'); return null; }
  currentStudio = data;
  return data;
}

async function loadExecutors() {
  const container = document.getElementById('executorsContainer');
  const showInactive = document.getElementById('showInactive').checked;

  container.innerHTML = '<div class="loading">â³ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>';

  try {
    let query = sb
      .from('executors')
      .select('*')
      .eq('studio_id', currentStudio.studio_id)
      .order('full_name', { ascending: true });

    if (!showInactive) query = query.eq('is_active', true);

    const { data, error } = await query;

    if (error) {
      console.error('Error loading executors:', error);
      container.innerHTML = '<div class="empty-state">âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸<br><small style="color:var(--text-muted)">ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ</small></div>';
      return;
    }

    if (!data || data.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ‘¥</div>
          <h3>ĞĞµÑ‚ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ²</h3>
          <p>Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ñ</p>
        </div>
      `;
      return;
    }

    renderExecutorsTable(data);

  } catch (e) {
    console.error('Error:', e);
    container.innerHTML = '<div class="empty-state">âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸</div>';
  }
}

function renderExecutorsTable(executors) {
  const container = document.getElementById('executorsContainer');

  let html = `
    <table class="executors-table">
      <thead>
        <tr>
          <th>Ğ¤Ğ˜Ğ</th>
          <th>Ğ Ğ¾Ğ»ÑŒ</th>
          <th>Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</th>
          <th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</th>
          <th style="width:200px"></th>
        </tr>
      </thead>
      <tbody>
  `;

  executors.forEach(exec => {
    const roleName    = roleNames[exec.role] || exec.role;
    const isAdmin     = exec.is_admin ? '&nbsp;<span class="badge badge-success">% Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ°</span>' : '';
    const statusBadge = exec.is_active
      ? '<span class="badge badge-success">ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½</span>'
      : '<span class="badge badge-inactive">ĞĞµĞ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½</span>';

    html += `
      <tr>
        <td data-label="Ğ¤Ğ˜Ğ">
          <div class="executor-name">${exec.full_name}${isAdmin}</div>
        </td>
        <td data-label="Ğ Ğ¾Ğ»ÑŒ">
          <span class="executor-role">${roleName}</span>
        </td>
        <td data-label="Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½">
          <span class="executor-phone">${exec.phone || 'â€”'}</span>
        </td>
        <td data-label="Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ">${statusBadge}</td>
        <td data-label="Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ">
          <div class="row-actions">
            <button class="btn btn-secondary btn-icon" onclick="editExecutor('${exec.id}')">âœï¸ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ</button>
            ${exec.is_active
              ? `<button class="btn btn-danger btn-icon" onclick="deactivateExecutor('${exec.id}','${exec.full_name.replace(/'/g,"\\'")}')">Ğ”ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</button>`
              : `<button class="btn btn-success btn-icon" onclick="activateExecutor('${exec.id}','${exec.full_name.replace(/'/g,"\\'")}')">ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</button>`
            }
          </div>
        </td>
      </tr>
    `;
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

function openModal(title = 'Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ°') {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('executorModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('executorModal').classList.remove('active');
  document.body.style.overflow = '';
  document.getElementById('executorForm').reset();
  document.getElementById('executorId').value = '';
  editingExecutorId = null;
}

window.editExecutor = async function(executorId) {
  try {
    const { data, error } = await sb.from('executors').select('*').eq('id', executorId).single();
    if (error || !data) { alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…'); return; }

    editingExecutorId = executorId;
    document.getElementById('executorId').value         = executorId;
    document.getElementById('executorName').value       = data.full_name;
    document.getElementById('executorRole').value       = data.role;
    document.getElementById('executorPhone').value      = data.phone || '';
    document.getElementById('executorIsAdmin').checked  = data.is_admin || false;

    openModal('Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ñ');
  } catch (e) {
    console.error('Error:', e);
    alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…');
  }
};

window.deactivateExecutor = async function(executorId, name) {
  if (!confirm(`Ğ”ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ° Â«${name}Â»?\nĞĞ½ Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°Ñ‚ÑŒÑÑ Ğ² Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…, Ğ½Ğ¾ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑÑ.`)) return;
  try {
    const { error } = await sb.from('executors').update({ is_active: false }).eq('id', executorId);
    if (error) { console.error('Error:', error); alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸'); return; }
    loadExecutors();
  } catch (e) { console.error('Error:', e); alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸'); }
};

window.activateExecutor = async function(executorId, name) {
  if (!confirm(`ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ñ Â«${name}Â»?`)) return;
  try {
    const { error } = await sb.from('executors').update({ is_active: true }).eq('id', executorId);
    if (error) { console.error('Error:', error); alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸'); return; }
    loadExecutors();
  } catch (e) { console.error('Error:', e); alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸'); }
};

async function saveExecutor(e) {
  e.preventDefault();

  const executorData = {
    studio_id: currentStudio.studio_id,
    full_name:  document.getElementById('executorName').value.trim(),
    role:       document.getElementById('executorRole').value,
    phone:      document.getElementById('executorPhone').value.trim() || null,
    is_admin:   document.getElementById('executorIsAdmin').checked,
    is_active:  true
  };

  if (!executorData.full_name || !executorData.role) { alert('âŒ Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ'); return; }

  try {
    let error;
    if (editingExecutorId) {
      ({ error } = await sb.from('executors').update(executorData).eq('id', editingExecutorId));
    } else {
      ({ error } = await sb.from('executors').insert(executorData));
    }
    if (error) { console.error('Error:', error); alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ'); return; }
    closeModal();
    loadExecutors();
  } catch (e) {
    console.error('Error:', e);
    alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ');
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  initNav({ actionLabel: 'â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ°', actionHref: '#', hideAction: false });
  if (!await checkAuth()) return;
  if (!await getStudio()) return;
  await loadExecutors();

  const navAction = document.querySelector('#navTopBar .btn-nav-action');
  if (navAction) navAction.addEventListener('click', (e) => { e.preventDefault(); openModal(); });

  document.getElementById('btnAddExecutor').addEventListener('click', () => openModal());
  document.getElementById('modalClose').addEventListener('click', closeModal);
  document.getElementById('btnCancel').addEventListener('click', closeModal);
  document.getElementById('executorForm').addEventListener('submit', saveExecutor);
  document.getElementById('showInactive').addEventListener('change', loadExecutors);

  document.getElementById('executorModal').addEventListener('click', (e) => {
    if (e.target.id === 'executorModal') closeModal();
  });
});

})();
</script>

</body>
</html>
