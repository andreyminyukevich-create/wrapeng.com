<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ú–æ–∏ —Ä–∞—Å—á—ë—Ç—ã</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="dashboard-container">
    <!-- Header -->
    <header class="dashboard-header">
      <div class="header-left">
        <button onclick="location.href='dashboard.html'" class="btn-secondary">‚Üê Dashboard</button>
        <h1 style="margin-left: 20px;">üìä –ú–æ–∏ —Ä–∞—Å—á—ë—Ç—ã</h1>
      </div>
      <div class="header-right">
        <span id="userEmail">user@email.com</span>
      </div>
    </header>

    <!-- Calculations List -->
    <main style="background: white; border-radius: 20px; padding: 30px; margin-top: 20px;">
      <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
        <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Ä–∞—Å—á—ë—Ç–æ–≤</h2>
        <button onclick="loadCalculations()" class="btn-secondary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>

      <!-- –¢–∞–±–ª–∏—Ü–∞ -->
      <div style="overflow-x: auto;">
        <table id="calculationsTable" style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f5f5f5; text-align: left;">
              <th style="padding: 15px; border-bottom: 2px solid #e0e0e0;">–î–∞—Ç–∞</th>
              <th style="padding: 15px; border-bottom: 2px solid #e0e0e0;">–ê–≤—Ç–æ–º–æ–±–∏–ª—å</th>
              <th style="padding: 15px; border-bottom: 2px solid #e0e0e0;">–¢–∏–ø</th>
              <th style="padding: 15px; border-bottom: 2px solid #e0e0e0;">–°—É–º–º–∞</th>
              <th style="padding: 15px; border-bottom: 2px solid #e0e0e0;">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="calculationsBody">
            <tr>
              <td colspan="5" style="text-align: center; padding: 40px; color: #999;">
                –ó–∞–≥—Ä—É–∑–∫–∞...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <script src="shared.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      await initAuth();
      
      const user = await getCurrentUser();
      if (!user) {
        window.location.href = 'dashboard.html';
        return;
      }

      document.getElementById('userEmail').textContent = user.email;
      
      await loadCalculations();
    });

    async function loadCalculations() {
      const tbody = document.getElementById('calculationsBody');
      tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

      try {
        const calculations = await getCalculations(100);
        
        if (calculations.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">–†–∞—Å—á—ë—Ç—ã –ø–æ–∫–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</td></tr>';
          return;
        }

        tbody.innerHTML = calculations.map(calc => `
          <tr style="border-bottom: 1px solid #e0e0e0; cursor: pointer;" onmouseover="this.style.background='#f9f9f9'" onmouseout="this.style.background='white'">
            <td style="padding: 15px;">${formatDate(calc.created_at)}</td>
            <td style="padding: 15px;">
              <strong>${calc.car_brand || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'} ${calc.car_model || ''}</strong>
              ${calc.car_year ? `<br><span style="color: #999; font-size: 12px;">${calc.car_year} –≥.</span>` : ''}
            </td>
            <td style="padding: 15px;">${getTypeLabel(calc.calculation_type)}</td>
            <td style="padding: 15px;"><strong>${formatMoney(calc.total_cost)}</strong></td>
            <td style="padding: 15px;">
              <button onclick="openCalculation('${calc.id}')" class="btn-secondary" style="padding: 8px 15px; margin-right: 5px;">–û—Ç–∫—Ä—ã—Ç—å</button>
              <button onclick="deleteCalc('${calc.id}')" style="padding: 8px 15px; background: #ff4757; color: white; border: none; border-radius: 8px; cursor: pointer;">–£–¥–∞–ª–∏—Ç—å</button>
            </td>
          </tr>
        `).join('');
        
      } catch (error) {
        console.error('Error loading calculations:', error);
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #ff4757;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—á—ë—Ç–æ–≤</td></tr>';
      }
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const day = date.getDate();
      const months = ['—è–Ω–≤', '—Ñ–µ–≤', '–º–∞—Ä', '–∞–ø—Ä', '–º–∞–π', '–∏—é–Ω', '–∏—é–ª', '–∞–≤–≥', '—Å–µ–Ω', '–æ–∫—Ç', '–Ω–æ—è', '–¥–µ–∫'];
      const month = months[date.getMonth()];
      const time = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      return `${day} ${month}, ${time}`;
    }

    function getTypeLabel(type) {
      const types = {
        'ppf': 'PPF',
        'vinyl': '–í–∏–Ω–∏–ª',
        'detailing': '–î–µ—Ç–µ–π–ª–∏–Ω–≥',
        'glass': '–°—Ç—ë–∫–ª–∞'
      };
      return types[type] || '–ù–µ —É–∫–∞–∑–∞–Ω';
    }

    function formatMoney(amount) {
      if (!amount) return '‚Äî';
      return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        minimumFractionDigits: 0
      }).format(amount);
    }

    function openCalculation(id) {
      // TODO: –û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –¥–∞–Ω–Ω—ã—Ö
      window.location.href = `calculator.html?load=${id}`;
    }

    async function deleteCalc(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–∞—Å—á—ë—Ç?')) return;
      
      try {
        await deleteCalculation(id);
        await loadCalculations();
      } catch (error) {
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message);
      }
    }
  </script>
</body>
</html>
