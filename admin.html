<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keep1R CRM ‚Äî –ê–¥–º–∏–Ω</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="nav.css">
<script src="nav.js"></script>
<style>
:root {
  --bg: #f0f4fb;
  --card: #ffffff;
  --border: rgba(15,23,42,0.09);
  --text: #0f172a;
  --muted: #64748b;
  --primary: #2563eb;
  --success: #059669;
  --warning: #d97706;
  --danger: #dc2626;
  --purple: #7c3aed;
  --radius: 12px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: inherit; }

.page { max-width: 1100px; margin: 0 auto; padding: 28px 20px; }

/* ‚îÄ‚îÄ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚îÄ‚îÄ */
.page-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 12px;
}
.page-title {
  font-size: 1.4rem;
  font-weight: 800;
  letter-spacing: -0.3px;
}
.page-title span { color: var(--primary); }

/* ‚îÄ‚îÄ –¢–∞–±—ã ‚îÄ‚îÄ */
.tabs {
  display: flex;
  gap: 4px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 4px;
  margin-bottom: 24px;
  width: fit-content;
}
.tab-btn {
  padding: 7px 18px;
  border-radius: 7px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  border: none;
  background: transparent;
  color: var(--muted);
  font-family: inherit;
  transition: all 0.15s;
  white-space: nowrap;
}
.tab-btn.active {
  background: var(--primary);
  color: #fff;
}

/* ‚îÄ‚îÄ –ö–∞—Ä—Ç–æ—á–∫–∞ ‚îÄ‚îÄ */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 20px;
  box-shadow: 0 1px 6px rgba(0,0,0,0.05);
}
.card-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
  gap: 10px;
}
.card-head h2 { font-size: 0.95rem; font-weight: 700; }

/* ‚îÄ‚îÄ –¢–∞–±–ª–∏—Ü–∞ ‚îÄ‚îÄ */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
thead th {
  background: #f8faff;
  padding: 10px 16px;
  text-align: left;
  font-size: 0.75rem;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
tbody td {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
}
tbody tr:last-child td { border-bottom: none; }
tbody tr:hover { background: #f8faff; }

.studio-name { font-weight: 700; font-size: 0.88rem; }
.studio-email { font-size: 0.78rem; color: var(--muted); margin-top: 2px; }

/* ‚îÄ‚îÄ –ë–µ–π–¥–∂–∏ –ø–æ–¥–ø–∏—Å–∫–∏ ‚îÄ‚îÄ */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 700;
  white-space: nowrap;
}
.badge-active  { background: rgba(5,150,105,0.1);  color: var(--success); }
.badge-trial   { background: rgba(37,99,235,0.1);   color: var(--primary); }
.badge-expired { background: rgba(220,38,38,0.1);   color: var(--danger);  }
.badge-ref     { background: rgba(124,58,237,0.1);  color: var(--purple);  }
.badge-pending { background: rgba(217,119,6,0.1);   color: var(--warning); }
.badge-paid    { background: rgba(5,150,105,0.1);   color: var(--success); }

/* ‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π ‚îÄ‚îÄ */
.actions { display: flex; gap: 5px; flex-wrap: wrap; }
.btn {
  padding: 5px 12px;
  border-radius: 7px;
  font-size: 0.78rem;
  font-weight: 600;
  cursor: pointer;
  border: none;
  font-family: inherit;
  transition: all 0.15s;
  white-space: nowrap;
}
.btn-primary  { background: var(--primary); color: #fff; }
.btn-primary:hover { background: #1d4ed8; }
.btn-success  { background: var(--success); color: #fff; }
.btn-success:hover { background: #047857; }
.btn-warning  { background: rgba(217,119,6,0.12); color: var(--warning); border: 1px solid rgba(217,119,6,0.25); }
.btn-warning:hover { background: var(--warning); color: #fff; }
.btn-danger   { background: rgba(220,38,38,0.08); color: var(--danger); border: 1px solid rgba(220,38,38,0.2); }
.btn-danger:hover { background: var(--danger); color: #fff; }
.btn-ghost    { background: #f1f5ff; color: var(--primary); border: 1px solid rgba(37,99,235,0.15); }
.btn-ghost:hover { background: var(--primary); color: #fff; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* ‚îÄ‚îÄ Stat –∫–∞—Ä—Ç–æ—á–∫–∏ ‚îÄ‚îÄ */
.stats-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 14px;
  margin-bottom: 24px;
}
.stat-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px 20px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
}
.stat-label { font-size: 0.75rem; color: var(--muted); font-weight: 600; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.05em; }
.stat-value { font-size: 1.8rem; font-weight: 800; letter-spacing: -1px; }
.stat-sub   { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }

/* ‚îÄ‚îÄ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ ‚îÄ‚îÄ */
.ref-code {
  font-family: monospace;
  font-size: 0.85rem;
  font-weight: 700;
  background: #f1f5ff;
  color: var(--primary);
  padding: 3px 8px;
  border-radius: 6px;
  letter-spacing: 0.1em;
}

.expires-text { font-size: 0.8rem; color: var(--muted); }
.expires-soon { color: var(--warning); font-weight: 600; }

/* ‚îÄ‚îÄ –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚îÄ‚îÄ */
.empty { text-align: center; padding: 40px; color: var(--muted); }
.empty-icon { font-size: 2.5rem; margin-bottom: 10px; }

/* ‚îÄ‚îÄ –ú–æ–¥–∞–ª–∫–∞ ‚îÄ‚îÄ */
.modal-overlay {
  display: none;
  position: fixed; inset: 0; z-index: 1000;
  background: rgba(15,23,42,0.4);
  backdrop-filter: blur(4px);
  align-items: center; justify-content: center;
  padding: 20px;
}
.modal-overlay.active { display: flex; }
.modal {
  background: #fff;
  border-radius: 16px;
  padding: 28px;
  width: 100%;
  max-width: 400px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.2);
}
.modal h3 { font-size: 1.1rem; font-weight: 800; margin-bottom: 16px; }
.modal-actions { display: flex; gap: 8px; margin-top: 20px; }
.modal-actions .btn { flex: 1; padding: 10px; font-size: 0.85rem; }

/* ‚îÄ‚îÄ –§–æ—Ä–º–∞ –≤ –º–æ–¥–∞–ª–∫–µ ‚îÄ‚îÄ */
.form-group { margin-bottom: 14px; }
.form-group label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--muted); margin-bottom: 5px; }
.form-group select, .form-group input {
  width: 100%;
  padding: 9px 12px;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  font-size: 0.88rem;
  font-family: inherit;
  color: var(--text);
  outline: none;
}
.form-group select:focus, .form-group input:focus { border-color: var(--primary); }

@media (max-width: 640px) {
  .page { padding: 16px 14px; }
  .actions { flex-direction: column; }
  .btn { width: 100%; text-align: center; }
}

/* –ú–æ–¥–∞–ª –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–∞—Å—á—ë—Ç–∞ */
#calcViewModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.6);
  z-index: 9000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
#calcViewModal.active { display: flex; }
#calcViewModal .modal-box {
  background: #fff;
  border-radius: 16px;
  padding: 28px;
  max-width: 700px;
  width: 100%;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.2);
}
#calcViewModal h2 { font-size: 1.2rem; font-weight: 800; margin-bottom: 20px; color: #1e293b; }
.calc-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
.calc-detail-item { background: #f8fafc; border-radius: 10px; padding: 12px 16px; }
.calc-detail-label { font-size: 0.72rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
.calc-detail-value { font-size: 1rem; font-weight: 700; color: #1e293b; }
.calc-detail-value.accent { color: #7c3aed; }
.calc-services-list { border: 1px solid #e2e8f0; border-radius: 10px; overflow: hidden; margin-bottom: 16px; }
.calc-services-list table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
.calc-services-list th { background: #f1f5f9; padding: 8px 12px; text-align: left; font-weight: 700; color: #64748b; font-size: 0.75rem; text-transform: uppercase; }
.calc-services-list td { padding: 8px 12px; border-top: 1px solid #f1f5f9; }
</style>
</head>
<body>

<div class="page">
  <div class="page-header">
    <div class="page-title">‚öôÔ∏è <span>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</span></div>
    <div id="adminBadge" style="font-size:0.8rem;color:var(--muted)">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <div class="stats-row" id="statsRow">
    <div class="stat-card"><div class="stat-label">–°—Ç—É–¥–∏–π –≤—Å–µ–≥–æ</div><div class="stat-value" id="sTotal">‚Äî</div></div>
    <div class="stat-card"><div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div><div class="stat-value" id="sActive" style="color:var(--success)">‚Äî</div></div>
    <div class="stat-card"><div class="stat-label">–ù–∞ —Ç—Ä–∏–∞–ª–µ</div><div class="stat-value" id="sTrial" style="color:var(--primary)">‚Äî</div></div>
    <div class="stat-card"><div class="stat-label">–ò—Å—Ç—ë–∫ –¥–æ—Å—Ç—É–ø</div><div class="stat-value" id="sExpired" style="color:var(--danger)">‚Äî</div></div>
    <div class="stat-card"><div class="stat-label">–ö–æ–º–∏—Å—Å–∏–π –∫ –≤—ã–ø–ª–∞—Ç–µ</div><div class="stat-value" id="sCommission" style="color:var(--purple)">‚Äî</div><div class="stat-sub">‚ÇΩ</div></div>
  </div>

  <div class="tabs">
    <button class="tab-btn" onclick="switchTab('requests')">üìã –ó–∞—è–≤–∫–∏ <span id="badgeRequests"></span></button>
    <button class="tab-btn" onclick="switchTab('trial')">üß™ –ù–∞ —Ç–µ—Å—Ç–µ <span id="badgeTrial"></span></button>
    <button class="tab-btn active" onclick="switchTab('studios')">üè¢ –°—Ç—É–¥–∏–∏</button>
    <button class="tab-btn" onclick="switchTab('referrals')">üîó –†–µ—Ñ–µ—Ä–∞–ª—ã</button>
    <button class="tab-btn" onclick="switchTab('commissions')">üí∞ –ö–æ–º–∏—Å—Å–∏–∏</button>
    <button class="tab-btn" onclick="switchTab('calcs')">üìä –†–∞—Å—á—ë—Ç—ã</button>
  </div>

  <!-- –¢–∞–±: –°—Ç—É–¥–∏–∏ -->
  <div id="tab-requests" style="display:none">
  <table class="table">
    <thead><tr>
      <th>–°—Ç—É–¥–∏—è</th><th>–ì–æ—Ä–æ–¥ / –¢–µ–ª–µ—Ñ–æ–Ω</th><th>Email</th>
      <th>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th>
    </tr></thead>
    <tbody id="requestsBody"><tr><td colspan="5" style="text-align:center;color:#94a3b8">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
  </table>
</div>

<div id="tab-trial" style="display:none">
  <table class="table">
    <thead><tr>
      <th>–°—Ç—É–¥–∏—è</th><th>–í–ª–∞–¥–µ–ª–µ—Ü</th><th>–†–µ—Ñ. –∫–æ–¥</th><th>–¢—Ä–∏–∞–ª –∏—Å—Ç–µ–∫–∞–µ—Ç</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr></thead>
    <tbody id="trialBody"><tr><td colspan="5" style="text-align:center;color:#94a3b8">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
  </table>
</div>

<div id="tab-studios">
    <div class="card">
      <div class="card-head">
        <h2>–°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–∏–π</h2>
        <button class="btn btn-primary" onclick="openAddModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–∏—é</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>–°—Ç—É–¥–∏—è</th>
              <th>–†–µ—Ñ. –∫–æ–¥</th>
              <th>–ü–æ–¥–ø–∏—Å–∫–∞</th>
              <th>–ò—Å—Ç–µ–∫–∞–µ—Ç</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="studiosBody">
            <tr><td colspan="5"><div class="empty"><div class="empty-icon">‚è≥</div>–ó–∞–≥—Ä—É–∑–∫–∞...</div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- –¢–∞–±: –†–µ—Ñ–µ—Ä–∞–ª—ã -->
  <div id="tab-calcs" style="display:none">
  <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
    <select id="calcsStudioFilter" style="padding:8px 12px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:0.9rem">
      <option value="">–í—Å–µ —Å—Ç—É–¥–∏–∏</option>
    </select>
    <input type="text" id="calcsSearch" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∞–≤—Ç–æ..." style="padding:8px 12px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:0.9rem;min-width:200px">
    <span id="calcsCount" style="color:#64748b;font-size:0.85rem"></span>
    <div style="margin-left:auto;display:flex;gap:8px">
      <div style="background:#f1f5f9;border-radius:8px;padding:8px 16px;text-align:center">
        <div style="font-size:0.75rem;color:#64748b;text-transform:uppercase">–†–∞—Å—á—ë—Ç–æ–≤</div>
        <div id="calcsStatTotal" style="font-weight:800;font-size:1.1rem">‚Äî</div>
      </div>
      <div style="background:#f1f5f9;border-radius:8px;padding:8px 16px;text-align:center">
        <div style="font-size:0.75rem;color:#64748b;text-transform:uppercase">–°—É–º–º–∞</div>
        <div id="calcsStatSum" style="font-weight:800;font-size:1.1rem;color:#7c3aed">‚Äî</div>
      </div>
      <div style="background:#f1f5f9;border-radius:8px;padding:8px 16px;text-align:center">
        <div style="font-size:0.75rem;color:#64748b;text-transform:uppercase">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
        <div id="calcsStatAvg" style="font-weight:800;font-size:1.1rem">‚Äî</div>
      </div>
    </div>
  </div>
  <table class="table">
    <thead><tr>
      <th>–°—Ç—É–¥–∏—è</th><th>–ê–≤—Ç–æ</th><th>–°—É–º–º–∞</th><th>–ò—Ç–æ–≥</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th><th></th>
    </tr></thead>
    <tbody id="calcsBody"><tr><td colspan="6" style="text-align:center;color:#94a3b8">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
  </table>
</div>

<div id="tab-referrals" style="display:none">
    <div class="card">
      <div class="card-head"><h2>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏</h2></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>–ö—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª</th>
              <th>–ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–∞—è —Å—Ç—É–¥–∏—è</th>
              <th>–†–µ—Ñ. –∫–æ–¥</th>
              <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
              <th>–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏</th>
            </tr>
          </thead>
          <tbody id="referralsBody">
            <tr><td colspan="5"><div class="empty"><div class="empty-icon">‚è≥</div>–ó–∞–≥—Ä—É–∑–∫–∞...</div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- –¢–∞–±: –ö–æ–º–∏—Å—Å–∏–∏ -->
  <div id="tab-commissions" style="display:none">
    <div class="card">
      <div class="card-head">
        <h2>–ö–æ–º–∏—Å—Å–∏–∏ –∫ –≤—ã–ø–ª–∞—Ç–µ</h2>
        <button class="btn btn-success" onclick="markAllPaid()">‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –≤—ã–ø–ª–∞—á–µ–Ω–Ω—ã–º–∏</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>–†–µ—Ñ–µ—Ä—Ä–µ—Ä</th>
              <th>–ó–∞ —Å—Ç—É–¥–∏—é</th>
              <th>–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞</th>
              <th>–ö–æ–º–∏—Å—Å–∏—è 20%</th>
              <th>–î–∞—Ç–∞</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            </tr>
          </thead>
          <tbody id="commissionsBody">
            <tr><td colspan="7"><div class="empty"><div class="empty-icon">‚è≥</div>–ó–∞–≥—Ä—É–∑–∫–∞...</div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π -->
<div class="modal-overlay" id="subModal">
  <div class="modal">
    <h3 id="subModalTitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π</h3>
    <div style="font-size:0.85rem;color:var(--muted);margin-bottom:16px" id="subModalStudio"></div>
    <div class="form-group">
      <label>–î–µ–π—Å—Ç–≤–∏–µ</label>
      <select id="subAction">
        <option value="trial">‚è∞ –ü—Ä–æ–¥–ª–∏—Ç—å —Ç—Ä–∏–∞–ª +72 —á–∞—Å–∞</option>
        <option value="month">üìÖ –û–ø–ª–∞—Ç–∞ –º–µ—Å—è—Ü (+30 –¥–Ω–µ–π) ‚Äî 4 900 ‚ÇΩ</option>
        <option value="year">üóì –û–ø–ª–∞—Ç–∞ –≥–æ–¥ (+365 –¥–Ω–µ–π) ‚Äî 51 900 ‚ÇΩ</option>
        <option value="custom">‚úèÔ∏è –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Å—Ä–æ–∫</option>
        <option value="block">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</option>
      </select>
    </div>
    <div class="form-group" id="customDaysGroup" style="display:none">
      <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π</label>
      <input type="number" id="customDays" placeholder="30" min="1" max="3650">
    </div>
    <div id="subModalPayment" style="font-size:0.83rem;color:var(--muted);margin-bottom:4px"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('subModal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" id="subSaveBtn" onclick="saveSubscription()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞: –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–∏—é -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <h3>–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–∏—é</h3>
    <div class="form-group">
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—É–¥–∏–∏</label>
      <input type="text" id="newStudioName" placeholder="–°—Ç—É–¥–∏—è –æ–∫–ª–µ–π–∫–∏">
    </div>
    <div class="form-group">
      <label>Email –≤–ª–∞–¥–µ–ª—å—Ü–∞</label>
      <input type="email" id="newStudioEmail" placeholder="owner@studio.ru">
    </div>
    <div class="form-group">
      <label>–¢–∞—Ä–∏—Ñ</label>
      <select id="newStudioTier">
        <option value="trial">–¢—Ä–∏–∞–ª 72—á</option>
        <option value="active_month">–ê–∫—Ç–∏–≤–Ω—ã–π (1 –º–µ—Å—è—Ü)</option>
        <option value="active_year">–ê–∫—Ç–∏–≤–Ω—ã–π (1 –≥–æ–¥)</option>
      </select>
    </div>
    <div id="addError" style="color:var(--danger);font-size:0.82rem;margin-top:8px;display:none"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addModal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" id="addSaveBtn" onclick="saveNewStudio()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>
</div>

<script>
(function() {
'use strict';

const ADMIN_USER_ID   = 'c5db87ec-8e4a-4c48-bad3-5747513224d9';
const SUPABASE_URL    = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window._crmSb = sb;

let allStudios = [];
let activeStudioId = null;

// ‚îÄ‚îÄ Auth + –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkAdminAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'welcome.html'; return false; }
  if (session.user.id !== ADMIN_USER_ID) {
    document.body.innerHTML = '<div style="text-align:center;padding:60px;font-family:sans-serif"><h2>üö´ –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</h2><p style="color:#64748b;margin-top:8px">–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p><a href="dashboard.html" style="color:#2563eb">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</a></div>';
    return false;
  }
  document.getElementById('adminBadge').textContent = 'üëë ' + session.user.email;
  return true;
}

// ‚îÄ‚îÄ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmt(n) {
  return new Intl.NumberFormat('ru-RU').format(n || 0);
}
function fmtDate(d) {
  if (!d) return '‚Äî';
  return new Date(d).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', year: 'numeric' });
}
function subStatus(studio) {
  const tier    = studio.subscription_tier;
  const expires = studio.subscription_expires_at;
  const now     = new Date();
  if (tier === 'active') {
    return (!expires || new Date(expires) > now) ? 'active' : 'expired';
  }
  if (tier === 'trial') {
    return (expires && new Date(expires) > now) ? 'trial' : 'expired';
  }
  return 'expired';
}
function subBadge(studio) {
  if (studio.subscription_tier === 'pending') {
    return '<span class="badge badge-pending">üìã –ó–∞—è–≤–∫–∞</span>';
  }
  const s = subStatus(studio);
  const labels = { active: '‚úÖ –ê–∫—Ç–∏–≤–Ω–∞', trial: '‚è∞ –¢—Ä–∏–∞–ª', expired: '‚ùå –ò—Å—Ç–µ–∫–ª–∞' };
  const cls    = { active: 'badge-active', trial: 'badge-trial', expired: 'badge-expired' };
  return `<span class="badge ${cls[s]}">${labels[s]}</span>`;
}
function expireText(studio) {
  if (!studio.subscription_expires_at) return '‚Äî';
  const d    = new Date(studio.subscription_expires_at);
  const days = Math.ceil((d - new Date()) / 86400000);
  const txt  = fmtDate(studio.subscription_expires_at);
  if (days <= 7 && days > 0) return `<span class="expires-soon">‚ö†Ô∏è ${txt} (${days}–¥)</span>`;
  if (days <= 0) return `<span style="color:var(--danger)">${txt}</span>`;
  return `<span class="expires-text">${txt}</span>`;
}

// ‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


window.openCalcView = async function(calcId) {
  const modal = document.getElementById('calcViewModal');
  const content = document.getElementById('calcViewContent');
  const title = document.getElementById('calcViewTitle');
  
  modal.classList.add('active');
  content.innerHTML = '<div style="text-align:center;padding:40px;color:#94a3b8">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  
  const { data, error } = await sb
    .from('calculations')
    .select('*, studios(name)')
    .eq('id', calcId)
    .single();
  
  if (error || !data) {
    content.innerHTML = '<p style="color:#ef4444">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—á—ë—Ç–∞</p>';
    return;
  }
  
  const cd = data.calculation_data || {};
  const sd = data.services_detail || cd.services_detail || {};
  
  title.textContent = (data.car_name || '–†–∞—Å—á—ë—Ç') + ' ‚Äî ' + (data.studios?.name || '');
  
  const statusMap = { new:'üÜï –ù–æ–≤—ã–π', scheduled:'üìÖ –ó–∞–ø–∏—Å—å', in_progress:'üîß –í —Ä–∞–±–æ—Ç–µ', done:'‚úÖ –ì–æ—Ç–æ–≤–æ', delivered:'üöó –í—ã–¥–∞–Ω–æ' };
  
  // –°–æ–±–∏—Ä–∞–µ–º —É—Å–ª—É–≥–∏ –∏–∑ services_detail
  let servicesRows = '';
  const sectionNames = { arm:'–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ', det:'–î–µ—Ç–µ–π–ª–∏–Ω–≥', gl:'–°—Ç—ë–∫–ª–∞', ms:'–î–æ–ø.—É—Å–ª—É–≥–∏', wrap:'–û–∫–ª–µ–π–∫–∞' };
  Object.entries(sd).forEach(([key, items]) => {
    if (!items || !items.length) return;
    items.forEach(item => {
      const base = (item.mat||0) + (item.mot||0);
      if (base > 0) {
        servicesRows += `<tr>
          <td>${sectionNames[key]||key}</td>
          <td>${item.name||'‚Äî'}</td>
          <td>${fmt(item.mat||0)} ‚ÇΩ</td>
          <td>${fmt(item.mot||0)} ‚ÇΩ</td>
          <td style="font-weight:700">${fmt(base)} ‚ÇΩ</td>
        </tr>`;
      }
    });
  });
  
  // –ü–∞–∫–µ—Ç –∏ —É–¥–∞—Ä–Ω–∞—è —á–∞—Å—Ç—å
  if (cd.package) {
    const pkgBase = [cd.package.wrapMat, cd.package.wrapMot, cd.package.prepMat, cd.package.prepMot, cd.package.armMat, cd.package.armMot]
      .reduce((a,v) => a + (parseFloat(v)||0), 0);
    if (pkgBase > 0) servicesRows = `<tr><td>–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞</td><td>–ü–∞–∫–µ—Ç –≤–∫—Ä—É–≥</td><td colspan="2">‚Äî</td><td style="font-weight:700">${fmt(pkgBase)} ‚ÇΩ</td></tr>` + servicesRows;
  }
  if (cd.impact) {
    const impBase = [cd.impact.wrapMat, cd.impact.wrapMot, cd.impact.prepMat, cd.impact.prepMot, cd.impact.armMat, cd.impact.armMot]
      .reduce((a,v) => a + (parseFloat(v)||0), 0);
    if (impBase > 0) servicesRows = `<tr><td>–£–¥–∞—Ä–Ω–∞—è —á–∞—Å—Ç—å</td><td>–ó–∞—â–∏—Ç–∞</td><td colspan="2">‚Äî</td><td style="font-weight:700">${fmt(impBase)} ‚ÇΩ</td></tr>` + servicesRows;
  }
  
  content.innerHTML = \`
    <div class="calc-detail-grid">
      <div class="calc-detail-item">
        <div class="calc-detail-label">–ê–≤—Ç–æ–º–æ–±–∏–ª—å</div>
        <div class="calc-detail-value">\${data.car_name || '‚Äî'}</div>
      </div>
      <div class="calc-detail-item">
        <div class="calc-detail-label">–°—Ç–∞—Ç—É—Å</div>
        <div class="calc-detail-value">\${statusMap[data.status] || data.status || '‚Äî'}</div>
      </div>
      <div class="calc-detail-item">
        <div class="calc-detail-label">–°—Ç—É–¥–∏—è</div>
        <div class="calc-detail-value">\${data.studios?.name || '‚Äî'}</div>
      </div>
      <div class="calc-detail-item">
        <div class="calc-detail-label">–î–∞—Ç–∞</div>
        <div class="calc-detail-value">\${new Date(data.created_at).toLocaleDateString('ru')}</div>
      </div>
      <div class="calc-detail-item">
        <div class="calc-detail-label">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
        <div class="calc-detail-value">\${fmt(data.total_price||0)} ‚ÇΩ</div>
      </div>
      <div class="calc-detail-item">
        <div class="calc-detail-label">–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞</div>
        <div class="calc-detail-value accent">\${fmt(data.final_price||data.total_price||0)} ‚ÇΩ</div>
      </div>
    </div>
    \${servicesRows ? \`
    <div class="calc-services-list">
      <table>
        <thead><tr><th>–ë–ª–æ–∫</th><th>–£—Å–ª—É–≥–∞</th><th>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</th><th>–ú–æ—Ç–∏–≤–∞—Ü–∏—è</th><th>–ò—Ç–æ–≥–æ</th></tr></thead>
        <tbody>\${servicesRows}</tbody>
      </table>
    </div>\` : '<p style="color:#94a3b8;font-size:0.9rem">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —É—Å–ª—É–≥ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (—Ä–∞—Å—á—ë—Ç —Å–æ–∑–¥–∞–Ω –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)</p>'}
    <div style="display:flex;justify-content:flex-end;margin-top:8px">
      <button onclick="document.getElementById('calcViewModal').classList.remove('active')" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  \`;
};

// ‚îÄ‚îÄ –†–∞—Å—á—ë—Ç—ã –≤—Å–µ—Ö —Å—Ç—É–¥–∏–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let allCalcs = [];

async function loadCalcs() {
  const tbody = document.getElementById('calcsBody');
  if (tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#94a3b8">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

  const { data, error } = await sb
    .from('calculations')
    .select('id, car_name, total_price, final_price, status, created_at, studio_id, studios(name)')
    .order('created_at', { ascending: false })
    .limit(500);

  if (error) { console.error('loadCalcs error:', error); return; }
  allCalcs = data || [];

  // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä —Å—Ç—É–¥–∏–π
  const filter = document.getElementById('calcsStudioFilter');
  if (filter) {
    const studios = [...new Map(allCalcs.map(c => [c.studio_id, c.studios?.name || c.studio_id])).entries()];
    studios.forEach(([id, name]) => {
      const o = document.createElement('option');
      o.value = id; o.textContent = name;
      filter.appendChild(o);
    });
    filter.addEventListener('change', renderCalcs);
  }
  const search = document.getElementById('calcsSearch');
  if (search) search.addEventListener('input', renderCalcs);

  renderCalcs();
}

function renderCalcs() {
  const studioFilter = document.getElementById('calcsStudioFilter')?.value || '';
  const searchVal = (document.getElementById('calcsSearch')?.value || '').toLowerCase();

  let filtered = allCalcs.filter(c => {
    if (studioFilter && c.studio_id !== studioFilter) return false;
    if (searchVal && !(c.car_name || '').toLowerCase().includes(searchVal)) return false;
    return true;
  });

  const total = filtered.length;
  const sum = filtered.reduce((a, c) => a + (c.final_price || c.total_price || 0), 0);
  const avg = total > 0 ? sum / total : 0;

  document.getElementById('calcsStatTotal').textContent = total;
  document.getElementById('calcsStatSum').textContent = fmt(sum) + ' ‚ÇΩ';
  document.getElementById('calcsStatAvg').textContent = fmt(avg) + ' ‚ÇΩ';
  document.getElementById('calcsCount').textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ: ${total}`;

  const statusLabel = { new:'üÜï –ù–æ–≤—ã–π', scheduled:'üìÖ –ó–∞–ø–∏—Å—å', in_progress:'üîß –í —Ä–∞–±–æ—Ç–µ', done:'‚úÖ –ì–æ—Ç–æ–≤–æ', delivered:'üöó –í—ã–¥–∞–Ω–æ', draft:'üìù –ß–µ—Ä–Ω–æ–≤–∏–∫' };

  const tbody = document.getElementById('calcsBody');
  if (!tbody) return;
  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#94a3b8">–†–∞—Å—á—ë—Ç–æ–≤ –Ω–µ—Ç</td></tr>';
    return;
  }
  tbody.innerHTML = filtered.map(c => `
    <tr>
      <td><strong>${c.studios?.name || '‚Äî'}</strong></td>
      <td>${c.car_name || '‚Äî'}</td>
      <td style="color:#475569">${fmt(c.total_price || 0)} ‚ÇΩ</td>
      <td style="color:#7c3aed;font-weight:700">${fmt(c.final_price || c.total_price || 0)} ‚ÇΩ</td>
      <td><span style="font-size:0.8rem">${statusLabel[c.status] || c.status || '‚Äî'}</span></td>
      <td style="color:#94a3b8;font-size:0.8rem">${new Date(c.created_at).toLocaleDateString('ru')}</td>
      <td><button class="btn btn-sm" style="white-space:nowrap" onclick="openCalcView('${c.id}')">üîç –û—Ç–∫—Ä—ã—Ç—å</button></td>
    </tr>
  `).join('');
}

async function loadAll() {
  await Promise.all([loadStudios(), loadCommissions()]);
  await loadRequests(); // –ø–æ—Å–ª–µ loadStudios —Ç.–∫. –∏—Å–ø–æ–ª—å–∑—É–µ—Ç allStudios
}


async function loadRequests() {
  // –ë–µ—Ä—ë–º –∑–∞—è–≤–∫–∏ –∏–∑ –¥–≤—É—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: access_requests + pending —Å—Ç—É–¥–∏–∏
  let accessReqs = [], pendingStudios = [];
  try {
    const [r1, r2] = await Promise.all([
      sb.from('access_requests').select('*').order('created_at', { ascending: false }),
      sb.from('studios').select('*').eq('subscription_tier', 'pending').order('created_at', { ascending: false })
    ]);
    accessReqs = r1.data || [];
    pendingStudios = r2.data || [];
  } catch(e) {
    console.error('loadRequests error:', e);
    // access_requests –º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ pending —Å—Ç—É–¥–∏–∏
    try {
      const { data } = await sb.from('studios').select('*').eq('subscription_tier', 'pending').order('created_at', { ascending: false });
      pendingStudios = data || [];
    } catch(e2) { console.error(e2); }
  }

  const reqs = accessReqs;
  const pending = pendingStudios;

  // –ë–µ–π–¥–∂
  const totalNew = reqs.filter(r => r.status === 'new').length + pending.length;
  const badge = document.getElementById('badgeRequests');
  if (badge) badge.textContent = totalNew > 0 ? `(${totalNew})` : '';

  const tbody = document.getElementById('requestsBody');
  if (!tbody) return;

  if (!reqs.length && !pending.length) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#94a3b8">–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</td></tr>';
    return;
  }

  // –†–µ–Ω–¥–µ—Ä–∏–º pending —Å—Ç—É–¥–∏–∏
  const pendingRows = pending.map(s => `
    <tr style="background:rgba(245,158,11,0.05)">
      <td><strong>${s.name || '‚Äî'}</strong><br><small style="color:#94a3b8">ID: ${s.id.substring(0,8)}...</small></td>
      <td>${s.settings?.city || '‚Äî'}<br><small>${s.settings?.phone || '‚Äî'}</small></td>
      <td>${s.settings?.contact_email || '‚Äî'}</td>
      <td>${new Date(s.created_at).toLocaleDateString('ru')}</td>
      <td style="display:flex;gap:6px">
        <button class="btn btn-success btn-sm" onclick="approveStudio('${s.id}','${s.name || s.id}')">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
        <button class="btn btn-sm" style="background:#ef4444;color:#fff" onclick="blockStudio('${s.id}','${s.name}')">‚ùå</button>
      </td>
    </tr>
  `).join('');

  // –†–µ–Ω–¥–µ—Ä–∏–º access_requests
  const reqRows = reqs.map(r => `
    <tr>
      <td><strong>${r.studio_name || '‚Äî'}</strong></td>
      <td>${r.city || '‚Äî'}<br><small>${r.phone || '‚Äî'}</small></td>
      <td>${r.email || '‚Äî'}</td>
      <td>${new Date(r.created_at).toLocaleDateString('ru')}</td>
      <td>
        ${r.status === 'new' ? `
          <button class="btn btn-success btn-sm" onclick="approveRequest('${r.id}','${(r.studio_name||'').replace(/'/g,'')}',' ${r.email}')">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
          <button class="btn btn-sm" style="background:#ef4444;color:#fff" onclick="rejectRequest('${r.id}')">‚ùå</button>
        ` : `<span style="color:#64748b;font-size:0.8rem">${r.status === 'approved' ? '‚úÖ –û–¥–æ–±—Ä–µ–Ω–∞' : '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∞'}</span>`}
      </td>
    </tr>
  `).join('');

  tbody.innerHTML = pendingRows + reqRows;
}

window.approveRequest = async function(id, studioName, email) {
  if (!confirm('–û–¥–æ–±—Ä–∏—Ç—å –∑–∞—è–≤–∫—É –æ—Ç ' + studioName + '?')) return;
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏
  await sb.from('access_requests').update({ status: 'approved' }).eq('id', id);
  // –ï—Å–ª–∏ –µ—Å—Ç—å supabase_user ‚Äî —Å–æ–∑–¥–∞—ë–º —Å—Ç—É–¥–∏—é
  const { data: req } = await sb.from('access_requests').select('*').eq('id', id).single();
  if (req?.supabase_user_id) {
    const refCode = Math.random().toString(36).substring(2,10).toUpperCase();
    const trialEnds = new Date(Date.now() + 72 * 3600 * 1000).toISOString();
    const { data: studio } = await sb.from('studios').insert({
      name: req.studio_name,
      owner_id: req.supabase_user_id,
      subscription_tier: 'trial',
      subscription_expires_at: trialEnds,
      referral_code: refCode,
      settings: { phone: req.phone, city: req.city, contact_email: req.email }
    }).select('id').single();
    if (studio) {
      await sb.from('studio_members').insert({
        studio_id: studio.id, user_id: req.supabase_user_id, role: 'owner', is_active: true
      });
    }
  }
  alert('‚úÖ –ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞! –°—Ç—É–¥–∏—è —Å–æ–∑–¥–∞–Ω–∞, —Ç—Ä–∏–∞–ª 72 —á–∞—Å–∞.');
  loadRequests();
  loadStudios();
};

window.rejectRequest = async function(id) {
  if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É?')) return;
  await sb.from('access_requests').update({ status: 'rejected' }).eq('id', id);
  loadRequests();
};

async function loadStudios() {
  const { data, error } = await sb
    .from('studios')
    .select('id, name, owner_id, subscription_tier, subscription_expires_at, referral_code, referred_by_studio_id, created_at, settings')
    .order('created_at', { ascending: false });

  if (error) { console.error(error); return; }
  allStudios = data || [];

  // –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç—ã
  let active = 0, trial = 0, expired = 0;
  allStudios.forEach(s => {
    const st = subStatus(s);
    if (st === 'active') active++;
    else if (st === 'trial') trial++;
    else expired++;
  });

  document.getElementById('sTotal').textContent   = allStudios.length;
  const pending = allStudios.filter(s => s.subscription_tier === 'pending').length;
  if (pending > 0) {
    document.getElementById('sTotal').textContent = allStudios.length + ' (' + pending + ' üìã)';
  }
  document.getElementById('sActive').textContent  = active;
  document.getElementById('sTrial').textContent   = trial;
  document.getElementById('sExpired').textContent = expired;

  renderStudios();
  renderTrialStudios();
  renderReferrals();
}

async function loadCommissions() {
  const { data, error } = await sb
    .from('referral_commissions')
    .select('*, referrer:referrer_studio_id(name), referred:referred_studio_id(name)')
    .order('created_at', { ascending: false });

  if (error) { console.error(error); return; }
  const comms = data || [];

  const pending = comms.filter(c => !c.paid_to_referrer).reduce((s, c) => s + Number(c.amount), 0);
  document.getElementById('sCommission').textContent = fmt(pending);

  renderCommissions(comms);
}

// ‚îÄ‚îÄ –†–µ–Ω–¥–µ—Ä —Å—Ç—É–¥–∏–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTrialStudios() {
  const trial = allStudios.filter(s => s.subscription_tier === 'trial');
  // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂
  const badge = document.getElementById('badgeTrial');
  if (badge) badge.textContent = trial.length > 0 ? `(${trial.length})` : '';
  
  const tbody = document.getElementById('trialBody');
  if (!tbody) return;
  if (!trial.length) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#94a3b8">–ù–µ—Ç —Å—Ç—É–¥–∏–π –Ω–∞ —Ç–µ—Å—Ç–µ</td></tr>';
    return;
  }
  tbody.innerHTML = trial.map(s => {
    const exp = s.subscription_expires_at ? new Date(s.subscription_expires_at) : null;
    const now = new Date();
    const hoursLeft = exp ? Math.round((exp - now) / 3600000) : null;
    const expText = exp 
      ? (hoursLeft > 0 
          ? `<span style="color:${hoursLeft < 12 ? '#ef4444' : '#f59e0b'}">‚è∞ ${hoursLeft}—á –æ—Å—Ç–∞–ª–æ—Å—å</span>`
          : `<span style="color:#ef4444">‚ö†Ô∏è –ò—Å—Ç—ë–∫</span>`)
      : '‚Äî';
    const owner = s.owner_id ? s.owner_id.substring(0,8)+'...' : '–Ω–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞';
    return `<tr>
      <td><strong>${s.name || '‚Äî'}</strong><br><small style="color:#94a3b8">${s.settings?.phone || ''} ${s.settings?.city || ''}</small></td>
      <td style="font-size:0.8rem">${s.settings?.contact_email || owner}</td>
      <td><span class="ref-code">${s.referral_code || '‚Äî'}</span></td>
      <td>${expText}</td>
      <td style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-success btn-sm" onclick="extendTrial('${s.id}','${s.name}')">+72—á</button>
        <button class="btn btn-sm" style="background:#7c3aed;color:#fff" onclick="openSubModal('${s.id}')">üí≥ –ü–æ–¥–ø–∏—Å–∫–∞</button>
        <button class="btn btn-sm" style="background:#ef4444;color:#fff" onclick="blockStudio('${s.id}','${s.name}')">üö´</button>
      </td>
    </tr>`;
  }).join('');
}

window.extendTrial = async function(studioId, name) {
  const trialEnds = new Date(Date.now() + 72 * 3600 * 1000).toISOString();
  const { error } = await sb.from('studios').update({
    subscription_expires_at: trialEnds
  }).eq('id', studioId);
  if (error) { alert('‚ùå ' + error.message); return; }
  alert('‚úÖ –¢—Ä–∏–∞–ª –ø—Ä–æ–¥–ª—ë–Ω –Ω–∞ 72 —á–∞—Å–∞');
  await loadStudios();
};

function renderStudios() {
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ active/expired/blocked
  const visibleStudios = allStudios.filter(s => !['pending','trial'].includes(s.subscription_tier));
  const tbody = document.getElementById('studiosBody');

  if (!allStudios.length) {
    tbody.innerHTML = '<tr><td colspan="5"><div class="empty"><div class="empty-icon">üè¢</div>–ù–µ—Ç —Å—Ç—É–¥–∏–π</div></td></tr>';
    return;
  }

  // –ü–æ–ª—É—á–∞–µ–º email –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ —á–µ—Ä–µ–∑ studio_members
  tbody.innerHTML = allStudios.map(s => `
    <tr>
      <td>
        <div class="studio-name">${s.name}</div>
        <div class="studio-email" id="email-${s.id}">–∑–∞–≥—Ä—É–∑–∫–∞...</div>
        ${s.settings?.phone ? `<div style="font-size:0.75rem;color:#2563eb;margin-top:1px">${s.settings.phone}</div>` : `<div style="font-size:0.75rem;color:#94a3b8;margin-top:1px" id="phone-${s.id}"></div>`}
        ${s.settings?.city ? `<div style="font-size:0.75rem;color:#64748b">${s.settings.city}</div>` : ''}
      </td>
      <td>
        ${s.referral_code
          ? `<span class="ref-code">${s.referral_code}</span>`
          : `<button class="btn btn-ghost" style="font-size:0.72rem" onclick="genRefCode('${s.id}')">–°–æ–∑–¥–∞—Ç—å</button>`
        }
      </td>
      <td>${subBadge(s)}</td>
      <td>${expireText(s)}</td>
      <td>
        <div class="actions">
          <!-- pending —Å—Ç—É–¥–∏–∏ –≤ —Ç–∞–±–µ –ó–∞—è–≤–∫–∏ -->
          <button class="btn btn-primary" onclick="openSubModal('${s.id}')">‚öôÔ∏è –ü–æ–¥–ø–∏—Å–∫–∞</button>
          <button class="btn btn-danger" onclick="blockStudio('${s.id}', '${s.name}')">üö´</button>
        </div>
      </td>
    </tr>
  `).join('');

  // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º email –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—É–¥–∏–∏
  allStudios.forEach(async s => {
    const { data } = await sb
      .from('studio_members')
      .select('user_id, role')
      .eq('studio_id', s.id)
      .eq('role', 'owner')
      .single();

    const el = document.getElementById(`email-${s.id}`);
    if (!el) return;

    if (data) {
      const { data: userData } = await sb.auth.admin?.getUserById(data.user_id).catch(() => ({ data: null })) || { data: null };
      // Fallback ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º user_id —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ
      el.textContent = data.user_id.slice(0, 8) + '...';
    // –¢–µ–ª–µ—Ñ–æ–Ω –∏–∑ settings
    const phone = s.settings?.phone;
    if (phone) {
      const phoneEl = document.getElementById('phone-' + s.id);
      if (phoneEl) phoneEl.textContent = phone;
    }
    } else {
      el.textContent = '–Ω–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞';
    }
  });
}

// ‚îÄ‚îÄ –†–µ–Ω–¥–µ—Ä —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderReferrals() {
  const tbody = document.getElementById('referralsBody');
  const referred = allStudios.filter(s => s.referred_by_studio_id);

  if (!referred.length) {
    tbody.innerHTML = '<tr><td colspan="5"><div class="empty"><div class="empty-icon">üîó</div>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div></td></tr>';
    return;
  }

  tbody.innerHTML = referred.map(s => {
    const referrer = allStudios.find(r => r.id === s.referred_by_studio_id);
    return `
      <tr>
        <td><div class="studio-name">${referrer ? referrer.name : '‚Äî'}</div></td>
        <td><div class="studio-name">${s.name}</div></td>
        <td>${referrer ? `<span class="ref-code">${referrer.referral_code || '‚Äî'}</span>` : '‚Äî'}</td>
        <td>${fmtDate(s.created_at)}</td>
        <td>${subBadge(s)}</td>
      </tr>
    `;
  }).join('');
}

// ‚îÄ‚îÄ –†–µ–Ω–¥–µ—Ä –∫–æ–º–∏—Å—Å–∏–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCommissions(comms) {
  const tbody = document.getElementById('commissionsBody');

  if (!comms.length) {
    tbody.innerHTML = '<tr><td colspan="7"><div class="empty"><div class="empty-icon">üí∞</div>–ö–æ–º–∏—Å—Å–∏–π –Ω–µ—Ç</div></td></tr>';
    return;
  }

  tbody.innerHTML = comms.map(c => `
    <tr>
      <td><div class="studio-name">${c.referrer?.name || '‚Äî'}</div></td>
      <td><div class="studio-name">${c.referred?.name || '‚Äî'}</div></td>
      <td>${fmt(c.payment_amount)} ‚ÇΩ</td>
      <td><strong>${fmt(c.amount)} ‚ÇΩ</strong></td>
      <td>${fmtDate(c.payment_date)}</td>
      <td>
        ${c.paid_to_referrer
          ? `<span class="badge badge-paid">‚úÖ –í—ã–ø–ª–∞—á–µ–Ω–æ ${fmtDate(c.paid_date)}</span>`
          : `<span class="badge badge-pending">‚è≥ –û–∂–∏–¥–∞–µ—Ç</span>`
        }
      </td>
      <td>
        ${!c.paid_to_referrer
          ? `<button class="btn btn-success" onclick="markCommissionPaid('${c.id}')">–í—ã–ø–ª–∞—Ç–∏—Ç—å</button>`
          : '‚Äî'
        }
      </td>
    </tr>
  `).join('');
}

// ‚îÄ‚îÄ –¢–∞–±—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.switchTab = function(tab) {
  ['requests', 'trial', 'studios', 'referrals', 'commissions', 'calcs'].forEach(t => {
    const el = document.getElementById('tab-' + t);
    if (el) el.style.display = t === tab ? 'block' : 'none';
  });
  document.querySelectorAll('.tab-btn').forEach(btn => {
    const onclick = btn.getAttribute('onclick') || '';
    btn.classList.toggle('active', onclick.includes("'" + tab + "'"));
  });
  if (tab === 'calcs' && !window._calcsLoaded) {
    window._calcsLoaded = true;
    loadCalcs();
  }
};

// ‚îÄ‚îÄ –ü–æ–¥–ø–∏—Å–∫–∞: –º–æ–¥–∞–ª–∫–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openSubModal = function(studioId) {
  activeStudioId = studioId;
  const studio = allStudios.find(s => s.id === studioId);
  document.getElementById('subModalTitle').textContent = '–ü–æ–¥–ø–∏—Å–∫–∞: ' + studio.name;
  document.getElementById('subModalStudio').textContent =
    '–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: ' + subStatus(studio).toUpperCase() + ' ¬∑ ' + expireText(studio).replace(/<[^>]+>/g, '');
  document.getElementById('subAction').value = 'month';
  updatePaymentHint();
  document.getElementById('subModal').classList.add('active');
};

document.getElementById('subAction').addEventListener('change', updatePaymentHint);

function updatePaymentHint() {
  const action = document.getElementById('subAction').value;
  const hint   = document.getElementById('subModalPayment');
  const customGroup = document.getElementById('customDaysGroup');
  customGroup.style.display = action === 'custom' ? 'block' : 'none';
  const hints = {
    trial: '72 —á–∞—Å–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞',
    month: '–û–ø–ª–∞—Ç–∞ 4 900 ‚ÇΩ ‚Äî —Å–æ–∑–¥–∞—Å—Ç –∑–∞–ø–∏—Å—å –∫–æ–º–∏—Å—Å–∏–∏ –¥–ª—è —Ä–µ—Ñ–µ—Ä—Ä–µ—Ä–∞',
    year:  '–û–ø–ª–∞—Ç–∞ 51 900 ‚ÇΩ ‚Äî —Å–æ–∑–¥–∞—Å—Ç –∑–∞–ø–∏—Å—å –∫–æ–º–∏—Å—Å–∏–∏ –¥–ª—è —Ä–µ—Ñ–µ—Ä—Ä–µ—Ä–∞',
    custom: '–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Å—Ä–æ–∫ –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–∏',
    block: '–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø –∫ CRM',
  };
  hint.textContent = hints[action] || '';
}

window.saveSubscription = async function() {
  const action = document.getElementById('subAction').value;
  const btn    = document.getElementById('subSaveBtn');
  btn.disabled = true; btn.textContent = '–°–æ—Ö—Ä–∞–Ω—è–µ–º...';

  try {
    const studio = allStudios.find(s => s.id === activeStudioId);
    const now    = new Date();
    // –ë–µ—Ä—ë–º –º–∞–∫—Å–∏–º—É–º –∏–∑ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –∏—Å—Ç–µ—á–µ–Ω–∏—è –∏ —Å–µ–π—á–∞—Å (—á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –æ—Å—Ç–∞—Ç–æ–∫)
    const base   = studio.subscription_expires_at && new Date(studio.subscription_expires_at) > now
      ? new Date(studio.subscription_expires_at)
      : now;

    let tier, expires, paymentAmount = 0;

    if (action === 'trial') {
      tier    = 'trial';
      expires = new Date(now.getTime() + 72 * 3600 * 1000).toISOString();
    } else if (action === 'month') {
      tier    = 'active';
      expires = new Date(base.getTime() + 30 * 86400000).toISOString();
      paymentAmount = 4900;
    } else if (action === 'year') {
      tier    = 'active';
      expires = new Date(base.getTime() + 365 * 86400000).toISOString();
      paymentAmount = 51900;
    } else if (action === 'custom') {
      const days = parseInt(document.getElementById('customDays').value);
      if (!days || days < 1) { alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π'); btn.disabled = false; btn.textContent = '–ü—Ä–∏–º–µ–Ω–∏—Ç—å'; return; }
      tier    = 'active';
      expires = new Date(base.getTime() + days * 86400000).toISOString();
    } else if (action === 'block') {
      if (!confirm(`–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—É–¥–∏—é "${studio.name}"?`)) { btn.disabled = false; btn.textContent = '–ü—Ä–∏–º–µ–Ω–∏—Ç—å'; return; }
      tier    = 'expired';
      expires = now.toISOString();
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
    const { error } = await sb
      .from('studios')
      .update({ subscription_tier: tier, subscription_expires_at: expires })
      .eq('id', activeStudioId);

    if (error) throw error;

    // –°–æ–∑–¥–∞—ë–º –∫–æ–º–∏—Å—Å–∏—é –µ—Å–ª–∏ —Ä–µ—Ñ–µ—Ä—Ä–µ—Ä –µ—Å—Ç—å –∏ —ç—Ç–æ –æ–ø–ª–∞—Ç–∞
    if (paymentAmount > 0 && studio.referred_by_studio_id) {
      await sb.from('referral_commissions').insert({
        referrer_studio_id: studio.referred_by_studio_id,
        referred_studio_id: activeStudioId,
        amount: Math.round(paymentAmount * 0.2),
        payment_amount: paymentAmount,
        payment_date: new Date().toISOString().split('T')[0],
        paid_to_referrer: false
      });
    }

    closeModal('subModal');
    await loadAll();
  } catch (e) {
    alert('–û—à–∏–±–∫–∞: ' + e.message);
  } finally {
    btn.disabled = false; btn.textContent = '–ü—Ä–∏–º–µ–Ω–∏—Ç—å';
  }
};

// ‚îÄ‚îÄ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.approveStudio = async function(studioId, name) {
  if (!confirm(`–û–¥–æ–±—Ä–∏—Ç—å –∑–∞—è–≤–∫—É —Å—Ç—É–¥–∏–∏ "${name}" –∏ –¥–∞—Ç—å –ø—Ä–æ–±–Ω—ã–π –¥–æ—Å—Ç—É–ø –Ω–∞ 72 —á–∞—Å–∞?`)) return;
  const trialEnds = new Date(Date.now() + 72 * 3600 * 1000).toISOString();
  
  const { data, error } = await sb.from('studios')
    .update({ subscription_tier: 'trial', subscription_expires_at: trialEnds })
    .eq('id', studioId)
    .select('id, subscription_tier, subscription_expires_at');
  
  if (error) {
    alert('‚ùå –û—à–∏–±–∫–∞ RLS/DB: ' + error.message + '\n–ö–æ–¥: ' + error.code + '\n\n–í—ã–ø–æ–ª–Ω–∏ –≤ SQL Editor:\nUPDATE studios SET subscription_tier=\'trial\', subscription_expires_at=\'' + trialEnds + '\' WHERE id=\'' + studioId + '\';');
    console.error('approveStudio error:', error);
    return;
  }
  
  if (!data || data.length === 0) {
    alert('‚ö†Ô∏è RLS –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–Ω–µ—Ç –æ—à–∏–±–∫–∏ –Ω–æ –∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –≤–µ—Ä–Ω—É–ª–∏—Å—å).\n\n–í—ã–ø–æ–ª–Ω–∏ –≤—Ä—É—á–Ω—É—é –≤ SQL Editor:\nUPDATE studios SET subscription_tier=\'trial\', subscription_expires_at=\'' + trialEnds + '\' WHERE id=\'' + studioId + '\';');
    return;
  }
  
  alert(`‚úÖ –°—Ç—É–¥–∏—è "${name}" –æ–¥–æ–±—Ä–µ–Ω–∞!\n–¢—Ä–∏–∞–ª –¥–æ: ${new Date(trialEnds).toLocaleString('ru')}`);
  await loadStudios();
  switchTab('trial');
};

window.blockStudio = async function(studioId, name) {
  if (!confirm(`–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—É–¥–∏—é "${name}"?\n–î–æ—Å—Ç—É–ø –±—É–¥–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞–∫—Ä—ã—Ç.`)) return;
  await sb.from('studios').update({
    subscription_tier: 'expired',
    subscription_expires_at: new Date().toISOString()
  }).eq('id', studioId);
  await loadStudios();
};

// ‚îÄ‚îÄ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ñ. –∫–æ–¥–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.genRefCode = async function(studioId) {
  const code = Math.random().toString(36).substring(2, 10).toUpperCase();
  await sb.from('studios').update({ referral_code: code }).eq('id', studioId);
  await loadStudios();
};

// ‚îÄ‚îÄ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–∏—é ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openAddModal = function() {
  document.getElementById('newStudioName').value = '';
  document.getElementById('newStudioEmail').value = '';
  document.getElementById('newStudioTier').value = 'trial';
  document.getElementById('addError').style.display = 'none';
  document.getElementById('addModal').classList.add('active');
};

window.saveNewStudio = async function() {
  const name  = document.getElementById('newStudioName').value.trim();
  const email = document.getElementById('newStudioEmail').value.trim();
  const tier  = document.getElementById('newStudioTier').value;
  const btn   = document.getElementById('addSaveBtn');
  const errEl = document.getElementById('addError');

  if (!name || !email) { errEl.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'; errEl.style.display = 'block'; return; }

  btn.disabled = true; btn.textContent = '–°–æ–∑–¥–∞—ë–º...';
  errEl.style.display = 'none';

  try {
    const now = new Date();
    let expiresAt, subTier;

    if (tier === 'trial') {
      subTier   = 'trial';
      expiresAt = new Date(now.getTime() + 72 * 3600 * 1000).toISOString();
    } else if (tier === 'active_month') {
      subTier   = 'active';
      expiresAt = new Date(now.getTime() + 30 * 86400000).toISOString();
    } else {
      subTier   = 'active';
      expiresAt = new Date(now.getTime() + 365 * 86400000).toISOString();
    }

    const refCode = Math.random().toString(36).substring(2, 10).toUpperCase();

    // –°–æ–∑–¥–∞—ë–º —Å—Ç—É–¥–∏—é (–±–µ–∑ –≤–ª–∞–¥–µ–ª—å—Ü–∞ ‚Äî –æ–Ω–∏ —Å–∞–º–∏ –∑–∞—Ä–µ–≥–∞—é—Ç—Å—è)
    const { data: studio, error: studioErr } = await sb
      .from('studios')
      .insert({
        name,
        subscription_tier: subTier,
        subscription_expires_at: expiresAt,
        referral_code: refCode,
        settings: { contact_email: email }
      })
      .select('id')
      .single();

    if (studioErr) throw studioErr;

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
    const inviteLink = `${window.location.origin}/welcome.html?studio=${studio.id}`;
    alert(`‚úÖ –°—Ç—É–¥–∏—è "${name}" —Å–æ–∑–¥–∞–Ω–∞!\n\n–û—Ç–ø—Ä–∞–≤—å –∫–ª–∏–µ–Ω—Ç—É —Å—Å—ã–ª–∫—É –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:\n${inviteLink}\n\n–õ–∏–±–æ –æ–Ω–∏ –º–æ–≥—É—Ç –∑–∞—Ä–µ–≥–∞—Ç—å—Å—è —Å–∞–º–∏ ‚Äî –ø–æ—Ç–æ–º –ø—Ä–∏–≤—è–∂–∏ –∏—Ö –≤—Ä—É—á–Ω—É—é.`);

    closeModal('addModal');
    await loadStudios();
  } catch (e) {
    errEl.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
    errEl.style.display = 'block';
  } finally {
    btn.disabled = false; btn.textContent = '–°–æ–∑–¥–∞—Ç—å';
  }
};

// ‚îÄ‚îÄ –ö–æ–º–∏—Å—Å–∏–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.markCommissionPaid = async function(id) {
  await sb.from('referral_commissions').update({
    paid_to_referrer: true,
    paid_date: new Date().toISOString().split('T')[0]
  }).eq('id', id);
  await loadCommissions();
};

window.markAllPaid = async function() {
  if (!confirm('–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∫–æ–º–∏—Å—Å–∏–∏ –∫–∞–∫ –≤—ã–ø–ª–∞—á–µ–Ω–Ω—ã–µ?')) return;
  await sb.from('referral_commissions').update({
    paid_to_referrer: true,
    paid_date: new Date().toISOString().split('T')[0]
  }).eq('paid_to_referrer', false);
  await loadCommissions();
};

// ‚îÄ‚îÄ –£—Ç–∏–ª–∏—Ç—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.closeModal = function(id) {
  document.getElementById(id).classList.remove('active');
};
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
});

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  initNav({ hideAction: true });
  const ok = await checkAdminAuth();
  if (!ok) return;
  await loadAll();
  switchTab('studios'); // –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ç–∞–± –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
}

init();
})();
</script>
<script src="footer.js"></script>

<!-- –ú–æ–¥–∞–ª –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–∞—Å—á—ë—Ç–∞ -->
<div id="calcViewModal">
  <div class="modal-box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h2 id="calcViewTitle">–†–∞—Å—á—ë—Ç</h2>
      <button onclick="document.getElementById('calcViewModal').classList.remove('active')" 
              style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#94a3b8;line-height:1">√ó</button>
    </div>
    <div id="calcViewContent">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>
</div>
</body>
</html>
