<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keep1R CRM â€” ĞĞ´Ğ¼Ğ¸Ğ½</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="nav.css">
<script src="nav.js"></script>
<style>
:root {
  --bg: #f0f4fb;
  --card: #ffffff;
  --border: rgba(15,23,42,0.09);
  --text: #0f172a;
  --muted: #64748b;
  --primary: #2563eb;
  --success: #059669;
  --warning: #d97706;
  --danger: #dc2626;
  --purple: #7c3aed;
  --radius: 12px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: inherit; }

.page { max-width: 1100px; margin: 0 auto; padding: 28px 20px; }

/* â”€â”€ Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ â”€â”€ */
.page-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 12px;
}
.page-title {
  font-size: 1.4rem;
  font-weight: 800;
  letter-spacing: -0.3px;
}
.page-title span { color: var(--primary); }

/* â”€â”€ Ğ¢Ğ°Ğ±Ñ‹ â”€â”€ */
.tabs {
  display: flex;
  gap: 4px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 4px;
  margin-bottom: 24px;
  width: fit-content;
}
.tab-btn {
  padding: 7px 18px;
  border-radius: 7px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  border: none;
  background: transparent;
  color: var(--muted);
  font-family: inherit;
  transition: all 0.15s;
  white-space: nowrap;
}
.tab-btn.active {
  background: var(--primary);
  color: #fff;
}

/* â”€â”€ ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° â”€â”€ */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 20px;
  box-shadow: 0 1px 6px rgba(0,0,0,0.05);
}
.card-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
  gap: 10px;
}
.card-head h2 { font-size: 0.95rem; font-weight: 700; }

/* â”€â”€ Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° â”€â”€ */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
thead th {
  background: #f8faff;
  padding: 10px 16px;
  text-align: left;
  font-size: 0.75rem;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
tbody td {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
}
tbody tr:last-child td { border-bottom: none; }
tbody tr:hover { background: #f8faff; }

.studio-name { font-weight: 700; font-size: 0.88rem; }
.studio-email { font-size: 0.78rem; color: var(--muted); margin-top: 2px; }

/* â”€â”€ Ğ‘ĞµĞ¹Ğ´Ğ¶Ğ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ â”€â”€ */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 700;
  white-space: nowrap;
}
.badge-active  { background: rgba(5,150,105,0.1);  color: var(--success); }
.badge-trial   { background: rgba(37,99,235,0.1);   color: var(--primary); }
.badge-expired { background: rgba(220,38,38,0.1);   color: var(--danger);  }
.badge-ref     { background: rgba(124,58,237,0.1);  color: var(--purple);  }
.badge-pending { background: rgba(217,119,6,0.1);   color: var(--warning); }
.badge-paid    { background: rgba(5,150,105,0.1);   color: var(--success); }

/* â”€â”€ ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ â”€â”€ */
.actions { display: flex; gap: 5px; flex-wrap: wrap; }
.btn {
  padding: 5px 12px;
  border-radius: 7px;
  font-size: 0.78rem;
  font-weight: 600;
  cursor: pointer;
  border: none;
  font-family: inherit;
  transition: all 0.15s;
  white-space: nowrap;
}
.btn-primary  { background: var(--primary); color: #fff; }
.btn-primary:hover { background: #1d4ed8; }
.btn-success  { background: var(--success); color: #fff; }
.btn-success:hover { background: #047857; }
.btn-warning  { background: rgba(217,119,6,0.12); color: var(--warning); border: 1px solid rgba(217,119,6,0.25); }
.btn-warning:hover { background: var(--warning); color: #fff; }
.btn-danger   { background: rgba(220,38,38,0.08); color: var(--danger); border: 1px solid rgba(220,38,38,0.2); }
.btn-danger:hover { background: var(--danger); color: #fff; }
.btn-ghost    { background: #f1f5ff; color: var(--primary); border: 1px solid rgba(37,99,235,0.15); }
.btn-ghost:hover { background: var(--primary); color: #fff; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* â”€â”€ Stat ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ â”€â”€ */
.stats-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 14px;
  margin-bottom: 24px;
}
.stat-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px 20px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
}
.stat-label { font-size: 0.75rem; color: var(--muted); font-weight: 600; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.05em; }
.stat-value { font-size: 1.8rem; font-weight: 800; letter-spacing: -1px; }
.stat-sub   { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }

/* â”€â”€ Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ â”€â”€ */
.ref-code {
  font-family: monospace;
  font-size: 0.85rem;
  font-weight: 700;
  background: #f1f5ff;
  color: var(--primary);
  padding: 3px 8px;
  border-radius: 6px;
  letter-spacing: 0.1em;
}

.expires-text { font-size: 0.8rem; color: var(--muted); }
.expires-soon { color: var(--warning); font-weight: 600; }

/* â”€â”€ ĞŸÑƒÑÑ‚Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ â”€â”€ */
.empty { text-align: center; padding: 40px; color: var(--muted); }
.empty-icon { font-size: 2.5rem; margin-bottom: 10px; }

/* â”€â”€ ĞœĞ¾Ğ´Ğ°Ğ»ĞºĞ° â”€â”€ */
.modal-overlay {
  display: none;
  position: fixed; inset: 0; z-index: 1000;
  background: rgba(15,23,42,0.4);
  backdrop-filter: blur(4px);
  align-items: center; justify-content: center;
  padding: 20px;
}
.modal-overlay.active { display: flex; }
.modal {
  background: #fff;
  border-radius: 16px;
  padding: 28px;
  width: 100%;
  max-width: 400px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.2);
}
.modal h3 { font-size: 1.1rem; font-weight: 800; margin-bottom: 16px; }
.modal-actions { display: flex; gap: 8px; margin-top: 20px; }
.modal-actions .btn { flex: 1; padding: 10px; font-size: 0.85rem; }

/* â”€â”€ Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ² Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºĞµ â”€â”€ */
.form-group { margin-bottom: 14px; }
.form-group label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--muted); margin-bottom: 5px; }
.form-group select, .form-group input {
  width: 100%;
  padding: 9px 12px;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  font-size: 0.88rem;
  font-family: inherit;
  color: var(--text);
  outline: none;
}
.form-group select:focus, .form-group input:focus { border-color: var(--primary); }

@media (max-width: 640px) {
  .page { padding: 16px 14px; }
  .actions { flex-direction: column; }
  .btn { width: 100%; text-align: center; }
}
</style>
</head>
<body>

<div class="page">
  <div class="page-header">
    <div class="page-title">âš™ï¸ <span>ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ</span></div>
    <div id="adminBadge" style="font-size:0.8rem;color:var(--muted)">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
  </div>

  <div class="stats-row" id="statsRow">
    <div class="stat-card"><div class="stat-label">Ğ¡Ñ‚ÑƒĞ´Ğ¸Ğ¹ Ğ²ÑĞµĞ³Ğ¾</div><div class="stat-value" id="sTotal">â€”</div></div>
    <div class="stat-card"><div class="stat-label">ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…</div><div class="stat-value" id="sActive" style="color:var(--success)">â€”</div></div>
    <div class="stat-card"><div class="stat-label">ĞĞ° Ñ‚Ñ€Ğ¸Ğ°Ğ»Ğµ</div><div class="stat-value" id="sTrial" style="color:var(--primary)">â€”</div></div>
    <div class="stat-card"><div class="stat-label">Ğ˜ÑÑ‚Ñ‘Ğº Ğ´Ğ¾ÑÑ‚ÑƒĞ¿</div><div class="stat-value" id="sExpired" style="color:var(--danger)">â€”</div></div>
    <div class="stat-card"><div class="stat-label">ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¹ Ğº Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ğµ</div><div class="stat-value" id="sCommission" style="color:var(--purple)">â€”</div><div class="stat-sub">â‚½</div></div>
  </div>

  <div class="tabs">
    <button class="tab-btn" onclick="switchTab('requests')">ğŸ“‹ Ğ—Ğ°ÑĞ²ĞºĞ¸</button>
    <button class="tab-btn active" onclick="switchTab('studios')">ğŸ¢ Ğ¡Ñ‚ÑƒĞ´Ğ¸Ğ¸</button>
    <button class="tab-btn" onclick="switchTab('referrals')">ğŸ”— Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹</button>
    <button class="tab-btn" onclick="switchTab('commissions')">ğŸ’° ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸</button>
    <button class="tab-btn" onclick="switchTab('calcs')">ğŸ“Š Ğ Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹</button>
  </div>

  <!-- Ğ¢Ğ°Ğ±: Ğ¡Ñ‚ÑƒĞ´Ğ¸Ğ¸ -->
  <div id="tab-requests" style="display:none">
  <table class="table">
    <thead><tr>
      <th>Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ</th><th>Ğ“Ğ¾Ñ€Ğ¾Ğ´</th><th>Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</th><th>Email</th>
      <th>Ğ”Ğ°Ñ‚Ğ°</th><th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</th><th>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ</th>
    </tr></thead>
    <tbody id="requestsBody"><tr><td colspan="7" style="text-align:center;color:#94a3b8">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</td></tr></tbody>
  </table>
</div>

<div id="tab-studios">
    <div class="card">
      <div class="card-head">
        <h2>Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑÑ‚ÑƒĞ´Ğ¸Ğ¹</h2>
        <button class="btn btn-primary" onclick="openAddModal()">â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚ÑƒĞ´Ğ¸Ñ</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ</th>
              <th>Ğ ĞµÑ„. ĞºĞ¾Ğ´</th>
              <th>ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°</th>
              <th>Ğ˜ÑÑ‚ĞµĞºĞ°ĞµÑ‚</th>
              <th>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</th>
            </tr>
          </thead>
          <tbody id="studiosBody">
            <tr><td colspan="5"><div class="empty"><div class="empty-icon">â³</div>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ğ¢Ğ°Ğ±: Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹ -->
  <div id="tab-calcs" style="display:none">
  <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
    <select id="calcsStudioFilter" style="padding:8px 12px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:0.9rem">
      <option value="">Ğ’ÑĞµ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸</option>
    </select>
    <input type="text" id="calcsSearch" placeholder="ğŸ” ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ°Ğ²Ñ‚Ğ¾..." style="padding:8px 12px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:0.9rem;min-width:200px">
    <span id="calcsCount" style="color:#64748b;font-size:0.85rem"></span>
    <div style="margin-left:auto;display:flex;gap:8px">
      <div style="background:#f1f5f9;border-radius:8px;padding:8px 16px;text-align:center">
        <div style="font-size:0.75rem;color:#64748b;text-transform:uppercase">Ğ Ğ°ÑÑ‡Ñ‘Ñ‚Ğ¾Ğ²</div>
        <div id="calcsStatTotal" style="font-weight:800;font-size:1.1rem">â€”</div>
      </div>
      <div style="background:#f1f5f9;border-radius:8px;padding:8px 16px;text-align:center">
        <div style="font-size:0.75rem;color:#64748b;text-transform:uppercase">Ğ¡ÑƒĞ¼Ğ¼Ğ°</div>
        <div id="calcsStatSum" style="font-weight:800;font-size:1.1rem;color:#7c3aed">â€”</div>
      </div>
      <div style="background:#f1f5f9;border-radius:8px;padding:8px 16px;text-align:center">
        <div style="font-size:0.75rem;color:#64748b;text-transform:uppercase">Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ‡ĞµĞº</div>
        <div id="calcsStatAvg" style="font-weight:800;font-size:1.1rem">â€”</div>
      </div>
    </div>
  </div>
  <table class="table">
    <thead><tr>
      <th>Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ</th><th>ĞĞ²Ñ‚Ğ¾</th><th>Ğ¡ÑƒĞ¼Ğ¼Ğ°</th><th>Ğ˜Ñ‚Ğ¾Ğ³ ÑĞ¾ ÑĞºĞ¸Ğ´ĞºĞ¾Ğ¹</th><th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</th><th>Ğ”Ğ°Ñ‚Ğ°</th>
    </tr></thead>
    <tbody id="calcsBody"><tr><td colspan="6" style="text-align:center;color:#94a3b8">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</td></tr></tbody>
  </table>
</div>

<div id="tab-referrals" style="display:none">
    <div class="card">
      <div class="card-head"><h2>Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞ²ÑĞ·Ğ¸</h2></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ĞšÑ‚Ğ¾ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ğ»</th>
              <th>ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑˆÑ‘Ğ½Ğ½Ğ°Ñ ÑÑ‚ÑƒĞ´Ğ¸Ñ</th>
              <th>Ğ ĞµÑ„. ĞºĞ¾Ğ´</th>
              <th>Ğ”Ğ°Ñ‚Ğ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸</th>
              <th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸</th>
            </tr>
          </thead>
          <tbody id="referralsBody">
            <tr><td colspan="5"><div class="empty"><div class="empty-icon">â³</div>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ğ¢Ğ°Ğ±: ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸ -->
  <div id="tab-commissions" style="display:none">
    <div class="card">
      <div class="card-head">
        <h2>ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸ Ğº Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ğµ</h2>
        <button class="btn btn-success" onclick="markAllPaid()">âœ… ĞÑ‚Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Ğ ĞµÑ„ĞµÑ€Ñ€ĞµÑ€</th>
              <th>Ğ—Ğ° ÑÑ‚ÑƒĞ´Ğ¸Ñ</th>
              <th>Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°</th>
              <th>ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ñ 20%</th>
              <th>Ğ”Ğ°Ñ‚Ğ°</th>
              <th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</th>
              <th>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ</th>
            </tr>
          </thead>
          <tbody id="commissionsBody">
            <tr><td colspan="7"><div class="empty"><div class="empty-icon">â³</div>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ĞœĞ¾Ğ´Ğ°Ğ»ĞºĞ°: ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¾Ğ¹ -->
<div class="modal-overlay" id="subModal">
  <div class="modal">
    <h3 id="subModalTitle">Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¾Ğ¹</h3>
    <div style="font-size:0.85rem;color:var(--muted);margin-bottom:16px" id="subModalStudio"></div>
    <div class="form-group">
      <label>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ</label>
      <select id="subAction">
        <option value="trial">â° ĞŸÑ€Ğ¾Ğ´Ğ»Ğ¸Ñ‚ÑŒ Ñ‚Ñ€Ğ¸Ğ°Ğ» +72 Ñ‡Ğ°ÑĞ°</option>
        <option value="month">ğŸ“… ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ¼ĞµÑÑÑ† (+30 Ğ´Ğ½ĞµĞ¹) â€” 4 900 â‚½</option>
        <option value="year">ğŸ—“ ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ³Ğ¾Ğ´ (+365 Ğ´Ğ½ĞµĞ¹) â€” 51 900 â‚½</option>
        <option value="custom">âœï¸ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ€Ğ¾Ğº</option>
        <option value="block">ğŸš« Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</option>
      </select>
    </div>
    <div class="form-group" id="customDaysGroup" style="display:none">
      <label>ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹</label>
      <input type="number" id="customDays" placeholder="30" min="1" max="3650">
    </div>
    <div id="subModalPayment" style="font-size:0.83rem;color:var(--muted);margin-bottom:4px"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('subModal')">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn btn-primary" id="subSaveBtn" onclick="saveSubscription()">ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<!-- ĞœĞ¾Ğ´Ğ°Ğ»ĞºĞ°: Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚ÑƒĞ´Ğ¸Ñ -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <h3>Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚ÑƒĞ´Ğ¸Ñ</h3>
    <div class="form-group">
      <label>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸</label>
      <input type="text" id="newStudioName" placeholder="Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ Ğ¾ĞºĞ»ĞµĞ¹ĞºĞ¸">
    </div>
    <div class="form-group">
      <label>Email Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ°</label>
      <input type="email" id="newStudioEmail" placeholder="owner@studio.ru">
    </div>
    <div class="form-group">
      <label>Ğ¢Ğ°Ñ€Ğ¸Ñ„</label>
      <select id="newStudioTier">
        <option value="trial">Ğ¢Ñ€Ğ¸Ğ°Ğ» 72Ñ‡</option>
        <option value="active_month">ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ (1 Ğ¼ĞµÑÑÑ†)</option>
        <option value="active_year">ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ (1 Ğ³Ğ¾Ğ´)</option>
      </select>
    </div>
    <div id="addError" style="color:var(--danger);font-size:0.82rem;margin-top:8px;display:none"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addModal')">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn btn-primary" id="addSaveBtn" onclick="saveNewStudio()">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<script>
(function() {
'use strict';

const ADMIN_USER_ID   = 'c5db87ec-8e4a-4c48-bad3-5747513224d9';
const SUPABASE_URL    = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window._crmSb = sb;

let allStudios = [];
let activeStudioId = null;

// â”€â”€ Auth + Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkAdminAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'welcome.html'; return false; }
  if (session.user.id !== ADMIN_USER_ID) {
    document.body.innerHTML = '<div style="text-align:center;padding:60px;font-family:sans-serif"><h2>ğŸš« Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰Ñ‘Ğ½</h2><p style="color:#64748b;margin-top:8px">Ğ­Ñ‚Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°</p><a href="dashboard.html" style="color:#2563eb">â† Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ</a></div>';
    return false;
  }
  document.getElementById('adminBadge').textContent = 'ğŸ‘‘ ' + session.user.email;
  return true;
}

// â”€â”€ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n) {
  return new Intl.NumberFormat('ru-RU').format(n || 0);
}
function fmtDate(d) {
  if (!d) return 'â€”';
  return new Date(d).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', year: 'numeric' });
}
function subStatus(studio) {
  const tier    = studio.subscription_tier;
  const expires = studio.subscription_expires_at;
  const now     = new Date();
  if (tier === 'active') {
    return (!expires || new Date(expires) > now) ? 'active' : 'expired';
  }
  if (tier === 'trial') {
    return (expires && new Date(expires) > now) ? 'trial' : 'expired';
  }
  return 'expired';
}
function subBadge(studio) {
  if (studio.subscription_tier === 'pending') {
    return '<span class="badge badge-pending">ğŸ“‹ Ğ—Ğ°ÑĞ²ĞºĞ°</span>';
  }
  const s = subStatus(studio);
  const labels = { active: 'âœ… ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°', trial: 'â° Ğ¢Ñ€Ğ¸Ğ°Ğ»', expired: 'âŒ Ğ˜ÑÑ‚ĞµĞºĞ»Ğ°' };
  const cls    = { active: 'badge-active', trial: 'badge-trial', expired: 'badge-expired' };
  return `<span class="badge ${cls[s]}">${labels[s]}</span>`;
}
function expireText(studio) {
  if (!studio.subscription_expires_at) return 'â€”';
  const d    = new Date(studio.subscription_expires_at);
  const days = Math.ceil((d - new Date()) / 86400000);
  const txt  = fmtDate(studio.subscription_expires_at);
  if (days <= 7 && days > 0) return `<span class="expires-soon">âš ï¸ ${txt} (${days}Ğ´)</span>`;
  if (days <= 0) return `<span style="color:var(--danger)">${txt}</span>`;
  return `<span class="expires-text">${txt}</span>`;
}

// â”€â”€ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€ Ğ Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹ Ğ²ÑĞµÑ… ÑÑ‚ÑƒĞ´Ğ¸Ğ¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allCalcs = [];

async function loadCalcs() {
  const tbody = document.getElementById('calcsBody');
  if (tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#94a3b8">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</td></tr>';

  const { data, error } = await sb
    .from('calculations')
    .select('id, car_name, total_price, final_price, status, created_at, studio_id, studios(name)')
    .order('created_at', { ascending: false })
    .limit(500);

  if (error) { console.error('loadCalcs error:', error); return; }
  allCalcs = data || [];

  // Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ ÑÑ‚ÑƒĞ´Ğ¸Ğ¹
  const filter = document.getElementById('calcsStudioFilter');
  if (filter) {
    const studios = [...new Map(allCalcs.map(c => [c.studio_id, c.studios?.name || c.studio_id])).entries()];
    studios.forEach(([id, name]) => {
      const o = document.createElement('option');
      o.value = id; o.textContent = name;
      filter.appendChild(o);
    });
    filter.addEventListener('change', renderCalcs);
  }
  const search = document.getElementById('calcsSearch');
  if (search) search.addEventListener('input', renderCalcs);

  renderCalcs();
}

function renderCalcs() {
  const studioFilter = document.getElementById('calcsStudioFilter')?.value || '';
  const searchVal = (document.getElementById('calcsSearch')?.value || '').toLowerCase();

  let filtered = allCalcs.filter(c => {
    if (studioFilter && c.studio_id !== studioFilter) return false;
    if (searchVal && !(c.car_name || '').toLowerCase().includes(searchVal)) return false;
    return true;
  });

  const total = filtered.length;
  const sum = filtered.reduce((a, c) => a + (c.final_price || c.total_price || 0), 0);
  const avg = total > 0 ? sum / total : 0;

  document.getElementById('calcsStatTotal').textContent = total;
  document.getElementById('calcsStatSum').textContent = fmt(sum) + ' â‚½';
  document.getElementById('calcsStatAvg').textContent = fmt(avg) + ' â‚½';
  document.getElementById('calcsCount').textContent = `ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¾: ${total}`;

  const statusLabel = { new:'ğŸ†• ĞĞ¾Ğ²Ñ‹Ğ¹', scheduled:'ğŸ“… Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ', in_progress:'ğŸ”§ Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ', done:'âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾', delivered:'ğŸš— Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ¾', draft:'ğŸ“ Ğ§ĞµÑ€Ğ½Ğ¾Ğ²Ğ¸Ğº' };

  const tbody = document.getElementById('calcsBody');
  if (!tbody) return;
  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#94a3b8">Ğ Ğ°ÑÑ‡Ñ‘Ñ‚Ğ¾Ğ² Ğ½ĞµÑ‚</td></tr>';
    return;
  }
  tbody.innerHTML = filtered.map(c => `
    <tr>
      <td><strong>${c.studios?.name || 'â€”'}</strong></td>
      <td>${c.car_name || 'â€”'}</td>
      <td style="color:#475569">${fmt(c.total_price || 0)} â‚½</td>
      <td style="color:#7c3aed;font-weight:700">${fmt(c.final_price || c.total_price || 0)} â‚½</td>
      <td><span style="font-size:0.8rem">${statusLabel[c.status] || c.status || 'â€”'}</span></td>
      <td style="color:#94a3b8;font-size:0.8rem">${new Date(c.created_at).toLocaleDateString('ru')}</td>
    </tr>
  `).join('');
}

async function loadAll() {
  await Promise.all([loadStudios(), loadCommissions(), loadRequests()]);
}


async function loadRequests() {
  const { data, error } = await sb
    .from('access_requests')
    .select('*')
    .order('created_at', { ascending: false });
  if (error) { console.error(error); return; }
  const reqs = data || [];
  // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ±ĞµĞ¹Ğ´Ğ¶ Ğ½Ğ° Ğ²ĞºĞ»Ğ°Ğ´ĞºĞµ
  const btn = Array.from(document.querySelectorAll(".tab-btn")).find(b => b.textContent.includes("Ğ—Ğ°ÑĞ²ĞºĞ¸"));
  if (btn && reqs.filter(r => r.status === 'new').length > 0) {
    btn.textContent = 'ğŸ“‹ Ğ—Ğ°ÑĞ²ĞºĞ¸ (' + reqs.filter(r => r.status === 'new').length + ')';
  }
  const tbody = document.getElementById('requestsBody');
  if (!tbody) return;
  if (!reqs.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#94a3b8">Ğ—Ğ°ÑĞ²Ğ¾Ğº Ğ½ĞµÑ‚</td></tr>';
    return;
  }
  tbody.innerHTML = reqs.map(r => `
    <tr>
      <td><strong>${r.studio_name || 'â€”'}</strong></td>
      <td>${r.city || 'â€”'}</td>
      <td><a href="tel:${r.phone}">${r.phone || 'â€”'}</a></td>
      <td>${r.email || 'â€”'}</td>
      <td>${new Date(r.created_at).toLocaleDateString('ru')}</td>
      <td><span class="badge ${r.status === 'new' ? 'badge-pending' : 'badge-active'}">${
        r.status === 'new' ? 'ğŸ†• ĞĞ¾Ğ²Ğ°Ñ' : r.status === 'approved' ? 'âœ… ĞĞ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ°' : 'âŒ ĞÑ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ°'
      }</span></td>
      <td>
        ${r.status === 'new' ? `
          <button class="btn btn-success btn-sm" onclick="approveRequest('${r.id}', '${r.studio_name}', '${r.email}')">âœ… ĞĞ´Ğ¾Ğ±Ñ€Ğ¸Ñ‚ÑŒ</button>
          <button class="btn btn-sm" style="background:#ef4444;color:#fff" onclick="rejectRequest('${r.id}')">âŒ</button>
        ` : 'â€”'}
      </td>
    </tr>
  `).join('');
}

window.approveRequest = async function(id, studioName, email) {
  if (!confirm('ĞĞ´Ğ¾Ğ±Ñ€Ğ¸Ñ‚ÑŒ Ğ·Ğ°ÑĞ²ĞºÑƒ Ğ¾Ñ‚ ' + studioName + '?')) return;
  // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ·Ğ°ÑĞ²ĞºĞ¸
  await sb.from('access_requests').update({ status: 'approved' }).eq('id', id);
  // Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ supabase_user â€” ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ ÑÑ‚ÑƒĞ´Ğ¸Ñ
  const { data: req } = await sb.from('access_requests').select('*').eq('id', id).single();
  if (req?.supabase_user_id) {
    const refCode = Math.random().toString(36).substring(2,10).toUpperCase();
    const trialEnds = new Date(Date.now() + 72 * 3600 * 1000).toISOString();
    const { data: studio } = await sb.from('studios').insert({
      name: req.studio_name,
      owner_id: req.supabase_user_id,
      subscription_tier: 'trial',
      subscription_expires_at: trialEnds,
      referral_code: refCode,
      settings: { phone: req.phone, city: req.city, contact_email: req.email }
    }).select('id').single();
    if (studio) {
      await sb.from('studio_members').insert({
        studio_id: studio.id, user_id: req.supabase_user_id, role: 'owner', is_active: true
      });
    }
  }
  alert('âœ… Ğ—Ğ°ÑĞ²ĞºĞ° Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ°! Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°, Ñ‚Ñ€Ğ¸Ğ°Ğ» 72 Ñ‡Ğ°ÑĞ°.');
  loadRequests();
  loadStudios();
};

window.rejectRequest = async function(id) {
  if (!confirm('ĞÑ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ñ‚ÑŒ Ğ·Ğ°ÑĞ²ĞºÑƒ?')) return;
  await sb.from('access_requests').update({ status: 'rejected' }).eq('id', id);
  loadRequests();
};

async function loadStudios() {
  const { data, error } = await sb
    .from('studios')
    .select('id, name, owner_id, subscription_tier, subscription_expires_at, referral_code, referred_by_studio_id, created_at, settings')
    .order('created_at', { ascending: false });

  if (error) { console.error(error); return; }
  allStudios = data || [];

  // Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ñ‹
  let active = 0, trial = 0, expired = 0;
  allStudios.forEach(s => {
    const st = subStatus(s);
    if (st === 'active') active++;
    else if (st === 'trial') trial++;
    else expired++;
  });

  document.getElementById('sTotal').textContent   = allStudios.length;
  const pending = allStudios.filter(s => s.subscription_tier === 'pending').length;
  if (pending > 0) {
    document.getElementById('sTotal').textContent = allStudios.length + ' (' + pending + ' ğŸ“‹)';
  }
  document.getElementById('sActive').textContent  = active;
  document.getElementById('sTrial').textContent   = trial;
  document.getElementById('sExpired').textContent = expired;

  renderStudios();
  renderReferrals();
}

async function loadCommissions() {
  const { data, error } = await sb
    .from('referral_commissions')
    .select('*, referrer:referrer_studio_id(name), referred:referred_studio_id(name)')
    .order('created_at', { ascending: false });

  if (error) { console.error(error); return; }
  const comms = data || [];

  const pending = comms.filter(c => !c.paid_to_referrer).reduce((s, c) => s + Number(c.amount), 0);
  document.getElementById('sCommission').textContent = fmt(pending);

  renderCommissions(comms);
}

// â”€â”€ Ğ ĞµĞ½Ğ´ĞµÑ€ ÑÑ‚ÑƒĞ´Ğ¸Ğ¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStudios() {
  const tbody = document.getElementById('studiosBody');

  if (!allStudios.length) {
    tbody.innerHTML = '<tr><td colspan="5"><div class="empty"><div class="empty-icon">ğŸ¢</div>ĞĞµÑ‚ ÑÑ‚ÑƒĞ´Ğ¸Ğ¹</div></td></tr>';
    return;
  }

  // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ email Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†ĞµĞ² Ñ‡ĞµÑ€ĞµĞ· studio_members
  tbody.innerHTML = allStudios.map(s => `
    <tr>
      <td>
        <div class="studio-name">${s.name}</div>
        <div class="studio-email" id="email-${s.id}">Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
        ${s.settings?.phone ? `<div style="font-size:0.75rem;color:#2563eb;margin-top:1px">${s.settings.phone}</div>` : `<div style="font-size:0.75rem;color:#94a3b8;margin-top:1px" id="phone-${s.id}"></div>`}
        ${s.settings?.city ? `<div style="font-size:0.75rem;color:#64748b">${s.settings.city}</div>` : ''}
      </td>
      <td>
        ${s.referral_code
          ? `<span class="ref-code">${s.referral_code}</span>`
          : `<button class="btn btn-ghost" style="font-size:0.72rem" onclick="genRefCode('${s.id}')">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ</button>`
        }
      </td>
      <td>${subBadge(s)}</td>
      <td>${expireText(s)}</td>
      <td>
        <div class="actions">
          ${s.subscription_tier === 'pending' ? `<button class="btn btn-success" onclick="approveStudio('${s.id}', '${s.name}')">âœ… ĞĞ´Ğ¾Ğ±Ñ€Ğ¸Ñ‚ÑŒ</button>` : ''}
          <button class="btn btn-primary" onclick="openSubModal('${s.id}')">âš™ï¸ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°</button>
          <button class="btn btn-danger" onclick="blockStudio('${s.id}', '${s.name}')">ğŸš«</button>
        </div>
      </td>
    </tr>
  `).join('');

  // ĞŸĞ¾Ğ´Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ email Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸
  allStudios.forEach(async s => {
    const { data } = await sb
      .from('studio_members')
      .select('user_id, role')
      .eq('studio_id', s.id)
      .eq('role', 'owner')
      .single();

    const el = document.getElementById(`email-${s.id}`);
    if (!el) return;

    if (data) {
      const { data: userData } = await sb.auth.admin?.getUserById(data.user_id).catch(() => ({ data: null })) || { data: null };
      // Fallback â€” Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ user_id ÑĞ¾ĞºÑ€Ğ°Ñ‰Ñ‘Ğ½Ğ½Ğ¾
      el.textContent = data.user_id.slice(0, 8) + '...';
    // Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ¸Ğ· settings
    const phone = s.settings?.phone;
    if (phone) {
      const phoneEl = document.getElementById('phone-' + s.id);
      if (phoneEl) phoneEl.textContent = phone;
    }
    } else {
      el.textContent = 'Ğ½ĞµÑ‚ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ°';
    }
  });
}

// â”€â”€ Ğ ĞµĞ½Ğ´ĞµÑ€ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReferrals() {
  const tbody = document.getElementById('referralsBody');
  const referred = allStudios.filter(s => s.referred_by_studio_id);

  if (!referred.length) {
    tbody.innerHTML = '<tr><td colspan="5"><div class="empty"><div class="empty-icon">ğŸ”—</div>Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¹ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚</div></td></tr>';
    return;
  }

  tbody.innerHTML = referred.map(s => {
    const referrer = allStudios.find(r => r.id === s.referred_by_studio_id);
    return `
      <tr>
        <td><div class="studio-name">${referrer ? referrer.name : 'â€”'}</div></td>
        <td><div class="studio-name">${s.name}</div></td>
        <td>${referrer ? `<span class="ref-code">${referrer.referral_code || 'â€”'}</span>` : 'â€”'}</td>
        <td>${fmtDate(s.created_at)}</td>
        <td>${subBadge(s)}</td>
      </tr>
    `;
  }).join('');
}

// â”€â”€ Ğ ĞµĞ½Ğ´ĞµÑ€ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCommissions(comms) {
  const tbody = document.getElementById('commissionsBody');

  if (!comms.length) {
    tbody.innerHTML = '<tr><td colspan="7"><div class="empty"><div class="empty-icon">ğŸ’°</div>ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¹ Ğ½ĞµÑ‚</div></td></tr>';
    return;
  }

  tbody.innerHTML = comms.map(c => `
    <tr>
      <td><div class="studio-name">${c.referrer?.name || 'â€”'}</div></td>
      <td><div class="studio-name">${c.referred?.name || 'â€”'}</div></td>
      <td>${fmt(c.payment_amount)} â‚½</td>
      <td><strong>${fmt(c.amount)} â‚½</strong></td>
      <td>${fmtDate(c.payment_date)}</td>
      <td>
        ${c.paid_to_referrer
          ? `<span class="badge badge-paid">âœ… Ğ’Ñ‹Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾ ${fmtDate(c.paid_date)}</span>`
          : `<span class="badge badge-pending">â³ ĞĞ¶Ğ¸Ğ´Ğ°ĞµÑ‚</span>`
        }
      </td>
      <td>
        ${!c.paid_to_referrer
          ? `<button class="btn btn-success" onclick="markCommissionPaid('${c.id}')">Ğ’Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ÑŒ</button>`
          : 'â€”'
        }
      </td>
    </tr>
  `).join('');
}

// â”€â”€ Ğ¢Ğ°Ğ±Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.switchTab = function(tab) {
  ['requests', 'studios', 'referrals', 'commissions', 'calcs'].forEach(t => {
    const el = document.getElementById('tab-' + t);
    if (el) el.style.display = t === tab ? 'block' : 'none';
  });
  document.querySelectorAll('.tab-btn').forEach(btn => {
    const onclick = btn.getAttribute('onclick') || '';
    btn.classList.toggle('active', onclick.includes("'" + tab + "'"));
  });
  if (tab === 'calcs' && !window._calcsLoaded) {
    window._calcsLoaded = true;
    loadCalcs();
  }
};

// â”€â”€ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°: Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openSubModal = function(studioId) {
  activeStudioId = studioId;
  const studio = allStudios.find(s => s.id === studioId);
  document.getElementById('subModalTitle').textContent = 'ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°: ' + studio.name;
  document.getElementById('subModalStudio').textContent =
    'Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ: ' + subStatus(studio).toUpperCase() + ' Â· ' + expireText(studio).replace(/<[^>]+>/g, '');
  document.getElementById('subAction').value = 'month';
  updatePaymentHint();
  document.getElementById('subModal').classList.add('active');
};

document.getElementById('subAction').addEventListener('change', updatePaymentHint);

function updatePaymentHint() {
  const action = document.getElementById('subAction').value;
  const hint   = document.getElementById('subModalPayment');
  const customGroup = document.getElementById('customDaysGroup');
  customGroup.style.display = action === 'custom' ? 'block' : 'none';
  const hints = {
    trial: '72 Ñ‡Ğ°ÑĞ° Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°',
    month: 'ĞĞ¿Ğ»Ğ°Ñ‚Ğ° 4 900 â‚½ â€” ÑĞ¾Ğ·Ğ´Ğ°ÑÑ‚ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸ Ğ´Ğ»Ñ Ñ€ĞµÑ„ĞµÑ€Ñ€ĞµÑ€Ğ°',
    year:  'ĞĞ¿Ğ»Ğ°Ñ‚Ğ° 51 900 â‚½ â€” ÑĞ¾Ğ·Ğ´Ğ°ÑÑ‚ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸ Ğ´Ğ»Ñ Ñ€ĞµÑ„ĞµÑ€Ñ€ĞµÑ€Ğ°',
    custom: 'ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ€Ğ¾Ğº Ğ±ĞµĞ· ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸',
    block: 'ĞĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº CRM',
  };
  hint.textContent = hints[action] || '';
}

window.saveSubscription = async function() {
  const action = document.getElementById('subAction').value;
  const btn    = document.getElementById('subSaveBtn');
  btn.disabled = true; btn.textContent = 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼...';

  try {
    const studio = allStudios.find(s => s.id === activeStudioId);
    const now    = new Date();
    // Ğ‘ĞµÑ€Ñ‘Ğ¼ Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ğ¸Ğ· Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ´Ğ°Ñ‚Ñ‹ Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ Ğ¸ ÑĞµĞ¹Ñ‡Ğ°Ñ (Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ¿Ğ¾Ñ‚ĞµÑ€ÑÑ‚ÑŒ Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº)
    const base   = studio.subscription_expires_at && new Date(studio.subscription_expires_at) > now
      ? new Date(studio.subscription_expires_at)
      : now;

    let tier, expires, paymentAmount = 0;

    if (action === 'trial') {
      tier    = 'trial';
      expires = new Date(now.getTime() + 72 * 3600 * 1000).toISOString();
    } else if (action === 'month') {
      tier    = 'active';
      expires = new Date(base.getTime() + 30 * 86400000).toISOString();
      paymentAmount = 4900;
    } else if (action === 'year') {
      tier    = 'active';
      expires = new Date(base.getTime() + 365 * 86400000).toISOString();
      paymentAmount = 51900;
    } else if (action === 'custom') {
      const days = parseInt(document.getElementById('customDays').value);
      if (!days || days < 1) { alert('Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹'); btn.disabled = false; btn.textContent = 'ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ'; return; }
      tier    = 'active';
      expires = new Date(base.getTime() + days * 86400000).toISOString();
    } else if (action === 'block') {
      if (!confirm(`Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚ÑƒĞ´Ğ¸Ñ "${studio.name}"?`)) { btn.disabled = false; btn.textContent = 'ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ'; return; }
      tier    = 'expired';
      expires = now.toISOString();
    }

    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ
    const { error } = await sb
      .from('studios')
      .update({ subscription_tier: tier, subscription_expires_at: expires })
      .eq('id', activeStudioId);

    if (error) throw error;

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ñ ĞµÑĞ»Ğ¸ Ñ€ĞµÑ„ĞµÑ€Ñ€ĞµÑ€ ĞµÑÑ‚ÑŒ Ğ¸ ÑÑ‚Ğ¾ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°
    if (paymentAmount > 0 && studio.referred_by_studio_id) {
      await sb.from('referral_commissions').insert({
        referrer_studio_id: studio.referred_by_studio_id,
        referred_studio_id: activeStudioId,
        amount: Math.round(paymentAmount * 0.2),
        payment_amount: paymentAmount,
        payment_date: new Date().toISOString().split('T')[0],
        paid_to_referrer: false
      });
    }

    closeModal('subModal');
    await loadAll();
  } catch (e) {
    alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + e.message);
  } finally {
    btn.disabled = false; btn.textContent = 'ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ';
  }
};

// â”€â”€ Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.approveStudio = async function(studioId, name) {
  if (!confirm(`ĞĞ´Ğ¾Ğ±Ñ€Ğ¸Ñ‚ÑŒ Ğ·Ğ°ÑĞ²ĞºÑƒ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸ "${name}" Ğ¸ Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ±Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğ½Ğ° 72 Ñ‡Ğ°ÑĞ°?`)) return;
  const trialEnds = new Date(Date.now() + 72 * 3600 * 1000).toISOString();
  const { error } = await sb.from('studios').update({
    subscription_tier: 'trial',
    subscription_expires_at: trialEnds
  }).eq('id', studioId);
  if (error) {
    alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.message + '\nĞšĞ¾Ğ´: ' + error.code);
    console.error('approveStudio error:', error);
    return;
  }
  alert(`âœ… Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ "${name}" Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ°! Ğ¢Ñ€Ğ¸Ğ°Ğ» Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ½Ğ° 72 Ñ‡Ğ°ÑĞ°.`);
  await loadStudios();
};

window.blockStudio = async function(studioId, name) {
  if (!confirm(`Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚ÑƒĞ´Ğ¸Ñ "${name}"?\nĞ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ±ÑƒĞ´ĞµÑ‚ Ğ½ĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚.`)) return;
  await sb.from('studios').update({
    subscription_tier: 'expired',
    subscription_expires_at: new Date().toISOString()
  }).eq('id', studioId);
  await loadStudios();
};

// â”€â”€ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ñ€ĞµÑ„. ĞºĞ¾Ğ´Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.genRefCode = async function(studioId) {
  const code = Math.random().toString(36).substring(2, 10).toUpperCase();
  await sb.from('studios').update({ referral_code: code }).eq('id', studioId);
  await loadStudios();
};

// â”€â”€ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚ÑƒĞ´Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openAddModal = function() {
  document.getElementById('newStudioName').value = '';
  document.getElementById('newStudioEmail').value = '';
  document.getElementById('newStudioTier').value = 'trial';
  document.getElementById('addError').style.display = 'none';
  document.getElementById('addModal').classList.add('active');
};

window.saveNewStudio = async function() {
  const name  = document.getElementById('newStudioName').value.trim();
  const email = document.getElementById('newStudioEmail').value.trim();
  const tier  = document.getElementById('newStudioTier').value;
  const btn   = document.getElementById('addSaveBtn');
  const errEl = document.getElementById('addError');

  if (!name || !email) { errEl.textContent = 'Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ'; errEl.style.display = 'block'; return; }

  btn.disabled = true; btn.textContent = 'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼...';
  errEl.style.display = 'none';

  try {
    const now = new Date();
    let expiresAt, subTier;

    if (tier === 'trial') {
      subTier   = 'trial';
      expiresAt = new Date(now.getTime() + 72 * 3600 * 1000).toISOString();
    } else if (tier === 'active_month') {
      subTier   = 'active';
      expiresAt = new Date(now.getTime() + 30 * 86400000).toISOString();
    } else {
      subTier   = 'active';
      expiresAt = new Date(now.getTime() + 365 * 86400000).toISOString();
    }

    const refCode = Math.random().toString(36).substring(2, 10).toUpperCase();

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ ÑÑ‚ÑƒĞ´Ğ¸Ñ (Ğ±ĞµĞ· Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ° â€” Ğ¾Ğ½Ğ¸ ÑĞ°Ğ¼Ğ¸ Ğ·Ğ°Ñ€ĞµĞ³Ğ°ÑÑ‚ÑÑ)
    const { data: studio, error: studioErr } = await sb
      .from('studios')
      .insert({
        name,
        subscription_tier: subTier,
        subscription_expires_at: expiresAt,
        referral_code: refCode,
        settings: { contact_email: email }
      })
      .select('id')
      .single();

    if (studioErr) throw studioErr;

    // Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ĞµĞ»ÑŒĞ½ÑƒÑ ÑÑÑ‹Ğ»ĞºÑƒ
    const inviteLink = `${window.location.origin}/welcome.html?studio=${studio.id}`;
    alert(`âœ… Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ "${name}" ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°!\n\nĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ ÑÑÑ‹Ğ»ĞºÑƒ Ğ´Ğ»Ñ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸:\n${inviteLink}\n\nĞ›Ğ¸Ğ±Ğ¾ Ğ¾Ğ½Ğ¸ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ·Ğ°Ñ€ĞµĞ³Ğ°Ñ‚ÑŒÑÑ ÑĞ°Ğ¼Ğ¸ â€” Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ¿Ñ€Ğ¸Ğ²ÑĞ¶Ğ¸ Ğ¸Ñ… Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ.`);

    closeModal('addModal');
    await loadStudios();
  } catch (e) {
    errEl.textContent = 'ĞÑˆĞ¸Ğ±ĞºĞ°: ' + e.message;
    errEl.style.display = 'block';
  } finally {
    btn.disabled = false; btn.textContent = 'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ';
  }
};

// â”€â”€ ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.markCommissionPaid = async function(id) {
  await sb.from('referral_commissions').update({
    paid_to_referrer: true,
    paid_date: new Date().toISOString().split('T')[0]
  }).eq('id', id);
  await loadCommissions();
};

window.markAllPaid = async function() {
  if (!confirm('ĞÑ‚Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ½ĞµĞ¾Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸ ĞºĞ°Ğº Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ?')) return;
  await sb.from('referral_commissions').update({
    paid_to_referrer: true,
    paid_date: new Date().toISOString().split('T')[0]
  }).eq('paid_to_referrer', false);
  await loadCommissions();
};

// â”€â”€ Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.closeModal = function(id) {
  document.getElementById(id).classList.remove('active');
};
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
});

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  initNav({ hideAction: true });
  const ok = await checkAdminAuth();
  if (!ok) return;
  await loadAll();
  switchTab('studios'); // Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ñ‹Ğ¹ Ñ‚Ğ°Ğ± Ğ¿Ğ¾ÑĞ»Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸
}

init();
})();
</script>
<script src="footer.js"></script>
</body>
</html>
