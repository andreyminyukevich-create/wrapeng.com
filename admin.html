<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keep1R CRM â€” ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link rel="stylesheet" href="nav.css">
<script src="nav.js"></script>
<style>
:root {
  --font:       -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
  --bg:         #eef2f9;
  --surface:    #ffffff;
  --border:     rgba(15,23,42,0.08);
  --text:       #0f172a;
  --muted:      #64748b;
  --dim:        #94a3b8;
  --primary:    #2563eb;
  --primary-dk: #1d4ed8;
  --success:    #059669;
  --warning:    #d97706;
  --danger:     #dc2626;
  --purple:     #7c3aed;
  --radius:     14px;
  --radius-sm:  9px;
  --shadow:     0 1px 3px rgba(0,0,0,0.04), 0 4px 14px rgba(0,0,0,0.06);
  --shadow-lg:  0 8px 40px rgba(0,0,0,0.14);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--font);
  -webkit-font-smoothing: antialiased;
  background: var(--bg);
  color: var(--text);
  min-height: 100svh;
}

.page {
  max-width: 1360px;
  margin: 0 auto;
  padding: 24px 20px 48px;
}

/* â”€â”€ Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 10px;
}
.page-title {
  font-size: 1.2rem;
  font-weight: 800;
  letter-spacing: -0.3px;
}
.page-title span { color: var(--primary); }

/* â”€â”€ Ğ¡Ñ‚Ğ°Ñ‚-ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-row {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 12px;
  margin-bottom: 20px;
}
.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px 18px;
  box-shadow: var(--shadow);
}
.stat-label {
  font-size: 0.67rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--muted);
  margin-bottom: 5px;
}
.stat-value {
  font-size: 1.6rem;
  font-weight: 800;
  letter-spacing: -0.8px;
  line-height: 1;
}
.stat-sub { font-size: 0.7rem; color: var(--muted); margin-top: 3px; }

/* â”€â”€ Ğ¢Ğ°Ğ±Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs {
  display: flex;
  gap: 3px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 3px;
  margin-bottom: 18px;
  width: fit-content;
  max-width: 100%;
  flex-wrap: wrap;
  box-shadow: 0 1px 2px rgba(0,0,0,0.03);
}
.tab-btn {
  padding: 7px 15px;
  border-radius: 7px;
  font-size: 0.8rem;
  font-weight: 700;
  cursor: pointer;
  border: none;
  background: transparent;
  color: var(--muted);
  font-family: var(--font);
  transition: all 0.15s;
  white-space: nowrap;
}
.tab-btn:hover { background: var(--bg); color: var(--text); }
.tab-btn.active { background: var(--primary); color: #fff; box-shadow: 0 2px 8px rgba(37,99,235,0.22); }

/* â”€â”€ ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 16px;
  box-shadow: var(--shadow);
}
.card-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 15px 20px;
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
  gap: 10px;
}
.card-head h2 { font-size: 0.9rem; font-weight: 700; }

/* â”€â”€ Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
table { width: 100%; border-collapse: collapse; font-size: 0.82rem; min-width: 540px; }
thead th {
  background: var(--bg);
  padding: 9px 14px;
  text-align: left;
  font-size: 0.67rem;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
tbody td {
  padding: 11px 14px;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
}
tbody tr:last-child td { border-bottom: none; }
tbody tr:hover { background: #f8fafc; }

.studio-name  { font-weight: 700; font-size: 0.85rem; }
.studio-email { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }

/* â”€â”€ Ğ‘ĞµĞ¹Ğ´Ğ¶Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 3px;
  padding: 2px 8px;
  border-radius: 20px;
  font-size: 0.7rem;
  font-weight: 700;
  white-space: nowrap;
}
.badge-active  { background: rgba(5,150,105,0.10);  color: var(--success); border: 1px solid rgba(5,150,105,0.2); }
.badge-trial   { background: rgba(37,99,235,0.10);   color: var(--primary); border: 1px solid rgba(37,99,235,0.2); }
.badge-expired { background: rgba(220,38,38,0.08);   color: var(--danger);  border: 1px solid rgba(220,38,38,0.15); }
.badge-ref     { background: rgba(124,58,237,0.08);  color: var(--purple);  border: 1px solid rgba(124,58,237,0.15); }
.badge-pending { background: rgba(217,119,6,0.08);   color: var(--warning); border: 1px solid rgba(217,119,6,0.2); }
.badge-paid    { background: rgba(5,150,105,0.10);   color: var(--success); border: 1px solid rgba(5,150,105,0.2); }

/* â”€â”€ ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.actions { display: flex; gap: 5px; flex-wrap: wrap; }
.btn {
  padding: 6px 12px;
  border-radius: 7px;
  font-size: 0.75rem;
  font-weight: 700;
  cursor: pointer;
  border: none;
  font-family: var(--font);
  transition: all 0.15s;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-primary  { background: var(--primary); color: #fff; }
.btn-primary:hover  { background: var(--primary-dk); }
.btn-success  { background: var(--success); color: #fff; }
.btn-success:hover  { background: #047857; }
.btn-warning  { background: rgba(217,119,6,0.10); color: var(--warning); border: 1px solid rgba(217,119,6,0.2); }
.btn-warning:hover  { background: var(--warning); color: #fff; }
.btn-danger   { background: rgba(220,38,38,0.07); color: var(--danger); border: 1px solid rgba(220,38,38,0.15); }
.btn-danger:hover   { background: var(--danger); color: #fff; }
.btn-ghost    { background: rgba(37,99,235,0.06); color: var(--primary); border: 1px solid rgba(37,99,235,0.18); }
.btn-ghost:hover    { background: var(--primary); color: #fff; }
.btn-excel    { background: rgba(5,150,105,0.08); color: var(--success); border: 1px solid rgba(5,150,105,0.2); }
.btn-excel:hover    { background: var(--success); color: #fff; }
.btn-sm { padding: 4px 9px; font-size: 0.7rem; }

/* â”€â”€ Ğ ĞµÑ„. ĞºĞ¾Ğ´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ref-code {
  font-family: monospace;
  font-size: 0.82rem;
  font-weight: 700;
  background: rgba(37,99,235,0.06);
  color: var(--primary);
  padding: 2px 7px;
  border-radius: 5px;
  letter-spacing: 0.08em;
  border: 1px solid rgba(37,99,235,0.15);
}

.expires-text { font-size: 0.78rem; color: var(--muted); }
.expires-soon { color: var(--warning); font-weight: 700; font-size: 0.78rem; }

/* â”€â”€ ĞŸÑƒÑÑ‚Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty { text-align: center; padding: 40px; color: var(--muted); }
.empty-icon { font-size: 2rem; margin-bottom: 8px; opacity: 0.35; }

/* â”€â”€ Ğ Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹ â€” Ñ‚ÑƒĞ»Ğ±Ğ°Ñ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.calcs-toolbar {
  display: flex;
  gap: 10px;
  margin-bottom: 14px;
  flex-wrap: wrap;
  align-items: center;
}
.calcs-toolbar select,
.calcs-toolbar input[type="text"] {
  padding: 8px 12px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 0.82rem;
  font-family: var(--font);
  color: var(--text);
  outline: none;
  transition: border-color 0.15s, box-shadow 0.15s;
  box-shadow: 0 1px 2px rgba(0,0,0,0.03);
}
.calcs-toolbar select:focus,
.calcs-toolbar input[type="text"]:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37,99,235,0.08);
}
.calcs-toolbar input[type="text"] { min-width: 200px; }

.calcs-stats {
  display: flex;
  gap: 8px;
  margin-left: auto;
  flex-wrap: wrap;
}
.calcs-stat-pill {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 6px 14px;
  text-align: center;
}
.calcs-stat-pill .s-label { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; font-weight: 700; letter-spacing: 0.06em; }
.calcs-stat-pill .s-val   { font-size: 1rem; font-weight: 800; letter-spacing: -0.3px; }

/* â”€â”€ Work assigned checkbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.work-check {
  width: 16px; height: 16px;
  accent-color: var(--success);
  cursor: default;
  pointer-events: none;
}

/* â”€â”€ ĞœĞ¾Ğ´Ğ°Ğ»ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
  display: none;
  position: fixed; inset: 0; z-index: 1000;
  background: rgba(15,23,42,0.45);
  backdrop-filter: blur(5px);
  -webkit-backdrop-filter: blur(5px);
  align-items: center; justify-content: center;
  padding: 20px;
}
.modal-overlay.active { display: flex; animation: fadein 0.15s ease; }

@keyframes fadein  { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideup { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.modal {
  background: var(--surface);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  padding: 26px 28px 24px;
  width: 100%;
  max-width: 420px;
  box-shadow: var(--shadow-lg);
  animation: slideup 0.18s ease;
}
.modal h3 { font-size: 1rem; font-weight: 700; margin-bottom: 14px; letter-spacing: -0.2px; }
.modal-actions { display: flex; gap: 8px; margin-top: 18px; }
.modal-actions .btn { flex: 1; padding: 10px; font-size: 0.82rem; justify-content: center; }

/* â”€â”€ Ğ¤Ğ¾Ñ€Ğ¼Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-group { margin-bottom: 12px; }
.form-group label {
  display: block;
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--muted);
  margin-bottom: 5px;
}
.form-group select, .form-group input {
  width: 100%;
  padding: 9px 12px;
  background: var(--bg);
  border: 1.5px solid var(--border);
  border-radius: 8px;
  font-size: 16px;
  font-family: var(--font);
  color: var(--text);
  outline: none;
  -webkit-appearance: none;
  transition: border-color 0.15s;
}
.form-group select:focus, .form-group input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37,99,235,0.08);
  background: var(--surface);
}

/* â”€â”€ ĞœĞ¾Ğ´Ğ°Ğ» Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#calcViewModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.5);
  backdrop-filter: blur(5px);
  z-index: 9000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
#calcViewModal.active { display: flex; }
#calcViewModal .modal-box {
  background: var(--surface);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  padding: 26px 28px;
  max-width: 680px;
  width: 100%;
  max-height: 88svh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
}
#calcViewModal h2 { font-size: 1.05rem; font-weight: 700; margin-bottom: 18px; letter-spacing: -0.2px; }

.calc-detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 18px;
}
.calc-detail-item {
  background: var(--bg);
  border-radius: 10px;
  padding: 11px 14px;
  border: 1px solid var(--border);
}
.calc-detail-label {
  font-size: 0.67rem;
  color: var(--dim);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  font-weight: 700;
  margin-bottom: 3px;
}
.calc-detail-value { font-size: 0.92rem; font-weight: 700; color: var(--text); }
.calc-detail-value.accent { color: var(--purple); }

.calc-services-list {
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 14px;
}
.calc-services-list table { min-width: 0; }
.calc-services-list th {
  background: var(--bg);
  padding: 8px 12px;
  text-align: left;
  font-weight: 700;
  color: var(--muted);
  font-size: 0.68rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}
.calc-services-list td { padding: 8px 12px; border-top: 1px solid var(--border); font-size: 0.82rem; }

/* â”€â”€ ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 1100px) {
  .stats-row { grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 768px) {
  .page { padding: 14px 12px 36px; }
  .stats-row { grid-template-columns: repeat(2, 1fr); }
  .tabs { width: 100%; }
  .tab-btn { flex: 1; text-align: center; padding: 7px 8px; font-size: 0.72rem; }
  .calcs-toolbar { flex-direction: column; align-items: stretch; }
  .calcs-toolbar input[type="text"] { min-width: 0; width: 100%; }
  .calcs-stats { margin-left: 0; }
  .actions { flex-direction: row; }
  .modal { padding: 20px 16px 18px; }
  .modal-actions { flex-direction: column-reverse; }
  .calc-detail-grid { grid-template-columns: 1fr; }
}
@media (max-width: 480px) {
  .stats-row { grid-template-columns: 1fr 1fr; }
  .stat-card:last-child { grid-column: 1 / -1; }
}
</style>
</head>
<body>

<div class="page">

  <!-- Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº -->
  <div class="page-header">
    <div class="page-title">âš™ï¸ <span>ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ</span></div>
    <div id="adminBadge" style="font-size:0.78rem;color:var(--muted);font-weight:600">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
  </div>

  <!-- Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° -->
  <div class="stats-row" id="statsRow">
    <div class="stat-card"><div class="stat-label">Ğ¡Ñ‚ÑƒĞ´Ğ¸Ğ¹ Ğ²ÑĞµĞ³Ğ¾</div><div class="stat-value" id="sTotal">â€”</div></div>
    <div class="stat-card"><div class="stat-label">ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…</div><div class="stat-value" id="sActive" style="color:var(--success)">â€”</div></div>
    <div class="stat-card"><div class="stat-label">ĞĞ° Ñ‚Ñ€Ğ¸Ğ°Ğ»Ğµ</div><div class="stat-value" id="sTrial" style="color:var(--primary)">â€”</div></div>
    <div class="stat-card"><div class="stat-label">Ğ˜ÑÑ‚Ñ‘Ğº Ğ´Ğ¾ÑÑ‚ÑƒĞ¿</div><div class="stat-value" id="sExpired" style="color:var(--danger)">â€”</div></div>
    <div class="stat-card"><div class="stat-label">ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¹ Ğº Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ğµ</div><div class="stat-value" id="sCommission" style="color:var(--purple)">â€”</div></div>
  </div>

  <!-- Ğ¢Ğ°Ğ±Ñ‹ -->
  <div class="tabs">
    <button class="tab-btn" onclick="switchTab('requests')">ğŸ“‹ Ğ—Ğ°ÑĞ²ĞºĞ¸ <span id="badgeRequests"></span></button>
    <button class="tab-btn" onclick="switchTab('trial')">ğŸ§ª ĞĞ° Ñ‚ĞµÑÑ‚Ğµ <span id="badgeTrial"></span></button>
    <button class="tab-btn active" onclick="switchTab('studios')">ğŸ¢ Ğ¡Ñ‚ÑƒĞ´Ğ¸Ğ¸</button>
    <button class="tab-btn" onclick="switchTab('referrals')">ğŸ”— Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹</button>
    <button class="tab-btn" onclick="switchTab('commissions')">ğŸ’° ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸</button>
    <button class="tab-btn" onclick="switchTab('calcs')">ğŸ“Š Ğ Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹</button>
    <button class="tab-btn" onclick="switchTab('blacklist')">ğŸš« Ğ‘Ğ»Ğ¾Ğº-Ğ»Ğ¸ÑÑ‚</button>
  </div>

  <!-- Ğ¢Ğ°Ğ±: Ğ—Ğ°ÑĞ²ĞºĞ¸ -->
  <div id="tab-requests" style="display:none">
    <div class="card">
      <div class="card-head"><h2>ĞĞ¾Ğ²Ñ‹Ğµ Ğ·Ğ°ÑĞ²ĞºĞ¸</h2></div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ</th><th>Ğ“Ğ¾Ñ€Ğ¾Ğ´ / Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</th><th>Email</th>
            <th>Ğ”Ğ°Ñ‚Ğ° Ğ·Ğ°ÑĞ²ĞºĞ¸</th><th>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ</th>
          </tr></thead>
          <tbody id="requestsBody"><tr><td colspan="5" style="text-align:center;color:var(--dim)">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ğ¢Ğ°Ğ±: ĞĞ° Ñ‚ĞµÑÑ‚Ğµ -->
  <div id="tab-trial" style="display:none">
    <div class="card">
      <div class="card-head"><h2>Ğ¡Ñ‚ÑƒĞ´Ğ¸Ğ¸ Ğ½Ğ° Ñ‚Ñ€Ğ¸Ğ°Ğ»Ğµ</h2></div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ</th><th>Ğ’Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ†</th><th>Ğ ĞµÑ„. ĞºĞ¾Ğ´</th><th>Ğ¢Ñ€Ğ¸Ğ°Ğ» Ğ¸ÑÑ‚ĞµĞºĞ°ĞµÑ‚</th><th>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</th>
          </tr></thead>
          <tbody id="trialBody"><tr><td colspan="5" style="text-align:center;color:var(--dim)">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ğ¢Ğ°Ğ±: Ğ¡Ñ‚ÑƒĞ´Ğ¸Ğ¸ -->
  <div id="tab-studios">
    <div class="card">
      <div class="card-head">
        <h2>Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑÑ‚ÑƒĞ´Ğ¸Ğ¹</h2>
        <button class="btn btn-primary" onclick="openAddModal()">â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚ÑƒĞ´Ğ¸Ñ</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ</th><th>Ğ ĞµÑ„. ĞºĞ¾Ğ´</th><th>ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°</th><th>Ğ˜ÑÑ‚ĞµĞºĞ°ĞµÑ‚</th><th>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</th>
          </tr></thead>
          <tbody id="studiosBody"><tr><td colspan="5"><div class="empty"><div class="empty-icon">â³</div>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div></td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ğ¢Ğ°Ğ±: Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹ -->
  <div id="tab-referrals" style="display:none">
    <div class="card">
      <div class="card-head"><h2>Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞ²ÑĞ·Ğ¸</h2></div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>ĞšÑ‚Ğ¾ Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ğ»</th><th>ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑˆÑ‘Ğ½Ğ½Ğ°Ñ ÑÑ‚ÑƒĞ´Ğ¸Ñ</th><th>Ğ ĞµÑ„. ĞºĞ¾Ğ´</th><th>Ğ”Ğ°Ñ‚Ğ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸</th><th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸</th>
          </tr></thead>
          <tbody id="referralsBody"><tr><td colspan="5"><div class="empty"><div class="empty-icon">â³</div>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div></td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ğ¢Ğ°Ğ±: ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸ -->
  <div id="tab-commissions" style="display:none">
    <div class="card">
      <div class="card-head">
        <h2>ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸ Ğº Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ğµ</h2>
        <button class="btn btn-success" onclick="markAllPaid()">âœ… ĞÑ‚Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Ğ ĞµÑ„ĞµÑ€Ñ€ĞµÑ€</th><th>Ğ—Ğ° ÑÑ‚ÑƒĞ´Ğ¸Ñ</th><th>Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°</th><th>ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ñ 20%</th><th>Ğ”Ğ°Ñ‚Ğ°</th><th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</th><th>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ</th>
          </tr></thead>
          <tbody id="commissionsBody"><tr><td colspan="7"><div class="empty"><div class="empty-icon">â³</div>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div></td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ğ¢Ğ°Ğ±: Ğ Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹ -->
  <div id="tab-calcs" style="display:none">
    <div class="calcs-toolbar">
      <select id="calcsStudioFilter">
        <option value="">Ğ’ÑĞµ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸</option>
      </select>
      <input type="text" id="calcsSearch" placeholder="ğŸ” ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ°Ğ²Ñ‚Ğ¾...">
      <span id="calcsCount" style="color:var(--muted);font-size:0.78rem;font-weight:600;white-space:nowrap"></span>
      <button class="btn btn-excel" id="btnExcelExport" onclick="exportToExcel()">ğŸ“¥ Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ²ÑĞµ</button>
      <div class="calcs-stats">
        <div class="calcs-stat-pill">
          <div class="s-label">Ğ Ğ°ÑÑ‡Ñ‘Ñ‚Ğ¾Ğ²</div>
          <div class="s-val" id="calcsStatTotal">â€”</div>
        </div>
        <div class="calcs-stat-pill">
          <div class="s-label">Ğ¡ÑƒĞ¼Ğ¼Ğ°</div>
          <div class="s-val" id="calcsStatSum" style="color:var(--purple)">â€”</div>
        </div>
        <div class="calcs-stat-pill">
          <div class="s-label">Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ‡ĞµĞº</div>
          <div class="s-val" id="calcsStatAvg">â€”</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ</th>
            <th>ĞĞ²Ñ‚Ğ¾</th>
            <th>Ğ¡ĞµĞ±ĞµÑÑ‚.</th>
            <th>Ğ˜Ñ‚Ğ¾Ğ³ ĞšĞŸ</th>
            <th>Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ¾</th>
            <th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</th>
            <th>Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ</th>
            <th>Ğ”Ğ°Ñ‚Ğ°</th>
            <th>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</th>
          </tr></thead>
          <tbody id="calcsBody"><tr><td colspan="9" style="text-align:center;color:var(--dim)">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ğ¢Ğ°Ğ±: Ğ‘Ğ»Ğ¾Ğº-Ğ»Ğ¸ÑÑ‚ -->
  <div id="tab-blacklist" style="display:none">
    <div class="card">
      <div class="card-head"><h2>Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸</h2></div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ</th><th>ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</th><th>Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°</th><th>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</th>
          </tr></thead>
          <tbody id="blacklistBody"><tr><td colspan="4" style="text-align:center;color:var(--dim)">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

</div><!-- /.page -->

<!-- ĞœĞ¾Ğ´Ğ°Ğ»ĞºĞ°: ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¾Ğ¹ -->
<div class="modal-overlay" id="subModal">
  <div class="modal">
    <h3 id="subModalTitle">Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¾Ğ¹</h3>
    <div style="font-size:0.8rem;color:var(--muted);margin-bottom:14px" id="subModalStudio"></div>
    <div class="form-group">
      <label>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ</label>
      <select id="subAction">
        <option value="trial">â° ĞŸÑ€Ğ¾Ğ´Ğ»Ğ¸Ñ‚ÑŒ Ñ‚Ñ€Ğ¸Ğ°Ğ» +72 Ñ‡Ğ°ÑĞ°</option>
        <option value="month">ğŸ“… ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ¼ĞµÑÑÑ† (+30 Ğ´Ğ½ĞµĞ¹) â€” 4 900 â‚½</option>
        <option value="year">ğŸ—“ ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ³Ğ¾Ğ´ (+365 Ğ´Ğ½ĞµĞ¹) â€” 51 900 â‚½</option>
        <option value="custom">âœï¸ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ€Ğ¾Ğº</option>
        <option value="block">ğŸš« Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</option>
      </select>
    </div>
    <div class="form-group" id="customDaysGroup" style="display:none">
      <label>ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹</label>
      <input type="number" id="customDays" placeholder="30" min="1" max="3650">
    </div>
    <div id="subModalPayment" style="font-size:0.78rem;color:var(--muted);margin-bottom:4px"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('subModal')">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn btn-primary" id="subSaveBtn" onclick="saveSubscription()">ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<!-- ĞœĞ¾Ğ´Ğ°Ğ»ĞºĞ°: Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚ÑƒĞ´Ğ¸Ñ -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <h3>Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚ÑƒĞ´Ğ¸Ñ</h3>
    <div class="form-group">
      <label>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸</label>
      <input type="text" id="newStudioName" placeholder="Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ Ğ¾ĞºĞ»ĞµĞ¹ĞºĞ¸">
    </div>
    <div class="form-group">
      <label>Email Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ°</label>
      <input type="email" id="newStudioEmail" placeholder="owner@studio.ru">
    </div>
    <div class="form-group">
      <label>Ğ¢Ğ°Ñ€Ğ¸Ñ„</label>
      <select id="newStudioTier">
        <option value="trial">Ğ¢Ñ€Ğ¸Ğ°Ğ» 72Ñ‡</option>
        <option value="active_month">ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ (1 Ğ¼ĞµÑÑÑ†)</option>
        <option value="active_year">ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ (1 Ğ³Ğ¾Ğ´)</option>
      </select>
    </div>
    <div id="addError" style="color:var(--danger);font-size:0.78rem;margin-top:8px;display:none"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addModal')">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn btn-primary" id="addSaveBtn" onclick="saveNewStudio()">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<!-- ĞœĞ¾Ğ´Ğ°Ğ» Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ° -->
<div id="calcViewModal">
  <div class="modal-box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
      <h2 id="calcViewTitle">Ğ Ğ°ÑÑ‡Ñ‘Ñ‚</h2>
      <button onclick="document.getElementById('calcViewModal').classList.remove('active')"
              style="background:none;border:none;font-size:1.4rem;cursor:pointer;color:var(--dim);line-height:1;padding:4px 6px;border-radius:6px;transition:background 0.15s"
              onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='none'">Ã—</button>
    </div>
    <div id="calcViewContent">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
  </div>
</div>

<script src="footer.js"></script>
<script>
(function() {
'use strict';

const ADMIN_USER_ID   = 'c5db87ec-8e4a-4c48-bad3-5747513224d9';
const SUPABASE_URL    = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window._crmSb = sb;

let allStudios   = [];
let allCalcs     = [];
let activeStudioId = null;

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkAdminAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'welcome.html'; return false; }
  if (session.user.id !== ADMIN_USER_ID) {
    document.body.innerHTML = '<div style="text-align:center;padding:60px;font-family:sans-serif"><h2>ğŸš« Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰Ñ‘Ğ½</h2><p style="color:#64748b;margin-top:8px">Ğ­Ñ‚Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°</p><a href="dashboard.html" style="color:#2563eb">â† Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ</a></div>';
    return false;
  }
  document.getElementById('adminBadge').textContent = 'ğŸ‘‘ ' + session.user.email;
  return true;
}

// â”€â”€ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n) {
  return new Intl.NumberFormat('ru-RU').format(n || 0);
}
function fmtDate(d) {
  if (!d) return 'â€”';
  return new Date(d).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', year: 'numeric' });
}
function subStatus(studio) {
  const tier    = studio.subscription_tier;
  const expires = studio.subscription_expires_at;
  const now     = new Date();
  if (tier === 'active') return (!expires || new Date(expires) > now) ? 'active' : 'expired';
  if (tier === 'trial')  return (expires && new Date(expires) > now)  ? 'trial'  : 'expired';
  return 'expired';
}
function subBadge(studio) {
  if (studio.subscription_tier === 'pending') return '<span class="badge badge-pending">ğŸ“‹ Ğ—Ğ°ÑĞ²ĞºĞ°</span>';
  const s      = subStatus(studio);
  const labels = { active: 'âœ… ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°', trial: 'â° Ğ¢Ñ€Ğ¸Ğ°Ğ»', expired: 'âŒ Ğ˜ÑÑ‚ĞµĞºĞ»Ğ°' };
  const cls    = { active: 'badge-active', trial: 'badge-trial', expired: 'badge-expired' };
  return `<span class="badge ${cls[s]}">${labels[s]}</span>`;
}
function expireText(studio) {
  if (!studio.subscription_expires_at) return 'â€”';
  const d    = new Date(studio.subscription_expires_at);
  const days = Math.ceil((d - new Date()) / 86400000);
  const txt  = fmtDate(studio.subscription_expires_at);
  if (days <= 7 && days > 0) return `<span class="expires-soon">âš ï¸ ${txt} (${days}Ğ´)</span>`;
  if (days <= 0) return `<span style="color:var(--danger);font-size:0.78rem">${txt}</span>`;
  return `<span class="expires-text">${txt}</span>`;
}

// â”€â”€ Ğ‘Ğ»Ğ¾Ğº-Ğ»Ğ¸ÑÑ‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadBlacklist() {
  const tbody = document.getElementById('blacklistBody');
  if (tbody) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--dim)">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</td></tr>';

  const { data, error } = await sb.from('studios')
    .select('id, name, settings, subscription_expires_at, created_at')
    .eq('subscription_tier', 'blocked')
    .order('subscription_expires_at', { ascending: false });

  if (error || !data || !data.length) {
    if (tbody) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--dim)">Ğ‘Ğ»Ğ¾Ğº-Ğ»Ğ¸ÑÑ‚ Ğ¿ÑƒÑÑ‚</td></tr>';
    return;
  }

  tbody.innerHTML = data.map(s => `
    <tr>
      <td><strong>${s.name || 'â€”'}</strong><br><small style="color:var(--dim)">${s.settings?.contact_email || ''}</small></td>
      <td style="color:var(--muted);font-size:0.8rem">Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ</td>
      <td style="font-size:0.8rem">${new Date(s.subscription_expires_at).toLocaleDateString('ru')}</td>
      <td><button class="btn btn-warning btn-sm" onclick="unblockStudio(this)" data-id="${s.id}" data-name="${encodeURIComponent(s.name||'')}">â†© Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</button></td>
    </tr>
  `).join('');
}

window.unblockStudio = async function(btn) {
  const studioId = btn.getAttribute('data-id');
  const name     = decodeURIComponent(btn.getAttribute('data-name') || '');
  if (!confirm(`Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ "${name}" Ğ¸ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ² Ğ·Ğ°ÑĞ²ĞºĞ¸?`)) return;
  const { error } = await sb.from('studios').update({ subscription_tier: 'pending', subscription_expires_at: null }).eq('id', studioId);
  if (error) { alert('âŒ ' + error.message); return; }
  await loadStudios(); await loadRequests(); loadBlacklist();
};

// â”€â”€ ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openCalcView = async function(calcId) {
  const modal   = document.getElementById('calcViewModal');
  const content = document.getElementById('calcViewContent');
  const title   = document.getElementById('calcViewTitle');
  modal.classList.add('active');
  content.innerHTML = '<div style="text-align:center;padding:40px;color:var(--dim)">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>';

  const res = await sb.from('calculations').select('*, studios(name)').eq('id', calcId).single();
  if (res.error || !res.data) { content.innerHTML = '<p style="color:var(--danger)">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸</p>'; return; }

  const data = res.data;
  const cd   = data.calculation_data || {};
  const sd   = data.services_detail  || cd.services_detail || {};
  const statusMap    = { new:'ğŸ†• ĞĞ¾Ğ²Ñ‹Ğ¹', scheduled:'ğŸ“… Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ', in_progress:'ğŸ”§ Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ', done:'âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾', delivered:'ğŸš— Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ¾' };
  const sectionNames = { arm:'Ğ‘Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ', det:'Ğ”ĞµÑ‚ĞµĞ¹Ğ»Ğ¸Ğ½Ğ³', gl:'Ğ¡Ñ‚Ñ‘ĞºĞ»Ğ°', ms:'Ğ”Ğ¾Ğ¿.ÑƒÑĞ»ÑƒĞ³Ğ¸', wrap:'ĞĞºĞ»ĞµĞ¹ĞºĞ°' };

  title.textContent = (data.car_name || 'Ğ Ğ°ÑÑ‡Ñ‘Ñ‚') + ' â€” ' + (data.studios ? data.studios.name : '');

  let servicesRows = '';
  if (cd.package) {
    const b = ['wrapMat','wrapMot','prepMat','prepMot','armMat','armMot'].reduce((a,k) => a + (parseFloat(cd.package[k]) || 0), 0);
    if (b > 0) servicesRows += `<tr><td>ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°</td><td>ĞŸĞ°ĞºĞµÑ‚ Ğ²ĞºÑ€ÑƒĞ³</td><td colspan="2">â€”</td><td><b>${fmt(b)} </b></td></tr>`;
  }
  if (cd.impact) {
    const bi = ['wrapMat','wrapMot','prepMat','prepMot','armMat','armMot'].reduce((a,k) => a + (parseFloat(cd.impact[k]) || 0), 0);
    if (bi > 0) servicesRows += `<tr><td>Ğ£Ğ´Ğ°Ñ€Ğ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ</td><td>Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ°</td><td colspan="2">â€”</td><td><b>${fmt(bi)} </b></td></tr>`;
  }
  Object.keys(sd).forEach(key => {
    const items = sd[key];
    if (!items || !items.length) return;
    items.forEach(item => {
      const base = (item.mat || 0) + (item.mot || 0);
      if (base > 0) {
        servicesRows += `<tr><td>${sectionNames[key] || key}</td><td>${item.name || 'â€”'}</td><td>${fmt(item.mat||0)}</td><td>${fmt(item.mot||0)}</td><td><b>${fmt(base)} </b></td></tr>`;
      }
    });
  });

  const grid = `<div class="calc-detail-grid">
    <div class="calc-detail-item"><div class="calc-detail-label">ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ</div><div class="calc-detail-value">${data.car_name || 'â€”'}</div></div>
    <div class="calc-detail-item"><div class="calc-detail-label">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</div><div class="calc-detail-value">${statusMap[data.status] || data.status || 'â€”'}</div></div>
    <div class="calc-detail-item"><div class="calc-detail-label">Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ</div><div class="calc-detail-value">${data.studios ? data.studios.name : 'â€”'}</div></div>
    <div class="calc-detail-item"><div class="calc-detail-label">Ğ”Ğ°Ñ‚Ğ°</div><div class="calc-detail-value">${new Date(data.created_at).toLocaleDateString('ru')}</div></div>
    <div class="calc-detail-item"><div class="calc-detail-label">Ğ¡ĞµĞ±ĞµÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ</div><div class="calc-detail-value">${fmt(data.total_price || 0)}</div></div>
    <div class="calc-detail-item"><div class="calc-detail-label">Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° ĞšĞŸ</div><div class="calc-detail-value accent">${fmt(data.final_price || data.total_price || 0)}</div></div>
    <div class="calc-detail-item"><div class="calc-detail-label">Ğ¡Ğ´Ğ°Ğ½Ğ¾ (Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ°)</div><div class="calc-detail-value" style="color:var(--success)">${data.final_price ? fmt(data.final_price)  : 'â€”'}</div></div>
    <div class="calc-detail-item"><div class="calc-detail-label">Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ</div><div class="calc-detail-value">${data.work_assigned ? 'âœ… Ğ”Ğ°' : 'â€”'}</div></div>
  </div>`;

  const table = servicesRows
    ? `<div class="calc-services-list"><table><thead><tr><th>Ğ‘Ğ»Ğ¾Ğº</th><th>Ğ£ÑĞ»ÑƒĞ³Ğ°</th><th>ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ñ‹</th><th>ĞœĞ¾Ñ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ñ</th><th>Ğ˜Ñ‚Ğ¾Ğ³Ğ¾</th></tr></thead><tbody>${servicesRows}</tbody></table></div>`
    : '<p style="color:var(--dim);font-size:0.85rem;margin-bottom:14px">Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°</p>';

  content.innerHTML = grid + table;

  const closeDiv = document.createElement('div');
  closeDiv.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-top:12px';
  const openBtn = document.createElement('a');
  openBtn.className = 'btn btn-primary';
  openBtn.href = `calculator.html?load=${calcId}`;
  openBtn.target = '_blank';
  openBtn.textContent = 'ğŸ“‚ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ² ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€Ğµ';
  const closeBtn = document.createElement('button');
  closeBtn.className = 'btn btn-ghost';
  closeBtn.textContent = 'Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ';
  closeBtn.onclick = () => modal.classList.remove('active');
  closeDiv.appendChild(openBtn);
  closeDiv.appendChild(closeBtn);
  content.appendChild(closeDiv);
};

// â”€â”€ Ğ Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCalcs() {
  const tbody = document.getElementById('calcsBody');
  if (tbody) tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;color:var(--dim)">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</td></tr>`;

  const { data, error } = await sb
    .from('calculations')
    .select('id, car_name, total_price, final_price, status, work_assigned, created_at, studio_id, studios(name)')
    .order('created_at', { ascending: false })
    .limit(1000);

  if (error) { console.error('loadCalcs error:', error); return; }
  allCalcs = data || [];

  // Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ ÑÑ‚ÑƒĞ´Ğ¸Ğ¹
  const filter = document.getElementById('calcsStudioFilter');
  if (filter) {
    const studios = [...new Map(allCalcs.map(c => [c.studio_id, c.studios?.name || c.studio_id])).entries()];
    studios.forEach(([id, name]) => {
      const o = document.createElement('option');
      o.value = id; o.textContent = name;
      filter.appendChild(o);
    });
    filter.addEventListener('change', renderCalcs);
  }
  const search = document.getElementById('calcsSearch');
  if (search) search.addEventListener('input', renderCalcs);

  renderCalcs();
}

function renderCalcs() {
  const studioFilter = document.getElementById('calcsStudioFilter')?.value || '';
  const searchVal    = (document.getElementById('calcsSearch')?.value || '').toLowerCase();

  let filtered = allCalcs.filter(c => {
    if (studioFilter && c.studio_id !== studioFilter) return false;
    if (searchVal && !(c.car_name || '').toLowerCase().includes(searchVal)) return false;
    return true;
  });

  const total = filtered.length;
  const sum   = filtered.reduce((a, c) => a + (c.final_price || c.total_price || 0), 0);
  const avg   = total > 0 ? sum / total : 0;

  document.getElementById('calcsStatTotal').textContent = total;
  document.getElementById('calcsStatSum').textContent   = fmt(sum) ;
  document.getElementById('calcsStatAvg').textContent   = fmt(avg) ;
  document.getElementById('calcsCount').textContent     = `ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¾: ${total}`;

  const statusLabel = {
    new: 'ğŸ†• ĞĞ¾Ğ²Ñ‹Ğ¹', scheduled: 'ğŸ“… Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ', in_progress: 'ğŸ”§ Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ',
    done: 'âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾', delivered: 'ğŸš— Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ¾', draft: 'ğŸ“ Ğ§ĞµÑ€Ğ½Ğ¾Ğ²Ğ¸Ğº'
  };

  const tbody = document.getElementById('calcsBody');
  if (!tbody) return;
  if (!filtered.length) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;color:var(--dim)">Ğ Ğ°ÑÑ‡Ñ‘Ñ‚Ğ¾Ğ² Ğ½ĞµÑ‚</td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(c => `
    <tr>
      <td><strong>${c.studios?.name || 'â€”'}</strong></td>
      <td>${c.car_name || 'â€”'}</td>
      <td style="color:var(--muted)">${fmt(c.total_price || 0)}</td>
      <td style="color:var(--purple);font-weight:700">${fmt(c.final_price || c.total_price || 0)}</td>
      <td style="color:var(--success);font-weight:700">${c.final_price ? fmt(c.final_price)  : 'â€”'}</td>
      <td><span style="font-size:0.75rem">${statusLabel[c.status] || c.status || 'â€”'}</span></td>
      <td style="text-align:center"><input type="checkbox" class="work-check" ${c.work_assigned ? 'checked' : ''} title="${c.work_assigned ? 'Ğ£ÑˆĞ»Ğ¾ Ğ² Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ' : 'ĞĞµ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¾'}"></td>
      <td style="color:var(--dim);font-size:0.78rem;white-space:nowrap">${new Date(c.created_at).toLocaleDateString('ru')}</td>
      <td style="white-space:nowrap">
        <button class="btn btn-ghost btn-sm" onclick="openCalcView('${c.id}')" title="ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€">ğŸ”</button>
        <button class="btn btn-ghost btn-sm" onclick="exportOneCalc('${c.id}')" title="Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Excel" style="margin-left:2px">ğŸ“¥</button>
      </td>
    </tr>
  `).join('');
}

// â”€â”€ Excel ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcToRow(c) {
  const statusMap = {
    new: 'ĞĞ¾Ğ²Ñ‹Ğ¹', scheduled: 'Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ', in_progress: 'Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ',
    done: 'Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾', delivered: 'Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ¾', draft: 'Ğ§ĞµÑ€Ğ½Ğ¾Ğ²Ğ¸Ğº', cancelled: 'ĞÑ‚ĞºĞ°Ğ·'
  };
  return {
    'Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ':        c.studios?.name || 'â€”',
    'ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ':    c.car_name || 'â€”',
    'Ğ¡ĞµĞ±ĞµÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ': c.total_price || 0,
    'Ğ˜Ñ‚Ğ¾Ğ³ ĞšĞŸ':       c.final_price || c.total_price || 0,
    'Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ¾':        c.final_price || '',
    'Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ':        statusMap[c.status] || c.status || 'â€”',
    'Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ':      c.work_assigned ? 'Ğ”Ğ°' : 'ĞĞµÑ‚',
    'Ğ”Ğ°Ñ‚Ğ°':          new Date(c.created_at).toLocaleDateString('ru-RU'),
    'ID':            c.id,
  };
}

function writeXlsx(rows, filename) {
  if (!rows.length) { alert('ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ°'); return; }
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Ğ Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹');
  ws['!cols'] = [
    {wch:22},{wch:24},{wch:16},{wch:14},{wch:14},{wch:14},{wch:10},{wch:14},{wch:36}
  ];
  XLSX.writeFile(wb, filename);
}

window.exportToExcel = function() {
  const studioFilter = document.getElementById('calcsStudioFilter')?.value || '';
  const searchVal    = (document.getElementById('calcsSearch')?.value || '').toLowerCase();

  const filtered = allCalcs.filter(c => {
    if (studioFilter && c.studio_id !== studioFilter) return false;
    if (searchVal && !(c.car_name || '').toLowerCase().includes(searchVal)) return false;
    return true;
  });

  const studioName = studioFilter
    ? (allCalcs.find(c => c.studio_id === studioFilter)?.studios?.name || 'ÑÑ‚ÑƒĞ´Ğ¸Ñ')
    : 'Ğ²ÑĞµ-ÑÑ‚ÑƒĞ´Ğ¸Ğ¸';
  const date = new Date().toISOString().slice(0,10);

  writeXlsx(filtered.map(calcToRow), `keep1r-${studioName}-${date}.xlsx`);
};

window.exportOneCalc = function(calcId) {
  const c = allCalcs.find(x => x.id === calcId);
  if (!c) { alert('Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½'); return; }
  const carName = (c.car_name || 'Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚').replace(/[^\w\-Ğ°-ÑÑ‘Ğ-Ğ¯Ğ ]/gi, '').trim();
  const date    = new Date(c.created_at).toISOString().slice(0,10);
  writeXlsx([calcToRow(c)], `keep1r-${carName}-${date}.xlsx`);
};

// â”€â”€ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAll() {
  await Promise.all([loadStudios(), loadCommissions()]);
  await loadRequests();
}

async function loadRequests() {
  let accessReqs = [], pendingStudios = [];
  try {
    const [r1, r2] = await Promise.all([
      sb.from('access_requests').select('*').order('created_at', { ascending: false }),
      sb.from('studios').select('*').in('subscription_tier', ['pending']).order('created_at', { ascending: false })
    ]);
    accessReqs     = r1.data || [];
    pendingStudios = r2.data || [];
  } catch(e) {
    try {
      const { data } = await sb.from('studios').select('*').in('subscription_tier', ['pending']).order('created_at', { ascending: false });
      pendingStudios = data || [];
    } catch(e2) { console.error(e2); }
  }

  const totalNew = accessReqs.filter(r => r.status === 'new').length + pendingStudios.length;
  const badge = document.getElementById('badgeRequests');
  if (badge) badge.textContent = totalNew > 0 ? '(' + totalNew + ')' : '';
  const sNew = document.getElementById('sNewRequests');
  if (sNew) sNew.textContent = totalNew;

  const tbody = document.getElementById('requestsBody');
  if (!tbody) return;
  if (!accessReqs.length && !pendingStudios.length) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--dim)">Ğ—Ğ°ÑĞ²Ğ¾Ğº Ğ½ĞµÑ‚</td></tr>';
    return;
  }

  const rows = [];

  pendingStudios.forEach(s => {
    rows.push(`<tr>
      <td><div class="studio-name">${s.name || 'â€”'}</div></td>
      <td style="font-size:0.8rem">${s.settings?.city || 'â€”'} / ${s.settings?.phone || 'â€”'}</td>
      <td style="font-size:0.8rem">${s.settings?.contact_email || 'â€”'}</td>
      <td style="font-size:0.78rem;color:var(--dim)">${fmtDate(s.created_at)}</td>
      <td>
        <div class="actions">
          <button class="btn btn-success btn-sm" onclick="approveStudio('${s.id}','${s.name}')">âœ… ĞĞ´Ğ¾Ğ±Ñ€Ğ¸Ñ‚ÑŒ</button>
          <button class="btn btn-danger btn-sm" onclick="blockStudio('${s.id}','${s.name}')">ğŸš« Ğ‘Ğ»Ğ¾Ğº</button>
        </div>
      </td>
    </tr>`);
  });

  accessReqs.filter(r => r.status === 'new').forEach(r => {
    rows.push(`<tr>
      <td><div class="studio-name">${r.studio_name || 'â€”'}</div></td>
      <td style="font-size:0.8rem">${r.city || 'â€”'} / ${r.phone || 'â€”'}</td>
      <td style="font-size:0.8rem">${r.email || 'â€”'}</td>
      <td style="font-size:0.78rem;color:var(--dim)">${fmtDate(r.created_at)}</td>
      <td>
        <div class="actions">
          <button class="btn btn-success btn-sm" onclick="approveRequest('${r.id}')">âœ… ĞĞ´Ğ¾Ğ±Ñ€Ğ¸Ñ‚ÑŒ</button>
          <button class="btn btn-danger btn-sm" onclick="rejectRequest('${r.id}')">âŒ ĞÑ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ñ‚ÑŒ</button>
        </div>
      </td>
    </tr>`);
  });

  tbody.innerHTML = rows.join('');
}

window.approveRequest = async function(id) {
  if (!confirm('ĞĞ´Ğ¾Ğ±Ñ€Ğ¸Ñ‚ÑŒ Ğ·Ğ°ÑĞ²ĞºÑƒ?')) return;
  await sb.from('access_requests').update({ status: 'approved' }).eq('id', id);
  const { data: req } = await sb.from('access_requests').select('*').eq('id', id).single();
  if (req?.supabase_user_id) {
    const refCode   = Math.random().toString(36).substring(2,10).toUpperCase();
    const trialEnds = new Date(Date.now() + 72 * 3600 * 1000).toISOString();
    const { data: studio } = await sb.from('studios').insert({
      name: req.studio_name, owner_id: req.supabase_user_id,
      subscription_tier: 'trial', subscription_expires_at: trialEnds,
      referral_code: refCode,
      settings: { phone: req.phone, city: req.city, contact_email: req.email }
    }).select('id').single();
    if (studio) {
      await sb.from('studio_members').insert({ studio_id: studio.id, user_id: req.supabase_user_id, role: 'owner', is_active: true });
    }
  }
  alert('âœ… Ğ—Ğ°ÑĞ²ĞºĞ° Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ°! Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°, Ñ‚Ñ€Ğ¸Ğ°Ğ» 72 Ñ‡Ğ°ÑĞ°.');
  loadRequests(); loadStudios();
};

window.rejectRequest = async function(id) {
  if (!confirm('ĞÑ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ñ‚ÑŒ Ğ·Ğ°ÑĞ²ĞºÑƒ?')) return;
  await sb.from('access_requests').update({ status: 'rejected' }).eq('id', id);
  loadRequests();
};

async function loadStudios() {
  const { data, error } = await sb
    .from('studios')
    .select('id, name, owner_id, subscription_tier, subscription_expires_at, referral_code, referred_by_studio_id, created_at, settings')
    .order('created_at', { ascending: false });

  if (error) { console.error(error); return; }
  allStudios = data || [];

  let active = 0, trial = 0, expired = 0;
  allStudios.forEach(s => {
    const st = subStatus(s);
    if (st === 'active') active++;
    else if (st === 'trial') trial++;
    else expired++;
  });

  document.getElementById('sTotal').textContent   = allStudios.length;
  const pending = allStudios.filter(s => s.subscription_tier === 'pending').length;
  if (pending > 0) document.getElementById('sTotal').textContent = allStudios.length + ' (' + pending + ' ğŸ“‹)';
  document.getElementById('sActive').textContent  = active;
  document.getElementById('sTrial').textContent   = trial;
  document.getElementById('sExpired').textContent = expired;

  renderStudios(); renderTrialStudios(); renderReferrals();
}

async function loadCommissions() {
  const { data, error } = await sb
    .from('referral_commissions')
    .select('*, referrer:referrer_studio_id(name), referred:referred_studio_id(name)')
    .order('created_at', { ascending: false });

  if (error) { console.error(error); return; }
  const comms = data || [];
  const pending = comms.filter(c => !c.paid_to_referrer).reduce((s, c) => s + Number(c.amount), 0);
  document.getElementById('sCommission').textContent = fmt(pending);
  renderCommissions(comms);
}

function renderTrialStudios() {
  const trial = allStudios.filter(s => s.subscription_tier === 'trial');
  const badge = document.getElementById('badgeTrial');
  if (badge) badge.textContent = trial.length > 0 ? `(${trial.length})` : '';
  const tbody = document.getElementById('trialBody');
  if (!tbody) return;
  if (!trial.length) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--dim)">ĞĞµÑ‚ ÑÑ‚ÑƒĞ´Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµÑÑ‚Ğµ</td></tr>';
    return;
  }
  tbody.innerHTML = trial.map(s => {
    const exp       = s.subscription_expires_at ? new Date(s.subscription_expires_at) : null;
    const now       = new Date();
    const hoursLeft = exp ? Math.round((exp - now) / 3600000) : null;
    const expText   = exp
      ? (hoursLeft > 0
          ? `<span style="color:${hoursLeft < 12 ? 'var(--danger)' : 'var(--warning)'}">â° ${hoursLeft}Ñ‡ Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ</span>`
          : `<span style="color:var(--danger)">âš ï¸ Ğ˜ÑÑ‚Ñ‘Ğº</span>`)
      : 'â€”';
    const owner = s.owner_id ? s.owner_id.substring(0,8)+'...' : 'Ğ½ĞµÑ‚ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ°';
    return `<tr>
      <td><strong>${s.name || 'â€”'}</strong><br><small style="color:var(--dim)">${s.settings?.phone || ''} ${s.settings?.city || ''}</small></td>
      <td style="font-size:0.78rem">${s.settings?.contact_email || owner}</td>
      <td><span class="ref-code">${s.referral_code || 'â€”'}</span></td>
      <td>${expText}</td>
      <td>
        <div class="actions">
          <button class="btn btn-success btn-sm" onclick="extendTrial('${s.id}','${s.name}')">+72Ñ‡</button>
          <button class="btn btn-ghost btn-sm" onclick="openSubModal('${s.id}')">ğŸ’³ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°</button>
          <button class="btn btn-danger btn-sm" onclick="blockStudio('${s.id}','${s.name}')">ğŸš«</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

window.extendTrial = async function(studioId, name) {
  const trialEnds = new Date(Date.now() + 72 * 3600 * 1000).toISOString();
  const { error } = await sb.from('studios').update({ subscription_expires_at: trialEnds }).eq('id', studioId);
  if (error) { alert('âŒ ' + error.message); return; }
  alert('âœ… Ğ¢Ñ€Ğ¸Ğ°Ğ» Ğ¿Ñ€Ğ¾Ğ´Ğ»Ñ‘Ğ½ Ğ½Ğ° 72 Ñ‡Ğ°ÑĞ°');
  await loadStudios();
};

function renderStudios() {
  const tbody = document.getElementById('studiosBody');
  if (!allStudios.length) {
    tbody.innerHTML = '<tr><td colspan="5"><div class="empty"><div class="empty-icon">ğŸ¢</div>ĞĞµÑ‚ ÑÑ‚ÑƒĞ´Ğ¸Ğ¹</div></td></tr>';
    return;
  }
  tbody.innerHTML = allStudios.map(s => `
    <tr>
      <td>
        <div class="studio-name">${s.name}</div>
        <div class="studio-email" id="email-${s.id}">Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
        ${s.settings?.phone ? `<div style="font-size:0.72rem;color:var(--primary);margin-top:1px">${s.settings.phone}</div>` : `<div style="font-size:0.72rem;color:var(--dim);margin-top:1px" id="phone-${s.id}"></div>`}
        ${s.settings?.city ? `<div style="font-size:0.72rem;color:var(--muted)">${s.settings.city}</div>` : ''}
      </td>
      <td>${s.referral_code ? `<span class="ref-code">${s.referral_code}</span>` : `<button class="btn btn-ghost btn-sm" onclick="genRefCode('${s.id}')">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ</button>`}</td>
      <td>${subBadge(s)}</td>
      <td>${expireText(s)}</td>
      <td>
        <div class="actions">
          <button class="btn btn-primary btn-sm" onclick="openSubModal('${s.id}')">âš™ï¸ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°</button>
          <button class="btn btn-danger btn-sm" onclick="blockStudio('${s.id}','${s.name}')">ğŸš«</button>
        </div>
      </td>
    </tr>
  `).join('');

  allStudios.forEach(async s => {
    const { data } = await sb.from('studio_members').select('user_id, role').eq('studio_id', s.id).eq('role', 'owner').single();
    const el = document.getElementById(`email-${s.id}`);
    if (!el) return;
    if (data) {
      el.textContent = data.user_id.slice(0, 8) + '...';
      const phone = s.settings?.phone;
      if (phone) { const phoneEl = document.getElementById('phone-' + s.id); if (phoneEl) phoneEl.textContent = phone; }
    } else { el.textContent = 'Ğ½ĞµÑ‚ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ°'; }
  });
}

function renderReferrals() {
  const tbody    = document.getElementById('referralsBody');
  const referred = allStudios.filter(s => s.referred_by_studio_id);
  if (!referred.length) {
    tbody.innerHTML = '<tr><td colspan="5"><div class="empty"><div class="empty-icon">ğŸ”—</div>Ğ ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¹ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚</div></td></tr>';
    return;
  }
  tbody.innerHTML = referred.map(s => {
    const referrer = allStudios.find(r => r.id === s.referred_by_studio_id);
    return `<tr>
      <td><div class="studio-name">${referrer ? referrer.name : 'â€”'}</div></td>
      <td><div class="studio-name">${s.name}</div></td>
      <td>${referrer ? `<span class="ref-code">${referrer.referral_code || 'â€”'}</span>` : 'â€”'}</td>
      <td>${fmtDate(s.created_at)}</td>
      <td>${subBadge(s)}</td>
    </tr>`;
  }).join('');
}

function renderCommissions(comms) {
  const tbody = document.getElementById('commissionsBody');
  if (!comms.length) {
    tbody.innerHTML = '<tr><td colspan="7"><div class="empty"><div class="empty-icon">ğŸ’°</div>ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¹ Ğ½ĞµÑ‚</div></td></tr>';
    return;
  }
  tbody.innerHTML = comms.map(c => `
    <tr>
      <td><div class="studio-name">${c.referrer?.name || 'â€”'}</div></td>
      <td><div class="studio-name">${c.referred?.name || 'â€”'}</div></td>
      <td>${fmt(c.payment_amount)}</td>
      <td><strong>${fmt(c.amount)}</strong></td>
      <td>${fmtDate(c.payment_date)}</td>
      <td>${c.paid_to_referrer ? `<span class="badge badge-paid">âœ… Ğ’Ñ‹Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾ ${fmtDate(c.paid_date)}</span>` : `<span class="badge badge-pending">â³ ĞĞ¶Ğ¸Ğ´Ğ°ĞµÑ‚</span>`}</td>
      <td>${!c.paid_to_referrer ? `<button class="btn btn-success btn-sm" onclick="markCommissionPaid('${c.id}')">Ğ’Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ÑŒ</button>` : 'â€”'}</td>
    </tr>
  `).join('');
}

// â”€â”€ ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ñ‚Ğ°Ğ±Ğ¾Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.switchTab = function(tab) {
  ['requests','trial','studios','referrals','commissions','calcs','blacklist'].forEach(t => {
    const el = document.getElementById('tab-' + t);
    if (el) el.style.display = t === tab ? 'block' : 'none';
  });
  document.querySelectorAll('.tab-btn').forEach(btn => {
    const onclick = btn.getAttribute('onclick') || '';
    btn.classList.toggle('active', onclick.includes("'" + tab + "'"));
  });
  if (tab === 'calcs' && !window._calcsLoaded) { window._calcsLoaded = true; loadCalcs(); }
  if (tab === 'blacklist') loadBlacklist();
};

// â”€â”€ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openSubModal = function(studioId) {
  activeStudioId = studioId;
  const studio = allStudios.find(s => s.id === studioId);
  document.getElementById('subModalTitle').textContent    = 'ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°: ' + studio.name;
  document.getElementById('subModalStudio').textContent   = 'Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ: ' + subStatus(studio).toUpperCase() + ' Â· ' + expireText(studio).replace(/<[^>]+>/g, '');
  document.getElementById('subAction').value = 'month';
  updatePaymentHint();
  document.getElementById('subModal').classList.add('active');
};

document.getElementById('subAction').addEventListener('change', updatePaymentHint);
function updatePaymentHint() {
  const action = document.getElementById('subAction').value;
  const hint   = document.getElementById('subModalPayment');
  const customGroup = document.getElementById('customDaysGroup');
  customGroup.style.display = action === 'custom' ? 'block' : 'none';
  const hints = { trial: '72 Ñ‡Ğ°ÑĞ° Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°', month: 'ĞĞ¿Ğ»Ğ°Ñ‚Ğ° 4 900', year: 'ĞĞ¿Ğ»Ğ°Ñ‚Ğ° 51 900', custom: 'ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ€Ğ¾Ğº Ğ±ĞµĞ· ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸', block: 'ĞĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿' };
  hint.textContent = hints[action] || '';
}

window.saveSubscription = async function() {
  const action = document.getElementById('subAction').value;
  const btn    = document.getElementById('subSaveBtn');
  btn.disabled = true; btn.textContent = 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼...';
  try {
    const studio = allStudios.find(s => s.id === activeStudioId);
    const now    = new Date();
    const base   = studio.subscription_expires_at && new Date(studio.subscription_expires_at) > now ? new Date(studio.subscription_expires_at) : now;
    let tier, expires, paymentAmount = 0;
    if (action === 'trial')        { tier = 'trial';  expires = new Date(now.getTime() + 72 * 3600 * 1000).toISOString(); }
    else if (action === 'month')   { tier = 'active'; expires = new Date(base.getTime() + 30 * 86400000).toISOString(); paymentAmount = 4900; }
    else if (action === 'year')    { tier = 'active'; expires = new Date(base.getTime() + 365 * 86400000).toISOString(); paymentAmount = 51900; }
    else if (action === 'custom')  {
      const days = parseInt(document.getElementById('customDays').value);
      if (!days || days < 1) { alert('Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ½ĞµĞ¹'); btn.disabled = false; btn.textContent = 'ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ'; return; }
      tier = 'active'; expires = new Date(base.getTime() + days * 86400000).toISOString();
    } else if (action === 'block') {
      if (!confirm(`Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚ÑƒĞ´Ğ¸Ñ "${studio.name}"?`)) { btn.disabled = false; btn.textContent = 'ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ'; return; }
      tier = 'expired'; expires = now.toISOString();
    }
    const { error } = await sb.from('studios').update({ subscription_tier: tier, subscription_expires_at: expires }).eq('id', activeStudioId);
    if (error) throw error;
    if (paymentAmount > 0 && studio.referred_by_studio_id) {
      await sb.from('referral_commissions').insert({
        referrer_studio_id: studio.referred_by_studio_id, referred_studio_id: activeStudioId,
        amount: Math.round(paymentAmount * 0.2), payment_amount: paymentAmount,
        payment_date: new Date().toISOString().split('T')[0], paid_to_referrer: false
      });
    }
    closeModal('subModal'); await loadAll();
  } catch (e) { alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + e.message); }
  finally { btn.disabled = false; btn.textContent = 'ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ'; }
};

window.approveStudio = async function(studioId, name) {
  if (!confirm(`ĞĞ´Ğ¾Ğ±Ñ€Ğ¸Ñ‚ÑŒ Ğ·Ğ°ÑĞ²ĞºÑƒ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸ "${name}" Ğ¸ Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ±Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğ½Ğ° 72 Ñ‡Ğ°ÑĞ°?`)) return;
  const trialEnds = new Date(Date.now() + 72 * 3600 * 1000).toISOString();
  const { data, error } = await sb.from('studios').update({ subscription_tier: 'trial', subscription_expires_at: trialEnds }).eq('id', studioId).select('id, subscription_tier, subscription_expires_at');
  if (error) { alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° RLS/DB: ' + error.message); return; }
  if (!data || data.length === 0) { alert('âš ï¸ RLS Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ» Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ â€” Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ² SQL Editor.'); return; }
  alert(`âœ… Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ "${name}" Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ°!\nĞ¢Ñ€Ğ¸Ğ°Ğ» Ğ´Ğ¾: ${new Date(trialEnds).toLocaleString('ru')}`);
  await loadStudios(); switchTab('trial');
};

window.blockStudio = async function(studioId, name) {
  if (!confirm('Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚ÑƒĞ´Ğ¸Ñ "'+name+'" Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² Ğ±Ğ»Ğ¾Ğº-Ğ»Ğ¸ÑÑ‚?')) return;
  const { error } = await sb.from('studios').update({ subscription_tier: 'blocked', subscription_expires_at: new Date().toISOString() }).eq('id', studioId);
  if (error) { alert('âŒ ' + error.message); return; }
  await loadStudios(); await loadRequests();
};

window.genRefCode = async function(studioId) {
  const code = Math.random().toString(36).substring(2, 10).toUpperCase();
  await sb.from('studios').update({ referral_code: code }).eq('id', studioId);
  await loadStudios();
};

window.openAddModal = function() {
  document.getElementById('newStudioName').value = '';
  document.getElementById('newStudioEmail').value = '';
  document.getElementById('newStudioTier').value = 'trial';
  document.getElementById('addError').style.display = 'none';
  document.getElementById('addModal').classList.add('active');
};

window.saveNewStudio = async function() {
  const name  = document.getElementById('newStudioName').value.trim();
  const email = document.getElementById('newStudioEmail').value.trim();
  const tier  = document.getElementById('newStudioTier').value;
  const btn   = document.getElementById('addSaveBtn');
  const errEl = document.getElementById('addError');
  if (!name || !email) { errEl.textContent = 'Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ'; errEl.style.display = 'block'; return; }
  btn.disabled = true; btn.textContent = 'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼...'; errEl.style.display = 'none';
  try {
    const now = new Date();
    let expiresAt, subTier;
    if (tier === 'trial')        { subTier = 'trial';  expiresAt = new Date(now.getTime() + 72 * 3600 * 1000).toISOString(); }
    else if (tier === 'active_month') { subTier = 'active'; expiresAt = new Date(now.getTime() + 30 * 86400000).toISOString(); }
    else                         { subTier = 'active'; expiresAt = new Date(now.getTime() + 365 * 86400000).toISOString(); }
    const refCode = Math.random().toString(36).substring(2, 10).toUpperCase();
    const { data: studio, error: studioErr } = await sb.from('studios').insert({
      name, subscription_tier: subTier, subscription_expires_at: expiresAt,
      referral_code: refCode, settings: { contact_email: email }
    }).select('id').single();
    if (studioErr) throw studioErr;
    const inviteLink = `${window.location.origin}/welcome.html?studio=${studio.id}`;
    alert(`âœ… Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ "${name}" ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°!\n\nĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ ÑÑÑ‹Ğ»ĞºÑƒ:\n${inviteLink}`);
    closeModal('addModal'); await loadStudios();
  } catch (e) { errEl.textContent = 'ĞÑˆĞ¸Ğ±ĞºĞ°: ' + e.message; errEl.style.display = 'block'; }
  finally { btn.disabled = false; btn.textContent = 'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ'; }
};

window.markCommissionPaid = async function(id) {
  await sb.from('referral_commissions').update({ paid_to_referrer: true, paid_date: new Date().toISOString().split('T')[0] }).eq('id', id);
  await loadCommissions();
};

window.markAllPaid = async function() {
  if (!confirm('ĞÑ‚Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ½ĞµĞ¾Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸ ĞºĞ°Ğº Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ?')) return;
  await sb.from('referral_commissions').update({ paid_to_referrer: true, paid_date: new Date().toISOString().split('T')[0] }).eq('paid_to_referrer', false);
  await loadCommissions();
};

window.closeModal = function(id) { document.getElementById(id).classList.remove('active'); };
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
});

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  initNav({ hideAction: true });
  const ok = await checkAdminAuth();
  if (!ok) return;
  await loadAll();
  switchTab('requests');
}

init();
})();
</script>

</body>
</html>
