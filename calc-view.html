<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ â€” Keep1R CRM</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link rel="stylesheet" href="nav.css">
<script src="nav.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --font: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
  --bg: #eef2f9; --card: #fff;
  --border: rgba(15,23,42,0.10); --text: #0f172a;
  --muted: #64748b; --primary: #2563eb; --success: #059669;
  --purple: #7c3aed; --warning: #f59e0b; --danger: #dc2626;
  --radius: 14px;
}
body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100svh; -webkit-font-smoothing: antialiased; }
.container { max-width: 960px; margin: 0 auto; padding: 24px 20px 80px; }

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 22px; flex-wrap: wrap; gap: 12px; }
.page-title  { font-size: 1.35rem; font-weight: 900; letter-spacing: -0.4px; }
.page-sub    { font-size: 0.8rem; color: var(--muted); margin-top: 4px; }
.status-badge {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 3px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;
  margin-top: 6px;
}
.status-new        { background: #f1f5f9; color: #64748b; }
.status-scheduled  { background: #fef3c7; color: #92400e; }
.status-in_progress{ background: #dbeafe; color: #1e40af; }
.status-done       { background: #ede9fe; color: #5b21b6; }
.status-delivered  { background: #d1fae5; color: #065f46; }

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn { display: inline-flex; align-items: center; gap: 6px; padding: 9px 16px; border-radius: 9px; border: none; font-size: 0.83rem; font-weight: 700; cursor: pointer; font-family: var(--font); transition: all 0.15s; white-space: nowrap; }
.btn-secondary { background: #f1f5f9; color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover { background: #e2e8f0; }
.btn-primary   { background: var(--primary); color: #fff; }
.btn-primary:hover { background: #1d4ed8; }
.btn-success   { background: var(--success); color: #fff; }
.btn-success:hover { background: #047857; }
.btn-dark      { background: #0f172a; color: #fff; }
.btn-dark:hover { background: #1e293b; }
.btn-warning   { background: #f59e0b; color: #fff; }
.btn-warning:hover { background: #d97706; }
.btn-danger    { background: var(--danger); color: #fff; }
.btn-danger:hover { background: #b91c1c; }
.btn-group     { display: flex; gap: 8px; flex-wrap: wrap; }

/* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card { background: var(--card); border-radius: var(--radius); border: 1px solid var(--border); box-shadow: 0 1px 4px rgba(0,0,0,0.06); margin-bottom: 14px; overflow: hidden; }
.card-head { padding: 12px 18px 10px; border-bottom: 1px solid var(--border); font-size: 0.74rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); background: #f8fafc; display: flex; align-items: center; justify-content: space-between; }
.card-body { padding: 16px 18px; }

/* â”€â”€ Info grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.info-grid { display: grid; grid-template-columns: repeat(3, 1fr); }
.info-cell { padding: 10px 14px; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); }
.info-cell:nth-child(3n) { border-right: none; }
.info-cell:nth-last-child(-n+3) { border-bottom: none; }
.info-label { font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); margin-bottom: 3px; }
.info-value { font-size: 0.9rem; font-weight: 600; }
.info-value.empty { color: var(--muted); font-weight: 400; font-style: italic; }
.info-value.accent { color: var(--primary); }
.info-value.success { color: var(--success); }
@media (max-width: 540px) { .info-grid { grid-template-columns: 1fr 1fr; } }

/* â”€â”€ Block sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.block-section { margin-bottom: 2px; }
.block-title { font-size: 0.84rem; font-weight: 800; color: var(--text); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }

.detail-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
.detail-table th { text-align: left; padding: 6px 10px; background: #f8fafc; font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; color: var(--muted); border-bottom: 1.5px solid var(--border); }
.detail-table td { padding: 8px 10px; border-bottom: 1px solid var(--border); vertical-align: middle; }
.detail-table tr:last-child td { border-bottom: none; }
.detail-table .subtotal-row td { font-weight: 700; background: #f8fafc; color: var(--text); }
.right { text-align: right; white-space: nowrap; }
.muted-num { color: var(--muted); font-size: 0.78rem; }

/* Editable input */
.edit-input {
  display: none; width: 100%; padding: 4px 8px; border: 1.5px solid var(--primary);
  border-radius: 6px; font-size: 0.82rem; font-family: var(--font);
  color: var(--text); background: #eff6ff; text-align: right; outline: none;
}
body.editing .edit-input  { display: block; }
body.editing .view-val    { display: none; }

/* â”€â”€ Financials â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fin-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
.fin-cell { background: #fff; padding: 12px 14px; text-align: center; }
.fin-label { font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; color: var(--muted); margin-bottom: 4px; }
.fin-value { font-size: 1rem; font-weight: 800; }
.fin-value.big { font-size: 1.4rem; letter-spacing: -0.5px; }
.fin-value.green { color: var(--success); }
.fin-value.purple { color: var(--purple); }
.fin-value.blue { color: var(--primary); }
@media (max-width: 600px) { .fin-grid { grid-template-columns: 1fr 1fr; } }

/* â”€â”€ Executors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.exec-pill { display: inline-flex; align-items: center; gap: 3px; padding: 2px 9px; border-radius: 20px; background: rgba(37,99,235,0.08); color: #1e40af; font-size: 0.74rem; font-weight: 700; margin: 2px; }
.exec-pill.admin { background: rgba(124,58,237,0.08); color: #6d28d9; }

/* â”€â”€ Edit mode banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#editBanner { display: none; padding: 11px 18px; background: #fef3c7; border: 1.5px solid #fde68a; border-radius: 10px; margin-bottom: 14px; font-size: 0.84rem; color: #78350f; font-weight: 600; align-items: center; gap: 10px; }
body.editing #editBanner { display: flex; }
#editBanner .spacer { flex: 1; }

/* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#loadingMsg { text-align: center; padding: 60px 20px; color: var(--muted); font-size: 1rem; }
#errMsg     { display: none; text-align: center; padding: 40px; color: var(--danger); }

/* â•â• PRINT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media print {
  * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  body { background: #fff !important; }
  #navTopBar, .no-print, #editBanner { display: none !important; }
  .container { padding: 0 !important; max-width: 100% !important; }
  .card { box-shadow: none !important; border: 1px solid #e2e8f0 !important; margin-bottom: 8px !important; break-inside: avoid; }
  .card-head { background: #f1f5f9 !important; padding: 7px 12px 6px !important; }
  .card-body { padding: 10px 12px !important; }
  .fin-grid { background: #e2e8f0 !important; }
  .fin-cell { padding: 8px 10px !important; }
  @page { margin: 15mm; size: A4; }
}

/* â”€â”€ Print header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#printHeader { display: none; align-items: center; justify-content: space-between; padding-bottom: 12px; border-bottom: 2.5px solid #0f172a; margin-bottom: 16px; gap: 16px; }
#ph-logo { max-height: 48px; max-width: 120px; object-fit: contain; }
.ph-doc-title { font-size: 1.1rem; font-weight: 900; text-transform: uppercase; text-align: center; }
.ph-doc-sub   { font-size: 0.76rem; color: var(--muted); text-align: center; margin-top: 2px; }
.ph-right { text-align: right; }
.ph-studio-name { font-size: 0.9rem; font-weight: 800; }
.ph-studio-info { font-size: 0.72rem; color: var(--muted); line-height: 1.5; }
@media print { #printHeader { display: flex !important; } }
</style>
</head>
<body>

<div id="navTopBar">
  <a href="board.html" class="nav-brand">Keep1R CRM</a>
  <div class="nav-links">
    <a href="board.html" class="nav-link">ğŸ“‹ Ğ”Ğ¾ÑĞºĞ°</a>
    <span class="nav-link active">ğŸ“Š Ğ Ğ°ÑÑ‡Ñ‘Ñ‚</span>
  </div>
  <div class="nav-right"></div>
</div>

<div class="container">

  <!-- Print header -->
  <div id="printHeader">
    <img id="ph-logo" src="" alt="" style="display:none">
    <div>
      <div class="ph-doc-title">Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ·Ğ°ĞºĞ°Ğ·Ğ°</div>
      <div class="ph-doc-sub" id="ph-sub"></div>
    </div>
    <div class="ph-right">
      <div class="ph-studio-name" id="ph-name"></div>
      <div class="ph-studio-info" id="ph-info"></div>
    </div>
  </div>

  <div id="loadingMsg">â³ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚â€¦</div>
  <div id="errMsg">âŒ Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. <a href="board.html">â† Ğ”Ğ¾ÑĞºĞ°</a></div>

  <!-- Edit mode banner -->
  <div id="editBanner">
    âœï¸ Ğ ĞµĞ¶Ğ¸Ğ¼ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ â€” Ğ¸Ğ·Ğ¼ĞµĞ½ÑĞ¹Ñ‚Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¿Ñ€ÑĞ¼Ğ¾ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ
    <span class="spacer"></span>
    <button class="btn btn-success" onclick="saveEdits()">ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
    <button class="btn btn-secondary" onclick="cancelEdits()">âœ• ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
  </div>

  <div id="mainContent" style="display:none">

    <!-- Screen header -->
    <div class="page-header no-print">
      <div>
        <div class="page-title" id="pageTitle">â€”</div>
        <div class="page-sub" id="pageSub"></div>
        <div id="statusBadge"></div>
      </div>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="history.back()">â† ĞĞ°Ğ·Ğ°Ğ´</button>
        <button class="btn btn-secondary" onclick="window.location.href='acceptance-act.html?calc_id='+calcId">ğŸ“„ ĞĞºÑ‚ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ĞºĞ¸</button>
        <button class="btn btn-secondary" onclick="window.location.href='work-order.html?calc_id='+calcId">ğŸ–¨ï¸ Ğ—Ğ°ĞºĞ°Ğ·-Ğ½Ğ°Ñ€ÑĞ´</button>
        <button class="btn btn-success" onclick="exportExcel()">ğŸ“¥ Excel</button>
        <button class="btn btn-dark" onclick="window.print()">ğŸ“„ PDF</button>
        <button class="btn btn-warning" id="btnEdit" onclick="startEdit()" style="display:none">âœï¸ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</button>
      </div>
    </div>

    <!-- â‘  ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ -->
    <div class="card">
      <div class="card-head">ğŸš— ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚</div>
      <div class="card-body" style="padding:0">
        <div class="info-grid" id="carGrid"></div>
      </div>
    </div>

    <!-- â‘¡ Ğ Ğ°Ğ±Ğ¾Ñ‚Ñ‹ -->
    <div class="card" id="servicesCard">
      <div class="card-head">ğŸ”§ ĞŸĞµÑ€ĞµÑ‡ĞµĞ½ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚</div>
      <div class="card-body" id="servicesBody"></div>
    </div>

    <!-- â‘¢ Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑÑ‹ -->
    <div class="card">
      <div class="card-head">ğŸ’° Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ¸Ñ‚Ğ¾Ğ³</div>
      <div class="card-body">
        <div class="fin-grid" id="finGrid"></div>
      </div>
    </div>

    <!-- â‘£ Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ğ¸ -->
    <div class="card" id="execCard" style="display:none">
      <div class="card-head">ğŸ‘¥ Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ğ¸</div>
      <div class="card-body">
        <table class="detail-table">
          <thead><tr>
            <th>Ğ˜Ğ¼Ñ</th>
            <th>Ğ£ÑĞ»ÑƒĞ³Ğ°</th>
            <th class="right">Ğ—ĞŸ Ğ¿Ğ»Ğ°Ğ½</th>
            <th class="right">Ğ—ĞŸ Ñ„Ğ°ĞºÑ‚</th>
          </tr></thead>
          <tbody id="execBody"></tbody>
        </table>
      </div>
    </div>

  </div><!-- /mainContent -->
</div>

<script src="footer.js"></script>
<script>
(function(){
'use strict';

const SUPABASE_URL      = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let currentStudio = null;
let calcData = null; // full calculation row
window.calcId = null;
let isAdmin = false;
let originalFormData = null; // for cancel

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n) { return new Intl.NumberFormat('ru-RU').format(Math.round(n||0)); }
function fmtDate(s) { if(!s) return 'â€”'; return new Date(s).toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit',year:'numeric'}); }
function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function p(v) { return parseFloat(v||0)||0; }

const STATUS_MAP = {
  new:         { label:'Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´Ñ‘Ğ½',    cls:'status-new' },
  scheduled:   { label:'ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ° Ğ´Ğ°Ñ‚Ğ°',        cls:'status-scheduled' },
  in_progress: { label:'ĞŸÑ€Ğ¸Ğ½ÑÑ‚Ğ¾ Ğ² Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ',      cls:'status-in_progress' },
  done:        { label:'Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾',             cls:'status-done' },
  delivered:   { label:'Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ¾',               cls:'status-delivered' },
};

const PAY_MAP = { cash:'ğŸ’µ ĞĞ°Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ', card:'ğŸ’³ ĞšĞ°Ñ€Ñ‚Ğ° / Ğ˜ĞŸ (+13%)', ooo:'ğŸ¢ ĞĞĞ (+22%)' };

// â”€â”€ Auth & Studio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkAuth() {
  const { data:{ session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'welcome.html'; return false; }
  currentUser = session.user;
  return true;
}

async function loadStudio() {
  const { data: m } = await sb.from('studio_members')
    .select('studio_id, role').eq('user_id', currentUser.id).eq('is_active', true).single();
  if (!m) return;
  isAdmin = m.role === 'admin' || m.role === 'owner';
  const { data: s } = await sb.from('studios').select('name, settings').eq('id', m.studio_id).single();
  if (!s) return;
  currentStudio = { ...m, studioName: s.name, settings: s.settings||{} };

  // Print header
  document.getElementById('ph-name').textContent = s.name||'';
  const cfg = s.settings||{};
  const lines = [cfg.phone||cfg.kp_phone, [cfg.city,cfg.address].filter(Boolean).join(', '), cfg.website||cfg.kp_website].filter(Boolean);
  document.getElementById('ph-info').innerHTML = lines.map(esc).join('<br>');
  if (cfg.kp_logo) { const img=document.getElementById('ph-logo'); img.src=cfg.kp_logo; img.style.display='block'; }

  // Show edit button for admins
  if (isAdmin) document.getElementById('btnEdit').style.display = '';
}

// â”€â”€ Compute block totals from raw formData â”€â”€â”€â”€â”€â”€â”€â”€
function computeBlock(block, markupPct, taxK) {
  if (!block) return null;
  const mat = p(block.wrapMat) + p(block.prepMat) + p(block.armMat);
  const mot = p(block.wrapMot) + p(block.prepMot) + p(block.armMot);
  // extra costs
  const extraMat = (block.costs||[]).reduce((s,c) => s + p(c.value), 0);
  const base     = mat + mot + extraMat;
  if (base === 0) return null;
  const markup   = Math.round(base * (p(markupPct)||0) / 100);
  const subtotal = base + markup;
  return { mat: mat + extraMat, mot, base, markup, subtotal,
    rows: [
      { name: 'ĞĞºĞ»ĞµĞ¹ĞºĞ°',       mat: p(block.wrapMat), mot: p(block.wrapMot) },
      { name: 'ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ°',    mat: p(block.prepMat), mot: p(block.prepMot) },
      { name: 'ĞÑ€Ğ¼Ğ°Ñ‚ÑƒÑ€Ğ½Ñ‹Ğµ',    mat: p(block.armMat),  mot: p(block.armMot) },
    ].filter(r => r.mat + r.mot > 0)
  };
}

function computeServiceDetail(items, markupPct) {
  if (!items || !items.length) return null;
  const markup = p(markupPct)||0;
  const rows = items.filter(d => p(d.mat) + p(d.mot) > 0);
  if (!rows.length) return null;
  const base    = rows.reduce((s,d) => s + p(d.mat) + p(d.mot), 0);
  const markupAmt = Math.round(base * markup / 100);
  return { rows, base, markup: markupAmt, subtotal: base + markupAmt };
}

// â”€â”€ Render car info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCarInfo(calc) {
  const cd = calc.calculation_data||{};
  const car = cd.car||{};
  const st = STATUS_MAP[calc.status]||{ label: calc.status||'â€”', cls:'status-new' };

  document.getElementById('pageTitle').textContent = calc.car_name || 'Ğ Ğ°ÑÑ‡Ñ‘Ñ‚';
  document.getElementById('pageSub').textContent   = `Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½: ${fmtDate(calc.created_at)}`;
  document.getElementById('ph-sub').textContent    = calc.car_name||'';
  document.getElementById('statusBadge').innerHTML = `<span class="status-badge ${st.cls}">${st.label}</span>`;
  document.title = (calc.car_name||'Ğ Ğ°ÑÑ‡Ñ‘Ñ‚') + ' â€” Keep1R';

  const cells = [
    { label:'ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ',     value: calc.car_name||'â€”' },
    { label:'Ğ“Ğ¾Ğ´',            value: car.year||calc.year||'â€”' },
    { label:'Ğ”Ğ°Ñ‚Ğ° Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ĞºĞ¸',   value: fmtDate(calc.checkin_date||calc.created_at) },
    { label:'Ğ“Ğ¾Ñ. Ğ½Ğ¾Ğ¼ĞµÑ€',     value: cd.plate||'â€”' },
    { label:'VIN / ĞºÑƒĞ·Ğ¾Ğ²',    value: cd.vin||'â€”' },
    { label:'ĞšĞ»Ğ¸ĞµĞ½Ñ‚',         value: cd.client_name||cd.clientName||'â€”' },
    { label:'Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹',   value: PAY_MAP[cd.paymentMode||''] || 'â€”' },
    { label:'Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ',         value: st.label },
    { label:'Ğ”Ğ°Ñ‚Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ',  value: fmtDate(calc.created_at) },
  ];

  document.getElementById('carGrid').innerHTML = cells.map(c => `
    <div class="info-cell">
      <div class="info-label">${c.label}</div>
      <div class="info-value${c.value==='â€”'?' empty':''}">${esc(c.value)}</div>
    </div>`).join('');
}

// â”€â”€ Render services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderServices(calc) {
  const cd  = calc.calculation_data||{};
  const mu  = cd.markups||{};
  const sd  = cd.services_detail || cd.servicesDetail || {};
  const taxK = cd.paymentMode==='card' ? 0.13 : cd.paymentMode==='ooo' ? 0.22 : 0;
  const body = document.getElementById('servicesBody');

  const sections = [];

  // â”€â”€ ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ²ĞºÑ€ÑƒĞ³ â”€â”€
  const pkg = computeBlock(cd.package, cd.package?.markup, taxK);
  if (pkg) sections.push({ icon:'ğŸ“¦', title:'ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ²ĞºÑ€ÑƒĞ³', data: pkg, editKey: 'package' });

  // â”€â”€ Ğ£Ğ´Ğ°Ñ€Ğ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ â”€â”€
  const imp = computeBlock(cd.impact, cd.impact?.markup, taxK);
  if (imp) sections.push({ icon:'ğŸ›¡ï¸', title:'Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° ÑƒĞ´Ğ°Ñ€Ğ½Ğ¾Ğ¹ Ñ‡Ğ°ÑÑ‚Ğ¸', data: imp, editKey: 'impact' });

  // â”€â”€ ĞÑ€Ğ¼Ğ°Ñ‚ÑƒÑ€Ğ½Ñ‹Ğµ (Ğ¸Ğ· services_detail) â”€â”€
  const arm = computeServiceDetail(sd.arm, mu.arm);
  if (arm) sections.push({ icon:'ğŸ”©', title:'ĞÑ€Ğ¼Ğ°Ñ‚ÑƒÑ€Ğ½Ñ‹Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹', data: arm, editKey: 'arm' });

  // â”€â”€ ĞĞºĞ»ĞµĞ¹ĞºĞ° â”€â”€
  const wrap = computeServiceDetail(sd.wrap, mu.wrap);
  if (wrap) sections.push({ icon:'ğŸ¨', title:'ĞĞºĞ»ĞµĞ¹ĞºĞ° Ğ¿Ğ»Ñ‘Ğ½ĞºĞ¾Ğ¹', data: wrap, editKey: 'wrap' });

  // â”€â”€ Ğ”ĞµÑ‚ĞµĞ¹Ğ»Ğ¸Ğ½Ğ³ â”€â”€
  const det = computeServiceDetail(sd.det, mu.det);
  if (det) sections.push({ icon:'âœ¨', title:'Ğ”ĞµÑ‚ĞµĞ¹Ğ»Ğ¸Ğ½Ğ³', data: det, editKey: 'det' });

  // â”€â”€ ĞŸĞ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° / Ğ¥Ğ¸Ğ¼Ñ‡Ğ¸ÑÑ‚ĞºĞ° â”€â”€
  const gl = computeServiceDetail(sd.gl, mu.gl);
  if (gl) sections.push({ icon:'ğŸ’', title:'ĞŸĞ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° / Ğ¥Ğ¸Ğ¼Ñ‡Ğ¸ÑÑ‚ĞºĞ°', data: gl, editKey: 'gl' });

  // â”€â”€ ĞŸÑ€Ğ¾Ñ‡ĞµĞµ â”€â”€
  const ms = computeServiceDetail(sd.ms, mu.misc);
  if (ms) sections.push({ icon:'ğŸ“‹', title:'ĞŸÑ€Ğ¾Ñ‡Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹', data: ms, editKey: 'ms' });

  if (sections.length === 0) {
    body.innerHTML = '<div style="color:var(--muted);font-style:italic;font-size:0.84rem">Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ğ±Ğ»Ğ¾ĞºĞ°Ğ¼ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° â€” Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ½Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸ÑÑŒ Ğ² Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğµ.</div>';
    return;
  }

  body.innerHTML = sections.map(sec => `
    <div class="block-section" style="margin-bottom:20px">
      <div class="block-title">${sec.icon} ${sec.title}
        <span style="margin-left:auto;font-size:0.78rem;font-weight:700;color:var(--primary)">${fmt(sec.data.subtotal)} â‚½</span>
      </div>
      <table class="detail-table">
        <thead><tr>
          <th>ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ñ</th>
          <th class="right">ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ñ‹</th>
          <th class="right">ĞœĞ¾Ñ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ñ</th>
          <th class="right">Ğ˜Ñ‚Ğ¾Ğ³Ğ¾</th>
        </tr></thead>
        <tbody>
          ${sec.data.rows.map(r => `<tr>
            <td>${esc(r.name||r[0]||'â€”')}</td>
            <td class="right">
              <span class="view-val muted-num">${fmt(r.mat||r[1]||0)} â‚½</span>
              <input class="edit-input" data-field="mat" data-sec="${sec.editKey}" data-name="${esc(r.name||r[0]||'')}" value="${Math.round(r.mat||r[1]||0)}">
            </td>
            <td class="right">
              <span class="view-val muted-num">${fmt(r.mot||r[2]||0)} â‚½</span>
              <input class="edit-input" data-field="mot" data-sec="${sec.editKey}" data-name="${esc(r.name||r[0]||'')}" value="${Math.round(r.mot||r[2]||0)}">
            </td>
            <td class="right"><strong>${fmt((r.mat||r[1]||0)+(r.mot||r[2]||0))} â‚½</strong></td>
          </tr>`).join('')}
          <tr class="subtotal-row">
            <td>ĞĞ°Ñ†ĞµĞ½ĞºĞ° ${cd[sec.editKey]?.markup || mu[sec.editKey] || 0}%</td>
            <td colspan="2" class="right muted-num">${fmt(sec.data.markup)} â‚½</td>
            <td class="right" style="color:var(--success)">${fmt(sec.data.subtotal)} â‚½</td>
          </tr>
        </tbody>
      </table>
    </div>`).join('<hr style="border:none;border-top:1px solid var(--border);margin:4px 0 20px">');
}

// â”€â”€ Render financials â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFinancials(calc) {
  const cd   = calc.calculation_data||{};
  const taxK = cd.paymentMode==='card' ? 0.13 : cd.paymentMode==='ooo' ? 0.22 : 0;
  const total = calc.final_price || calc.total_price || 0;

  // Try to get base/markup from stored data or estimate
  const sd  = cd.services_detail||{};
  const mu  = cd.markups||{};
  let baseCmp = 0, markupCmp = 0;

  // Sum up block bases from computeBlock / computeServiceDetail
  const tryBlock = (block, mkp) => {
    const b = computeBlock(block, mkp);
    if (b) { baseCmp += b.base; markupCmp += b.markup; }
  };
  const trySvc = (items, mkp) => {
    const s = computeServiceDetail(items, mkp);
    if (s) { baseCmp += s.base; markupCmp += s.markup; }
  };
  tryBlock(cd.package, cd.package?.markup);
  tryBlock(cd.impact,  cd.impact?.markup);
  trySvc(sd.arm, mu.arm); trySvc(sd.wrap, mu.wrap);
  trySvc(sd.det, mu.det); trySvc(sd.gl,  mu.gl);
  trySvc(sd.ms,  mu.misc);

  const afterMarkup = baseCmp + markupCmp;
  const tax = taxK > 0 ? Math.round(afterMarkup * taxK) : 0;

  const cells = [
    { label:'Ğ¡ĞµĞ±ĞµÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ', value: fmt(baseCmp||Math.round(total/(1+taxK)/1.3)) + ' â‚½', cls: '' },
    { label:'ĞĞ°Ñ†ĞµĞ½ĞºĞ°',       value: fmt(markupCmp) + ' â‚½',                                cls:'purple' },
    { label:'ĞĞ°Ğ»Ğ¾Ğ³',         value: tax > 0 ? fmt(tax) + ' â‚½' : 'â€”',                     cls:'' },
    { label:'Ğ˜Ñ‚Ğ¾Ğ³Ğ¾ Ğº Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ',value: fmt(total) + ' â‚½',                                   cls:'big green' },
  ];

  document.getElementById('finGrid').innerHTML = cells.map(c => `
    <div class="fin-cell">
      <div class="fin-label">${c.label}</div>
      <div class="fin-value ${c.cls}">${c.value}</div>
    </div>`).join('');

  // Final price if delivered
  if (calc.final_price && calc.status === 'delivered') {
    document.getElementById('finGrid').innerHTML += `
      <div class="fin-cell" style="grid-column:1/-1;background:#f0fdf4">
        <div class="fin-label">Ğ¤Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾ (Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğµ)</div>
        <div class="fin-value big green">${fmt(calc.final_price)} â‚½</div>
      </div>`;
  }
}

// â”€â”€ Render executors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderExecutors() {
  const { data: assigns } = await sb.from('work_assignments')
    .select('executor_name, service_name, salary, is_admin_sale, admin_percent, status')
    .eq('calculation_id', window.calcId);

  if (!assigns || assigns.length === 0) return;
  document.getElementById('execCard').style.display = '';

  const isPaid = calcData.status === 'delivered';
  const finalPrice = calcData.final_price || 0;

  document.getElementById('execBody').innerHTML = assigns.map(a => {
    const isAdminSale = !!a.is_admin_sale;
    const planSalary  = a.salary || 0;
    const factSalary  = (isPaid && isAdminSale && a.admin_percent)
      ? Math.round(finalPrice * a.admin_percent / 100)
      : planSalary;
    return `<tr>
      <td>
        <span class="exec-pill${isAdminSale?' admin':''}">
          ${isAdminSale ? 'ğŸ‘”' : 'ğŸ‘¤'} ${esc(a.executor_name||'â€”')}
        </span>
      </td>
      <td style="font-size:0.82rem;color:var(--muted)">${esc(a.service_name || (isAdminSale ? `ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶Ğ° (${a.admin_percent}%)` : 'â€”'))}</td>
      <td class="right"><strong>${fmt(planSalary)} â‚½</strong></td>
      <td class="right" style="color:${factSalary!==planSalary?'var(--success)':'var(--muted)'}">
        ${factSalary !== planSalary ? '<strong>' + fmt(factSalary) + ' â‚½</strong>' : 'â€”'}
      </td>
    </tr>`;
  }).join('');
}

// â”€â”€ Edit mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.startEdit = function() {
  originalFormData = JSON.parse(JSON.stringify(calcData.calculation_data||{}));
  document.body.classList.add('editing');
};

window.cancelEdits = function() {
  document.body.classList.remove('editing');
};

window.saveEdits = async function() {
  const cd  = JSON.parse(JSON.stringify(calcData.calculation_data||{}));
  const sd  = cd.services_detail || {};
  const mu  = cd.markups || {};

  // Collect edited values from inputs
  document.querySelectorAll('.edit-input').forEach(inp => {
    const sec  = inp.dataset.sec;
    const field= inp.dataset.field; // mat or mot
    const name = inp.dataset.name;
    const val  = parseFloat(inp.value)||0;

    if (sec === 'package' || sec === 'impact') {
      const block = cd[sec] || {};
      if (name === 'ĞĞºĞ»ĞµĞ¹ĞºĞ°')    { if (field==='mat') block.wrapMat = val; else block.wrapMot = val; }
      if (name === 'ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ°') { if (field==='mat') block.prepMat = val; else block.prepMot = val; }
      if (name === 'ĞÑ€Ğ¼Ğ°Ñ‚ÑƒÑ€Ğ½Ñ‹Ğµ') { if (field==='mat') block.armMat  = val; else block.armMot  = val; }
      cd[sec] = block;
    } else {
      // services_detail
      const items = sd[sec] || [];
      const item  = items.find(d => d.name === name);
      if (item) { item[field] = val; }
      sd[sec] = items;
    }
  });

  cd.services_detail = sd;

  // Recalculate total_price
  const taxK = cd.paymentMode==='card' ? 0.13 : cd.paymentMode==='ooo' ? 0.22 : 0;
  let base = 0, markup = 0;
  const tryB = (block, mkp) => { const r = computeBlock(block, mkp); if(r){base+=r.base;markup+=r.markup;} };
  const tryS = (items, mkp) => { const r = computeServiceDetail(items, mkp); if(r){base+=r.base;markup+=r.markup;} };
  tryB(cd.package, cd.package?.markup); tryB(cd.impact, cd.impact?.markup);
  tryS(sd.arm, mu.arm); tryS(sd.wrap, mu.wrap); tryS(sd.det, mu.det); tryS(sd.gl, mu.gl); tryS(sd.ms, mu.misc);
  const afterMarkup = base + markup;
  const tax          = Math.round(afterMarkup * taxK);
  const newTotal     = afterMarkup + tax;

  const { error } = await sb.from('calculations')
    .update({ calculation_data: cd, total_price: newTotal, updated_at: new Date().toISOString() })
    .eq('id', window.calcId);

  if (error) { alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ: ' + error.message); return; }

  // Reload
  window.location.reload();
};

// â”€â”€ Excel export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.exportExcel = function() {
  const cd   = calcData.calculation_data||{};
  const sd   = cd.services_detail||{};
  const mu   = cd.markups||{};
  const car  = cd.car||{};
  const wb   = XLSX.utils.book_new();

  // Sheet 1: Summary
  const summaryData = [
    ['ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ', calcData.car_name||'â€”'],
    ['Ğ“Ğ¾Ğ´', car.year||'â€”'],
    ['Ğ“Ğ¾Ñ. Ğ½Ğ¾Ğ¼ĞµÑ€', cd.plate||'â€”'],
    ['VIN', cd.vin||'â€”'],
    ['ĞšĞ»Ğ¸ĞµĞ½Ñ‚', cd.client_name||cd.clientName||'â€”'],
    ['Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹', PAY_MAP[cd.paymentMode]||'â€”'],
    ['Ğ˜Ñ‚Ğ¾Ğ³Ğ¾ Ğº Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ', calcData.final_price||calcData.total_price||0],
    ['Ğ”Ğ°Ñ‚Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ', fmtDate(calcData.created_at)],
    ['Ğ”Ğ°Ñ‚Ğ° Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ĞºĞ¸',  fmtDate(calcData.checkin_date)],
  ];

  // Sheet 2: Services
  const servRows = [['Ğ‘Ğ»Ğ¾Ğº','ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ñ','ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ñ‹','ĞœĞ¾Ñ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ñ','Ğ˜Ñ‚Ğ¾Ğ³Ğ¾','ĞĞ°Ñ†ĞµĞ½ĞºĞ°','Ğ˜Ñ‚Ğ¾Ğ³Ğ¾ Ñ Ğ½Ğ°Ñ†ĞµĞ½ĞºĞ¾Ğ¹']];
  const addBlock = (title, block, mkp) => {
    const b = computeBlock(block, mkp);
    if (!b) return;
    b.rows.forEach(r => servRows.push([title, r.name, r.mat, r.mot, r.mat+r.mot, '', '']));
    servRows.push([title, 'Ğ˜Ğ¢ĞĞ“Ğ Ğ±Ğ»Ğ¾ĞºĞ°', b.mat, b.mot, b.base, b.markup, b.subtotal]);
  };
  const addSvc = (title, items, mkp) => {
    const s = computeServiceDetail(items, mkp);
    if (!s) return;
    s.rows.forEach(r => servRows.push([title, r.name||r[0], r.mat||r[1]||0, r.mot||r[2]||0, (r.mat||r[1]||0)+(r.mot||r[2]||0), '', '']));
    servRows.push([title, 'Ğ˜Ğ¢ĞĞ“Ğ Ğ±Ğ»Ğ¾ĞºĞ°', '', '', s.base, s.markup, s.subtotal]);
  };
  addBlock('ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°', cd.package, cd.package?.markup);
  addBlock('Ğ£Ğ´Ğ°Ñ€Ğ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ', cd.impact,  cd.impact?.markup);
  addSvc('ĞÑ€Ğ¼Ğ°Ñ‚ÑƒÑ€Ğ½Ñ‹Ğµ',  sd.arm,  mu.arm);
  addSvc('ĞĞºĞ»ĞµĞ¹ĞºĞ°',     sd.wrap, mu.wrap);
  addSvc('Ğ”ĞµÑ‚ĞµĞ¹Ğ»Ğ¸Ğ½Ğ³',   sd.det,  mu.det);
  addSvc('ĞŸĞ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°',   sd.gl,   mu.gl);
  addSvc('ĞŸÑ€Ğ¾Ñ‡ĞµĞµ',      sd.ms,   mu.misc);

  const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
  const ws2 = XLSX.utils.aoa_to_sheet(servRows);
  ws1['!cols'] = [{wch:22},{wch:28}];
  ws2['!cols'] = [{wch:18},{wch:26},{wch:14},{wch:14},{wch:14},{wch:14},{wch:18}];
  XLSX.utils.book_append_sheet(wb, ws1, 'Ğ Ğ°ÑÑ‡Ñ‘Ñ‚');
  XLSX.utils.book_append_sheet(wb, ws2, 'Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ');

  const safeCarName = (calcData.car_name||'Ğ Ğ°ÑÑ‡Ñ‘Ñ‚').replace(/[/\\?*\[\]:]/g,'');
  XLSX.writeFile(wb, `${safeCarName}.xlsx`);
};

// â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function init() {
  if (!await checkAuth()) return;

  const params = new URLSearchParams(window.location.search);
  window.calcId = params.get('id');

  const loading = document.getElementById('loadingMsg');
  const errMsg  = document.getElementById('errMsg');
  const content = document.getElementById('mainContent');

  if (!window.calcId) {
    loading.style.display = 'none'; errMsg.style.display = '';
    errMsg.textContent = 'âŒ ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½ ID Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ°.'; return;
  }

  await loadStudio();

  const [calcRes] = await Promise.all([
    sb.from('calculations').select('*').eq('id', window.calcId).single()
  ]);

  if (calcRes.error || !calcRes.data) {
    loading.style.display = 'none'; errMsg.style.display = ''; return;
  }

  calcData = calcRes.data;

  renderCarInfo(calcData);
  renderServices(calcData);
  renderFinancials(calcData);
  await renderExecutors();

  loading.style.display = 'none';
  content.style.display = '';
  if (window.initNav) window.initNav({ activePage: 'calc-view.html' });
})();

})();
</script>
</body>
</html>
