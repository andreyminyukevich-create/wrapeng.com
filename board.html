<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ â€” Keep1R CRM</title>
<script>document.documentElement.setAttribute('data-theme','light');</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="nav.css">
<script src="nav.js"></script>
<style>
:root {
  --font:         -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
  --bg:           #eef2f9;
  --surface:      #ffffff;
  --border:       rgba(15,23,42,0.08);
  --border-focus: rgba(37,99,235,0.35);
  --text:         #0f172a;
  --text-muted:   #64748b;
  --text-dim:     #94a3b8;
  --primary:      #2563eb;
  --primary-dark: #1d4ed8;
  --success:      #059669;
  --warning:      #d97706;
  --danger:       #dc2626;
  --purple:       #7c3aed;
  --shadow:       0 1px 3px rgba(0,0,0,0.05), 0 4px 16px rgba(0,0,0,0.07);
  --shadow-modal: 0 8px 40px rgba(0,0,0,0.14);
  --radius:       14px;
  --radius-sm:    10px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  font-family: var(--font);
  -webkit-font-smoothing: antialiased;
  background: var(--bg);
  color: var(--text);
  overflow-x: hidden;
}

/* â”€â”€ Board layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.board-page {
  display: flex;
  flex-direction: column;
  min-height: 100svh;
}

.board-outer {
  flex: 1;
  overflow-x: auto;
  padding: 20px 20px 32px;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
  scrollbar-color: rgba(37,99,235,0.2) transparent;
}

.board-outer::-webkit-scrollbar       { height: 6px; }
.board-outer::-webkit-scrollbar-track { background: transparent; }
.board-outer::-webkit-scrollbar-thumb { background: rgba(37,99,235,0.18); border-radius: 3px; }

.board-wrap {
  display: flex;
  gap: 14px;
  align-items: flex-start;
  min-width: max-content;
}

/* â”€â”€ Column â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.column {
  width: 272px;
  flex-shrink: 0;
  background: var(--surface);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  max-height: calc(100svh - 110px);
  box-shadow: var(--shadow);
}

.column-header {
  padding: 14px 16px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  border-radius: var(--radius) var(--radius) 0 0;
  position: sticky;
  top: 0;
  background: var(--surface);
  z-index: 1;
}

.column-title {
  display: flex;
  align-items: center;
  gap: 7px;
  font-weight: 700;
  font-size: 0.82rem;
  letter-spacing: 0.01em;
  text-transform: uppercase;
}

.column-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.column-count {
  font-size: 0.7rem;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 20px;
  background: var(--bg);
  color: var(--text-muted);
  min-width: 24px;
  text-align: center;
}

.column-cards {
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 7px;
  overflow-y: auto;
  flex: 1;
  scrollbar-width: thin;
  scrollbar-color: rgba(0,0,0,0.08) transparent;
}

/* â”€â”€ Column accent colours â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.col-new .column-dot        { background: #94a3b8; }
.col-new .column-title      { color: #64748b; }
.col-new .column-count      { background: rgba(148,163,184,0.12); }

.col-scheduled .column-dot   { background: #f59e0b; }
.col-scheduled .column-title { color: #92400e; }
.col-scheduled .column-count { background: rgba(245,158,11,0.1); color: #b45309; }
.col-scheduled              { border-top: 3px solid #f59e0b; border-radius: var(--radius); }

.col-in_progress .column-dot   { background: var(--primary); }
.col-in_progress .column-title { color: var(--primary); }
.col-in_progress .column-count { background: rgba(37,99,235,0.08); color: var(--primary); }
.col-in_progress               { border-top: 3px solid var(--primary); border-radius: var(--radius); }

.col-done .column-dot   { background: var(--purple); }
.col-done .column-title { color: var(--purple); }
.col-done .column-count { background: rgba(124,58,237,0.08); color: var(--purple); }
.col-done               { border-top: 3px solid var(--purple); border-radius: var(--radius); }

.col-delivered .column-dot   { background: var(--success); }
.col-delivered .column-title { color: #065f46; }
.col-delivered .column-count { background: rgba(5,150,105,0.08); color: var(--success); }
.col-delivered               { border-top: 3px solid var(--success); border-radius: var(--radius); }

/* â”€â”€ Kanban card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kanban-card {
  background: #f8fafc;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px 13px;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s, border-color 0.15s, background 0.15s;
}

.kanban-card:hover {
  background: var(--surface);
  border-color: rgba(37,99,235,0.3);
  box-shadow: 0 3px 14px rgba(37,99,235,0.09);
  transform: translateY(-2px);
}

.card-car {
  font-weight: 700;
  font-size: 0.88rem;
  margin-bottom: 5px;
  letter-spacing: -0.2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text);
}

.card-checkin {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 0.7rem;
  font-weight: 700;
  padding: 2px 7px;
  border-radius: 5px;
  background: rgba(217,119,6,0.08);
  color: #b45309;
  border: 1px solid rgba(217,119,6,0.18);
  margin-bottom: 6px;
}

.card-note {
  font-size: 0.72rem;
  color: var(--text-muted);
  line-height: 1.4;
  margin-bottom: 6px;
  font-style: italic;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.card-price {
  font-size: 0.98rem;
  font-weight: 800;
  color: var(--success);
  letter-spacing: -0.4px;
  margin-bottom: 9px;
}

.card-actions {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.card-btn {
  width: 100%;
  padding: 7px 10px;
  border-radius: 7px;
  font-size: 0.78rem;
  font-weight: 700;
  cursor: pointer;
  border: none;
  transition: all 0.15s;
  font-family: var(--font);
  text-align: center;
  letter-spacing: -0.1px;
}

.card-btn-primary {
  background: var(--primary);
  color: #fff;
}
.card-btn-primary:hover { background: var(--primary-dark); }

.card-btn-secondary {
  background: var(--bg);
  color: var(--text-muted);
  border: 1px solid var(--border);
}
.card-btn-secondary:hover { color: var(--text); border-color: rgba(37,99,235,0.25); background: #fff; }

.empty-col {
  text-align: center;
  padding: 28px 12px;
  color: var(--text-dim);
  font-size: 0.78rem;
}

/* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.5);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal.active { display: flex; animation: fadeIn 0.15s ease; }

@keyframes fadeIn {
  from { opacity: 0; }
  to   { opacity: 1; }
}

.modal-content {
  background: var(--surface);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  padding: 28px 28px 24px;
  max-width: 440px;
  width: 100%;
  box-shadow: var(--shadow-modal);
  animation: slideUp 0.18s ease;
}

@keyframes slideUp {
  from { transform: translateY(12px); opacity: 0; }
  to   { transform: translateY(0);    opacity: 1; }
}

.modal-title {
  font-size: 1.05rem;
  font-weight: 700;
  margin-bottom: 4px;
  letter-spacing: -0.2px;
}

.modal-car {
  font-size: 0.82rem;
  color: var(--text-muted);
  margin-bottom: 20px;
  font-weight: 500;
}

.form-group { margin-bottom: 13px; }

.form-group label {
  display: block;
  font-size: 0.69rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.07em;
  color: var(--text-muted);
  margin-bottom: 5px;
}

.form-group input,
.form-group textarea,
.form-group select {
  width: 100%;
  padding: 10px 13px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 16px;
  font-family: var(--font);
  transition: border-color 0.15s, box-shadow 0.15s;
  outline: none;
  -webkit-appearance: none;
}

.form-group textarea { resize: vertical; min-height: 72px; }

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37,99,235,0.10);
  background: var(--surface);
}

.modal-footer {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 20px;
}

/* Ğ˜Ğ½Ñ„Ğ¾-ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ² Ğ¼Ğ¾Ğ´Ğ°Ğ»Ğµ */
.info-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  font-size: 0.85rem;
}
.info-row:last-child { border-bottom: none; }
.info-row-label { color: var(--text-muted); font-weight: 500; }
.info-row-value { font-weight: 700; text-align: right; }

.info-note-box {
  background: var(--bg);
  border-radius: var(--radius-sm);
  padding: 10px 13px;
  margin-top: 10px;
}
.info-note-label {
  font-size: 0.68rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-dim);
  margin-bottom: 4px;
  font-weight: 700;
}
.info-note-text {
  font-size: 0.83rem;
  font-style: italic;
  color: var(--text-muted);
}

/* â”€â”€ ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 9px 18px;
  border-radius: var(--radius-sm);
  font-size: 0.83rem; font-weight: 700;
  font-family: var(--font); cursor: pointer;
  border: none; transition: all 0.15s; text-decoration: none;
  white-space: nowrap;
}
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary {
  background: transparent;
  color: var(--text-muted);
  border: 1px solid var(--border);
}
.btn-secondary:hover { background: var(--bg); color: var(--text); }

/* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-muted);
  font-size: 0.88rem;
  width: 100%;
}

/* â”€â”€ Mobile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 640px) {
  .board-outer { padding: 12px 10px 24px; }
  .column { width: 240px; max-height: calc(100svh - 90px); }
  .modal-content { padding: 22px 18px 20px; }
  .modal-footer { flex-direction: column-reverse; gap: 7px; }
  .modal-footer .btn { width: 100%; justify-content: center; }
}
</style>
</head>
<body>

<div class="board-page">
  <div class="board-outer">
    <div class="board-wrap" id="board">
      <div class="loading">â³ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
    </div>
  </div>
</div>

<!-- Modal: ĞĞ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ñ‚Ñƒ Ğ·Ğ°ĞµĞ·Ğ´Ğ° -->
<div class="modal" id="modalSchedule">
  <div class="modal-content">
    <div class="modal-title">ğŸ“… ĞĞ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ñ‚Ñƒ Ğ·Ğ°ĞµĞ·Ğ´Ğ°</div>
    <div class="modal-car" id="scheduleCarName"></div>
    <div class="form-group">
      <label>Ğ”Ğ°Ñ‚Ğ° Ğ·Ğ°ĞµĞ·Ğ´Ğ°</label>
      <input type="date" id="scheduleDate">
    </div>
    <div class="form-group">
      <label>Ğ’Ñ€ĞµĞ¼Ñ</label>
      <input type="time" id="scheduleTime" value="10:00">
    </div>
    <div class="form-group">
      <label>ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ (Ğ½ĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)</label>
      <textarea id="scheduleNote" placeholder="ĞŸĞ¾Ğ¶ĞµĞ»Ğ°Ğ½Ğ¸Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°, Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸..."></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalSchedule')">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn" style="background:var(--warning);color:#fff" onclick="saveSchedule()">ğŸ“… ĞĞ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<!-- Modal: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğµ -->
<div class="modal" id="modalInfo">
  <div class="modal-content">
    <div class="modal-title">â„¹ï¸ Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğµ</div>
    <div style="font-size:1rem;font-weight:700;margin:4px 0 16px;letter-spacing:-0.2px" id="infoCarName"></div>
    <div>
      <div class="info-row">
        <span class="info-row-label">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</span>
        <span class="info-row-value" id="infoStatus"></span>
      </div>
      <div class="info-row">
        <span class="info-row-label">Ğ¡ÑƒĞ¼Ğ¼Ğ°</span>
        <span class="info-row-value" style="color:var(--success)" id="infoPrice"></span>
      </div>
      <div class="info-row" id="infoCheckinBlock" style="display:none">
        <span class="info-row-label">Ğ”Ğ°Ñ‚Ğ° Ğ·Ğ°ĞµĞ·Ğ´Ğ°</span>
        <span class="info-row-value" id="infoCheckin"></span>
      </div>
    </div>
    <div id="infoNoteBlock" style="display:none">
      <div class="info-note-box">
        <div class="info-note-label">ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹</div>
        <div class="info-note-text" id="infoNote"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalInfo')">Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
      <button class="btn btn-primary" onclick="openCalcFromInfo()">ğŸ“‚ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚</button>
    </div>
  </div>
</div>

<!-- Modal: Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ -->
<div class="modal" id="modalDone">
  <div class="modal-content">
    <div class="modal-title">âœ… Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ</div>
    <div class="modal-car" id="doneCarName"></div>
    <p style="color:var(--text-muted);font-size:0.85rem;line-height:1.6;margin-bottom:6px">
      Ğ Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ñ‹, ĞĞ¢Ğš Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ğ». ĞœĞ°ÑˆĞ¸Ğ½Ğ° Ğ¶Ğ´Ñ‘Ñ‚ Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ.
    </p>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalDone')">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn" style="background:var(--purple);color:#fff" onclick="saveDone()">âœ… Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<!-- Modal: Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ -->
<div class="modal" id="modalDeliver">
  <div class="modal-content">
    <div class="modal-title">ğŸš— Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ</div>
    <div class="modal-car" id="deliverCarName"></div>
    <div class="form-group">
      <label>Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ°</label>
      <input type="number" id="deliverPrice" placeholder="Ğ˜Ğ· Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ°">
    </div>
    <div class="form-group">
      <label>Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹</label>
      <select id="deliverPayment">
        <option value="cash">ğŸ’µ ĞĞ°Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ</option>
        <option value="card">ğŸ’³ ĞšĞ°Ñ€Ñ‚Ğ°</option>
        <option value="transfer">ğŸ¦ ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´</option>
      </select>
    </div>
    <div class="form-group">
      <label>ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹</label>
      <textarea id="deliverNote" placeholder="ĞŸĞ¾Ğ¶ĞµĞ»Ğ°Ğ½Ğ¸Ñ, Ğ·Ğ°Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ñ..."></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalDeliver')">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn" style="background:var(--success);color:#fff" onclick="saveDeliver()">ğŸš— Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<script src="footer.js"></script>
<script>
(function() {
'use strict';

const SUPABASE_URL = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window._crmSb = sb;

let currentUser = null;
let currentStudio = null;
let allCalcs = [];
let activeCalcId = null;

const COLUMNS = [
  { key: 'new',         label: 'Ğ Ğ°ÑÑ‡Ñ‘Ñ‚',      icon: 'ğŸ“‹' },
  { key: 'scheduled',   label: 'Ğ”Ğ°Ñ‚Ğ° Ğ·Ğ°ĞµĞ·Ğ´Ğ°',  icon: 'ğŸ“…' },
  { key: 'in_progress', label: 'Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ',     icon: 'ğŸ”§' },
  { key: 'done',        label: 'Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾',    icon: 'âœ…' },
  { key: 'delivered',   label: 'Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ¾',       icon: 'ğŸš—' },
];

function fmt(n) {
  return new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n || 0);
}

function fmtDate(d) {
  if (!d) return null;
  return new Date(d).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
}

async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'welcome.html'; return false; }
  currentUser = session.user;
  return true;
}

async function getStudio() {
  const { data, error } = await sb
    .from('studio_members')
    .select('studio_id, role')
    .eq('user_id', currentUser.id)
    .eq('is_active', true)
    .single();
  if (error || !data) { alert('âŒ Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°'); return false; }
  currentStudio = data;
  return true;
}

function normalizeStatus(status) {
  if (!status || status === '' || status === 'draft' || status === 'pending') return 'new';
  return status;
}

async function loadBoard() {
  const { data, error } = await sb
    .from('calculations')
    .select('id, car_name, total_price, final_price, status, checkin_date, checkin_time, schedule_note, work_assigned, created_at')
    .eq('studio_id', currentStudio.studio_id)
    .order('created_at', { ascending: false });

  if (error) { console.error(error); return; }
  allCalcs = data || [];
  renderBoard();
}

function renderBoard() {
  const board = document.getElementById('board');

  let html = '';
  COLUMNS.forEach(col => {
    const cards = allCalcs.filter(c => normalizeStatus(c.status) === col.key);
    html += `
      <div class="column col-${col.key}">
        <div class="column-header">
          <div class="column-title">
            <div class="column-dot"></div>
            ${col.icon} ${col.label}
          </div>
          <div class="column-count">${cards.length}</div>
        </div>
        <div class="column-cards">
          ${cards.length === 0
            ? `<div class="empty-col">ğŸ“­ ĞŸĞ¾ĞºĞ° Ğ¿ÑƒÑÑ‚Ğ¾</div>`
            : cards.map(c => renderCard(c, col.key)).join('')
          }
        </div>
      </div>
    `;
  });

  board.innerHTML = html;
}

function renderCard(calc, status) {
  const price = fmt(calc.final_price || calc.total_price);

  let checkin = '';
  if (calc.checkin_date) {
    const dateStr = fmtDate(calc.checkin_date);
    const timeStr = calc.checkin_time ? calc.checkin_time.slice(0, 5) : '';
    checkin = `<div class="card-checkin">ğŸ“… ${dateStr}${timeStr ? ', ' + timeStr : ''}</div>`;
  }

  let note = '';
  if (calc.schedule_note) {
    note = `<div class="card-note">ğŸ’¬ ${calc.schedule_note}</div>`;
  }

  let actions = '';
  if (status === 'new') {
    actions = `
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();openCalc('${calc.id}')">ğŸ“‚ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
      <button class="card-btn card-btn-primary" onclick="event.stopPropagation();openModal('modalSchedule','${calc.id}','${escStr(calc.car_name)}')">ğŸ“… ĞĞ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ÑŒ Ğ·Ğ°ĞµĞ·Ğ´</button>
    `;
  } else if (status === 'scheduled') {
    actions = `
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();openModal('modalSchedule','${calc.id}','${escStr(calc.car_name)}')">âœï¸ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ñ‚Ñƒ</button>
      <button class="card-btn card-btn-primary" onclick="event.stopPropagation();goAssign('${calc.id}')">ğŸ”§ Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ</button>
    `;
  } else if (status === 'in_progress') {
    actions = `
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();goAssign('${calc.id}')">ğŸ‘¥ Ğ Ğ°Ğ±Ğ¾Ñ‚Ñ‹</button>
      <button class="card-btn card-btn-primary" onclick="event.stopPropagation();openModal('modalDone','${calc.id}','${escStr(calc.car_name)}')" style="background:var(--purple)">âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾</button>
    `;
  } else if (status === 'done') {
    actions = `
      <button class="card-btn card-btn-primary" onclick="event.stopPropagation();openModalDeliver('${calc.id}','${escStr(calc.car_name)}',${calc.total_price || 0})" style="background:var(--success)">ğŸš— Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ</button>
    `;
  } else if (status === 'delivered') {
    actions = `
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();openCalc('${calc.id}')">ğŸ“‚ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
    `;
  }

  return `
    <div class="kanban-card" onclick="openModalInfo('${calc.id}','${escStr(calc.car_name)}','${status}',${calc.final_price || calc.total_price || 0},'${calc.checkin_date || ''}','${calc.checkin_time || ''}','${escStr(calc.schedule_note || '')}')">
      <div class="card-car">${calc.car_name || 'Ğ‘ĞµĞ· Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ'}</div>
      ${checkin}
      ${note}
      <div class="card-price">${price} â‚½</div>
      <div class="card-actions" onclick="event.stopPropagation()">
        ${actions}
      </div>
    </div>
  `;
}

function escStr(s) {
  return (s || '').replace(/'/g, '&#39;').replace(/"/g, '&quot;');
}

function openModal(modalId, calcId, carName) {
  activeCalcId = calcId;
  if (modalId === 'modalSchedule') {
    document.getElementById('scheduleCarName').textContent = carName;
    document.getElementById('scheduleDate').value = '';
    document.getElementById('scheduleTime').value = '10:00';
    document.getElementById('scheduleNote').value = '';
  }
  if (modalId === 'modalDone') {
    document.getElementById('doneCarName').textContent = carName;
  }
  document.getElementById(modalId).classList.add('active');
}

function openModalDeliver(calcId, carName, price) {
  activeCalcId = calcId;
  document.getElementById('deliverCarName').textContent = carName;
  document.getElementById('deliverPrice').value = price;
  document.getElementById('deliverNote').value = '';
  document.getElementById('modalDeliver').classList.add('active');
}

window.openModalInfo = function(calcId, carName, status, price, checkinDate, checkinTime, note) {
  activeCalcId = calcId;

  const STATUS_LABELS = {
    new: 'ğŸ“‹ Ğ Ğ°ÑÑ‡Ñ‘Ñ‚',
    scheduled: 'ğŸ“… Ğ—Ğ°ĞµĞ·Ğ´ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½',
    in_progress: 'ğŸ”§ Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ',
    done: 'âœ… Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾',
    delivered: 'ğŸš— Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ¾'
  };

  document.getElementById('infoCarName').textContent  = carName;
  document.getElementById('infoStatus').textContent   = STATUS_LABELS[status] || status;
  document.getElementById('infoPrice').textContent    = fmt(price) + ' â‚½';

  const checkinBlock = document.getElementById('infoCheckinBlock');
  if (checkinDate) {
    const dateStr = fmtDate(checkinDate);
    const timeStr = checkinTime ? checkinTime.slice(0, 5) : '';
    document.getElementById('infoCheckin').textContent = dateStr + (timeStr ? ', ' + timeStr : '');
    checkinBlock.style.display = 'flex';
  } else {
    checkinBlock.style.display = 'none';
  }

  const noteBlock = document.getElementById('infoNoteBlock');
  if (note) {
    document.getElementById('infoNote').textContent = note;
    noteBlock.style.display = 'block';
  } else {
    noteBlock.style.display = 'none';
  }

  document.getElementById('modalInfo').classList.add('active');
};

window.openCalcFromInfo = function() {
  closeModal('modalInfo');
  window.location.href = `calculator.html?load=${activeCalcId}`;
};

window.closeModal = function(modalId) {
  document.getElementById(modalId).classList.remove('active');
  activeCalcId = null;
};

window.openModal         = openModal;
window.openModalDeliver  = openModalDeliver;

window.openCalc = function(calcId) {
  window.location.href = `calculator.html?load=${calcId}`;
};

window.goAssign = function(calcId) {
  window.location.href = `assign-work.html?calc_id=${calcId}`;
};

async function updateStatus(calcId, status, extra = {}) {
  const { error } = await sb
    .from('calculations')
    .update({ status, ...extra })
    .eq('id', calcId);
  if (error) { console.error(error); alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.message); return false; }
  return true;
}

window.saveSchedule = async function() {
  const date = document.getElementById('scheduleDate').value;
  const time = document.getElementById('scheduleTime').value;
  const note = document.getElementById('scheduleNote').value.trim();
  if (!date) { alert('Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ!'); return; }
  if (!time) { alert('Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ²Ñ€ĞµĞ¼Ñ!'); return; }
  const ok = await updateStatus(activeCalcId, 'scheduled', {
    checkin_date: date, checkin_time: time, schedule_note: note || null
  });
  if (ok) { closeModal('modalSchedule'); loadBoard(); }
};

window.saveDone = async function() {
  const ok = await updateStatus(activeCalcId, 'done');
  if (ok) { closeModal('modalDone'); loadBoard(); }
};

window.saveDeliver = async function() {
  const price = parseFloat(document.getElementById('deliverPrice').value) || null;
  const note  = document.getElementById('deliverNote').value.trim();
  const ok = await updateStatus(activeCalcId, 'delivered', { final_price: price, delivery_note: note });
  if (ok) { closeModal('modalDeliver'); loadBoard(); }
};

document.querySelectorAll('.modal').forEach(m => {
  m.addEventListener('click', e => {
    if (e.target === m) { m.classList.remove('active'); activeCalcId = null; }
  });
});

async function init() {
  initNav();
  if (!await checkAuth()) return;
  if (!await getStudio()) return;
  await loadBoard();
}

init();

})();
</script>

</body>
</html>
