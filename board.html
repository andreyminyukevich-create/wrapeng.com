<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ â€” Keep1R CRM</title>
<script>document.documentElement.setAttribute('data-theme','light');</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="nav.css">
<script src="nav.js"></script>
<style>
:root {
  --font:         -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
  --bg:           #eef2f9;
  --surface:      #ffffff;
  --border:       rgba(15,23,42,0.08);
  --border-focus: rgba(37,99,235,0.35);
  --text:         #0f172a;
  --text-muted:   #64748b;
  --text-dim:     #94a3b8;
  --primary:      #2563eb;
  --primary-dark: #1d4ed8;
  --success:      #059669;
  --warning:      #d97706;
  --danger:       #dc2626;
  --purple:       #7c3aed;
  --shadow:       0 1px 3px rgba(0,0,0,0.05), 0 4px 16px rgba(0,0,0,0.07);
  --shadow-modal: 0 8px 40px rgba(0,0,0,0.14);
  --radius:       14px;
  --radius-sm:    10px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  font-family: var(--font);
  -webkit-font-smoothing: antialiased;
  background: var(--bg);
  color: var(--text);
  overflow-x: hidden;
}

/* â”€â”€ Board layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.board-page {
  display: flex;
  flex-direction: column;
  min-height: 100svh;
}

.board-outer {
  flex: 1;
  overflow-x: auto;
  padding: 20px 20px 32px;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
  scrollbar-color: rgba(37,99,235,0.2) transparent;
}

.board-outer::-webkit-scrollbar       { height: 6px; }
.board-outer::-webkit-scrollbar-track { background: transparent; }
.board-outer::-webkit-scrollbar-thumb { background: rgba(37,99,235,0.18); border-radius: 3px; }

.board-wrap {
  display: flex;
  gap: 14px;
  align-items: flex-start;
  min-width: max-content;
}

/* â”€â”€ Column â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.column {
  width: 272px;
  flex-shrink: 0;
  background: var(--surface);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  max-height: calc(100svh - 110px);
  box-shadow: var(--shadow);
}

.column-header {
  padding: 14px 16px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  border-radius: var(--radius) var(--radius) 0 0;
  position: sticky;
  top: 0;
  background: var(--surface);
  z-index: 1;
}

.column-title {
  display: flex;
  align-items: center;
  gap: 7px;
  font-weight: 700;
  font-size: 0.82rem;
  letter-spacing: 0.01em;
  text-transform: uppercase;
}

.column-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.column-count {
  font-size: 0.7rem;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 20px;
  background: var(--bg);
  color: var(--text-muted);
  min-width: 24px;
  text-align: center;
}

.column-sum {
  font-size: 0.78rem;
  font-weight: 800;
  padding: 3px 0 0;
  letter-spacing: -0.2px;
  opacity: 0.85;
  white-space: nowrap;
}

.column-cards {
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 7px;
  overflow-y: auto;
  flex: 1;
  scrollbar-width: thin;
  scrollbar-color: rgba(0,0,0,0.08) transparent;
}

/* â”€â”€ Column accent colours â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.col-new .column-dot        { background: #94a3b8; }
.col-new .column-title      { color: #64748b; }
.col-new .column-count      { background: rgba(148,163,184,0.12); }
.col-new .column-sum        { color: #64748b; }

.col-scheduled .column-dot   { background: #f59e0b; }
.col-scheduled .column-title { color: #92400e; }
.col-scheduled .column-count { background: rgba(245,158,11,0.1); color: #b45309; }
.col-scheduled .column-sum   { color: #b45309; }
.col-scheduled              { border-top: 3px solid #f59e0b; border-radius: var(--radius); }

.col-in_progress .column-dot   { background: var(--primary); }
.col-in_progress .column-title { color: var(--primary); }
.col-in_progress .column-count { background: rgba(37,99,235,0.08); color: var(--primary); }
.col-in_progress               { border-top: 3px solid var(--primary); border-radius: var(--radius); }
.col-in_progress .column-sum   { color: var(--primary); }

.col-done .column-dot   { background: var(--purple); }
.col-done .column-title { color: var(--purple); }
.col-done .column-count { background: rgba(124,58,237,0.08); color: var(--purple); }
.col-done               { border-top: 3px solid var(--purple); border-radius: var(--radius); }
.col-done .column-sum   { color: var(--purple); }

.col-delivered .column-dot   { background: var(--success); }
.col-delivered .column-title { color: #065f46; }
.col-delivered .column-count { background: rgba(5,150,105,0.08); color: var(--success); }
.col-delivered               { border-top: 3px solid var(--success); border-radius: var(--radius); }
.col-delivered .column-sum   { color: var(--success); font-size: 0.9rem; }

.col-cancelled .column-dot   { background: #dc2626; }
.col-cancelled .column-title { color: #991b1b; }
.col-cancelled .column-count { background: rgba(220,38,38,0.08); color: #dc2626; }
.col-cancelled .column-sum   { color: #dc2626; }
.col-cancelled               { border-top: 3px solid #dc2626; border-radius: var(--radius); opacity: 0.85; }


/* â”€â”€ Kanban card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kanban-card {
  background: #f8fafc;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px 13px;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s, border-color 0.15s, background 0.15s;
}

.kanban-card:hover {
  background: var(--surface);
  border-color: rgba(37,99,235,0.3);
  box-shadow: 0 3px 14px rgba(37,99,235,0.09);
  transform: translateY(-2px);
}

.card-car {
  font-weight: 700;
  font-size: 0.88rem;
  margin-bottom: 5px;
  letter-spacing: -0.2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text);
}

.card-checkin {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 0.7rem;
  font-weight: 700;
  padding: 2px 7px;
  border-radius: 5px;
  background: rgba(217,119,6,0.08);
  color: #b45309;
  border: 1px solid rgba(217,119,6,0.18);
  margin-bottom: 6px;
}

.card-note {
  font-size: 0.72rem;
  color: var(--text-muted);
  line-height: 1.4;
  margin-bottom: 6px;
  font-style: italic;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.card-price {
  font-size: 0.98rem;
  font-weight: 800;
  color: var(--success);
  letter-spacing: -0.4px;
  margin-bottom: 9px;
}

.card-actions {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.card-btn {
  width: 100%;
  padding: 7px 10px;
  border-radius: 7px;
  font-size: 0.78rem;
  font-weight: 700;
  cursor: pointer;
  border: none;
  transition: all 0.15s;
  font-family: var(--font);
  text-align: center;
  letter-spacing: -0.1px;
}

.card-btn-primary {
  background: var(--primary);
  color: #fff;
}
.card-btn-primary:hover { background: var(--primary-dark); }

.card-btn-cancel {
  background: rgba(220,38,38,0.06);
  color: #dc2626;
  border: 1px solid rgba(220,38,38,0.15);
}
.card-btn-cancel:hover { background: rgba(220,38,38,0.12); }

.card-btn-secondary {
  background: var(--bg);
  color: var(--text-muted);
  border: 1px solid var(--border);
}
.card-btn-secondary:hover { color: var(--text); border-color: rgba(37,99,235,0.25); background: #fff; }

.empty-col {
  text-align: center;
  padding: 28px 12px;
  color: var(--text-dim);
  font-size: 0.78rem;
}

/* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.5);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal.active { display: flex; animation: fadeIn 0.15s ease; }

@keyframes fadeIn {
  from { opacity: 0; }
  to   { opacity: 1; }
}

.modal-content {
  background: var(--surface);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  padding: 28px 28px 24px;
  max-width: 440px;
  width: 100%;
  box-shadow: var(--shadow-modal);
  animation: slideUp 0.18s ease;
}

@keyframes slideUp {
  from { transform: translateY(12px); opacity: 0; }
  to   { transform: translateY(0);    opacity: 1; }
}

.modal-title {
  font-size: 1.05rem;
  font-weight: 700;
  margin-bottom: 4px;
  letter-spacing: -0.2px;
}

.modal-car {
  font-size: 0.82rem;
  color: var(--text-muted);
  margin-bottom: 20px;
  font-weight: 500;
}

.form-group { margin-bottom: 13px; }

.form-group label {
  display: block;
  font-size: 0.69rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.07em;
  color: var(--text-muted);
  margin-bottom: 5px;
}

.form-group input,
.form-group textarea,
.form-group select {
  width: 100%;
  padding: 10px 13px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 16px;
  font-family: var(--font);
  transition: border-color 0.15s, box-shadow 0.15s;
  outline: none;
  -webkit-appearance: none;
}

.form-group textarea { resize: vertical; min-height: 72px; }

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37,99,235,0.10);
  background: var(--surface);
}

.modal-footer {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 20px;
}

/* Ğ˜Ğ½Ñ„Ğ¾-ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ² Ğ¼Ğ¾Ğ´Ğ°Ğ»Ğµ */
.info-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  font-size: 0.85rem;
}
.info-row:last-child { border-bottom: none; }
.info-row-label { color: var(--text-muted); font-weight: 500; }
.info-row-value { font-weight: 700; text-align: right; }

.info-note-box {
  background: var(--bg);
  border-radius: var(--radius-sm);
  padding: 10px 13px;
  margin-top: 10px;
}
.info-note-label {
  font-size: 0.68rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-dim);
  margin-bottom: 4px;
  font-weight: 700;
}
.info-note-text {
  font-size: 0.83rem;
  font-style: italic;
  color: var(--text-muted);
}

/* â”€â”€ ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 9px 18px;
  border-radius: var(--radius-sm);
  font-size: 0.83rem; font-weight: 700;
  font-family: var(--font); cursor: pointer;
  border: none; transition: all 0.15s; text-decoration: none;
  white-space: nowrap;
}
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary {
  background: transparent;
  color: var(--text-muted);
  border: 1px solid var(--border);
}
.btn-secondary:hover { background: var(--bg); color: var(--text); }

/* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-muted);
  font-size: 0.88rem;
  width: 100%;
}

/* â”€â”€ Mobile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 640px) {
  .board-outer { padding: 12px 10px 24px; }
  .column { width: 240px; max-height: calc(100svh - 90px); }
  .modal-content { padding: 22px 18px 20px; }
  .modal-footer { flex-direction: column-reverse; gap: 7px; }
  .modal-footer .btn { width: 100%; justify-content: center; }
}
</style>
</head>
<body>

<div class="board-page">
  <div class="board-outer">
    <div class="board-wrap" id="board">
      <div class="loading">â³ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
    </div>
  </div>
</div>

<!-- ĞšĞ½Ğ¾Ğ¿ĞºĞ° Â«Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Â» Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ BookingPopup Ğ¸Ğ· booking-popup.js -->

<!-- Modal: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğµ -->
<div class="modal" id="modalInfo">
  <div class="modal-content">
    <div class="modal-title">â„¹ï¸ Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğµ</div>
    <div style="font-size:1rem;font-weight:700;margin:4px 0 16px;letter-spacing:-0.2px" id="infoCarName"></div>
    <div>
      <div class="info-row">
        <span class="info-row-label">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</span>
        <span class="info-row-value" id="infoStatus"></span>
      </div>
      <div class="info-row">
        <span class="info-row-label">Ğ¡ÑƒĞ¼Ğ¼Ğ°</span>
        <span class="info-row-value" style="color:var(--success)" id="infoPrice"></span>
      </div>
      <div class="info-row" id="infoCheckinBlock" style="display:none">
        <span class="info-row-label">Ğ”Ğ°Ñ‚Ğ° Ğ·Ğ°ĞµĞ·Ğ´Ğ°</span>
        <span class="info-row-value" id="infoCheckin"></span>
      </div>
    </div>
    <div id="infoNoteBlock" style="display:none">
      <div class="info-note-box">
        <div class="info-note-label">ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹</div>
        <div class="info-note-text" id="infoNote"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalInfo')">Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
      <button class="btn btn-primary" onclick="openCalcFromInfo()">ğŸ“‚ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚</button>
    </div>
  </div>
</div>

<!-- Modal: Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ -->
<div class="modal" id="modalDone">
  <div class="modal-content" style="max-width:540px">
    <div class="modal-title">âœ… Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ</div>
    <div class="modal-car" id="doneCarName"></div>

    <!-- ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ñ‹: Ğ¿Ğ»Ğ°Ğ½ vs Ñ„Ğ°ĞºÑ‚ -->
    <div id="doneMaterialsBlock" style="margin-bottom:16px">
      <div style="font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-muted);margin-bottom:10px">
        ğŸ“¦ Ğ Ğ°ÑÑ…Ğ¾Ğ´ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ğ¾Ğ²
      </div>
      <div id="doneMaterialsLoading" style="color:var(--text-muted);font-size:0.82rem;text-align:center;padding:12px 0">
        Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...
      </div>
      <div id="doneMaterialsRows" style="display:none">
        <!-- Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ -->
        <div style="display:grid;grid-template-columns:1fr 110px 110px;gap:6px;margin-bottom:6px;padding:0 2px">
          <div style="font-size:0.67rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-muted)">Ğ£ÑĞ»ÑƒĞ³Ğ°</div>
          <div style="font-size:0.67rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-muted);text-align:right">ĞŸĞ»Ğ°Ğ½, â‚½</div>
          <div style="font-size:0.67rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:#7c3aed;text-align:right">Ğ¤Ğ°ĞºÑ‚, â‚½</div>
        </div>
        <div id="doneMaterialsList" style="display:flex;flex-direction:column;gap:5px"></div>
        <!-- Ğ˜Ñ‚Ğ¾Ğ³Ğ¾ -->
        <div style="display:grid;grid-template-columns:1fr 110px 110px;gap:6px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">
          <div style="font-size:0.8rem;font-weight:700;color:var(--text)">Ğ˜Ñ‚Ğ¾Ğ³Ğ¾</div>
          <div id="donePlanTotal" style="font-size:0.88rem;font-weight:700;color:var(--text-muted);text-align:right">â€”</div>
          <div id="doneFactTotal" style="font-size:0.88rem;font-weight:700;color:#7c3aed;text-align:right">â€”</div>
        </div>
        <!-- Ğ”ĞµĞ»ÑŒÑ‚Ğ° -->
        <div id="doneDelta" style="margin-top:6px;font-size:0.78rem;text-align:right;color:var(--text-muted)"></div>
      </div>
      <div id="doneMaterialsEmpty" style="display:none;color:var(--text-muted);font-size:0.82rem;padding:8px 0">
        Ğ’ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğµ Ğ½ĞµÑ‚ Ğ¿Ğ»Ğ°Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ğ¾Ğ².
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalDone')">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn" style="background:var(--purple);color:#fff" onclick="saveDone()">âœ… Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<!-- Modal: Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ -->
<div class="modal" id="modalDeliver">
  <div class="modal-content">
    <div class="modal-title">ğŸš— Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ</div>
    <div class="modal-car" id="deliverCarName"></div>
    <div class="form-group">
      <label>Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ°</label>
      <input type="number" id="deliverPrice" placeholder="Ğ˜Ğ· Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ°">
    </div>
    <div class="form-group">
      <label>Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹</label>
      <select id="deliverPayment">
        <option value="cash">ğŸ’µ ĞĞ°Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ</option>
        <option value="card">ğŸ’³ ĞšĞ°Ñ€Ñ‚Ğ°</option>
        <option value="transfer">ğŸ¦ ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´</option>
      </select>
    </div>
    <div class="form-group">
      <label>ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹</label>
      <textarea id="deliverNote" placeholder="ĞŸĞ¾Ğ¶ĞµĞ»Ğ°Ğ½Ğ¸Ñ, Ğ·Ğ°Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ñ..."></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalDeliver')">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn" style="background:var(--success);color:#fff" onclick="saveDeliver()">ğŸš— Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<script src="footer.js"></script>
<script src="booking-popup.js"></script>
<script>
(function() {
'use strict';

const SUPABASE_URL = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window._crmSb = sb;

let currentUser = null;
let currentStudio = null;
let allCalcs = [];
let activeCalcId = null;
let assignmentsMap = {}; // calcId â†’ [{executor_name, salary, is_admin_sale}]

// Ğ‘ĞµÑ€Ñ‘Ğ¼ Ğ¸Ğ· nav.js â€” ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¿Ñ€Ğ°Ğ²Ğ´Ñ‹
const COLUMNS = Object.entries(window.STATUSES || {
  new:         { label: 'Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´Ñ‘Ğ½',      icon: 'ğŸ“‹' },
  scheduled:   { label: 'ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ° Ğ´Ğ°Ñ‚Ğ° Ğ¸ Ğ²Ñ€ĞµĞ¼Ñ', icon: 'ğŸ“…' },
  in_progress: { label: 'ĞŸÑ€Ğ¸Ğ½ÑÑ‚Ğ¾ Ğ² Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ',       icon: 'ğŸ”§' },
  done:        { label: 'Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾',               icon: 'âœ…' },
  delivered:   { label: 'Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ¾',                  icon: 'ğŸš—' },
  cancelled:   { label: 'ĞÑ‚ĞºĞ°Ğ·',                   icon: 'âŒ' },
}).map(([key, s]) => ({ key, label: s.label, icon: s.icon }));

function fmt(n) {
  return new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n || 0);
}

function fmtDate(d) {
  if (!d) return null;
  return new Date(d).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
}

async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'welcome.html'; return false; }
  currentUser = session.user;
  return true;
}

async function getStudio() {
  const { data, error } = await sb
    .from('studio_members')
    .select('studio_id, role')
    .eq('user_id', currentUser.id)
    .eq('is_active', true)
    .single();
  if (error || !data) { alert('âŒ Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°'); return false; }
  currentStudio = data;
  window._boardStudioId = data.studio_id; // Ğ´Ğ»Ñ BookingPopup
  return true;
}

function normalizeStatus(status) {
  if (!status || status === '' || status === 'draft' || status === 'pending') return 'new';
  return status;
}

async function loadBoard() {
  const { data, error } = await sb
    .from('calculations')
    .select('id, car_name, total_price, final_price, status, checkin_date, checkin_time, schedule_note, work_assigned, created_at')
    .eq('studio_id', currentStudio.studio_id)
    .order('created_at', { ascending: false });

  if (error) { console.error(error); return; }
  allCalcs = data || [];

  // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ĞµĞ¹ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ¾Ğ²
  assignmentsMap = {};
  if (allCalcs.length > 0) {
    const calcIds = allCalcs.map(c => c.id);
    const { data: assignments } = await sb
      .from('work_assignments')
      .select('calculation_id, executor_name, salary, is_admin_sale, admin_percent')
      .in('calculation_id', calcIds);
    (assignments || []).forEach(a => {
      if (!assignmentsMap[a.calculation_id]) assignmentsMap[a.calculation_id] = [];
      assignmentsMap[a.calculation_id].push(a);
    });
  }

  renderBoard();
}

function renderBoard() {
  const board = document.getElementById('board');

  let html = '';
  COLUMNS.forEach(col => {
    const cards = allCalcs.filter(c => normalizeStatus(c.status) === col.key);
    const colSum = cards.reduce((s, c) => s + (c.final_price || c.total_price || 0), 0);
    html += `
      <div class="column col-${col.key}">
        <div class="column-header">
          <div class="column-title">
            <div class="column-dot"></div>
            ${col.icon} ${col.label}
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:2px">
            <div class="column-count">${cards.length} Ğ°Ğ²Ñ‚Ğ¾</div>
            ${colSum > 0 ? `<div class="column-sum">${fmt(colSum)} â‚½</div>` : ''}
          </div>
        </div>
        <div class="column-cards">
          ${cards.length === 0
            ? `<div class="empty-col">ğŸ“­ ĞŸĞ¾ĞºĞ° Ğ¿ÑƒÑÑ‚Ğ¾</div>`
            : cards.map(c => renderCard(c, col.key)).join('')
          }
        </div>
      </div>
    `;
  });

  board.innerHTML = html;
}

function renderCard(calc, status) {
  const price = fmt(calc.final_price || calc.total_price);

  let checkin = '';
  if (calc.checkin_date) {
    const dateStr = fmtDate(calc.checkin_date);
    const timeStr = calc.checkin_time ? calc.checkin_time.slice(0, 5) : '';
    checkin = `<div class="card-checkin">ğŸ“… ${dateStr}${timeStr ? ', ' + timeStr : ''}</div>`;
  }

  let note = '';
  if (calc.schedule_note) {
    note = `<div class="card-note">ğŸ’¬ ${calc.schedule_note}</div>`;
  }

  // Ğ‘Ğ»Ğ¾Ğº Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ĞµĞ¹ (Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ´Ğ»Ñ in_progress, done, delivered)
  let executorsBlock = '';
  if (['in_progress', 'done', 'delivered'].includes(status)) {
    const asgns = assignmentsMap[calc.id] || [];
    if (asgns.length > 0) {
      const workers = asgns.filter(a => !a.is_admin_sale);
      const adminSales = asgns.filter(a => a.is_admin_sale);

      // Ğ”Ğ»Ñ "Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ¾" â€” Ğ¿ĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ½Ğ¸ĞºĞ° Ğ¾Ñ‚ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑÑƒĞ¼Ğ¼Ñ‹
      let adminSalary = 0;
      if (adminSales.length > 0) {
        if (status === 'delivered' && calc.final_price) {
          // ĞŸĞµÑ€ĞµÑÑ‡Ñ‘Ñ‚ Ğ¾Ñ‚ Ñ„Ğ°ĞºÑ‚Ğ°: Ğ±ĞµÑ€Ñ‘Ğ¼ admin_percent Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ½Ğ¸ĞºĞ°
          const pct = parseFloat(adminSales[0].admin_percent) || 0;
          adminSalary = pct > 0
            ? Math.round(calc.final_price * pct / 100)
            : adminSales.reduce((s, a) => s + (parseFloat(a.salary) || 0), 0);
        } else {
          adminSalary = adminSales.reduce((s, a) => s + (parseFloat(a.salary) || 0), 0);
        }
      }

      const workersSalary = workers.reduce((s, a) => s + (parseFloat(a.salary) || 0), 0);
      const totalSalary = workersSalary + adminSalary;

      const allNames = [
        ...workers.map(a => a.executor_name),
        ...adminSales.map(a => a.executor_name)
      ].filter(Boolean);
      const uniqueNames = [...new Set(allNames)];

      // ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ° Ğ¾Ğ± Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞµ ÑÑƒĞ¼Ğ¼Ñ‹ Ğ´Ğ»Ñ delivered
      const salaryLabel = (status === 'delivered' && adminSales.length > 0 && calc.final_price)
        ? 'ğŸ’¸ Ğ—ĞŸ (Ğ¾Ñ‚ Ñ„Ğ°ĞºÑ‚Ğ°)'
        : 'ğŸ’¸ Ğ—ĞŸ (Ğ¿Ğ»Ğ°Ğ½)';

      executorsBlock = `
        <div style="margin-bottom:8px;padding:7px 9px;background:rgba(37,99,235,0.05);border-radius:7px;border:1px solid rgba(37,99,235,0.12)">
          <div style="font-size:0.67rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:#64748b;margin-bottom:4px">ğŸ‘¥ Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ğ¸</div>
          ${uniqueNames.length > 0
            ? `<div style="font-size:0.75rem;color:#0f172a;font-weight:600;line-height:1.5;margin-bottom:3px">${uniqueNames.join('<br>')}</div>`
            : `<div style="font-size:0.73rem;color:#94a3b8;font-style:italic">ĞĞµ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ñ‹</div>`
          }
          ${totalSalary > 0
            ? `<div style="font-size:0.75rem;font-weight:700;color:#7c3aed">${salaryLabel}: ${fmt(totalSalary)} â‚½</div>`
            : ''
          }
        </div>`;
    }
  }

  let actions = '';
  if (status === 'new') {
    actions = `
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();openCalc('${calc.id}')">ğŸ“‚ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
      <button class="card-btn card-btn-primary" onclick="event.stopPropagation();openBookingPopup('${calc.id}','${escStr(calc.car_name)}',${calc.final_price||calc.total_price||0})">ğŸ“… Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ</button>
      <button class="card-btn card-btn-cancel" onclick="event.stopPropagation();cancelOrder('${calc.id}','${escStr(calc.car_name)}')">âŒ ĞÑ‚ĞºĞ°Ğ·</button>
    `;
  } else if (status === 'scheduled') {
    actions = `
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();openBookingPopup('${calc.id}','${escStr(calc.car_name)}',${calc.final_price||calc.total_price||0})">âœï¸ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ</button>
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();window.location.href='acceptance-act.html?calc_id=${calc.id}'">ğŸ“‹ ĞŸÑ€Ğ¸Ğ½ÑÑ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾</button>
      <button class="card-btn card-btn-primary" onclick="event.stopPropagation();goAssign('${calc.id}')">ğŸ”§ Ğ’Ğ·ÑÑ‚ÑŒ Ğ² Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ</button>
      <button class="card-btn card-btn-cancel" onclick="event.stopPropagation();cancelOrder('${calc.id}','${escStr(calc.car_name)}')">âŒ ĞÑ‚ĞºĞ°Ğ·</button>
    `;
  } else if (status === 'in_progress') {
    actions = `
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();goAssign('${calc.id}')">ğŸ‘¥ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸</button>
      <button class="card-btn card-btn-primary" onclick="event.stopPropagation();openModal('modalDone','${calc.id}','${escStr(calc.car_name)}')" style="background:var(--purple)">âœ… Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ</button>
    `;
  } else if (status === 'done') {
    actions = `
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();window.location.href='calc-view.html?id=${calc.id}'">ğŸ“Š Ğ Ğ°ÑÑ‡Ñ‘Ñ‚</button>
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();window.location.href='acceptance-act.html?calc_id=${calc.id}'">ğŸ“„ ĞĞºÑ‚ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ĞºĞ¸</button>
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();window.location.href='work-order.html?calc_id=${calc.id}'">ğŸ–¨ï¸ Ğ—Ğ°ĞºĞ°Ğ·-Ğ½Ğ°Ñ€ÑĞ´</button>
      <button class="card-btn card-btn-primary" onclick="event.stopPropagation();openModalDeliver('${calc.id}','${escStr(calc.car_name)}',${calc.total_price || 0})" style="background:var(--success)">ğŸš— Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ</button>
    `;
  } else if (status === 'delivered') {
    actions = `
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();window.location.href='calc-view.html?id=${calc.id}'">ğŸ“Š Ğ Ğ°ÑÑ‡Ñ‘Ñ‚</button>
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();window.location.href='acceptance-act.html?calc_id=${calc.id}'">ğŸ“„ ĞĞºÑ‚ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ĞºĞ¸</button>
      <button class="card-btn card-btn-primary" onclick="event.stopPropagation();window.location.href='work-order.html?calc_id=${calc.id}'" style="background:#0f172a">ğŸ–¨ï¸ ĞĞºÑ‚ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸</button>
    `;
  } else if (status === 'cancelled') {
    actions = `
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();window.location.href='calc-view.html?id=${calc.id}'">ğŸ“Š Ğ Ğ°ÑÑ‡Ñ‘Ñ‚</button>
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();restoreOrder('${calc.id}','${escStr(calc.car_name)}')">â†©ï¸ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ</button>
    `;
  }

  return `
    <div class="kanban-card" onclick="openModalInfo('${calc.id}','${escStr(calc.car_name)}','${status}',${calc.final_price || calc.total_price || 0},'${calc.checkin_date || ''}','${calc.checkin_time || ''}','${escStr(calc.schedule_note || '')}')">
      <div class="card-car">${calc.car_name || 'Ğ‘ĞµĞ· Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ'}</div>
      ${checkin}
      ${note}
      <div class="card-price">${price} â‚½</div>
      ${executorsBlock}
      <div class="card-actions" onclick="event.stopPropagation()">
        ${actions}
      </div>
    </div>
  `;
}

function escStr(s) {
  return (s || '').replace(/'/g, '&#39;').replace(/"/g, '&quot;');
}

function openModal(modalId, calcId, carName) {
  activeCalcId = calcId;
  if (modalId === 'modalDone') {
    document.getElementById('doneCarName').textContent = carName;
    loadDoneMaterials(calcId);
  }
  document.getElementById(modalId).classList.add('active');
}

window.openBookingPopup = function(calcId, carName, price) {
  activeCalcId = calcId;
  BookingPopup.open({
    calcId,
    calcName:  carName,
    calcPrice: price,
    studioId:  window._boardStudioId,
    onSaved:   function() { loadBoard(); },
  });
};

function openModalDeliver(calcId, carName, price) {
  activeCalcId = calcId;
  document.getElementById('deliverCarName').textContent = carName;
  document.getElementById('deliverPrice').value = price;
  document.getElementById('deliverNote').value = '';
  document.getElementById('modalDeliver').classList.add('active');
}

window.openModalInfo = function(calcId, carName, status, price, checkinDate, checkinTime, note) {
  activeCalcId = calcId;

  const STATUS_LABELS = Object.fromEntries(
    Object.entries(window.STATUSES || {}).map(([k, s]) => [k, s.icon + ' ' + s.label])
  );

  document.getElementById('infoCarName').textContent  = carName;
  document.getElementById('infoStatus').textContent   = STATUS_LABELS[status] || status;
  document.getElementById('infoPrice').textContent    = fmt(price) + ' â‚½';

  const checkinBlock = document.getElementById('infoCheckinBlock');
  if (checkinDate) {
    const dateStr = fmtDate(checkinDate);
    const timeStr = checkinTime ? checkinTime.slice(0, 5) : '';
    document.getElementById('infoCheckin').textContent = dateStr + (timeStr ? ', ' + timeStr : '');
    checkinBlock.style.display = 'flex';
  } else {
    checkinBlock.style.display = 'none';
  }

  const noteBlock = document.getElementById('infoNoteBlock');
  if (note) {
    document.getElementById('infoNote').textContent = note;
    noteBlock.style.display = 'block';
  } else {
    noteBlock.style.display = 'none';
  }

  document.getElementById('modalInfo').classList.add('active');
};

window.openCalcFromInfo = function() {
  closeModal('modalInfo');
  window.location.href = `calculator.html?load=${activeCalcId}`;
};

window.closeModal = function(modalId) {
  document.getElementById(modalId).classList.remove('active');
  activeCalcId = null;
};

window.openModal         = openModal;
window.openModalDeliver  = openModalDeliver;

window.openCalc = function(calcId) {
  window.location.href = `calculator.html?load=${calcId}`;
};


window.cancelOrder = async function(calcId, carName) {
  if (!confirm('ĞŸĞµÑ€ĞµĞ²ĞµÑÑ‚Ğ¸ Â«' + carName + 'Â» Ğ² Ğ¾Ñ‚ĞºĞ°Ğ·?')) return;
  const { error } = await sb.from('calculations')
    .update({ status: 'cancelled' })
    .eq('id', calcId);
  if (error) { alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.message); return; }
  await loadBoard();
};

window.restoreOrder = async function(calcId, carName) {
  if (!confirm('Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Â«' + carName + 'Â» Ğ² Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹?')) return;
  const { error } = await sb.from('calculations')
    .update({ status: 'new' })
    .eq('id', calcId);
  if (error) { alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.message); return; }
  await loadBoard();
};

window.goAssign = function(calcId) {
  window.location.href = `assign-work.html?calc_id=${calcId}`;
};

async function updateStatus(calcId, status, extra = {}) {
  const { error } = await sb
    .from('calculations')
    .update({ status, ...extra })
    .eq('id', calcId);
  if (error) { console.error(error); alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.message); return false; }
  return true;
}

// saveSchedule Ğ·Ğ°Ğ¼ĞµĞ½Ñ‘Ğ½ Ğ½Ğ° BookingPopup â€” ÑĞ¼. booking-popup.js

// â”€â”€ ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ñ‹: Ğ¿Ğ»Ğ°Ğ½ vs Ñ„Ğ°ĞºÑ‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _donePlanItems = []; // [{key, name, plan}]

function extractMaterials(calcData) {
  const items = [];
  const d = calcData || {};
  const seen = new Set();

  function add(key, name, mat) {
    const m = parseFloat(mat) || 0;
    if (m > 0 && !seen.has(key)) { seen.add(key); items.push({ key, name, plan: m }); }
  }

  if (d.package) {
    add('pkg_wrap', 'ĞĞºĞ»ĞµĞ¹ĞºĞ° (ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°)', d.package.wrapMat);
    add('pkg_prep', 'ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° (ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°)', d.package.prepMat);
    add('pkg_arm',  'Ğ‘Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°)', d.package.armMat);
  }
  if (d.impact) {
    add('impact_wrap', 'ĞĞºĞ»ĞµĞ¹ĞºĞ° (Ğ£Ğ´Ğ°Ñ€Ğ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ)', d.impact.wrapMat);
    add('impact_prep', 'ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° (Ğ£Ğ´Ğ°Ñ€Ğ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ)', d.impact.prepMat);
    add('impact_arm',  'Ğ‘Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (Ğ£Ğ´Ğ°Ñ€Ğ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ)', d.impact.armMat);
  }
  if (d.services_detail) {
    const gn = { arm: 'Ğ‘Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ', det: 'Ğ”ĞµÑ‚ĞµĞ¹Ğ»Ğ¸Ğ½Ğ³', gl: 'Ğ¡Ñ‚Ñ‘ĞºĞ»Ğ°', ms: 'Ğ”Ğ¾Ğ¿. ÑƒÑĞ»ÑƒĞ³Ğ¸', wrap: 'ĞĞºĞ»ĞµĞ¹ĞºĞ°' };
    Object.entries(gn).forEach(([key, gName]) => {
      (d.services_detail[key] || []).forEach((item, idx) => {
        const m = parseFloat(item.mat) || 0;
        if (m > 0) add(`${key}_${idx}`, item.name || gName, m);
      });
    });
  }
  if (!d.services_detail) {
    const cats = { arm: 'ĞÑ€Ğ¼Ğ°Ñ‚ÑƒÑ€Ğ½Ñ‹Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹', wrap: 'ĞĞºĞ»ĞµĞ¹ĞºĞ°', det: 'Ğ”ĞµÑ‚ĞµĞ¹Ğ»Ğ¸Ğ½Ğ³', gl: 'Ğ¡Ñ‚Ñ‘ĞºĞ»Ğ°', ms: 'ĞŸÑ€Ğ¾Ñ‡Ğ¸Ğµ ÑƒÑĞ»ÑƒĞ³Ğ¸' };
    Object.entries(cats).forEach(([key, name]) => {
      if (d[key]) add(key, name, d[key].mat || d[key].material);
    });
  }

  return items;
}

async function loadDoneMaterials(calcId) {
  const loading = document.getElementById('doneMaterialsLoading');
  const rows    = document.getElementById('doneMaterialsRows');
  const empty   = document.getElementById('doneMaterialsEmpty');
  const list    = document.getElementById('doneMaterialsList');

  loading.style.display = 'block';
  rows.style.display    = 'none';
  empty.style.display   = 'none';

  const { data } = await sb.from('calculations').select('calculation_data, fact_materials').eq('id', calcId).single();
  const items    = extractMaterials(data?.calculation_data || {});
  const existing = data?.fact_materials || {};

  loading.style.display = 'none';
  _donePlanItems = items;

  if (!items.length) { empty.style.display = 'block'; return; }

  rows.style.display = 'block';
  list.innerHTML = items.map(item => `
    <div style="display:grid;grid-template-columns:1fr 110px 110px;gap:6px;align-items:center">
      <div style="font-size:0.8rem;color:var(--text);font-weight:600;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${item.name}">${item.name}</div>
      <div style="font-size:0.82rem;color:var(--text-muted);text-align:right;font-weight:600">${fmt(item.plan)}</div>
      <div>
        <input type="number"
          data-key="${item.key}"
          value="${existing[item.key] !== undefined ? existing[item.key] : item.plan}"
          min="0" step="1"
          oninput="updateDoneTotals()"
          style="width:100%;padding:5px 8px;background:rgba(124,58,237,0.05);border:1px solid rgba(124,58,237,0.25);border-radius:6px;font-size:0.82rem;font-weight:700;color:#7c3aed;outline:none;text-align:right;font-family:var(--font)"
        >
      </div>
    </div>
  `).join('');

  updateDoneTotals();
}

window.updateDoneTotals = function() {
  let planSum = 0, factSum = 0;
  _donePlanItems.forEach(item => { planSum += item.plan; });
  document.querySelectorAll('#doneMaterialsList input[data-key]').forEach(inp => {
    factSum += parseFloat(inp.value) || 0;
  });

  document.getElementById('donePlanTotal').textContent = fmt(planSum) + ' â‚½';
  document.getElementById('doneFactTotal').textContent = fmt(factSum) + ' â‚½';

  const delta    = factSum - planSum;
  const deltaEl  = document.getElementById('doneDelta');
  if (delta === 0) {
    deltaEl.textContent = 'Ğ¤Ğ°ĞºÑ‚ ÑĞ¾Ğ²Ğ¿Ğ°Ğ» Ñ Ğ¿Ğ»Ğ°Ğ½Ğ¾Ğ¼';
    deltaEl.style.color = 'var(--text-muted)';
  } else if (delta > 0) {
    deltaEl.textContent = `ĞŸĞµÑ€ĞµÑ€Ğ°ÑÑ…Ğ¾Ğ´: +${fmt(delta)} â‚½`;
    deltaEl.style.color = 'var(--danger)';
  } else {
    deltaEl.textContent = `Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ: ${fmt(Math.abs(delta))} â‚½`;
    deltaEl.style.color = 'var(--success)';
  }
};

window.saveDone = async function() {
  // Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ„Ğ°ĞºÑ‚ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ğ¾Ğ²
  const factMaterials = {};
  document.querySelectorAll('#doneMaterialsList input[data-key]').forEach(inp => {
    factMaterials[inp.dataset.key] = parseFloat(inp.value) || 0;
  });

  const extra = Object.keys(factMaterials).length > 0 ? { fact_materials: factMaterials } : {};
  const ok = await updateStatus(activeCalcId, 'done', extra);
  if (ok) { closeModal('modalDone'); loadBoard(); }
};

window.saveDeliver = async function() {
  const price = parseFloat(document.getElementById('deliverPrice').value) || null;
  const note  = document.getElementById('deliverNote').value.trim();
  const ok = await updateStatus(activeCalcId, 'delivered', { final_price: price, delivery_note: note });
  if (ok) { closeModal('modalDeliver'); loadBoard(); }
};

document.querySelectorAll('.modal').forEach(m => {
  m.addEventListener('click', e => {
    if (e.target === m) { m.classList.remove('active'); activeCalcId = null; }
  });
});

async function init() {
  initNav();
  if (!await checkAuth()) return;
  if (!await getStudio()) return;
  await loadBoard();
}

init();

})();
</script>

</body>
</html>
