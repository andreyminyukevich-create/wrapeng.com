<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–î–æ—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤</title>
<script>
const savedTheme = localStorage.getItem('theme') || 'dark';
document.documentElement.setAttribute('data-theme', savedTheme);
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

:root {
  --bg-primary: #080f1e;
  --bg-secondary: #0e1829;
  --bg-card: #131f35;
  --bg-input: #1a2844;
  --text: #eef2ff;
  --text-muted: #8aa0c0;
  --text-label: #b0c4de;
  --border: rgba(120, 160, 220, 0.22);
  --border-focus: rgba(99, 160, 255, 0.6);
  --primary: #5b9cf6;
  --primary-dark: #2563eb;
  --success: #22d3a0;
  --success-dark: #059669;
  --danger: #f87171;
  --danger-bg: rgba(248, 113, 113, 0.14);
  --warning: #fbbf24;
  --shadow: 0 4px 24px rgba(0,0,0,0.5);
  --shadow-lg: 0 8px 40px rgba(0,0,0,0.6);
}

[data-theme="light"] {
  --bg-primary: #f0f4fb;
  --bg-secondary: #ffffff;
  --bg-card: #ffffff;
  --bg-input: #f8faff;
  --text: #0f172a;
  --text-muted: #64748b;
  --text-label: #475569;
  --border: rgba(15, 23, 42, 0.1);
  --border-focus: rgba(79, 142, 247, 0.5);
  --shadow: 0 4px 16px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Inter', -apple-system, sans-serif;
  background: var(--bg-primary);
  color: var(--text);
  line-height: 1.5;
  min-height: 100vh;
  overflow-x: auto;
}

/* Top Bar */
.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow);
}

.top-bar-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.menu-toggle {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 1.1rem;
  transition: all 0.2s;
  color: var(--text);
}

.menu-toggle:hover {
  background: var(--primary);
  color: #fff;
  transform: scale(1.05);
}

.top-bar h1 {
  font-size: 1.3rem;
  font-weight: 800;
  background: linear-gradient(120deg, var(--primary), var(--success));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: -0.5px;
}

.top-bar-right {
  display: flex;
  gap: 10px;
  align-items: center;
}

.global-nav {
  display: flex;
  gap: 6px;
  align-items: center;
}

.nav-link {
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 0.88rem;
  font-weight: 600;
  color: var(--text-muted);
  text-decoration: none;
  transition: all 0.2s;
  border: 1px solid transparent;
}

.nav-link:hover {
  background: var(--bg-input);
  color: var(--text);
}

.nav-link.active {
  background: var(--primary);
  color: #fff;
  border-color: var(--primary);
}

.action-btn {
  background: var(--primary);
  color: #fff;
  border: none;
  padding: 9px 20px;
  border-radius: 10px;
  font-size: 0.88rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}

.action-btn:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
}

/* Drawer Menu */
.drawer-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}

.drawer-overlay.active {
  opacity: 1;
  pointer-events: all;
}

.drawer {
  position: fixed;
  top: 0;
  left: -300px;
  width: 300px;
  height: 100vh;
  background: var(--bg-card);
  box-shadow: var(--shadow-lg);
  z-index: 1000;
  transition: left 0.3s;
  overflow-y: auto;
}

.drawer.active {
  left: 0;
}

.drawer-header {
  padding: 24px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.drawer-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text);
}

.drawer-close {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 6px 10px;
  cursor: pointer;
  font-size: 1.2rem;
  color: var(--text);
  transition: all 0.2s;
}

.drawer-close:hover {
  background: var(--danger);
  color: #fff;
}

.drawer-menu {
  padding: 20px 0;
}

.drawer-link {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 20px;
  color: var(--text);
  text-decoration: none;
  transition: all 0.2s;
  font-size: 0.95rem;
  font-weight: 500;
}

.drawer-link:hover {
  background: var(--bg-input);
  color: var(--primary);
}

.drawer-link.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.drawer-badge {
  margin-left: auto;
  padding: 2px 8px;
  background: var(--warning);
  color: #000;
  border-radius: 6px;
  font-size: 0.7rem;
  font-weight: 700;
}

.btn {
  background: var(--primary);
  color: #fff;
  border: none;
  padding: 9px 20px;
  border-radius: 10px;
  font-size: 0.88rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 7px;
  text-decoration: none;
  font-family: 'Inter', sans-serif;
}

.btn:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: var(--shadow);
}

.btn-secondary {
  background: transparent;
  color: var(--text-muted);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  background: var(--bg-input);
  color: var(--text);
  border-color: var(--border-focus);
}

.theme-toggle {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 1.1rem;
  transition: all 0.2s;
}

/* Board */
.board-wrap {
  padding: 24px;
  display: flex;
  gap: 16px;
  min-height: calc(100vh - 65px);
  align-items: flex-start;
}

/* Column */
.column {
  flex: 0 0 280px;
  background: var(--bg-secondary);
  border-radius: 16px;
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  max-height: calc(100vh - 110px);
}

[data-theme="dark"] .column {
  background: #0a1525;
  border-color: rgba(120,160,220,0.2);
}

.column-header {
  padding: 16px 18px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  border-radius: 16px 16px 0 0;
  background: inherit;
}

.column-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 700;
  font-size: 0.9rem;
  letter-spacing: -0.1px;
}

.column-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

.column-count {
  font-size: 0.75rem;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 10px;
  background: var(--bg-input);
  color: var(--text-muted);
}

.column-cards {
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  overflow-y: auto;
  flex: 1;
}

/* Card */
.kanban-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

[data-theme="dark"] .kanban-card {
  background: #131f35;
  border-color: rgba(120,160,220,0.2);
}

.kanban-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
  border-color: var(--border-focus);
}

.card-car {
  font-weight: 700;
  font-size: 0.92rem;
  margin-bottom: 6px;
  letter-spacing: -0.2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.card-meta {
  display: flex;
  flex-direction: column;
  gap: 3px;
  font-size: 0.78rem;
  color: var(--text-muted);
  margin-bottom: 10px;
}

.card-meta-row {
  display: flex;
  align-items: center;
  gap: 5px;
}

.card-price {
  font-size: 1rem;
  font-weight: 800;
  color: var(--success);
  letter-spacing: -0.5px;
  margin-bottom: 10px;
}

.card-actions {
  display: flex;
  gap: 6px;
}

.card-btn {
  flex: 1;
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.2s;
  font-family: 'Inter', sans-serif;
  text-align: center;
}

.card-btn-primary {
  background: var(--primary);
  color: #fff;
}

.card-btn-primary:hover {
  background: var(--primary-dark);
}

.card-btn-secondary {
  background: var(--bg-input);
  color: var(--text-muted);
  border: 1px solid var(--border);
}

.card-btn-secondary:hover {
  color: var(--text);
  border-color: var(--border-focus);
}

.card-checkin {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 0.75rem;
  font-weight: 600;
  padding: 3px 8px;
  border-radius: 6px;
  background: rgba(251,191,36,0.12);
  color: var(--warning);
  border: 1px solid rgba(251,191,36,0.25);
  margin-bottom: 8px;
}

.card-note {
  font-size: 0.75rem;
  color: var(--text-muted);
  line-height: 1.4;
  margin-bottom: 8px;
  font-style: italic;
}

/* Column colors */
.col-new .column-dot { background: #94a3b8; }
.col-new .column-title { color: #94a3b8; }
.col-new .column-count { background: rgba(148,163,184,0.1); }

.col-scheduled .column-dot { background: #fbbf24; }
.col-scheduled .column-title { color: #fbbf24; }
.col-scheduled .column-count { background: rgba(251,191,36,0.1); color: #fbbf24; }

.col-in_progress .column-dot { background: #5b9cf6; }
.col-in_progress .column-title { color: #5b9cf6; }
.col-in_progress .column-count { background: rgba(91,156,246,0.1); color: #5b9cf6; }

.col-done .column-dot { background: #a78bfa; }
.col-done .column-title { color: #a78bfa; }
.col-done .column-count { background: rgba(167,139,250,0.1); color: #a78bfa; }

.col-delivered .column-dot { background: #22d3a0; }
.col-delivered .column-title { color: #22d3a0; }
.col-delivered .column-count { background: rgba(34,211,160,0.1); color: #22d3a0; }

.empty-col {
  text-align: center;
  padding: 32px 16px;
  color: var(--text-muted);
  font-size: 0.82rem;
  opacity: 0.6;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal.active { display: flex; }

.modal-content {
  background: var(--bg-card);
  border-radius: 20px;
  border: 1px solid var(--border);
  padding: 32px;
  max-width: 480px;
  width: 100%;
  box-shadow: var(--shadow-lg);
}

.modal-title {
  font-size: 1.2rem;
  font-weight: 800;
  margin-bottom: 8px;
  letter-spacing: -0.3px;
}

.modal-car {
  font-size: 0.9rem;
  color: var(--text-muted);
  margin-bottom: 24px;
}

.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  font-size: 0.78rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-label);
  margin-bottom: 6px;
}

.form-group input,
.form-group textarea,
.form-group select {
  width: 100%;
  padding: 11px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-size: 0.9rem;
  font-family: 'Inter', sans-serif;
  transition: all 0.2s;
}

.form-group textarea {
  resize: vertical;
  min-height: 80px;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
  outline: none;
  border-color: var(--border-focus);
  box-shadow: 0 0 0 3px rgba(79,142,247,0.1);
}

.modal-footer {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 24px;
}

.loading {
  text-align: center;
  padding: 60px;
  color: var(--text-muted);
  width: 100%;
}

/* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
@media (max-width: 768px) {
  .top-bar {
    flex-wrap: wrap;
    padding: 14px 16px;
    gap: 12px;
  }

  .top-bar-left {
    width: 100%;
    justify-content: center;
  }

  .top-bar h1 {
    font-size: 1.15rem;
  }

  .global-nav {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
    flex-wrap: nowrap;
    padding: 8px 0;
  }

  .global-nav::-webkit-scrollbar {
    display: none;
  }

  .nav-link {
    font-size: 0.8rem;
    padding: 6px 12px;
    flex-shrink: 0;
  }

  .action-btn {
    width: 100%;
    justify-content: center;
  }

  .board-wrap {
    padding: 12px 8px;
    gap: 12px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .column {
    flex: 0 0 280px;
    max-height: calc(100vh - 140px);
  }

  .column-header {
    padding: 14px 16px 12px;
  }

  .column-title {
    font-size: 0.85rem;
  }

  .column-cards {
    padding: 12px;
  }

  .kanban-card {
    padding: 14px 16px;
  }

  .card-car {
    font-size: 0.9rem;
  }

  .card-price {
    font-size: 1rem;
  }

  .card-btn {
    padding: 10px 12px;
    font-size: 0.8rem;
    min-height: 36px;
  }

  .modal {
    padding: 12px;
  }

  .modal-content {
    max-width: 100%;
    margin: 0;
    padding: 24px 20px;
    border-radius: 16px;
  }

  .modal-title {
    font-size: 1.1rem;
  }

  .form-group input,
  .form-group textarea,
  .form-group select {
    font-size: 16px; /* Prevent zoom on iOS */
    padding: 12px 14px;
  }

  .btn {
    padding: 12px 20px;
    font-size: 0.9rem;
    min-height: 44px; /* Touch target */
  }
}

@media (max-width: 480px) {
  .column {
    flex: 0 0 260px;
  }

  .card-actions {
    flex-direction: column;
    gap: 8px;
  }

  .card-btn {
    width: 100%;
    justify-content: center;
  }

  .modal-content {
    padding: 20px 16px;
  }

  .modal-footer {
    flex-direction: column-reverse;
  }

  .modal-footer .btn {
    width: 100%;
  }
}
    width: 100%;
  }

  .modal-footer {
    flex-direction: column;
    gap: 8px;
  }

  .modal-footer .btn {
    width: 100%;
  }

  .global-nav {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
    flex-wrap: nowrap;
  }

  .global-nav::-webkit-scrollbar {
    display: none;
  }

  .nav-link {
    flex-shrink: 0;
  }
}

/* Footer */
.page-footer {
  margin-top: 60px;
  padding: 32px 24px;
  background: var(--bg-card);
  border-top: 1px solid var(--border);
  text-align: center;
}

.footer-content {
  max-width: 800px;
  margin: 0 auto;
}

.footer-theme {
  margin-bottom: 20px;
}

.footer-theme button {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 20px;
  cursor: pointer;
  font-size: 1.1rem;
  transition: all 0.2s;
  font-family: 'Inter', sans-serif;
  color: var(--text);
}

.footer-theme button:hover {
  border-color: var(--border-focus);
  transform: translateY(-2px);
}

.footer-desc {
  color: var(--text-muted);
  font-size: 0.9rem;
  line-height: 1.6;
  max-width: 600px;
  margin: 0 auto;
}

.footer-desc strong {
  color: var(--text);
  font-weight: 600;
}

@media (max-width: 600px) {
  .page-footer {
    padding: 24px 16px;
    margin-top: 40px;
  }

  .footer-desc {
    font-size: 0.85rem;
  }
}

</style>
</head>
<body>

<!-- Top Bar -->
<div class="top-bar">
  <div class="top-bar-left">
    <button class="menu-toggle" id="menuToggle">‚ò∞</button>
    <h1>üìã –ó–∞–∫–∞–∑—ã</h1>
  </div>
  <nav class="global-nav">
    <a href="dashboard.html" class="nav-link">üè† –ì–ª–∞–≤–Ω–∞—è</a>
    <a href="board.html" class="nav-link active">üìã –ó–∞–∫–∞–∑—ã</a>
    <a href="executors.html" class="nav-link">üë• –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</a>
    <a href="payouts.html" class="nav-link">üí∞ –ó–∞—Ä–ø–ª–∞—Ç—ã</a>
    <a href="inventory.html" class="nav-link">üì¶ –°–∫–ª–∞–¥</a>
    <a href="settlements.html" class="nav-link">üí≥ –†–∞—Å—á—ë—Ç—ã</a>
  </nav>
  <a href="calculator.html" class="action-btn">‚ûï –ù–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç</a>
</div>

<!-- Board -->
<div class="board-wrap" id="board">
  <div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<!-- Modal: –ù–∞–∑–Ω–∞—á–∏—Ç—å –¥–∞—Ç—É –∑–∞–µ–∑–¥–∞ -->
<div class="modal" id="modalSchedule">
  <div class="modal-content">
    <div class="modal-title">üìÖ –ù–∞–∑–Ω–∞—á–∏—Ç—å –¥–∞—Ç—É –∑–∞–µ–∑–¥–∞</div>
    <div class="modal-car" id="scheduleCarName"></div>
    <div class="form-group">
      <label>–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞</label>
      <input type="date" id="scheduleDate">
    </div>
    <div class="form-group">
      <label>–í—Ä–µ–º—è –∑–∞–µ–∑–¥–∞</label>
      <input type="time" id="scheduleTime" value="10:00">
    </div>
    <div class="form-group">
      <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <textarea id="scheduleNote" placeholder="–ü–æ–∂–µ–ª–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏..."></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalSchedule')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn" style="background:var(--warning);color:#000" onclick="saveSchedule()">üìÖ –ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Modal: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
<div class="modal" id="modalInfo">
  <div class="modal-content">
    <div class="modal-title">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</div>
    <div style="margin-bottom:20px">
      <div style="font-size:1.2rem;font-weight:700;margin-bottom:16px" id="infoCarName"></div>
      <div style="display:flex;flex-direction:column;gap:12px">
        <div style="display:flex;justify-content:space-between">
          <span style="color:var(--text-muted)">–°—Ç–∞—Ç—É—Å:</span>
          <span id="infoStatus" style="font-weight:600"></span>
        </div>
        <div style="display:flex;justify-content:space-between">
          <span style="color:var(--text-muted)">–°—É–º–º–∞:</span>
          <span id="infoPrice" style="font-weight:700;color:var(--success)"></span>
        </div>
        <div id="infoCheckinBlock" style="display:none">
          <div style="display:flex;justify-content:space-between">
            <span style="color:var(--text-muted)">–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞:</span>
            <span id="infoCheckin" style="font-weight:600"></span>
          </div>
        </div>
        <div id="infoNoteBlock" style="display:none;padding:12px;background:var(--bg-secondary);border-radius:8px">
          <div style="font-size:0.75rem;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</div>
          <div id="infoNote" style="font-style:italic"></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalInfo')">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btn btn-primary" onclick="openCalcFromInfo()">üìÇ –û—Ç–∫—Ä—ã—Ç—å —Ä–∞—Å—á—ë—Ç</button>
    </div>
  </div>
</div>

<!-- Modal: –ó–∞–≤–µ—Ä—à–∏—Ç—å -->
<div class="modal" id="modalDone">
  <div class="modal-content">
    <div class="modal-title">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É</div>
    <div class="modal-car" id="doneCarName"></div>
    <p style="color:var(--text-muted);font-size:0.9rem;margin-bottom:24px">
      –†–∞–±–æ—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –û–¢–ö –ø—Ä–æ–≤–µ—Ä–∏–ª. –ú–∞—à–∏–Ω–∞ –∂–¥—ë—Ç –≤—ã–¥–∞—á–∏ –∫–ª–∏–µ–Ω—Ç—É.
    </p>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalDone')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn" style="background:#a78bfa" onclick="saveDone()">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Modal: –í—ã–¥–∞—Ç—å -->
<div class="modal" id="modalDeliver">
  <div class="modal-content">
    <div class="modal-title">üöó –í—ã–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É</div>
    <div class="modal-car" id="deliverCarName"></div>
    <div class="form-group">
      <label>–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞</label>
      <input type="number" id="deliverPrice" placeholder="–ò–∑ —Ä–∞—Å—á—ë—Ç–∞">
    </div>
    <div class="form-group">
      <label>–§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã</label>
      <select id="deliverPayment">
        <option value="cash">üíµ –ù–∞–ª–∏—á–Ω—ã–µ</option>
        <option value="card">üí≥ –ö–∞—Ä—Ç–∞</option>
        <option value="transfer">üè¶ –ü–µ—Ä–µ–≤–æ–¥</option>
      </select>
    </div>
    <div class="form-group">
      <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <textarea id="deliverNote" placeholder="–ü–æ–∂–µ–ª–∞–Ω–∏—è, –∑–∞–º–µ—á–∞–Ω–∏—è..."></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalDeliver')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn" style="background:var(--success);color:#000" onclick="saveDeliver()">üöó –í—ã–¥–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- Drawer Menu -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
<div class="drawer" id="drawer">
  <div class="drawer-header">
    <div class="drawer-title">üìÅ –ú–µ–Ω—é</div>
    <button class="drawer-close" onclick="closeDrawer()">‚úï</button>
  </div>
  <nav class="drawer-menu">
    <a href="analytics.html" class="drawer-link disabled">
      üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
      <span class="drawer-badge">–°–∫–æ—Ä–æ</span>
    </a>
    <a href="price-lists.html" class="drawer-link disabled">
      üíµ –ü—Ä–∞–π—Å—ã
      <span class="drawer-badge">–°–∫–æ—Ä–æ</span>
    </a>
    <a href="calendar.html" class="drawer-link disabled">
      üóì –ö–∞–ª–µ–Ω–¥–∞—Ä—å
      <span class="drawer-badge">–°–∫–æ—Ä–æ</span>
    </a>
    <a href="settings.html" class="drawer-link disabled">
      ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
      <span class="drawer-badge">–°–∫–æ—Ä–æ</span>
    </a>
  </nav>
</div>

<footer class="page-footer">
  <div class="footer-content">
    <div class="footer-theme">
      <button id="themeToggle">üåô</button>
    </div>
    <div class="footer-desc">
      <strong>–ó–∞–∫–∞–∑—ã</strong> ‚Äî –∫–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–æ—Ä–æ–Ω–∫–æ–π –ø—Ä–æ–¥–∞–∂. 
      5 —Å—Ç–∞–¥–∏–π: –†–∞—Å—á—ë—Ç ‚Üí –ó–∞–µ–∑–¥ ‚Üí –í —Ä–∞–±–æ—Ç–µ ‚Üí –ó–∞–≤–µ—Ä—à–µ–Ω–æ ‚Üí –í—ã–¥–∞–Ω–æ. 
      –ü–µ—Ä–µ–º–µ—â–∞–π—Ç–µ –∑–∞–∫–∞–∑—ã –º–µ–∂–¥—É —Å—Ç–∞–¥–∏—è–º–∏, –Ω–∞–∑–Ω–∞—á–∞–π—Ç–µ –¥–∞—Ç—ã –∑–∞–µ–∑–¥–∞, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞–±–æ—Ç.
    </div>
  </div>
</footer>

<script>
(function() {
'use strict';

const SUPABASE_URL = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let currentStudio = null;
let allCalcs = [];
let activeCalcId = null;

const COLUMNS = [
  { key: 'new',         label: '–†–∞—Å—á—ë—Ç',      icon: 'üìã' },
  { key: 'scheduled',   label: '–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞',  icon: 'üìÖ' },
  { key: 'in_progress', label: '–í —Ä–∞–±–æ—Ç–µ',     icon: 'üîß' },
  { key: 'done',        label: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',    icon: '‚úÖ' },
  { key: 'delivered',   label: '–í—ã–¥–∞–Ω–æ',       icon: 'üöó' },
];

// Theme
function initTheme() {
  const t = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', t);
  document.getElementById('themeToggle').textContent = t === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}

document.getElementById('themeToggle').addEventListener('click', () => {
  const cur = document.documentElement.getAttribute('data-theme');
  const next = cur === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  document.getElementById('themeToggle').textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
});

// Drawer Menu
function openDrawer() {
  document.getElementById('drawer').classList.add('active');
  document.getElementById('drawerOverlay').classList.add('active');
}

window.closeDrawer = function() {
  document.getElementById('drawer').classList.remove('active');
  document.getElementById('drawerOverlay').classList.remove('active');
};

document.getElementById('menuToggle')?.addEventListener('click', openDrawer);

// Format
function fmt(n) {
  return new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n || 0);
}

function fmtDate(d) {
  if (!d) return null;
  return new Date(d).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
}

// Auth
async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'welcome.html'; return false; }
  currentUser = session.user;
  return true;
}

async function getStudio() {
  const { data, error } = await sb
    .from('studio_members')
    .select('studio_id, role')
    .eq('user_id', currentUser.id)
    .eq('is_active', true)
    .single();
  if (error || !data) { alert('‚ùå –°—Ç—É–¥–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); return false; }
  currentStudio = data;
  return true;
}

// Load
async function loadBoard() {
  const { data, error } = await sb
    .from('calculations')
    .select('id, car_name, total_price, final_price, status, checkin_date, checkin_time, schedule_note, work_assigned, created_at')
    .eq('studio_id', currentStudio.studio_id)
    .order('created_at', { ascending: false });

  if (error) { console.error(error); return; }
  allCalcs = data || [];
  renderBoard();
}

// Render
function renderBoard() {
  const board = document.getElementById('board');

  let html = '';
  COLUMNS.forEach(col => {
    const cards = allCalcs.filter(c => (c.status || 'new') === col.key);
    html += `
      <div class="column col-${col.key}">
        <div class="column-header">
          <div class="column-title">
            <div class="column-dot"></div>
            ${col.icon} ${col.label}
          </div>
          <div class="column-count">${cards.length}</div>
        </div>
        <div class="column-cards">
          ${cards.length === 0
            ? `<div class="empty-col">üì≠ –ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>`
            : cards.map(c => renderCard(c, col.key)).join('')
          }
        </div>
      </div>
    `;
  });

  board.innerHTML = html;
}

function renderCard(calc, status) {
  const price = fmt(calc.final_price || calc.total_price);
  
  let checkin = '';
  if (calc.checkin_date) {
    const dateStr = fmtDate(calc.checkin_date);
    const timeStr = calc.checkin_time ? calc.checkin_time.slice(0, 5) : '';
    checkin = `<div class="card-checkin">üìÖ ${dateStr}${timeStr ? ', ' + timeStr : ''}</div>`;
  }

  let note = '';
  if (calc.schedule_note) {
    note = `<div class="card-note">üí¨ ${calc.schedule_note}</div>`;
  }

  let actions = '';
  if (status === 'new') {
    actions = `
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();openCalc('${calc.id}')">üìÇ –û—Ç–∫—Ä—ã—Ç—å</button>
      <button class="card-btn card-btn-primary" onclick="event.stopPropagation();openModal('modalSchedule','${calc.id}','${escStr(calc.car_name)}')">üìÖ –ó–∞–µ–∑–¥</button>
    `;
  } else if (status === 'scheduled') {
    actions = `
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();openModal('modalSchedule','${calc.id}','${escStr(calc.car_name)}')">‚úèÔ∏è –î–∞—Ç–∞</button>
      <button class="card-btn card-btn-primary" onclick="event.stopPropagation();goAssign('${calc.id}')">üîß –í —Ä–∞–±–æ—Ç—É</button>
    `;
  } else if (status === 'in_progress') {
    actions = `
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();goAssign('${calc.id}')">üë• –†–∞–±–æ—Ç—ã</button>
      <button class="card-btn card-btn-primary" onclick="event.stopPropagation();openModal('modalDone','${calc.id}','${escStr(calc.car_name)}')" style="background:#a78bfa">‚úÖ –ì–æ—Ç–æ–≤–æ</button>
    `;
  } else if (status === 'done') {
    actions = `
      <button class="card-btn card-btn-primary" onclick="event.stopPropagation();openModalDeliver('${calc.id}','${escStr(calc.car_name)}',${calc.total_price || 0})" style="background:var(--success);color:#000">üöó –í—ã–¥–∞—Ç—å</button>
    `;
  } else if (status === 'delivered') {
    actions = `
      <button class="card-btn card-btn-secondary" onclick="event.stopPropagation();openCalc('${calc.id}')">üìÇ –û—Ç–∫—Ä—ã—Ç—å</button>
    `;
  }

  return `
    <div class="kanban-card" onclick="openModalInfo('${calc.id}', '${escStr(calc.car_name)}', '${status}', ${calc.final_price || calc.total_price || 0}, '${calc.checkin_date || ''}', '${calc.checkin_time || ''}', '${escStr(calc.schedule_note || '')}')">
      <div class="card-car">${calc.car_name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
      ${checkin}
      ${note}
      <div class="card-price">${price} ‚ÇΩ</div>
      <div class="card-actions" onclick="event.stopPropagation()">
        ${actions}
      </div>
    </div>
  `;
}

function escStr(s) {
  return (s || '').replace(/'/g, '&#39;').replace(/"/g, '&quot;');
}

// Modal helpers
function openModal(modalId, calcId, carName) {
  activeCalcId = calcId;
  const nameEl = document.getElementById(modalId.replace('modal', '').toLowerCase() + 'CarName');
  if (nameEl) nameEl.textContent = carName;

  // –î–ª—è schedule - –∏–º–µ–Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥—Ä—É–≥–∏–µ
  if (modalId === 'modalSchedule') {
    document.getElementById('scheduleCarName').textContent = carName;
    document.getElementById('scheduleDate').value = '';
    document.getElementById('scheduleTime').value = '10:00';
    document.getElementById('scheduleNote').value = '';
  }
  if (modalId === 'modalDone') {
    document.getElementById('doneCarName').textContent = carName;
  }

  document.getElementById(modalId).classList.add('active');
}

function openModalDeliver(calcId, carName, price) {
  activeCalcId = calcId;
  document.getElementById('deliverCarName').textContent = carName;
  document.getElementById('deliverPrice').value = price;
  document.getElementById('deliverNote').value = '';
  document.getElementById('modalDeliver').classList.add('active');
}

window.openModalInfo = function(calcId, carName, status, price, checkinDate, checkinTime, note) {
  activeCalcId = calcId;
  
  const STATUS_LABELS = {
    new: 'üìã –†–∞—Å—á—ë—Ç',
    scheduled: 'üìÖ –î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞',
    in_progress: 'üîß –í —Ä–∞–±–æ—Ç–µ',
    done: '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ',
    delivered: 'üöó –í—ã–¥–∞–Ω–æ'
  };
  
  document.getElementById('infoCarName').textContent = carName;
  document.getElementById('infoStatus').textContent = STATUS_LABELS[status] || status;
  document.getElementById('infoPrice').textContent = fmt(price) + ' ‚ÇΩ';
  
  // –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –∑–∞–µ–∑–¥–∞
  const checkinBlock = document.getElementById('infoCheckinBlock');
  if (checkinDate) {
    const dateStr = fmtDate(checkinDate);
    const timeStr = checkinTime ? checkinTime.slice(0, 5) : '';
    document.getElementById('infoCheckin').textContent = dateStr + (timeStr ? ', ' + timeStr : '');
    checkinBlock.style.display = 'block';
  } else {
    checkinBlock.style.display = 'none';
  }
  
  // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
  const noteBlock = document.getElementById('infoNoteBlock');
  if (note) {
    document.getElementById('infoNote').textContent = note;
    noteBlock.style.display = 'block';
  } else {
    noteBlock.style.display = 'none';
  }
  
  document.getElementById('modalInfo').classList.add('active');
};

window.openCalcFromInfo = function() {
  closeModal('modalInfo');
  window.location.href = `calculator.html?load=${activeCalcId}`;
};

window.closeModal = function(modalId) {
  document.getElementById(modalId).classList.remove('active');
  activeCalcId = null;
};

window.openModal = openModal;
window.openModalDeliver = openModalDeliver;

// Actions
window.openCalc = function(calcId) {
  window.location.href = `calculator.html?load=${calcId}`;
};

window.goAssign = function(calcId) {
  window.location.href = `assign-work.html?calc_id=${calcId}`;
};

async function updateStatus(calcId, status, extra = {}) {
  const { error } = await sb
    .from('calculations')
    .update({ status, ...extra })
    .eq('id', calcId);

  if (error) {
    console.error(error);
    alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
    return false;
  }
  return true;
}

window.saveSchedule = async function() {
  const date = document.getElementById('scheduleDate').value;
  const time = document.getElementById('scheduleTime').value;
  const note = document.getElementById('scheduleNote').value.trim();
  
  if (!date) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É!'); return; }
  if (!time) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è!'); return; }

  const ok = await updateStatus(activeCalcId, 'scheduled', { 
    checkin_date: date,
    checkin_time: time,
    schedule_note: note || null
  });
  if (ok) {
    closeModal('modalSchedule');
    loadBoard();
  }
};

window.saveDone = async function() {
  const ok = await updateStatus(activeCalcId, 'done');
  if (ok) {
    closeModal('modalDone');
    loadBoard();
  }
};

window.saveDeliver = async function() {
  const price = parseFloat(document.getElementById('deliverPrice').value) || null;
  const note = document.getElementById('deliverNote').value.trim();

  const ok = await updateStatus(activeCalcId, 'delivered', {
    final_price: price,
    delivery_note: note
  });
  if (ok) {
    closeModal('modalDeliver');
    loadBoard();
  }
};

// Close modal on backdrop
document.querySelectorAll('.modal').forEach(m => {
  m.addEventListener('click', e => {
    if (e.target === m) {
      m.classList.remove('active');
      activeCalcId = null;
    }
  });
});

// Init
async function init() {
  initTheme();
  if (!await checkAuth()) return;
  if (!await getStudio()) return;
  loadBoard();
}

init();

})();
</script>

</body>
</html>
