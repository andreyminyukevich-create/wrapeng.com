<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Keep1R CRM â€” Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="nav.css">
<script src="nav.js"></script>
<style>

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  background: #eef2f9;
  color: #0f172a;
  min-height: 100svh;
}

.container {
  max-width: 1360px;
  margin: 0 auto;
  padding: 28px 24px 48px;
}

/* â”€â”€ Ğ¨Ğ°Ğ¿ĞºĞ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 12px;
}

.page-greeting {
  display: flex;
  flex-direction: column;
}

.studio-name {
  font-size: 1.25rem;
  font-weight: 800;
  color: #0f172a;
  letter-spacing: -0.3px;
  line-height: 1.2;
}

.studio-sub {
  font-size: 0.78rem;
  color: #64748b;
  margin-top: 2px;
  font-weight: 500;
}

.btn-logout {
  padding: 8px 16px;
  background: #fff;
  color: #64748b;
  border: 1px solid rgba(15,23,42,0.10);
  border-radius: 9px;
  font-size: 0.81rem;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.15s;
  white-space: nowrap;
}
.btn-logout:hover {
  background: #fee2e2;
  color: #dc2626;
  border-color: rgba(220,38,38,0.2);
}

/* â”€â”€ Ğ¡Ñ‚Ğ°Ñ‚-ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 14px;
  margin-bottom: 20px;
}

.stat-card {
  background: #fff;
  border-radius: 16px;
  border: 1px solid rgba(15,23,42,0.07);
  padding: 22px 20px 18px;
  position: relative;
  overflow: hidden;
  transition: box-shadow 0.18s, transform 0.18s;
  text-decoration: none;
  display: block;
  color: inherit;
  box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}

.stat-card::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: var(--accent, #2563eb);
  opacity: 0.7;
}

.stat-card:hover {
  box-shadow: 0 6px 24px rgba(37,99,235,0.10);
  transform: translateY(-2px);
}

.stat-icon {
  font-size: 1.5rem;
  line-height: 1;
  margin-bottom: 14px;
  display: block;
}

.stat-label {
  font-size: 0.7rem;
  color: #64748b;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 6px;
}

.stat-value {
  font-size: 1.75rem;
  font-weight: 800;
  color: #0f172a;
  line-height: 1;
  margin-bottom: 6px;
  letter-spacing: -0.5px;
}

.stat-change {
  font-size: 0.75rem;
  color: #64748b;
  font-weight: 500;
}

/* Ğ¦Ğ²ĞµÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ°ĞºÑ†ĞµĞ½Ñ‚Ñ‹ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº */
.stat-card:nth-child(1) { --accent: #2563eb; }
.stat-card:nth-child(2) { --accent: #059669; }
.stat-card:nth-child(3) { --accent: #7c3aed; }
.stat-card:nth-child(4) { --accent: #d97706; }

/* â”€â”€ ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ°-ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: #fff;
  border-radius: 16px;
  border: 1px solid rgba(15,23,42,0.07);
  padding: 20px 22px;
  margin-bottom: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.card-title {
  font-size: 0.95rem;
  font-weight: 700;
  color: #0f172a;
  letter-spacing: -0.1px;
}

.card-link {
  font-size: 0.78rem;
  font-weight: 700;
  color: #2563eb;
  text-decoration: none;
  padding: 5px 12px;
  border-radius: 8px;
  border: 1px solid rgba(37,99,235,0.25);
  background: rgba(37,99,235,0.04);
  transition: all 0.15s;
  white-space: nowrap;
}
.card-link:hover {
  background: #2563eb;
  color: #fff;
  border-color: #2563eb;
}

/* â”€â”€ ĞŸĞ¾Ğ¸ÑĞº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.search-wrap { margin-bottom: 16px; }

.search-input {
  width: 100%;
  max-width: 400px;
  padding: 10px 16px;
  border: 1px solid rgba(15,23,42,0.10);
  border-radius: 10px;
  font-size: 0.88rem;
  font-family: inherit;
  color: #0f172a;
  background: #fff;
  outline: none;
  transition: border-color 0.15s, box-shadow 0.15s;
  box-shadow: 0 1px 2px rgba(0,0,0,0.03);
}
.search-input::placeholder { color: #94a3b8; }
.search-input:focus {
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37,99,235,0.08);
}

/* â”€â”€ ĞœĞ¸Ğ½Ğ¸-ĞºĞ°Ğ½Ğ±Ğ°Ğ½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mini-kanban {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 10px;
}

.mini-col { min-width: 0; }

.mini-col-header {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 8px;
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: #64748b;
  padding-bottom: 8px;
  border-bottom: 2px solid rgba(15,23,42,0.06);
}

.mini-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  flex-shrink: 0;
}

.mini-cards { display: flex; flex-direction: column; gap: 5px; }

.mini-card {
  background: #f8fafc;
  border: 1px solid rgba(15,23,42,0.07);
  border-radius: 10px;
  padding: 10px 11px;
  cursor: pointer;
  transition: all 0.15s;
}
.mini-card:hover {
  border-color: #2563eb;
  background: #fff;
  box-shadow: 0 2px 10px rgba(37,99,235,0.08);
  transform: translateY(-1px);
}

.mini-card-car {
  font-size: 0.82rem;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: #0f172a;
  margin-bottom: 3px;
}

.mini-card-price {
  font-size: 0.78rem;
  color: #059669;
  font-weight: 700;
}

.mini-col-more {
  font-size: 0.68rem;
  color: #94a3b8;
  text-align: center;
  padding: 5px;
  cursor: pointer;
  border-radius: 7px;
  border: 1px dashed rgba(15,23,42,0.1);
  margin-top: 2px;
  transition: all 0.15s;
}
.mini-col-more:hover {
  color: #2563eb;
  border-color: rgba(37,99,235,0.3);
  background: rgba(37,99,235,0.03);
}

.mini-col-empty {
  font-size: 0.7rem;
  color: #94a3b8;
  text-align: center;
  padding: 16px 4px;
}

/* Ğ¦Ğ²ĞµÑ‚Ğ° ĞºĞ¾Ğ»Ğ¾Ğ½Ğ¾Ğº */
.mini-col-new         .mini-dot { background: #94a3b8; }
.mini-col-new         .mini-col-header { color: #64748b; border-bottom-color: #94a3b8; }
.mini-col-scheduled   .mini-dot { background: #f59e0b; }
.mini-col-scheduled   .mini-col-header { color: #92400e; border-bottom-color: #f59e0b; }
.mini-col-in_progress .mini-dot { background: #2563eb; }
.mini-col-in_progress .mini-col-header { color: #1e40af; border-bottom-color: #2563eb; }
.mini-col-done        .mini-dot { background: #7c3aed; }
.mini-col-done        .mini-col-header { color: #5b21b6; border-bottom-color: #7c3aed; }
.mini-col-delivered   .mini-dot { background: #059669; }
.mini-col-delivered   .mini-col-header { color: #065f46; border-bottom-color: #059669; }

/* â”€â”€ Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¿Ğ¾Ğ¸ÑĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.calc-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 12px;
}

.calc-card {
  background: #f8fafc;
  border: 1px solid rgba(15,23,42,0.07);
  border-radius: 12px;
  padding: 15px;
  cursor: pointer;
  transition: all 0.15s;
}
.calc-card:hover {
  border-color: #2563eb;
  box-shadow: 0 4px 16px rgba(37,99,235,0.08);
  transform: translateY(-1px);
}
.calc-card h3 {
  font-size: 0.9rem;
  font-weight: 700;
  margin-bottom: 4px;
  color: #0f172a;
}
.calc-price {
  font-size: 1.1rem;
  font-weight: 800;
  color: #059669;
  margin-bottom: 12px;
  letter-spacing: -0.3px;
}

.calc-actions { display: flex; gap: 7px; }

/* â”€â”€ ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 7px 12px; border-radius: 8px;
  font-size: 0.78rem; font-weight: 700;
  font-family: inherit; cursor: pointer;
  border: none; transition: all 0.15s; text-decoration: none;
}
.btn-primary { background: #2563eb; color: #fff; }
.btn-primary:hover { background: #1d4ed8; }
.btn-success {
  background: rgba(5,150,105,0.08);
  color: #059669;
  border: 1px solid rgba(5,150,105,0.2);
}
.btn-success:hover { background: #059669; color: #fff; }

/* â”€â”€ Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading {
  text-align: center;
  padding: 40px;
  color: #64748b;
  font-size: 0.88rem;
}

.empty-state {
  text-align: center;
  padding: 48px 20px;
  color: #64748b;
}
.empty-state-icon {
  font-size: 2.2rem;
  margin-bottom: 10px;
  opacity: 0.35;
}
.empty-state h3 {
  font-size: 0.95rem;
  color: #0f172a;
  font-weight: 700;
}

/* â”€â”€ ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 1100px) {
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 768px) {
  .container { padding: 16px 14px 40px; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
  .stat-value { font-size: 1.4rem; }
  .mini-kanban { grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 480px) {
  .mini-kanban { grid-template-columns: repeat(2, 1fr); }
  .search-input { max-width: 100%; }
  .stats-grid { gap: 8px; }
}
</style>
</head>
<body>

<div class="container">

  <!-- Ğ¨Ğ°Ğ¿ĞºĞ° -->
  <div class="page-header">
    <div class="page-greeting">
      <div class="studio-name" id="studioNameHeader">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
      <div class="studio-sub" id="studioSubheader">Keep1R CRM</div>
    </div>
    <button class="btn-logout" onclick="logout()">Ğ’Ñ‹Ğ¹Ñ‚Ğ¸ â†’</button>
  </div>

  <!-- Ğ¡Ñ‚Ğ°Ñ‚-ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ -->
  <div class="stats-grid" id="statsGrid">
    <a class="stat-card" href="analytics.html">
      <span class="stat-icon">ğŸš—</span>
      <div class="stat-label">Ğ Ğ°ÑÑ‡Ñ‘Ñ‚Ğ¾Ğ² Ğ·Ğ° Ğ¼ĞµÑÑÑ†</div>
      <div class="stat-value" id="statMonthTotal">â€”</div>
      <div class="stat-change" id="statMonthTotalChange">Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑÑÑ†</div>
    </a>
    <a class="stat-card" href="analytics.html">
      <span class="stat-icon">ğŸ’°</span>
      <div class="stat-label">Ğ¡ÑƒĞ¼Ğ¼Ğ° Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ¾Ğ²</div>
      <div class="stat-value" id="statMonthSum">â€”</div>
      <div class="stat-change">Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑÑÑ†</div>
    </a>
    <a class="stat-card" href="analytics.html">
      <span class="stat-icon">âœ…</span>
      <div class="stat-label">Ğ—Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹</div>
      <div class="stat-value" id="statMonthDone">â€”</div>
      <div class="stat-change" id="statMonthDoneCount">0 Ğ¼Ğ°ÑˆĞ¸Ğ½</div>
    </a>
    <a class="stat-card" href="analytics.html">
      <span class="stat-icon">ğŸ“Š</span>
      <div class="stat-label">Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ‡ĞµĞº</div>
      <div class="stat-value" id="statMonthAvg">â€”</div>
      <div class="stat-change">Ğ—Ğ° Ğ¼ĞµÑÑÑ†</div>
    </a>
  </div>

  <!-- ĞŸĞ¾Ğ¸ÑĞº -->
  <div class="search-wrap">
    <input
      type="text"
      class="search-input"
      id="searchInput"
      placeholder="ğŸ” ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¼Ğ°ÑˆĞ¸Ğ½Ğµ..."
      oninput="handleSearch()"
      autocomplete="off"
    >
  </div>

  <!-- Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¿Ğ¾Ğ¸ÑĞºĞ° -->
  <div class="card" id="searchResultsCard" style="display:none">
    <div class="card-header">
      <span class="card-title">ğŸ” Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¿Ğ¾Ğ¸ÑĞºĞ°</span>
    </div>
    <div id="searchResults"></div>
  </div>

  <!-- ĞœĞ¸Ğ½Ğ¸-ĞºĞ°Ğ½Ğ±Ğ°Ğ½ -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">ğŸ“‹ Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ</span>
      <a href="board.html" class="card-link">ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ²ÑÑ‘ â†’</a>
    </div>
    <div class="mini-kanban" id="miniKanban">
      <div class="loading">â³ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
    </div>
  </div>

</div>

<script src="footer.js"></script>
<script>
(function() {
'use strict';

const SUPABASE_URL      = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window._crmSb = sb;

let currentUser       = null;
let allCalcsForSearch = [];

async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'welcome.html'; return false; }
  currentUser = session.user;
  return true;
}

window.logout = async function() {
  await sb.auth.signOut();
  window.location.href = 'welcome.html';
};

function fmt(n) {
  return new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n || 0);
}

function normalizeStatus(status) {
  if (!status || status === '' || status === 'draft' || status === 'pending') return 'new';
  return status;
}

function updateStats(calculations) {
  const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
  const month      = calculations.filter(c => new Date(c.created_at) >= monthStart);
  const total      = month.length;
  const sum        = month.reduce((a, c) => a + (c.total_price || 0), 0);
  const done       = month.filter(c => ['done','delivered'].includes(normalizeStatus(c.status)));
  const doneSum    = done.reduce((a, c) => a + (c.final_price || c.total_price || 0), 0);
  const avg        = total > 0 ? sum / total : 0;

  document.getElementById('statMonthTotal').textContent     = total;
  document.getElementById('statMonthSum').textContent       = fmt(sum) + ' â‚½';
  document.getElementById('statMonthDone').textContent      = fmt(doneSum) + ' â‚½';
  document.getElementById('statMonthAvg').textContent       = fmt(avg) + ' â‚½';
  document.getElementById('statMonthDoneCount').textContent = done.length + ' Ğ¼Ğ°ÑˆĞ¸Ğ½';
  document.getElementById('statMonthTotalChange').textContent = 'Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑÑÑ†';
}

const MINI_COLS = [
  { key: 'new',         label: 'Ğ Ğ°ÑÑ‡Ñ‘Ñ‚',    icon: 'ğŸ“‹' },
  { key: 'scheduled',   label: 'Ğ—Ğ°ĞµĞ·Ğ´',     icon: 'ğŸ“…' },
  { key: 'in_progress', label: 'Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ',  icon: 'ğŸ”§' },
  { key: 'done',        label: 'Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾', icon: 'âœ…' },
  { key: 'delivered',   label: 'Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ¾',    icon: 'ğŸš—' },
];

async function loadMiniKanban(studioId) {
  const container = document.getElementById('miniKanban');

  const { data, error } = await sb
    .from('calculations')
    .select('id, car_name, total_price, final_price, status')
    .eq('studio_id', studioId)
    .order('created_at', { ascending: false });

  if (error) {
    container.innerHTML = `<div class="loading" style="color:#dc2626">âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ${error.message}</div>`;
    return;
  }
  if (!data || data.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><h3>Ğ—Ğ°ĞºĞ°Ğ·Ğ¾Ğ² Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚</h3></div>`;
    return;
  }

  let html = '';
  MINI_COLS.forEach(col => {
    const cards   = data.filter(c => normalizeStatus(c.status) === col.key);
    const visible = cards.slice(0, 5);
    const rest    = cards.length - 5;

    html += `<div class="mini-col mini-col-${col.key}">`;
    html += `<div class="mini-col-header"><div class="mini-dot"></div>${col.icon} ${col.label}</div>`;
    html += `<div class="mini-cards">`;

    if (cards.length === 0) {
      html += `<div class="mini-col-empty">ĞĞµÑ‚</div>`;
    } else {
      visible.forEach(c => {
        html += `<div class="mini-card" onclick="location.href='board.html'">
          <div class="mini-card-car">${c.car_name || 'Ğ‘ĞµĞ· Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ'}</div>
          <div class="mini-card-price">${fmt(c.final_price || c.total_price || 0)} â‚½</div>
        </div>`;
      });
      if (rest > 0) {
        html += `<div class="mini-col-more" onclick="location.href='board.html'">+ ĞµÑ‰Ñ‘ ${rest}</div>`;
      }
    }
    html += `</div></div>`;
  });
  container.innerHTML = html;
}

let searchTimeout;

window.handleSearch = function() {
  clearTimeout(searchTimeout);
  const term = document.getElementById('searchInput').value.trim().toLowerCase();
  const card = document.getElementById('searchResultsCard');
  const box  = document.getElementById('searchResults');
  if (!term) { card.style.display = 'none'; return; }

  searchTimeout = setTimeout(() => {
    const found = allCalcsForSearch.filter(c => (c.car_name || '').toLowerCase().includes(term));
    card.style.display = 'block';

    if (found.length === 0) {
      box.innerHTML = `<div class="empty-state" style="padding:30px">
        <div class="empty-state-icon">ğŸ”</div><h3>ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾</h3></div>`;
      return;
    }

    const STATUS = {
      new: 'ğŸ“‹ Ğ Ğ°ÑÑ‡Ñ‘Ñ‚', scheduled: 'ğŸ“… Ğ—Ğ°ĞµĞ·Ğ´',
      in_progress: 'ğŸ”§ Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ', done: 'âœ… Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾', delivered: 'ğŸš— Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ¾'
    };
    box.innerHTML = `<div class="calc-grid">` + found.map(c => `
      <div class="calc-card" onclick="location.href='calculator.html?load=${c.id}'">
        <h3>${c.car_name || 'Ğ‘ĞµĞ· Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ'}</h3>
        <div class="calc-price">${fmt(c.final_price || c.total_price || 0)} â‚½</div>
        <div class="calc-actions">
          <a class="btn btn-primary" href="calculator.html?load=${c.id}" onclick="event.stopPropagation()">ğŸ“‚ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ</a>
          <a class="btn btn-success" href="assign-work.html?calc_id=${c.id}" onclick="event.stopPropagation()">ğŸ‘¥ Ğ Ğ°Ğ±Ğ¾Ñ‚Ñ‹</a>
        </div>
      </div>`).join('') + `</div>`;
  }, 300);
};

function showLockedDashboard() {
  const fakeStats = [
    { icon: 'ğŸš—', label: 'Ğ Ğ°ÑÑ‡Ñ‘Ñ‚Ğ¾Ğ² Ğ·Ğ° Ğ¼ĞµÑÑÑ†', value: 'â–ˆâ–ˆ', change: '+â–ˆâ–ˆ%' },
    { icon: 'ğŸ’°', label: 'Ğ¡ÑƒĞ¼Ğ¼Ğ° Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ¾Ğ²',     value: 'â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ â‚½', change: '+â–ˆâ–ˆ%' },
    { icon: 'âœ…', label: 'Ğ—Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹', value: 'â–ˆâ–ˆ', change: '' },
    { icon: 'ğŸ“Š', label: 'Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ‡ĞµĞº',        value: 'â–ˆâ–ˆ â–ˆâ–ˆ â‚½', change: '+â–ˆâ–ˆ%' },
  ];

  const grid = document.getElementById('statsGrid');
  if (grid) {
    grid.innerHTML = fakeStats.map(s => `
      <div class="stat-card" style="cursor:default">
        <span class="stat-icon">${s.icon}</span>
        <div class="stat-label">${s.label}</div>
        <div class="stat-value" style="filter:blur(5px);user-select:none">${s.value}</div>
        ${s.change ? `<div class="stat-change" style="filter:blur(4px);user-select:none">${s.change}</div>` : ''}
      </div>`).join('');
  }

  const kanban = document.getElementById('miniKanban');
  if (kanban) {
    kanban.innerHTML = `
      <div style="grid-column:1/-1;text-align:center;padding:32px 16px;color:#94a3b8">
        <div style="font-size:2rem;margin-bottom:10px">ğŸ“‹</div>
        <div style="font-size:0.88rem;font-weight:600;color:#64748b;margin-bottom:4px">Ğ—Ğ´ĞµÑÑŒ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ²Ğ°ÑˆĞ¸ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹</div>
        <div style="font-size:0.8rem">ĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ´Ğ¾ÑĞºÑƒ</div>
      </div>`;
  }

  const search = document.getElementById('searchInput');
  if (search) { search.disabled = true; search.placeholder = 'ğŸ”’ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹'; }
}

async function init() {
  initNav();
  if (!await checkAuth()) return;

  const { data: member } = await sb
    .from('studio_members')
    .select('studio_id')
    .eq('user_id', currentUser.id)
    .eq('is_active', true)
    .single();

  if (!member) {
    document.getElementById('miniKanban').innerHTML =
      `<div class="loading" style="color:#dc2626">âš ï¸ Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°. ĞĞ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ.</div>`;
    return;
  }

  const studioId = member.studio_id;

  const { data: studioInfo } = await sb.from('studios').select('name').eq('id', studioId).single();
  if (studioInfo) {
    document.getElementById('studioNameHeader').textContent = studioInfo.name;
    document.getElementById('studioSubheader').textContent  = 'Keep1R CRM';
  }

  const subStatus = await checkSubscription(studioId);
  if (subStatus === 'expired' || subStatus === 'none') {
    showPaywall(subStatus === 'expired');
    showLockedDashboard();
    return;
  }

  const { data: calcs } = await sb
    .from('calculations')
    .select('id, car_name, total_price, final_price, status, work_assigned, created_at')
    .eq('studio_id', studioId)
    .order('created_at', { ascending: false });

  allCalcsForSearch = calcs || [];
  updateStats(allCalcsForSearch);
  await loadMiniKanban(studioId);
}

document.addEventListener('DOMContentLoaded', init);

})();
</script>

</body>
</html>
