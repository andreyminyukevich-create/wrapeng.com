<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–∫–ª–µ–π–∫–∏</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="dashboard-container">
    <!-- Header -->
    <header class="dashboard-header">
      <div class="header-left">
        <h1>üîß Dashboard</h1>
        <p id="studioName">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
      </div>
      <div class="header-right">
        <span id="userEmail">user@email.com</span>
        <button id="logoutBtn" class="btn-logout">–í—ã—Ö–æ–¥</button>
      </div>
    </header>

    <!-- Trial Banner -->
    <div id="trialBanner" class="trial-banner" style="display: none;">
      <span id="trialText">‚è∞ –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥: –æ—Å—Ç–∞–ª–æ—Å—å X –¥–Ω–µ–π</span>
    </div>

    <!-- Main Dashboard -->
    <main class="dashboard-main">
      <!-- Calculator Card -->
      <div class="dashboard-card" id="calculatorCard">
        <div class="card-icon">üßÆ</div>
        <h2>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h2>
        <p>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç</p>
        <button class="btn-primary" onclick="openCalculator()">–û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
      </div>

      <!-- My Calculations Card -->
      <div class="dashboard-card">
        <div class="card-icon">üìä</div>
        <h2>–ú–æ–∏ —Ä–∞—Å—á—ë—Ç—ã</h2>
        <p>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–æ–≤</p>
        <button class="btn-primary" onclick="openMyCalculations()">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞—Å—á—ë—Ç—ã</button>
      </div>

      <!-- Referral Card -->
      <div class="dashboard-card">
        <div class="card-icon">üîó</div>
        <h2>–ü–æ—Å–æ–≤–µ—Ç–æ–≤–∞—Ç—å</h2>
        <p id="referralCount">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ: 0 —á–µ–ª–æ–≤–µ–∫</p>
        <input type="text" id="referralLink" readonly class="referral-input">
        <button class="btn-secondary" onclick="copyReferralLink()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
      </div>

      <!-- Analytics Card (Coming Soon) -->
      <div class="dashboard-card card-disabled">
        <div class="card-icon">üìà</div>
        <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
        <p>–ü—Ä–∏–±—ã–ª—å, —Ä–∞—Å—Ö–æ–¥—ã, –ó–ü</p>
        <span class="coming-soon">–°–∫–æ—Ä–æ...</span>
      </div>
    </main>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal" style="display: none;">
      <div class="modal-content">
        <h2>‚ö†Ô∏è –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è</h2>
        <p>–û–ø–ª–∞—Ç–∏—Ç–µ –¥–æ—Å—Ç—É–ø –Ω–∞ –ª–µ–Ω–¥–∏–Ω–≥–µ, –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º—ã –æ—Ç–º–µ—Ç–∏–º –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π.</p>
        <button class="btn-primary" onclick="window.open('https://your-landing.com', '_blank')">
          –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ
        </button>
        <button class="btn-secondary" onclick="closePaymentModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <script src="shared.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      await initAuth();
      
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const user = await getCurrentUser();
      if (!user) {
        window.location.replace('/welcome.html');
        return;
      }

      const profile = await getProfile(user.id);
      if (!profile) {
        console.error('Profile not found');
        return;
      }

      document.getElementById('userEmail').textContent = user.email;
      document.getElementById('studioName').textContent = profile.studio_name || '–ú–æ—è —Å—Ç—É–¥–∏—è';

      checkTrialStatus(profile);

      const refLink = `${window.location.origin}/?ref=${profile.referral_code}&mode=trial`;
      document.getElementById('referralLink').value = refLink;

      const refCount = await getReferralCount(user.id);
      document.getElementById('referralCount').textContent = `–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ: ${refCount} —á–µ–ª–æ–≤–µ–∫`;

      document.getElementById('logoutBtn').addEventListener('click', async () => {
        await logout();
        window.location.replace('/welcome.html');
      });
    });

    function checkTrialStatus(profile) {
      if (profile.is_paid) {
        return;
      }

      const now = new Date();
      const trialEnds = profile.trial_ends_at ? new Date(profile.trial_ends_at) : null;

      if (!trialEnds) {
        showPaymentModal();
        return;
      }

      const daysLeft = Math.ceil((trialEnds - now) / (1000 * 60 * 60 * 24));

      if (daysLeft <= 0) {
        showPaymentModal();
      } else {
        const banner = document.getElementById('trialBanner');
        banner.style.display = 'block';
        document.getElementById('trialText').textContent = 
          `‚è∞ –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥: –æ—Å—Ç–∞–ª–æ—Å—å ${daysLeft} ${getDaysWord(daysLeft)}`;
      }
    }

    function getDaysWord(days) {
      if (days === 1) return '–¥–µ–Ω—å';
      if (days >= 2 && days <= 4) return '–¥–Ω—è';
      return '–¥–Ω–µ–π';
    }

    function showPaymentModal() {
      document.getElementById('paymentModal').style.display = 'flex';
      document.getElementById('calculatorCard').classList.add('card-disabled');
    }

    function closePaymentModal() {
      document.getElementById('paymentModal').style.display = 'none';
    }

    function openCalculator() {
      window.location.href = 'calculator.html';
    }

    function openMyCalculations() {
      window.location.href = 'my-calculations.html';
    }

    async function copyReferralLink() {
      const input = document.getElementById('referralLink');
      try {
        await navigator.clipboard.writeText(input.value);
        alert('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
      } catch (err) {
        input.select();
        document.execCommand('copy');
        alert('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
      }
    }

    async function getReferralCount(userId) {
      return 0;
    }
  </script>
</body>
</html>
