<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–î–∞—à–±–æ—Ä–¥</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --bg-tertiary: #334155;
  --card: rgba(255, 255, 255, 0.05);
  --card-hover: rgba(255, 255, 255, 0.08);
  --text: #f1f5f9;
  --text-muted: #94a3b8;
  --border: rgba(148, 163, 184, 0.1);
  --border-hover: rgba(148, 163, 184, 0.2);
  --primary: #3b82f6;
  --primary-dark: #2563eb;
  --success: #10b981;
  --danger: #ef4444;
  --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.15);
  --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.2);
}

[data-theme="light"] {
  --bg-primary: #f8fafc;
  --bg-secondary: #f1f5f9;
  --bg-tertiary: #e2e8f0;
  --card: rgba(255, 255, 255, 0.9);
  --card-hover: rgba(255, 255, 255, 1);
  --text: #0f172a;
  --text-muted: #475569;
  --border: rgba(15, 23, 42, 0.08);
  --border-hover: rgba(15, 23, 42, 0.15);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-primary);
  color: var(--text);
  line-height: 1.6;
  transition: background-color 0.3s ease;
  min-height: 100vh;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 80% 70%, rgba(16, 185, 129, 0.15) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  position: relative;
  z-index: 1;
}

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 40px;
  padding: 20px;
  background: var(--card);
  backdrop-filter: blur(20px);
  border-radius: 16px;
  border: 1px solid var(--border);
}

.top-bar h1 {
  font-size: 1.5rem;
  font-weight: 700;
  background: linear-gradient(135deg, var(--primary), var(--success));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 0.9rem;
}

.user-info > div {
  white-space: nowrap;
}

.top-bar-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.btn {
  padding: 12px 20px;
  border: none;
  border-radius: 12px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #fff;
  box-shadow: var(--shadow-md);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.btn-secondary {
  background: var(--bg-secondary);
  color: var(--text);
  border: 2px solid var(--border);
}

.btn-secondary:hover {
  background: var(--bg-tertiary);
  border-color: var(--border-hover);
}

.btn-danger {
  background: var(--danger);
  color: #fff;
}

.btn-danger:hover {
  background: #dc2626;
}

.actions {
  display: flex;
  gap: 12px;
  margin-bottom: 30px;
}

.card {
  background: var(--card);
  backdrop-filter: blur(20px);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 20px;
  border: 1px solid var(--border);
  transition: all 0.3s;
}

.card:hover {
  border-color: var(--border-hover);
  box-shadow: var(--shadow-md);
}

.card h2 {
  font-size: 1.2rem;
  margin-bottom: 20px;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 10px;
}

.card h2::before {
  content: '';
  width: 4px;
  height: 24px;
  background: linear-gradient(180deg, var(--primary), var(--success));
  border-radius: 4px;
}

.calculations-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
}

.calc-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  transition: all 0.3s;
  position: relative;
}

.calc-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
  border-color: var(--border-hover);
}

.calc-card h3 {
  font-size: 1.1rem;
  margin-bottom: 12px;
  color: var(--text);
  font-weight: 600;
}

.calc-info {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
  font-size: 0.9rem;
  color: var(--text-muted);
}

.calc-price {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--success);
  margin-bottom: 16px;
}

.calc-actions {
  display: flex;
  gap: 8px;
}

.calc-actions .btn {
  flex: 1;
  justify-content: center;
  font-size: 0.85rem;
  padding: 10px 16px;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-muted);
}

.empty-state-icon {
  font-size: 4rem;
  margin-bottom: 16px;
  opacity: 0.5;
}

.loading {
  text-align: center;
  padding: 40px;
  color: var(--text-muted);
}

.theme-toggle {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 8px 16px;
  cursor: pointer;
  font-size: 1.2rem;
  transition: all 0.3s;
}

.theme-toggle:hover {
  background: var(--bg-tertiary);
}

@media (max-width: 768px) {
  .top-bar {
    flex-direction: column;
    gap: 16px;
    text-align: center;
  }
  
  .user-info {
    flex-direction: column;
    gap: 8px;
  }
  
  .top-bar-right {
    flex-direction: column;
    width: 100%;
  }
  
  .actions {
    flex-direction: column;
  }
  
  .calculations-grid {
    grid-template-columns: 1fr;
  }
}
</style>
<script>
// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É –î–û –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–µ–ª—å–∫–∞–Ω–∏–µ)
(function() {
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
  }
})();
</script>
</head>
<body>

<div class="container">
  <div class="top-bar">
    <h1>üìä –î–∞—à–±–æ—Ä–¥</h1>
    <div class="top-bar-right">
      <div class="user-info" id="userInfo"></div>
      <div class="theme-toggle" onclick="toggleTheme()">
        <span id="themeIcon">‚òÄÔ∏è</span>
      </div>
      <button class="btn btn-danger" onclick="logout()">–í—ã—Ö–æ–¥</button>
    </div>
  </div>
  
  <div class="actions">
    <a href="calculator.html" class="btn btn-primary">‚ûï –ù–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç</a>
    <a href="salaries.html" class="btn btn-success">üí∞ –ü–æ–¥—Å—á–µ—Ç –ó–ü</a>
    <button class="btn btn-secondary" onclick="loadCalculations()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
  </div>
  
  <div class="card">
    <h2>üíº –ú–æ–∏ —Ä–∞—Å—á–µ—Ç—ã</h2>
    <div id="calculationsContainer" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let currentProfile = null;

// ========================================
// AUTH
// ========================================

async function checkAuth() {
  try {
    const { data: { session }, error } = await sb.auth.getSession();
    
    if (error || !session) {
      window.location.href = 'welcome.html';
      return false;
    }

    currentUser = session.user;
    
    const { data: profile, error: profileError } = await sb
      .from('profiles')
      .select('*')
      .eq('id', currentUser.id)
      .single();
    
    if (profileError || !profile) {
      console.error('Profile error:', profileError);
      await sb.auth.signOut();
      window.location.href = 'welcome.html';
      return false;
    }

    currentProfile = profile;

    if (!profile.is_paid) {
      const now = new Date();
      const trialEnds = profile.trial_ends_at ? new Date(profile.trial_ends_at) : null;
      
      if (!trialEnds || trialEnds <= now) {
        alert('‚ö†Ô∏è –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∏—Å—Ç—ë–∫. –û–ø–ª–∞—Ç–∏—Ç–µ –¥–æ—Å—Ç—É–ø.');
        await sb.auth.signOut();
        window.location.href = 'welcome.html';
        return false;
      }
    }

    displayUserInfo();
    return true;
  } catch (e) {
    console.error('Auth check error:', e);
    window.location.href = 'welcome.html';
    return false;
  }
}

function displayUserInfo() {
  const userInfo = document.getElementById('userInfo');
  if (!userInfo || !currentProfile) return;

  let statusText = '';
  if (currentProfile.is_paid) {
    statusText = '‚úÖ –û–ø–ª–∞—á–µ–Ω';
  } else if (currentProfile.trial_ends_at) {
    const now = new Date();
    const end = new Date(currentProfile.trial_ends_at);
    const hours = Math.floor((end - now) / (1000 * 60 * 60));
    statusText = hours > 0 ? `üïê –¢—Ä–∏–∞–ª: ${hours}—á` : '‚ö†Ô∏è –ò—Å—Ç—ë–∫';
  }

  userInfo.innerHTML = `
    <div style="font-weight:600">${currentProfile.studio_name || '–°—Ç—É–¥–∏—è'}</div>
    <div style="color:var(--text-muted)">${currentUser.email}</div>
    <div>${statusText}</div>
  `;
}

async function logout() {
  if (confirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) {
    await sb.auth.signOut();
    localStorage.clear();
    sessionStorage.clear();
    window.location.href = 'welcome.html';
  }
}

// ========================================
// CALCULATIONS
// ========================================

async function loadCalculations() {
  const container = document.getElementById('calculationsContainer');
  container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  
  try {
    // –ü–æ–ª—É—á–∞–µ–º studio_id —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const { data: memberData, error: memberError } = await sb
      .from('studio_members')
      .select('studio_id')
      .eq('user_id', currentUser.id)
      .eq('is_active', true)
      .single();
    
    if (memberError || !memberData) {
      console.error('No studio found:', memberError);
      // Fallback - –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ user_id
      var studioId = null;
    } else {
      var studioId = memberData.studio_id;
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å—á—ë—Ç—ã (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50)
    let query = sb
      .from('calculations')
      .select('*')
      .order('updated_at', { ascending: false })
      .limit(50);
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ studio_id –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –ø–æ user_id
    if (studioId) {
      query = query.eq('studio_id', studioId);
    } else {
      query = query.eq('user_id', currentUser.id);
    }
    
    const { data, error } = await query;
    
    if (error) {
      console.error('Error loading calculations:', error);
      container.innerHTML = '<div class="empty-state">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
      return;
    }
    
    if (!data || data.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üì≠</div>
          <h3>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤</h3>
          <p style="margin-top:8px">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç —á—Ç–æ–±—ã –æ–Ω –ø–æ—è–≤–∏–ª—Å—è –∑–¥–µ—Å—å</p>
        </div>
      `;
      return;
    }
    
    const grid = document.createElement('div');
    grid.className = 'calculations-grid';
    
    data.forEach(calc => {
      const card = document.createElement('div');
      card.className = 'calc-card';
      
      const updatedDate = new Date(calc.updated_at);
      const dateStr = updatedDate.toLocaleDateString('ru-RU', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
      });
      const timeStr = updatedDate.toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
      });
      
      card.innerHTML = `
        <h3>${calc.car_name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h3>
        <div class="calc-info">
          <div>üìÖ ${dateStr} –≤ ${timeStr}</div>
        </div>
        <div class="calc-price">${formatPrice(calc.total_price)}</div>
        <div class="calc-actions">
          <button class="btn btn-primary" onclick="openCalculation('${calc.id}')">
            üìÇ –û—Ç–∫—Ä—ã—Ç—å
          </button>
          <button class="btn btn-danger" onclick="deleteCalculation('${calc.id}')">
            üóëÔ∏è
          </button>
        </div>
      `;
      
      grid.appendChild(card);
    });
    
    container.innerHTML = '';
    container.appendChild(grid);
    
  } catch (e) {
    console.error('Error:', e);
    container.innerHTML = '<div class="empty-state">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
  }
}

function openCalculation(calcId) {
  window.location.href = `calculator.html?load=${calcId}`;
}

async function deleteCalculation(calcId) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–∞—Å—á–µ—Ç?')) return;
  
  try {
    const { error } = await sb
      .from('calculations')
      .delete()
      .eq('id', calcId)
      .eq('user_id', currentUser.id);
    
    if (error) {
      console.error('Delete error:', error);
      alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
      return;
    }
    
    loadCalculations();
  } catch (e) {
    console.error('Error:', e);
    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
  }
}

function formatPrice(price) {
  return parseFloat(price || 0).toLocaleString('ru-RU', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

// ========================================
// THEME
// ========================================

function toggleTheme() {
  const body = document.body;
  const icon = document.getElementById('themeIcon');
  const currentTheme = body.getAttribute('data-theme');
  
  if (currentTheme === 'light') {
    body.removeAttribute('data-theme');
    icon.textContent = '‚òÄÔ∏è';
    localStorage.setItem('theme', 'dark');
  } else {
    body.setAttribute('data-theme', 'light');
    icon.textContent = 'üåô';
    localStorage.setItem('theme', 'light');
  }
}

function initTheme() {
  const saved = localStorage.getItem('theme');
  const icon = document.getElementById('themeIcon');
  
  if (saved === 'light') {
    document.body.setAttribute('data-theme', 'light');
    icon.textContent = 'üåô';
  } else {
    icon.textContent = '‚òÄÔ∏è';
  }
}

// ========================================
// INIT
// ========================================

document.addEventListener('DOMContentLoaded', async () => {
  const hasAccess = await checkAuth();
  if (!hasAccess) return;
  
  initTheme();
  loadCalculations();
});
</script>

</body>
</html>
