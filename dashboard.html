<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keep1R CRM â€” Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="nav.css">
<script src="nav.js"></script>
<style>

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  background: #f0f4fb;
  color: #0f172a;
  min-height: 100vh;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 28px 24px;
}

/* â”€â”€ Ğ¡Ñ‚Ğ°Ñ‚-ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}

.stat-card {
  background: #fff;
  border-radius: 14px;
  border: 1px solid var(--border, rgba(15,23,42,0.08));
  padding: 26px 28px;
  position: relative;
  overflow: hidden;
  transition: box-shadow 0.2s, transform 0.2s;
  text-decoration: none;
  display: block;
  color: inherit;
}
.stat-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary, #2563eb), #7c3aed);
}
.stat-card:hover {
  box-shadow: 0 6px 24px rgba(37,99,235,0.10);
  transform: translateY(-2px);
}
.stat-icon { font-size: 1.8rem; margin-bottom: 12px; line-height: 1; }
.stat-label {
  font-size: 0.78rem;
  color: #64748b;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.4px;
  margin-bottom: 8px;
}
.stat-value {
  font-size: 2.1rem;
  font-weight: 800;
  color: #0f172a;
  line-height: 1;
  margin-bottom: 8px;
}
.stat-change {
  font-size: 0.82rem;
  color: var(--success, #059669);
  font-weight: 500;
}

/* â”€â”€ Ğ‘Ğ»Ğ¾Ğº-ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: #fff;
  border-radius: 14px;
  border: 1px solid var(--border, rgba(15,23,42,0.08));
  padding: 22px 24px;
  margin-bottom: 20px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
}
.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 18px;
}
.card-title {
  font-size: 1.05rem;
  font-weight: 700;
  color: var(--text, #0f172a);
}
.card-link {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--primary, #2563eb);
  text-decoration: none;
  padding: 5px 12px;
  border-radius: 7px;
  border: 1px solid rgba(37,99,235,0.3);
  transition: all 0.15s;
}
.card-link:hover {
  background: var(--primary, #2563eb);
  color: #fff;
  border-color: var(--primary, #2563eb);
}

/* â”€â”€ ĞŸĞ¾Ğ¸ÑĞº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.search-wrap { margin-bottom: 20px; }
.search-input {
  width: 100%;
  max-width: 420px;
  padding: 10px 16px;
  border: 1px solid var(--border, rgba(15,23,42,0.12));
  border-radius: 10px;
  font-size: 0.9rem;
  font-family: inherit;
  color: var(--text, #0f172a);
  background: #fff;
  outline: none;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.search-input:focus {
  border-color: var(--primary, #2563eb);
  box-shadow: 0 0 0 3px rgba(37,99,235,0.08);
}

/* â”€â”€ ĞœĞ¸Ğ½Ğ¸-ĞºĞ°Ğ½Ğ±Ğ°Ğ½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mini-kanban {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 12px;
}
.mini-col { min-width: 0; }
.mini-col-header {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 8px;
  font-size: 0.78rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.mini-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.mini-cards { display: flex; flex-direction: column; gap: 5px; }

.mini-card {
  background: var(--bg-input, #f1f5ff);
  border: 1px solid var(--border, rgba(15,23,42,0.08));
  border-radius: 8px;
  padding: 10px 12px;
  cursor: pointer;
  transition: all 0.15s;
}
.mini-card:hover {
  border-color: var(--primary, #2563eb);
  box-shadow: 0 2px 8px rgba(37,99,235,0.08);
}
.mini-card-car {
  font-size: 0.88rem;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text, #0f172a);
  margin-bottom: 3px;
}
.mini-card-price { font-size: 0.82rem; color: var(--success, #059669); font-weight: 700; }

.mini-col-more {
  font-size: 0.7rem;
  color: var(--text-muted, #64748b);
  text-align: center;
  padding: 5px;
  cursor: pointer;
  border-radius: 7px;
  border: 1px dashed var(--border, rgba(15,23,42,0.12));
  margin-top: 2px;
  transition: all 0.15s;
}
.mini-col-more:hover { color: var(--primary, #2563eb); border-color: var(--primary, #2563eb); }
.mini-col-empty { font-size: 0.7rem; color: var(--text-muted, #64748b); text-align: center; padding: 14px 4px; opacity: 0.5; }

/* Ğ¦Ğ²ĞµÑ‚Ğ° ĞºĞ¾Ğ»Ğ¾Ğ½Ğ¾Ğº */
.mini-col-new         .mini-dot { background: #94a3b8; }
.mini-col-new         .mini-col-header { color: #64748b; }
.mini-col-scheduled   .mini-dot { background: #f59e0b; }
.mini-col-scheduled   .mini-col-header { color: #92400e; }
.mini-col-in_progress .mini-dot { background: #3b82f6; }
.mini-col-in_progress .mini-col-header { color: #1e40af; }
.mini-col-done        .mini-dot { background: #8b5cf6; }
.mini-col-done        .mini-col-header { color: #5b21b6; }
.mini-col-delivered   .mini-dot { background: #10b981; }
.mini-col-delivered   .mini-col-header { color: #065f46; }

/* â”€â”€ Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¿Ğ¾Ğ¸ÑĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.calc-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 14px;
}
.calc-card {
  background: var(--bg-primary, #f0f4fb);
  border: 1px solid var(--border, rgba(15,23,42,0.08));
  border-radius: 12px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.15s;
}
.calc-card:hover { border-color: var(--primary, #2563eb); box-shadow: 0 4px 16px rgba(37,99,235,0.08); }
.calc-card h3 { font-size: 0.95rem; font-weight: 700; margin-bottom: 5px; }
.calc-price { font-size: 1.2rem; font-weight: 800; color: var(--success, #059669); margin-bottom: 12px; }
.calc-actions { display: flex; gap: 8px; }

.btn {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 7px 13px; border-radius: 8px;
  font-size: 0.8rem; font-weight: 600;
  font-family: inherit; cursor: pointer;
  border: none; transition: all 0.15s; text-decoration: none;
}
.btn-primary { background: var(--primary, #2563eb); color: #fff; }
.btn-primary:hover { background: var(--primary-dark, #1d4ed8); }
.btn-success { background: var(--success-bg, rgba(5,150,105,0.1)); color: var(--success, #059669); border: 1px solid rgba(5,150,105,0.25); }
.btn-success:hover { background: var(--success, #059669); color: #fff; }

/* â”€â”€ Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading { text-align: center; padding: 40px; color: var(--text-muted, #64748b); font-size: 0.9rem; }
.empty-state { text-align: center; padding: 50px 20px; color: var(--text-muted, #64748b); }
.empty-state-icon { font-size: 2.5rem; margin-bottom: 10px; opacity: 0.4; }
.empty-state h3 { font-size: 1rem; color: var(--text, #0f172a); }

/* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page-footer {
  margin-top: 40px;
  padding: 24px;
  text-align: center;
  border-top: 1px solid var(--border, rgba(15,23,42,0.08));
}
.footer-desc { font-size: 0.8rem; color: var(--text-muted, #64748b); max-width: 540px; margin: 0 auto; line-height: 1.6; }

/* â”€â”€ ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 1100px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 768px) {
  .container { padding: 16px 14px; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
  .mini-kanban { grid-template-columns: repeat(3, 1fr); }
  .stat-value { font-size: 1.4rem; }
}
@media (max-width: 480px) {
  .mini-kanban { grid-template-columns: repeat(2, 1fr); }
  .search-input { max-width: 100%; }
}

</style>
</head>
<body>

<div class="container">

  <!-- Ğ¨Ğ°Ğ¿ĞºĞ° Ñ Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸ĞµĞ¼ Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ Ğ²Ñ‹Ğ¹Ñ‚Ğ¸ -->
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px">
    <div>
      <div style="font-size:1.2rem;font-weight:800;color:#0f172a" id="studioNameHeader">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
      <div style="font-size:0.8rem;color:#64748b;margin-top:2px" id="studioSubheader">Keep1R CRM</div>
    </div>
    <button onclick="logout()" style="padding:7px 16px;background:#f1f5ff;color:#64748b;border:1.5px solid rgba(15,23,42,0.1);border-radius:8px;font-size:0.82rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.15s" onmouseover="this.style.background='#fee2e2';this.style.color='#dc2626';this.style.borderColor='rgba(220,38,38,0.2)'" onmouseout="this.style.background='#f1f5ff';this.style.color='#64748b';this.style.borderColor='rgba(15,23,42,0.1)'">
      Ğ’Ñ‹Ğ¹Ñ‚Ğ¸ â†’
    </button>
  </div>

  <!-- Ğ¡Ñ‚Ğ°Ñ‚-ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ -->
  <div class="stats-grid">
    <a class="stat-card" href="analytics.html">
      <div class="stat-icon">ğŸš—</div>
      <div class="stat-label">Ğ Ğ°ÑÑ‡Ñ‘Ñ‚Ğ¾Ğ² Ğ·Ğ° Ğ¼ĞµÑÑÑ†</div>
      <div class="stat-value" id="statMonthTotal">â€”</div>
      <div class="stat-change" id="statMonthTotalChange">Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑÑÑ†</div>
    </a>
    <a class="stat-card" href="analytics.html">
      <div class="stat-icon">ğŸ’°</div>
      <div class="stat-label">Ğ¡ÑƒĞ¼Ğ¼Ğ° Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ¾Ğ²</div>
      <div class="stat-value" id="statMonthSum">â€”</div>
      <div class="stat-change">Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑÑÑ†</div>
    </a>
    <a class="stat-card" href="analytics.html">
      <div class="stat-icon">âœ…</div>
      <div class="stat-label">Ğ—Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹</div>
      <div class="stat-value" id="statMonthDone">â€”</div>
      <div class="stat-change" id="statMonthDoneCount">0 Ğ¼Ğ°ÑˆĞ¸Ğ½</div>
    </a>
    <a class="stat-card" href="analytics.html">
      <div class="stat-icon">ğŸ“Š</div>
      <div class="stat-label">Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ‡ĞµĞº</div>
      <div class="stat-value" id="statMonthAvg">â€”</div>
      <div class="stat-change">Ğ—Ğ° Ğ¼ĞµÑÑÑ†</div>
    </a>
  </div>

  <!-- ĞŸĞ¾Ğ¸ÑĞº -->
  <div class="search-wrap">
    <input
      type="text"
      class="search-input"
      id="searchInput"
      placeholder="ğŸ” ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¼Ğ°ÑˆĞ¸Ğ½Ğµ..."
      oninput="handleSearch()"
      autocomplete="off"
    >
  </div>

  <!-- Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¿Ğ¾Ğ¸ÑĞºĞ° -->
  <div class="card" id="searchResultsCard" style="display:none">
    <div class="card-header">
      <span class="card-title">ğŸ” Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¿Ğ¾Ğ¸ÑĞºĞ°</span>
    </div>
    <div id="searchResults"></div>
  </div>

  <!-- ĞœĞ¸Ğ½Ğ¸-ĞºĞ°Ğ½Ğ±Ğ°Ğ½ -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">ğŸ“‹ Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ</span>
      <a href="board.html" class="card-link">ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ²ÑÑ‘ â†’</a>
    </div>
    <div class="mini-kanban" id="miniKanban">
      <div class="loading">â³ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
    </div>
  </div>

</div>

<footer class="page-footer">
  <div class="footer-desc">
    <strong>Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ</strong> â€” ÑĞ²Ğ¾Ğ´ĞºĞ° Ğ·Ğ° Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑÑÑ†. ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ ĞºĞ»Ğ¸ĞºĞ°Ğ±ĞµĞ»ÑŒĞ½Ñ‹ Ğ¸ Ğ²ĞµĞ´ÑƒÑ‚ Ğ² ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºÑƒ.
    ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ»ÑĞ±Ğ¾Ğ¹ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¼Ğ°ÑˆĞ¸Ğ½Ñ‹.
  </div>
</footer>

<script>
(function() {
'use strict';

const SUPABASE_URL     = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window._crmSb = sb; // Ğ´Ğ»Ñ nav.js checkSubscription

let currentUser        = null;
let allCalcsForSearch  = [];

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'welcome.html'; return false; }
  currentUser = session.user;
  return true;
}

window.logout = async function() {
  await sb.auth.signOut();
  window.location.href = 'welcome.html';
};

// â”€â”€ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ñ‡Ğ¸ÑĞ»Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n) {
  return new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n || 0);
}

// â”€â”€ Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats(calculations) {
  const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
  const month      = calculations.filter(c => new Date(c.created_at) >= monthStart);
  const total      = month.length;
  const sum        = month.reduce((a, c) => a + (c.total_price || 0), 0);
  const done       = month.filter(c => c.work_assigned === true);
  const doneSum    = done.reduce((a, c) => a + (c.total_price || 0), 0);
  const avg        = total > 0 ? sum / total : 0;

  document.getElementById('statMonthTotal').textContent      = total;
  document.getElementById('statMonthSum').textContent        = fmt(sum) + ' â‚½';
  document.getElementById('statMonthDone').textContent       = fmt(doneSum) + ' â‚½';
  document.getElementById('statMonthAvg').textContent        = fmt(avg) + ' â‚½';
  document.getElementById('statMonthDoneCount').textContent  = done.length + ' Ğ¼Ğ°ÑˆĞ¸Ğ½';
  document.getElementById('statMonthTotalChange').textContent = 'Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑÑÑ†';
}

// â”€â”€ ĞœĞ¸Ğ½Ğ¸-ĞºĞ°Ğ½Ğ±Ğ°Ğ½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MINI_COLS = [
  { key: 'new',         label: 'Ğ Ğ°ÑÑ‡Ñ‘Ñ‚',    icon: 'ğŸ“‹' },
  { key: 'scheduled',   label: 'Ğ—Ğ°ĞµĞ·Ğ´',     icon: 'ğŸ“…' },
  { key: 'in_progress', label: 'Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ',  icon: 'ğŸ”§' },
  { key: 'done',        label: 'Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾', icon: 'âœ…' },
  { key: 'delivered',   label: 'Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ¾',    icon: 'ğŸš—' },
];

async function loadMiniKanban(studioId) {
  const container = document.getElementById('miniKanban');

  const { data, error } = await sb
    .from('calculations')
    .select('id, car_name, total_price, final_price, status')
    .eq('studio_id', studioId)
    .order('created_at', { ascending: false });

  if (error) {
    container.innerHTML = `<div class="loading" style="color:#dc2626">âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ${error.message}</div>`;
    return;
  }
  if (!data || data.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><h3>Ğ—Ğ°ĞºĞ°Ğ·Ğ¾Ğ² Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚</h3></div>`;
    return;
  }

  let html = '';
  MINI_COLS.forEach(col => {
    const cards   = data.filter(c => (c.status || 'new') === col.key);
    const visible = cards.slice(0, 5);
    const rest    = cards.length - 5;

    html += `<div class="mini-col mini-col-${col.key}">`;
    html += `<div class="mini-col-header"><div class="mini-dot"></div>${col.icon} ${col.label}</div>`;
    html += `<div class="mini-cards">`;

    if (cards.length === 0) {
      html += `<div class="mini-col-empty">ĞĞµÑ‚</div>`;
    } else {
      visible.forEach(c => {
        html += `<div class="mini-card" onclick="location.href='board.html'">
          <div class="mini-card-car">${c.car_name || 'Ğ‘ĞµĞ· Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ'}</div>
          <div class="mini-card-price">${fmt(c.final_price || c.total_price || 0)} â‚½</div>
        </div>`;
      });
      if (rest > 0) {
        html += `<div class="mini-col-more" onclick="location.href='board.html'">+ ĞµÑ‰Ñ‘ ${rest}</div>`;
      }
    }
    html += `</div></div>`;
  });
  container.innerHTML = html;
}

// â”€â”€ ĞŸĞ¾Ğ¸ÑĞº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let searchTimeout;

window.handleSearch = function() {
  clearTimeout(searchTimeout);
  const term = document.getElementById('searchInput').value.trim().toLowerCase();
  const card = document.getElementById('searchResultsCard');
  const box  = document.getElementById('searchResults');
  if (!term) { card.style.display = 'none'; return; }

  searchTimeout = setTimeout(() => {
    const found = allCalcsForSearch.filter(c => (c.car_name || '').toLowerCase().includes(term));
    card.style.display = 'block';

    if (found.length === 0) {
      box.innerHTML = `<div class="empty-state" style="padding:30px">
        <div class="empty-state-icon">ğŸ”</div><h3>ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾</h3></div>`;
      return;
    }

    const STATUS = {
      new: 'ğŸ“‹ Ğ Ğ°ÑÑ‡Ñ‘Ñ‚', scheduled: 'ğŸ“… Ğ—Ğ°ĞµĞ·Ğ´',
      in_progress: 'ğŸ”§ Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ', done: 'âœ… Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾', delivered: 'ğŸš— Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ¾'
    };
    box.innerHTML = `<div class="calc-grid">` + found.map(c => `
      <div class="calc-card" onclick="location.href='calculator.html?load=${c.id}'">
        <h3>${c.car_name || 'Ğ‘ĞµĞ· Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ'}</h3>
        <div class="calc-price">${fmt(c.final_price || c.total_price || 0)} â‚½</div>
        <div class="calc-actions">
          <a class="btn btn-primary" href="calculator.html?load=${c.id}" onclick="event.stopPropagation()">ğŸ“‚ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ</a>
          <a class="btn btn-success" href="assign-work.html?calc_id=${c.id}" onclick="event.stopPropagation()">ğŸ‘¥ Ğ Ğ°Ğ±Ğ¾Ñ‚Ñ‹</a>
        </div>
      </div>`).join('') + `</div>`;
  }, 300);
};


// â”€â”€ Ğ”Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´-Ğ´Ñ€Ğ°Ğ·Ğ½Ğ¸Ğ»ĞºĞ° Ğ´Ğ»Ñ Ğ½ĞµĞ¾Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ğ²ÑˆĞ¸Ñ… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLockedDashboard() {
  // Ğ¡Ñ‚Ğ°Ñ‚ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ â€” Ğ·Ğ°Ğ¼Ğ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ†Ğ¸Ñ„Ñ€Ñ‹
  const fakeStats = [
    { icon: 'ğŸ§®', label: 'Ğ Ğ°ÑÑ‡Ñ‘Ñ‚Ğ¾Ğ² Ğ·Ğ° Ğ¼ĞµÑÑÑ†', value: 'â–ˆâ–ˆ', change: '+â–ˆâ–ˆ%', color: '#2563eb' },
    { icon: 'ğŸ’°', label: 'Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ° Ğ·Ğ° Ğ¼ĞµÑÑÑ†',  value: 'â–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ â‚½', change: '+â–ˆâ–ˆ%', color: '#059669' },
    { icon: 'ğŸ”§', label: 'Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ ÑĞµĞ¹Ñ‡Ğ°Ñ',   value: 'â–ˆâ–ˆ', change: '', color: '#d97706' },
    { icon: 'âœ…', label: 'Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ¾ Ğ·Ğ° Ğ¼ĞµÑÑÑ†',   value: 'â–ˆâ–ˆ', change: '+â–ˆâ–ˆ%', color: '#7c3aed' },
  ];

  const grid = document.getElementById('statsGrid');
  if (grid) {
    grid.innerHTML = fakeStats.map(s => `
      <div class="stat-card" style="cursor:default" title="ĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ°">
        <div class="stat-icon" style="color:${s.color}">${s.icon}</div>
        <div class="stat-label">${s.label}</div>
        <div class="stat-value" style="filter:blur(4px);user-select:none">${s.value}</div>
        ${s.change ? `<div class="stat-change" style="filter:blur(4px);user-select:none">${s.change}</div>` : ''}
      </div>
    `).join('');
  }

  // ĞšĞ°Ğ½Ğ±Ğ°Ğ½ â€” Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°
  const kanban = document.getElementById('miniKanban');
  if (kanban) {
    kanban.innerHTML = `
      <div style="text-align:center;padding:32px 16px;color:#94a3b8">
        <div style="font-size:2rem;margin-bottom:10px">ğŸ“‹</div>
        <div style="font-size:0.9rem;font-weight:600;color:#64748b;margin-bottom:4px">Ğ—Ğ´ĞµÑÑŒ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ²Ğ°ÑˆĞ¸ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹</div>
        <div style="font-size:0.8rem">ĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ´Ğ¾ÑĞºÑƒ</div>
      </div>`;
  }

  // ĞŸĞ¾Ğ¸ÑĞº â€” Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼
  const search = document.getElementById('searchInput');
  if (search) { search.disabled = true; search.placeholder = 'ğŸ”’ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹'; }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  initNav();
  if (!await checkAuth()) return;

  const { data: member } = await sb
    .from('studio_members')
    .select('studio_id')
    .eq('user_id', currentUser.id)
    .eq('is_active', true)
    .single();

  if (!member) {
    document.getElementById('miniKanban').innerHTML =
      `<div class="loading" style="color:#dc2626">âš ï¸ Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°. ĞĞ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ.</div>`;
    return;
  }

  const studioId = member.studio_id;

  // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸
  const { data: studioInfo } = await sb.from('studios').select('name').eq('id', studioId).single();
  if (studioInfo) {
    document.getElementById('studioNameHeader').textContent = studioInfo.name;
    document.getElementById('studioSubheader').textContent = 'Keep1R CRM';
  }

  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸
  const subStatus = await checkSubscription(studioId);
  if (subStatus === 'expired' || subStatus === 'none') {
    showPaywall(subStatus === 'expired');
    showLockedDashboard();
    return;
  }

  // ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ° Ğ¸Ğ»Ğ¸ Ñ‚Ñ€Ğ¸Ğ°Ğ» â€” Ğ³Ñ€ÑƒĞ·Ğ¸Ğ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
  const { data: calcs } = await sb
    .from('calculations')
    .select('id, car_name, total_price, final_price, status, work_assigned, created_at')
    .eq('studio_id', studioId)
    .order('created_at', { ascending: false });

  allCalcsForSearch = calcs || [];
  updateStats(allCalcsForSearch);
  await loadMiniKanban(studioId);
}

document.addEventListener('DOMContentLoaded', init);

})();
</script>

<script src="footer.js"></script>
</body>
</html>
