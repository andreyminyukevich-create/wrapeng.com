<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–∫–ª–µ–π–∫–∏</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --bg-tertiary: #334155;
  --card: rgba(255, 255, 255, 0.05);
  --card-hover: rgba(255, 255, 255, 0.08);
  --text: #f1f5f9;
  --text-muted: #94a3b8;
  --text-dimmed: #64748b;
  --border: rgba(148, 163, 184, 0.1);
  --border-hover: rgba(148, 163, 184, 0.2);
  --primary: #3b82f6;
  --primary-dark: #2563eb;
  --primary-light: #60a5fa;
  --success: #10b981;
  --success-dark: #059669;
  --warning: #f59e0b;
  --warning-dark: #d97706;
  --danger: #ef4444;
  --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
  --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.15);
  --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.2);
  --shadow-xl: 0 12px 48px rgba(0, 0, 0, 0.3);
  --glow-primary: 0 0 20px rgba(59, 130, 246, 0.3);
  --glow-success: 0 0 20px rgba(16, 185, 129, 0.3);
  --glass: rgba(255, 255, 255, 0.05);
  --glass-border: rgba(255, 255, 255, 0.1);
}

[data-theme="light"] {
  --bg-primary: #f8fafc;
  --bg-secondary: #f1f5f9;
  --bg-tertiary: #e2e8f0;
  --card: rgba(255, 255, 255, 0.9);
  --card-hover: rgba(255, 255, 255, 1);
  --text: #0f172a;
  --text-muted: #475569;
  --text-dimmed: #64748b;
  --border: rgba(15, 23, 42, 0.08);
  --border-hover: rgba(15, 23, 42, 0.15);
  --glass: rgba(255, 255, 255, 0.8);
  --glass-border: rgba(15, 23, 42, 0.1);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html {
  overflow-x: hidden;
  scroll-behavior: smooth;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg-primary);
  color: var(--text);
  line-height: 1.6;
  transition: background-color 0.3s ease, color 0.3s ease;
  -webkit-tap-highlight-color: transparent;
  overflow-x: hidden;
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 80% 70%, rgba(16, 185, 129, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.08) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
  animation: backgroundPulse 20s ease-in-out infinite;
}

@keyframes backgroundPulse {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 0.8; }
}

.top-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  background: var(--glass);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--glass-border);
  box-shadow: var(--shadow-md);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  animation: slideDown 0.5s ease-out;
}

@keyframes slideDown {
  from {
    transform: translateY(-100%);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.top-bar h1 {
  font-size: 1.1rem;
  font-weight: 700;
  background: linear-gradient(135deg, var(--primary), var(--success));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.02em;
}

@media (min-width: 768px) {
  .top-bar h1 {
    font-size: 1.3rem;
  }
}

.theme-toggle {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 8px 16px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 600;
  min-height: 40px;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  color: var(--text);
}

.theme-toggle::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, var(--primary), var(--success));
  opacity: 0;
  transition: opacity 0.3s;
}

.theme-toggle:hover::before {
  opacity: 0.1;
}

.theme-toggle:active {
  transform: scale(0.95);
}

.theme-toggle span {
  position: relative;
  z-index: 1;
}

#user-info {
  text-align: right;
  line-height: 1.4;
}

@media (max-width: 768px) {
  #user-info {
    font-size: 0.75rem;
    max-width: 120px;
  }
  
  #btn-logout {
    font-size: 0.75rem;
    padding: 6px 10px !important;
    min-height: auto !important;
  }
}

.main-container {
  padding-top: 90px;
  min-height: 100vh;
  position: relative;
  z-index: 1;
}

@media (max-width: 767px) {
  .main-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding: 90px 16px 40px;
  }
  
  .left-column,
  .right-column {
    width: 100%;
  }
}

@media (min-width: 768px) {
  .main-container {
    display: flex;
    gap: 24px;
    padding: 100px 24px 40px;
    max-width: 1400px;
    margin: 0 auto;
    align-items: flex-start;
  }
  
  .left-column {
    flex: 1;
    min-width: 0;
    margin-right: 444px;
  }
  
  .right-column {
    width: 420px;
    min-width: 420px;
    max-width: 420px;
    flex-shrink: 0;
    position: fixed;
    right: 24px;
    top: 100px;
    bottom: 20px;
    overflow-y: auto;
  }
  
  .right-column .card {
    margin-bottom: 20px;
  }
}

.card {
  background: var(--card);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 20px;
  box-shadow: var(--shadow-md);
  padding: 24px;
  margin-bottom: 20px;
  border: 1px solid var(--border);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  animation: fadeInUp 0.6s ease-out backwards;
  position: relative;
  overflow: hidden;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.card:nth-child(1) { animation-delay: 0.1s; }
.card:nth-child(2) { animation-delay: 0.2s; }
.card:nth-child(3) { animation-delay: 0.3s; }
.card:nth-child(4) { animation-delay: 0.4s; }
.card:nth-child(5) { animation-delay: 0.5s; }

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary), var(--success));
  opacity: 0;
  transition: opacity 0.3s;
}

.card:hover::before {
  opacity: 1;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
  border-color: var(--border-hover);
}

@media (min-width: 768px) {
  .card {
    padding: 28px;
  }
}

.card h2 {
  font-size: 1.15rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  min-height: 44px;
  letter-spacing: -0.02em;
  transition: all 0.3s;
}

.card h2:hover {
  color: var(--primary);
}

@media (min-width: 768px) {
  .card h2 {
    font-size: 1.3rem;
  }
}

.card h2::before {
  content: '';
  width: 4px;
  height: 24px;
  background: linear-gradient(180deg, var(--primary), var(--primary-light));
  border-radius: 4px;
  box-shadow: var(--glow-primary);
  transition: all 0.3s;
}

.card h2:hover::before {
  height: 28px;
  box-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
}

.card h2.collapsible::after {
  content: '‚ñº';
  margin-left: auto;
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-size: 0.9rem;
  opacity: 0.9;
  color: var(--text);
}

.card h2.collapsible:hover::after {
  opacity: 1;
}

.card h2.collapsible.collapsed::after {
  transform: rotate(-90deg);
}

.card-content {
  transition: all 0.3s ease;
}

.card-content.collapsed {
  display: none;
}

@media (min-width: 768px) {
  .right-column .card h2 {
    cursor: default;
  }
  
  .right-column .card h2::after {
    display: none;
  }
  
  .right-column .card {
    padding: 20px;
    margin-bottom: 20px;
  }
  
  .right-column .card-content {
    display: block !important;
  }
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
}

label {
  font-weight: 600;
  color: var(--text-muted);
  margin-bottom: 4px;
  display: block;
  font-size: 0.9rem;
  letter-spacing: -0.01em;
  transition: color 0.3s;
}

.form-group:focus-within label {
  color: var(--primary);
}

.markup-label {
  color: var(--warning);
  font-weight: 700;
}

input,
select {
  padding: 14px 16px;
  border: 2px solid var(--border);
  border-radius: 12px;
  font-size: 16px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  background: var(--bg-secondary);
  color: var(--text);
  width: 100%;
  min-height: 48px;
  font-family: 'Inter', sans-serif;
  font-weight: 500;
}

select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 16px center;
  background-size: 16px;
  padding-right: 48px;
  cursor: pointer;
}

select option {
  background: var(--bg-secondary);
  color: var(--text);
  padding: 12px;
  font-family: 'Inter', sans-serif;
  font-weight: 500;
}

@media (min-width: 768px) {
  input {
    padding: 12px 14px;
    font-size: 0.95rem;
    min-height: auto;
  }
  
  select {
    padding: 14px 16px;
    font-size: 16px;
    min-height: 54px;
    height: 54px;
  }
}

input:hover,
select:hover {
  border-color: var(--border-hover);
}

input.markup-warning {
  background: rgba(245, 158, 11, 0.1);
  border-color: var(--warning);
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

input:focus,
select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1), var(--glow-primary);
  transform: translateY(-1px);
}

input:read-only {
  background: var(--bg-tertiary);
  color: var(--text-dimmed);
  cursor: not-allowed;
}

.service-item {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 16px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.service-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(180deg, var(--primary), var(--success));
  opacity: 0;
  transition: opacity 0.3s;
}

.service-item:hover::before {
  opacity: 1;
}

.service-item:hover {
  border-color: var(--border-hover);
  transform: translateX(4px);
  box-shadow: var(--shadow-sm);
}

.service-header {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  user-select: none;
}

.service-header input[type="checkbox"] {
  width: 22px;
  height: 22px;
  margin: 0;
  cursor: pointer;
  min-height: auto;
  accent-color: var(--primary);
  border-radius: 6px;
}

.service-header label {
  font-weight: 600;
  color: var(--text);
  font-size: 0.95rem;
  margin: 0;
  cursor: pointer;
  flex: 1;
  transition: color 0.3s;
}

.service-header:hover label {
  color: var(--primary);
}

.service-body {
  margin-top: 16px;
  display: none;
  animation: slideDownFade 0.3s ease-out;
}

@keyframes slideDownFade {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.service-body.open {
  display: block;
}

.service-fields {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-bottom: 12px;
}

.service-complexity {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
  color: var(--text-muted);
  padding: 8px;
  background: var(--bg-tertiary);
  border-radius: 8px;
  transition: all 0.3s;
}

.service-complexity:hover {
  background: var(--card-hover);
}

.service-complexity input[type="checkbox"] {
  width: 20px;
  height: 20px;
  margin: 0;
  min-height: auto;
  accent-color: var(--primary);
  cursor: pointer;
}

.partial-wrapper {
  margin: 24px 0;
}

.partial-header {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  padding: 16px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 16px;
  user-select: none;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.partial-header:hover {
  border-color: var(--border-hover);
  transform: translateX(4px);
  box-shadow: var(--shadow-sm);
}

.partial-header input[type="checkbox"] {
  width: 22px;
  height: 22px;
  margin: 0;
  cursor: pointer;
  min-height: auto;
  accent-color: var(--primary);
}

.partial-header label {
  font-weight: 600;
  color: var(--text);
  font-size: 0.95rem;
  margin: 0;
  cursor: pointer;
  flex: 1;
}

.partial-content {
  margin-top: 16px;
  padding-left: 34px;
  display: none;
}

.partial-content.open {
  display: block;
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.cost-row {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 12px;
  align-items: end;
  margin-bottom: 12px;
  padding: 12px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 12px;
}

.cost-row .form-group {
  margin-bottom: 0;
}

.cost-row button {
  padding: 12px 16px;
  background: var(--danger);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  min-height: 48px;
}

@media (min-width: 768px) {
  .cost-row button {
    min-height: auto;
  }
}

.cost-row button:hover {
  background: #dc2626;
  transform: translateY(-2px);
}

.executor-row {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 10px;
}

.executor-row-header {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-muted);
  margin-bottom: 8px;
}

.executor-fields {
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;
}

@media (min-width: 768px) {
  .executor-fields {
    grid-template-columns: repeat(5, 1fr);
  }
}

.executor-fields input {
  padding: 10px 12px;
  min-height: 40px;
  font-size: 0.9rem;
}

.btn {
  padding: 14px 20px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  min-height: 48px;
  touch-action: manipulation;
  position: relative;
  overflow: hidden;
  letter-spacing: -0.01em;
}

@media (min-width: 768px) {
  .btn {
    padding: 12px 18px;
    font-size: 0.95rem;
  }
}

.btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.btn:active::before {
  width: 300px;
  height: 300px;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #fff;
  box-shadow: var(--shadow-md), var(--glow-primary);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg), 0 0 30px rgba(59, 130, 246, 0.4);
}

.btn-primary:active {
  transform: translateY(0);
}

.btn-secondary {
  background: var(--bg-secondary);
  color: var(--text);
  border: 2px solid var(--border);
  box-shadow: var(--shadow-sm);
}

.btn-secondary:hover {
  background: var(--bg-tertiary);
  border-color: var(--border-hover);
  transform: translateY(-2px);
}

.btn-secondary:active {
  transform: translateY(0);
}

.btn-success {
  background: linear-gradient(135deg, var(--success), var(--success-dark));
  color: #fff;
  box-shadow: var(--shadow-md), var(--glow-success);
}

.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg), 0 0 30px rgba(16, 185, 129, 0.4);
}

.btn-success:active {
  transform: translateY(0);
}

.chips {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 12px;
}

.chip {
  padding: 10px 16px;
  background: var(--bg-secondary);
  border: 2px solid var(--border);
  border-radius: 24px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  color: var(--text);
  min-height: 44px;
  display: flex;
  align-items: center;
  touch-action: manipulation;
}

@media (min-width: 768px) {
  .chip {
    padding: 8px 14px;
    font-size: 0.85rem;
    min-height: auto;
  }
}

.chip:hover {
  background: var(--primary);
  border-color: var(--primary);
  color: #fff;
  transform: translateY(-2px);
  box-shadow: var(--shadow-md), var(--glow-primary);
}

.chip:active {
  transform: scale(0.95);
}

.discount-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-top: 12px;
}

@media (min-width: 768px) {
  .discount-grid {
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
  }
}

.discount-btn {
  padding: 14px;
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
  border: 2px solid rgba(245, 158, 11, 0.3);
  border-radius: 12px;
  font-size: 0.95rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-align: center;
  min-height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  touch-action: manipulation;
  color: var(--text);
}

@media (min-width: 768px) {
  .discount-btn {
    padding: 10px 12px;
    font-size: 0.85rem;
    min-height: auto;
  }
}

.discount-btn:hover {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
  border-color: var(--warning);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.discount-btn:active {
  transform: scale(0.95);
}

.discount-btn.active {
  background: linear-gradient(135deg, var(--warning), var(--warning-dark));
  border-color: var(--warning);
  color: #fff;
  box-shadow: var(--shadow-md), 0 0 20px rgba(245, 158, 11, 0.3);
}

.executor-fields-new {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-top: 12px;
}

@media (min-width: 768px) {
  .executor-fields-new {
    grid-template-columns: 2fr 1.5fr 1.5fr 1.5fr 2fr;
    gap: 12px;
  }
}

.executor-field {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.executor-field label {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-muted);
  margin: 0;
}

.executor-field input {
  padding: 10px 12px;
  min-height: 42px;
  font-size: 0.9rem;
  border: 2px solid var(--border);
  border-radius: 8px;
  background: var(--bg-secondary);
  color: var(--text);
  transition: all 0.3s;
}

.executor-field input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.executor-field-note {
  grid-column: 1 / -1;
}

@media (max-width: 767px) {
  .executor-field-note {
    grid-column: 1;
  }
}

.toggle-group {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.toggle-btn {
  flex: 1;
  min-width: calc(50% - 4px);
  justify-content: center;
  padding: 12px;
  font-size: 0.9rem;
  font-weight: 600;
  background: var(--bg-secondary);
  border: 2px solid var(--border);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  min-height: 48px;
  display: flex;
  align-items: center;
  touch-action: manipulation;
}

@media (min-width: 768px) {
  .toggle-btn {
    padding: 10px 16px;
  }
}

.toggle-btn:hover {
  background: var(--bg-tertiary);
  border-color: var(--border-hover);
  transform: translateY(-2px);
}

.toggle-btn.active {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #fff;
  border-color: var(--primary);
  box-shadow: var(--shadow-md), var(--glow-primary);
}

.toggle-btn:active {
  transform: scale(0.98);
}

.table-wrapper {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  border-radius: 12px;
  margin-top: 16px;
}

table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 0.8rem;
  background: var(--bg-secondary);
  border-radius: 12px;
  overflow: hidden;
  table-layout: auto;
}

@media (min-width: 768px) {
  table {
    font-size: 0.9rem;
  }
}

th,
td {
  padding: 12px 10px;
  text-align: center;
  border-bottom: 1px solid var(--border);
  word-wrap: break-word;
  word-break: break-word;
  white-space: normal;
}

@media (min-width: 768px) {
  th,
  td {
    padding: 14px 12px;
  }
}

th {
  background: var(--bg-tertiary);
  font-weight: 700;
  color: var(--text);
  font-size: 0.85rem;
  letter-spacing: -0.01em;
}

tbody tr {
  transition: all 0.2s;
}

tbody tr:hover {
  background: var(--card-hover);
}

tbody tr:last-child td {
  border-bottom: none;
}

td:last-child {
  text-align: right;
  font-weight: 600;
}

#costTable td:nth-child(2),
#costTable td:nth-child(3) {
  text-align: right;
  font-weight: 600;
}

tfoot th {
  text-align: right;
  background: var(--bg-tertiary);
  font-weight: 700;
  padding: 16px 12px;
  font-size: 1rem;
}

tfoot th:first-child {
  text-align: left;
}

.totals-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-top: 16px;
}

@media (min-width: 768px) {
  .totals-grid {
    grid-template-columns: 1fr 1fr;
  }
}

.total-item {
  text-align: center;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: 16px;
  border: 1px solid var(--border);
  min-height: 80px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.total-item:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
  border-color: var(--border-hover);
}

@media (min-width: 768px) {
  .total-item {
    padding: 14px;
  }
}

.total-label {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-bottom: 6px;
  font-weight: 600;
  letter-spacing: -0.01em;
}

@media (min-width: 768px) {
  .total-label {
    font-size: 0.8rem;
  }
}

.total-value {
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -0.02em;
}

.final-total {
  background: linear-gradient(135deg, var(--success), var(--success-dark));
  color: #fff;
  border: none;
  box-shadow: var(--shadow-md), var(--glow-success);
  position: relative;
  overflow: hidden;
}

.final-total::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
  animation: shine 3s infinite;
}

@keyframes shine {
  0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
  100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

@media (min-width: 768px) {
  .final-total {
    grid-column: 1 / -1;
  }
}

.final-total .total-value {
  color: #fff;
  font-size: 1.5rem;
}

.final-total .total-label {
  color: rgba(255, 255, 255, 0.9);
  font-weight: 700;
}

.final-total:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg), 0 0 40px rgba(16, 185, 129, 0.5);
}

.chart-container {
  position: relative;
  height: 200px;
  margin-top: 16px;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: 12px;
  border: 1px solid var(--border);
}

@media (min-width: 768px) {
  .chart-container {
    height: 220px;
  }
}

.export-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  flex-direction: column;
}

@media (min-width: 768px) {
  .export-buttons .btn {
    font-size: 0.85rem;
    padding: 10px 12px;
  }
}

.package-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 16px;
  margin-bottom: 16px;
}

@media (min-width: 768px) {
  .package-grid {
    grid-template-columns: 1fr 1fr;
  }
}

.summary-cards {
  display: grid;
  grid-template-columns: 1fr;
  gap: 16px;
}

.invis {
  display: none !important;
}

.block-total {
  margin-top: 16px;
  padding: 14px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
  border: 2px solid rgba(59, 130, 246, 0.3);
  border-radius: 12px;
  text-align: right;
}

.block-total-value {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 4px;
}

.block-total-note {
  font-size: 0.75rem;
  color: var(--text-muted);
  font-style: italic;
}

#pdfTemplates {
  display: none;
  font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
  font-size: 7px;
  line-height: 1.3;
}

#pdfTemplates .pdf-block {
  width: 210mm;
  min-height: 297mm;
  padding: 12mm 15mm;
  background: #ffffff !important;
  color: #1e293b !important;
  position: relative;
}

#pdfTemplates .trial-watermark {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-45deg);
  font-size: 72px;
  font-weight: 900;
  color: rgba(239, 68, 68, 0.08);
  white-space: nowrap;
  pointer-events: none;
  z-index: 999;
  letter-spacing: 4px;
}

#pdfTemplates h1 {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 5px;
  text-align: center;
  color: #0f172a !important;
  letter-spacing: -0.5px;
  border-bottom: 3px solid #3b82f6;
  padding-bottom: 8px;
}

#pdfTemplates p {
  color: #475569 !important;
  font-size: 7px;
  line-height: 1.4;
}

#pdfTemplates table {
  width: 100%;
  border-collapse: collapse;
  margin: 10px 0;
  background: #ffffff !important;
  border: 2px solid #e2e8f0 !important;
}

#pdfTemplates th,
#pdfTemplates td {
  border: 1px solid #cbd5e1 !important;
  padding: 4px 5px;
  text-align: left;
  color: #1e293b !important;
  background: #ffffff !important;
}

#pdfTemplates th {
  background: #f1f5f9 !important;
  font-weight: 700;
  color: #0f172a !important;
  font-size: 7px;
  text-transform: uppercase;
  letter-spacing: 0.2px;
}

#pdfTemplates tbody tr:nth-child(even) {
  background: #f8fafc !important;
}

#pdfTemplates tbody tr:hover {
  background: #f1f5f9 !important;
}

#pdfTemplates tfoot th {
  text-align: right;
  color: #0f172a !important;
  background: #e2e8f0 !important;
  font-weight: 700;
  font-size: 9px;
  padding: 8px;
}

#pdfTemplates tfoot th:first-child {
  text-align: left;
  color: #0f172a !important;
}

#telegramWarning {
  display: none;
  background: rgba(245, 158, 11, 0.1);
  border: 2px solid var(--warning);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  font-size: 0.9rem;
  color: var(--text);
  animation: pulse 2s ease-in-out infinite;
}

::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg-secondary);
}

::-webkit-scrollbar-thumb {
  background: var(--bg-tertiary);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--border-hover);
}

#auth-wrapper {
  font-family: 'Inter', sans-serif;
}

#auth-box {
  background: var(--card);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 32px;
  max-width: 450px;
  width: 100%;
  box-shadow: var(--shadow-xl);
  animation: authSlideIn 0.4s ease-out;
}

@keyframes authSlideIn {
  from {
    opacity: 0;
    transform: translateY(-30px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

#auth-box h2 {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 12px;
  text-align: center;
}

#auth-box p {
  color: var(--text-muted);
  text-align: center;
  margin-bottom: 24px;
  line-height: 1.5;
}

#auth-trial-info {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
  border: 1px solid rgba(16, 185, 129, 0.3);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
  text-align: center;
  color: var(--success);
  font-weight: 600;
}

#auth-denied {
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
  text-align: center;
  color: var(--danger);
  font-weight: 600;
  line-height: 1.6;
}

#auth-form input {
  width: 100%;
  padding: 14px 16px;
  margin-bottom: 12px;
  border: 2px solid var(--border);
  border-radius: 12px;
  background: var(--bg-secondary);
  color: var(--text);
  font-size: 16px;
  font-family: 'Inter', sans-serif;
  transition: all 0.3s;
}

#auth-form input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

#auth-error {
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 16px;
  color: var(--danger);
  font-size: 0.9rem;
}

#auth-buttons {
  display: flex;
  gap: 12px;
  margin-top: 16px;
}

#auth-buttons button {
  flex: 1;
  padding: 14px 20px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-family: 'Inter', sans-serif;
}

#auth-login-btn {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #fff;
  box-shadow: var(--shadow-md), var(--glow-primary);
}

#auth-login-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg), 0 0 30px rgba(59, 130, 246, 0.4);
}

#auth-login-btn:active {
  transform: translateY(0);
}

#auth-register-btn {
  background: var(--bg-secondary);
  color: var(--text);
  border: 2px solid var(--border);
}

#auth-register-btn:hover {
  background: var(--bg-tertiary);
  border-color: var(--border-hover);
  transform: translateY(-2px);
}

#auth-register-btn:active {
  transform: translateY(0);
}

#auth-ref-link {
  margin-top: 20px;
  padding: 16px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 12px;
  text-align: center;
}

#auth-ref-link a {
  color: var(--primary);
  text-decoration: none;
  font-weight: 600;
  word-break: break-all;
}

#auth-ref-link a:hover {
  text-decoration: underline;
}
</style>
</head>
<body>

<div id="calc-wrapper">
<div id="app">
<div class="top-bar">
  <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h1>
  <div style="display:flex;align-items:center;gap:12px">
    <div id="user-info" style="display:none;font-size:0.85rem;color:var(--text-muted)"></div>
    <button id="btn-dashboard" class="theme-toggle" style="padding:8px 12px">‚Üê –î–∞—à–±–æ—Ä–¥</button>
    <div class="theme-toggle" onclick="toggleTheme()">
      <span id="themeIcon">‚òÄÔ∏è</span>
    </div>
  </div>
</div>

<div class="main-container">
  <div class="left-column">
    
    <div class="card">
      <h2>üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å</h2>
      <div class="card-content">
        <div class="form-group">
          <label>–ë—Ä–µ–Ω–¥:</label>
          <select id="brand">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</option>
            <option value="manual">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</option>
          </select>
          <input type="text" id="brandManual" placeholder="–í–≤–µ–¥–∏—Ç–µ –±—Ä–µ–Ω–¥" class="invis">
        </div>
        <div class="form-group">
          <label>–ú–æ–¥–µ–ª—å:</label>
          <select id="model">
            <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</option>
            <option value="manual">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</option>
          </select>
          <input type="text" id="modelManual" placeholder="–í–≤–µ–¥–∏—Ç–µ –º–æ–¥–µ–ª—å" class="invis">
        </div>
        <div class="form-group">
          <label>–ì–æ–¥:</label>
          <input type="text" id="year" placeholder="2025" maxlength="4" inputmode="numeric">
        </div>
      </div>
    </div>

    <div class="card">
      <h2 class="collapsible collapsed">üì¶ –ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –≤–∫—Ä—É–≥</h2>
      <div class="card-content collapsed">
        <div class="package-grid">
          <div><label>–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–ª–µ–Ω–∫–∏:</label><input type="number" id="pkgWrapMat" placeholder="0" step="0.01"></div>
          <div><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è –æ–∫–ª–µ–π—â–∏–∫–∞:</label><input type="number" id="pkgWrapMot" placeholder="0" step="0.01"></div>
          <div><label>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏:</label><input type="number" id="pkgPrepMat" placeholder="0" step="0.01"></div>
          <div><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏:</label><input type="number" id="pkgPrepMot" placeholder="0" step="0.01"></div>
          <div><label>–ú–∞—Ç–µ—Ä–∏–∞–ª –∞—Ä–º–∞—Ç—É—Ä–∫–∏:</label><input type="number" id="pkgArmMat" placeholder="0" step="0.01"></div>
          <div><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è –∞—Ä–º–∞—Ç—É—Ä—â–∏–∫–∞:</label><input type="number" id="pkgArmMot" placeholder="0" step="0.01"></div>
        </div>
        <div class="partial-wrapper">
          <div class="partial-header">
            <input type="checkbox" id="pkgCostsChk">
            <label for="pkgCostsChk">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã</label>
          </div>
          <div class="partial-content" id="pkgCostsContent"></div>
        </div>
        <button type="button" class="btn btn-secondary" id="btnAddPkgCost" style="margin-top:10px;display:none">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞—Ç—Ä–∞—Ç—É</button>
        <div style="margin-top:15px">
          <label class="markup-label">‚ö†Ô∏è –ù–∞—Ü–µ–Ω–∫–∞ –Ω–∞ –ø–∞–∫–µ—Ç (%):</label>
          <input type="number" id="pkgMarkup" placeholder="–°–≤–æ—è –Ω–∞—Ü–µ–Ω–∫–∞" step="1">
          <div class="chips">
            <span class="chip" data-markup-target="#pkgMarkup">30</span>
            <span class="chip" data-markup-target="#pkgMarkup">50</span>
            <span class="chip" data-markup-target="#pkgMarkup">70</span>
            <span class="chip" data-markup-target="#pkgMarkup">130</span>
            <span class="chip" data-markup-target="#pkgMarkup">150</span>
            <span class="chip" data-markup-target="#pkgMarkup">170</span>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;align-items:start">
          <div>
            <label>–°–≤–æ—è —Ü–µ–Ω–∞:</label>
            <input type="number" id="pkgCustomPrice" placeholder="–ê–≤—Ç–æ—Ä–∞—Å—á–µ—Ç –Ω–∞—Ü–µ–Ω–∫–∏" step="0.01">
          </div>
          <div class="block-total" id="pkgTotal" style="margin:0">
            <div class="block-total-value"></div>
            <div class="block-total-note">—Å —É—á–µ—Ç–æ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏, –Ω–∞—Ü–µ–Ω–∫–∏ –∏ –Ω–∞–ª–æ–≥–æ–≤</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 class="collapsible collapsed">üõ°Ô∏è –ó–∞—â–∏—Ç–∞ —É–¥–∞—Ä–Ω–æ–π —á–∞—Å—Ç–∏</h2>
      <div class="card-content collapsed">
        <div class="package-grid">
          <div><label>–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–ª–µ–Ω–∫–∏:</label><input type="number" id="impactWrapMat" placeholder="0" step="0.01"></div>
          <div><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è –æ–∫–ª–µ–π—â–∏–∫–∞:</label><input type="number" id="impactWrapMot" placeholder="0" step="0.01"></div>
          <div><label>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏:</label><input type="number" id="impactPrepMat" placeholder="0" step="0.01"></div>
          <div><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏:</label><input type="number" id="impactPrepMot" placeholder="0" step="0.01"></div>
          <div><label>–ú–∞—Ç–µ—Ä–∏–∞–ª –∞—Ä–º–∞—Ç—É—Ä–∫–∏:</label><input type="number" id="impactArmMat" placeholder="0" step="0.01"></div>
          <div><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è –∞—Ä–º–∞—Ç—É—Ä—â–∏–∫–∞:</label><input type="number" id="impactArmMot" placeholder="0" step="0.01"></div>
        </div>
        <div class="partial-wrapper">
          <div class="partial-header">
            <input type="checkbox" id="impactCostsChk">
            <label for="impactCostsChk">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã</label>
          </div>
          <div class="partial-content" id="impactCostsContent"></div>
        </div>
        <button type="button" class="btn btn-secondary" id="btnAddImpactCost" style="margin-top:10px;display:none">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞—Ç—Ä–∞—Ç—É</button>
        <div style="margin-top:15px">
          <label class="markup-label">‚ö†Ô∏è –ù–∞—Ü–µ–Ω–∫–∞ –Ω–∞ –ø–∞–∫–µ—Ç (%):</label>
          <input type="number" id="impactMarkup" placeholder="–°–≤–æ—è –Ω–∞—Ü–µ–Ω–∫–∞" step="1">
          <div class="chips">
            <span class="chip" data-markup-target="#impactMarkup">30</span>
            <span class="chip" data-markup-target="#impactMarkup">50</span>
            <span class="chip" data-markup-target="#impactMarkup">70</span>
            <span class="chip" data-markup-target="#impactMarkup">130</span>
            <span class="chip" data-markup-target="#impactMarkup">150</span>
            <span class="chip" data-markup-target="#impactMarkup">170</span>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;align-items:start">
          <div>
            <label>–°–≤–æ—è —Ü–µ–Ω–∞:</label>
            <input type="number" id="impactCustomPrice" placeholder="–ê–≤—Ç–æ—Ä–∞—Å—á–µ—Ç –Ω–∞—Ü–µ–Ω–∫–∏" step="0.01">
          </div>
          <div class="block-total" id="impactTotal" style="margin:0">
            <div class="block-total-value"></div>
            <div class="block-total-note">—Å —É—á–µ—Ç–æ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏, –Ω–∞—Ü–µ–Ω–∫–∏ –∏ –Ω–∞–ª–æ–≥–æ–≤</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>üí≥ –§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã</h2>
      <div class="card-content">
        <div class="toggle-group">
          <label class="toggle-btn active">
            <input type="radio" name="payMode" value="cash" checked style="display:none">
            <span>üíµ –ù–∞–ª–∏—á–Ω—ã–µ</span>
          </label>
          <label class="toggle-btn">
            <input type="radio" name="payMode" value="card" style="display:none">
            <span>üí≥ –ö–∞—Ä—Ç–∞ –∏–ª–∏ –ò–ü (+13%)</span>
          </label>
          <label class="toggle-btn">
            <input type="radio" name="payMode" value="ooo" style="display:none">
            <span>üè¢ –û–û–û (+22%)</span>
          </label>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 class="collapsible collapsed">üîß –ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</h2>
      <div class="card-content collapsed" id="armContent"></div>
    </div>

    <div class="card">
      <h2 class="collapsible collapsed">üé® –û–∫–ª–µ–π–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</h2>
      <div class="card-content collapsed" id="wrapContent"></div>
    </div>

    <div class="card">
      <h2 class="collapsible collapsed">‚ú® –î–µ—Ç–µ–π–ª–∏–Ω–≥</h2>
      <div class="card-content collapsed" id="detContent"></div>
    </div>

    <div class="card">
      <h2 class="collapsible collapsed">ü™ü –°—Ç—ë–∫–ª–∞</h2>
      <div class="card-content collapsed" id="glContent"></div>
    </div>

    <div class="card">
      <h2 class="collapsible collapsed">üõ†Ô∏è –ü—Ä–æ—á–∏–µ —Ä–∞–±–æ—Ç—ã</h2>
      <div class="card-content collapsed" id="miscContent"></div>
    </div>

    <div class="card">
      <h2>üìÑ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ö–ü</h2>
      <div class="card-content">
        <div class="table-wrapper">
          <table id="kpTable">
            <thead><tr><th style="width:25%">–£—Å–ª—É–≥–∞</th><th style="width:50%">–û–ø–∏—Å–∞–Ω–∏–µ</th><th style="width:25%">–°—Ç–æ–∏–º–æ—Å—Ç—å</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="text-align:right;font-weight:bold;margin-top:10px">–ò—Ç–æ–≥–æ: <span id="kpTotal">0,00</span></div>
      </div>
    </div>

    <div class="card">
      <h2>üí∞ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏</h2>
      <div class="card-content">
        <div class="table-wrapper">
          <table id="costTable">
            <thead><tr><th style="width:50%">–£—Å–ª—É–≥–∞</th><th style="width:25%">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</th><th style="width:25%">–ú–æ—Ç–∏–≤–∞—Ü–∏—è</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="display:flex;justify-content:space-between;font-weight:bold;margin-top:10px;flex-wrap:wrap;gap:10px;font-size:.9rem">
          <span>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã: <span id="cMat">0,00</span></span>
          <span>–ú–æ—Ç–∏–≤–∞—Ü–∏—è: <span id="cMot">0,00</span></span>
          <span>–ò—Ç–æ–≥–æ: <span id="cTotal">0,00</span></span>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 class="collapsible collapsed">üë• –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</h2>
      <div class="card-content collapsed">
        <div id="executorsContent"></div>
        <button type="button" class="btn btn-success" id="btnExportExecutors" style="width:100%;margin-top:16px">üìã –°–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π (PDF)</button>
        <button type="button" class="btn btn-success" id="btnExportExecutorsWithSalary" style="width:100%;margin-top:12px">üí∞ –°–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π —Å –ó–ü (PDF)</button>
      </div>
    </div>

  </div>

  <div class="right-column">
    
    <div class="card">
      <h2>üéÅ –°–∫–∏–¥–∫–∏</h2>
      <div class="card-content">
        <div class="discount-grid">
          <div class="discount-btn" data-discount="0">–ë–µ–∑ —Å–∫–∏–¥–∫–∏</div>
          <div class="discount-btn" data-discount="10">–î—Ä—É–∂–µ—Å–∫–∞—è 10%</div>
        </div>
        <div style="margin-top:8px">
          <input type="number" id="customDiscount" placeholder="–°–≤–æ—è —Å–∫–∏–¥–∫–∞ %" min="0" max="100" step="0.01">
        </div>
      </div>
    </div>

    <div class="card">
      <h2>üíé –ò—Ç–æ–≥–∏</h2>
      <div class="card-content">
        <div class="totals-grid">
          <div class="total-item"><div class="total-label">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</div><div class="total-value" id="grandMat">0,00</div></div>
          <div class="total-item"><div class="total-label">–ú–æ—Ç–∏–≤–∞—Ü–∏—è</div><div class="total-value" id="grandMot">0,00</div></div>
          <div class="total-item"><div class="total-label">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</div><div class="total-value" id="grandBase">0,00</div></div>
          <div class="total-item"><div class="total-label">–ù–∞—Ü–µ–Ω–∫–∞</div><div class="total-value" id="grandMarkup">0,00</div></div>
          <div class="total-item"><div class="total-label">–ù–∞–ª–æ–≥</div><div class="total-value" id="grandTax">0,00</div></div>
          <div class="total-item final-total"><div class="total-label">–ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï</div><div class="total-value" id="finalTotal">0,00</div></div>
        </div>
        <div class="chart-container">
          <canvas id="pieChart"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>üì• –≠–∫—Å–ø–æ—Ä—Ç</h2>
      <div class="card-content">
        <div id="telegramWarning">
          ‚ö†Ô∏è <b>Telegram WebView:</b> –î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è PDF –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (‚Ä¢‚Ä¢‚Ä¢ ‚Üí –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
        </div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px">
          <button type="button" class="btn btn-primary" id="btnRecalc" style="flex:1;min-width:140px">üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</button>
          <button type="button" class="btn btn-secondary" id="btnReset" style="flex:1;min-width:140px">üîÉ –°–±—Ä–æ—Å</button>
        </div>
        <div class="export-buttons">
          <button type="button" class="btn btn-success" id="btnExportKP">üìÑ –ö–ü (PDF)</button>
          <button type="button" class="btn btn-success" id="btnExportCost">üí∞ –°–µ–±–µ—Å (PDF)</button>
        </div>
      </div>
    </div>

  </div>
</div>

<div id="pdfTemplates">
  <!-- –ö–ü -->
  <div id="pdfKP" class="pdf-block">
    <div class="trial-watermark" id="watermarkKP" style="display:none"></div>
    <h1>–ö–û–ú–ú–ï–†–ß–ï–°–ö–û–ï –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï</h1>
    <p id="pdfKPMeta" style="text-align:center;margin-bottom:16px;font-weight:600"></p>
    <table>
      <thead><tr><th style="width:25%">–£—Å–ª—É–≥–∞</th><th style="width:50%">–û–ø–∏—Å–∞–Ω–∏–µ</th><th style="width:25%">–°—Ç–æ–∏–º–æ—Å—Ç—å</th></tr></thead>
      <tbody id="pdfKPTBody"></tbody>
      <tfoot><tr><th colspan="2">–ò–¢–û–ì–û:</th><th id="pdfKPTotal"></th></tr></tfoot>
    </table>
    <p style="text-align:center;margin-top:20px;font-style:italic;color:#64748b;font-size:8px">–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 3—Ö –¥–Ω–µ–π</p>
  </div>
  
  <!-- –°–ï–ë–ï–°–¢–û–ò–ú–û–°–¢–¨ -->
  <div id="pdfCost" class="pdf-block">
    <div class="trial-watermark" id="watermarkCost" style="display:none"></div>
    <h1>–°–ï–ë–ï–°–¢–û–ò–ú–û–°–¢–¨</h1>
    <p id="pdfCostMeta" style="text-align:center;margin-bottom:16px;font-weight:600"></p>
    <table>
      <thead><tr><th>–£—Å–ª—É–≥–∞</th><th>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</th><th>–ú–æ—Ç–∏–≤–∞—Ü–∏—è</th></tr></thead>
      <tbody id="pdfCostTBody"></tbody>
      <tfoot><tr><th>–ò–¢–û–ì–û:</th><th id="pdfCM"></th><th id="pdfCO"></th></tr></tfoot>
    </table>
  </div>
  
  <!-- –ò–°–ü–û–õ–ù–ò–¢–ï–õ–ò –ë–ï–ó –ó–ü -->
  <div id="pdfExecutors" class="pdf-block">
    <div class="trial-watermark" id="watermarkExecutors" style="display:none"></div>
    <h1>–°–ü–ò–°–û–ö –£–°–õ–£–ì –ò –ò–°–ü–û–õ–ù–ò–¢–ï–õ–ï–ô</h1>
    <p id="pdfExecutorsMeta" style="text-align:center;margin-bottom:16px;font-weight:600"></p>
    <table>
      <thead><tr><th style="width:30%">–£—Å–ª—É–≥–∞</th><th style="width:22%">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th><th style="width:15%">–ü—Ä–∏–µ–º</th><th style="width:15%">–í—ã–¥–∞—á–∞</th><th style="width:18%">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th></tr></thead>
      <tbody id="pdfExecutorsTBody"></tbody>
    </table>
  </div>
  
  <!-- –ò–°–ü–û–õ–ù–ò–¢–ï–õ–ò –° –ó–ü -->
  <div id="pdfExecutorsWithSalary" class="pdf-block">
    <div class="trial-watermark" id="watermarkExecutorsWithSalary" style="display:none"></div>
    <h1>–°–ü–ò–°–û–ö –£–°–õ–£–ì –ò –ò–°–ü–û–õ–ù–ò–¢–ï–õ–ï–ô –° –ó–ê–†–ü–õ–ê–¢–û–ô</h1>
    <p id="pdfExecutorsWithSalaryMeta" style="text-align:center;margin-bottom:16px;font-weight:600"></p>
    <table>
      <thead><tr><th style="width:24%">–£—Å–ª—É–≥–∞</th><th style="width:18%">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th><th style="width:13%">–ó–∞—Ä–ø–ª–∞—Ç–∞</th><th style="width:13%">–ü—Ä–∏–µ–º</th><th style="width:13%">–í—ã–¥–∞—á–∞</th><th style="width:19%">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th></tr></thead>
      <tbody id="pdfExecutorsWithSalaryTBody"></tbody>
    </table>
  </div>
</div>
</div>
</div>
<script>
(function() {
'use strict';

// ========================================
// CONFIGURATION & GLOBALS
// ========================================

const SUPABASE_URL = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true }
});

let currentUser = null;
let currentProfile = null;
let chart = null;
let disc = 0;
let costCounter = 0;
let dynCounter = 0;

// Render optimization
let renderScheduled = false;
let lastStateHash = '';

// Autosave timers
let localSaveTimer = null;
let supaSaveTimer = null;

// ========================================
// UTILITY FUNCTIONS
// ========================================

// –ö–æ—Ä–æ—Ç–∫–∏–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
const q = s => document.querySelector(s);
const qa = s => document.querySelectorAll(s);

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª
const fmt = n => parseFloat((n || 0).toFixed(2)).toLocaleString('ru-RU', {
  minimumFractionDigits: 2,
  maximumFractionDigits: 2
});

const r100 = n => Math.round((n || 0) * 100) / 100;

// –í–ê–ñ–ù–û: –ü–∞—Ä—Å–∏–Ω–≥ —á–∏—Å–µ–ª —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∑–∞–ø—è—Ç–æ–π (–¥–ª—è RU)
function numVal(el) {
  if (!el) return 0;
  const v = String(el.value ?? '').replace(',', '.');
  const n = parseFloat(v);
  return Number.isFinite(n) && n >= 0 ? n : 0;
}

// DOM Cache –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
const domCache = {};
function getCached(selector) {
  if (!domCache[selector]) {
    domCache[selector] = q(selector);
  }
  return domCache[selector];
}

// ========================================
// DATA & CONSTANTS
// ========================================

const carDB = {
  Audi: ["A3", "A4", "A5", "A6", "Q3", "Q5", "Q7", "Q8"],
  BMW: ["1 Series", "3 Series", "5 Series", "7 Series", "X3", "X5"],
  Buick: ["Cascada", "Enclave", "Encore", "Encore GX", "Envision", "GL8", "LaCrosse", "Regal", "Regal TourX", "Verano"],
  BYD: ["Dolphin", "Han", "Qin Plus", "Seal", "Song Plus", "Tang", "Yuan Plus"],
  Cadillac: ["Celestiq", "CT4", "CT5", "CT6", "Escalade", "Escalade ESV", "Lyriq", "XT4", "XT5", "XT6"],
  Changan: ["CS35 Plus", "CS55 Plus", "CS75 Plus", "Uni-K", "Uni-T"],
  Chery: ["Arrizo 5", "Tiggo 2", "Tiggo 4", "Tiggo 7", "Tiggo 8"],
  Chevrolet: ["Blazer", "Colorado", "Equinox", "Malibu", "Silverado 1500", "Silverado 2500/3500 HD", "Suburban", "Tahoe", "Trailblazer", "Traverse"],
  Chrysler: ["200", "300", "Pacifica", "Pacifica Hybrid", "Town & Country", "Voyager"],
  Dodge: ["Challenger", "Challenger SRT Hellcat", "Charger", "Charger SRT Hellcat", "Dart", "Durango", "Grand Caravan", "Hornet", "Journey", "Viper"],
  Fisker: ["Alaska", "Ocean", "Pear", "Ronin"],
  Ford: ["Bronco", "Edge", "Escape", "Expedition", "Explorer", "F-150", "Maverick", "Mustang", "Mustang Mach-E", "Ranger"],
  Geely: ["Atlas", "Coolray", "Emgrand", "Monjaro", "Tugella"],
  GMC: ["Acadia", "Canyon", "Hummer EV Pickup", "Hummer EV SUV", "Savana", "Sierra 1500", "Sierra HD", "Terrain", "Yukon", "Yukon XL"],
  Haval: ["Dargo", "F7", "F7x", "H6", "H9", "Jolion"],
  Honda: ["Accord", "Civic", "CR-V", "Fit", "HR-V"],
  Hummer: ["EV Pickup", "EV SUV"],
  Hyundai: ["Creta", "Elantra", "Santa Fe", "Sonata", "Tucson"],
  Jeep: ["Cherokee", "Compass", "Gladiator", "Grand Cherokee", "Grand Wagoneer", "Renegade", "Wagoneer", "Wagoneer S", "Wrangler", "Wrangler 4xe"],
  Kia: ["Cerato", "Ceed", "Rio", "Seltos", "Sorento", "Sportage"],
  Lincoln: ["Aviator", "Continental", "Corsair", "MKC", "MKT", "MKX", "MKZ", "Nautilus", "Navigator", "Navigator L"],
  Lixiang: ["I8", "L6", "L7", "L8", "L9", "Mega", "One"],
  Lucid: ["Air", "Air Grand Touring", "Air Pure", "Air Sapphire", "Air Touring", "Gravity", "Gravity Grand Touring", "Gravity Touring"],
  Mazda: ["CX-3", "CX-30", "CX-5", "Mazda3", "Mazda6"],
  "Mercedes-Benz": ["A-Class", "C-Class", "E-Class", "GLC", "GLE", "S-Class"],
  Nissan: ["Altima", "Qashqai", "Rogue", "Sentra", "X-Trail"],
  Omoda: ["C5", "C7", "C9", "E5", "S5"],
  Ram: ["1500", "1500 Classic", "1500 TRX", "2500", "3500", "4500 Chassis Cab", "5500 Chassis Cab", "ProMaster", "ProMaster City", "ProMaster Rapid"],
  Rivian: ["EDV", "R1S", "R1T", "R2", "R3", "R3X", "RCV"],
  Tank: ["300", "400", "500", "700"],
  Tesla: ["Cybertruck", "Model 3", "Model S", "Model X", "Model Y", "Semi"],
  Toyota: ["Camry", "Corolla", "Hilux", "Land Cruiser 300", "RAV4", "Yaris"],
  Volkswagen: ["Arteon", "Golf", "Passat", "Polo", "T-Roc", "Tiguan"],
  Voyah: ["Courage", "Dream", "Free", "Passion"],
  Zeekr: ["001", "007", "009", "7X", "9X", "Mix", "X"]
};

const serviceDescriptions = {
  '–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –≤–∫—Ä—É–≥': '–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –≥–ª—è–Ω—Ü–µ–≤—ã—Ö –∫—É–∑–æ–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å —Ä–∞–∑–±–æ—Ä–æ–º —Å—ä–µ–º–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–æ–π –∫—É–∑–æ–≤–∞',
  '–ó–∞—â–∏—Ç–∞ —É–¥–∞—Ä–Ω–æ–π —á–∞—Å—Ç–∏': '–ó–∞—â–∏—Ç–∞ —É–¥–∞—Ä–Ω–æ–π —á–∞—Å—Ç–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å —Ä–∞–∑–±–æ—Ä–æ–º —Å—ä–µ–º–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–æ–π –∫—É–∑–æ–≤–∞',
  '–î–µ–º–æ–Ω—Ç–∞–∂ —ç–ª–µ–º–µ–Ω—Ç–æ–≤': '–°–Ω—è—Ç–∏–µ –∫—É–∑–æ–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–∞–±–æ—Ç',
  '–ú–æ–Ω—Ç–∞–∂ —ç–ª–µ–º–µ–Ω—Ç–æ–≤': '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫—É–∑–æ–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–∞–±–æ—Ç',
  '–î–µ–º–æ–Ω—Ç–∞–∂ –∏ –º–æ–Ω—Ç–∞–∂': '–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Å–Ω—è—Ç–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫—É–∑–æ–≤–∞',
  '–ú–æ–π–∫–∞ –∫—É–∑–æ–≤–∞ –ø–µ—Ä–µ–¥ –æ–∫–ª–µ–π–∫–æ–π': '–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω–∞—è –º–æ–π–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø–µ—Ä–µ–¥ –æ–∫–ª–µ–π–∫–æ–π',
  '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫—É–∑–æ–≤–∞': '–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –∫ –Ω–∞–Ω–µ—Å–µ–Ω–∏—é –ø–ª–µ–Ω–∫–∏',
  '–ì–ª—É–±–æ–∫–∞—è —á–∏—Å—Ç–∫–∞ –∫—É–∑–æ–≤–∞': '–î–µ—Ç–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—É–∑–æ–≤–∞ –æ—Ç –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–π –∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤',
  '–ü–æ–ª–∏—Ä–æ–≤–∫–∞ –∫—É–∑–æ–≤–∞': '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ª–∞–∫–æ–∫—Ä–∞—Å–æ—á–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è',
  '–ù–∞–Ω–µ—Å–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–æ–≤ –Ω–∞ –∫—É–∑–æ–≤': '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫—É–∑–æ–≤–∞ –∑–∞—â–∏—Ç–Ω—ã–º–∏ —Å–æ—Å—Ç–∞–≤–∞–º–∏',
  '–•–∏–º—á–∏—Å—Ç–∫–∞ —Å–∞–ª–æ–Ω–∞': '–ì–ª—É–±–æ–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–∞–ª–æ–Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è',
  '–ù–∞–Ω–µ—Å–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–æ–≤ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–∞–ª–æ–Ω–∞': '–ó–∞—â–∏—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞',
  '–ü–æ–ª–∏—Ä–æ–≤–∫–∞ –≥–ª—è–Ω—Ü–µ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤': '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–ª–µ—Å–∫–∞ –≥–ª—è–Ω—Ü–µ–≤—ã—Ö –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–µ–π',
  '–¢–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–Ω–µ–π –ø–æ–ª—É—Å—Ñ–µ—Ä—ã': '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–π –ø–ª–µ–Ω–∫–∏ –Ω–∞ –∑–∞–¥–Ω—é—é –ø–æ–ª—É—Å—Ñ–µ—Ä—É',
  '–¢–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥–Ω–∏—Ö –±–æ–∫–æ–≤—ã—Ö —Å—Ç–µ–∫–æ–ª': '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–π –ø–ª–µ–Ω–∫–∏ –Ω–∞ –ø–µ—Ä–µ–¥–Ω–∏–µ –±–æ–∫–æ–≤—ã–µ —Å—Ç–µ–∫–ª–∞',
  '–¢–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–±–æ–≤–æ–≥–æ —Å—Ç–µ–∫–ª–∞': '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–π –ø–ª–µ–Ω–∫–∏ –Ω–∞ –ª–æ–±–æ–≤–æ–µ —Å—Ç–µ–∫–ª–æ',
  '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–±–æ–≤–æ–≥–æ —Å—Ç–µ–∫–ª–∞': '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞—â–∏—Ç–Ω–æ–π –ø–ª–µ–Ω–∫–∏ –Ω–∞ –ª–æ–±–æ–≤–æ–µ —Å—Ç–µ–∫–ª–æ',
  '–ú–∞–ª—è—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã': '–õ–æ–∫–∞–ª—å–Ω—ã–π –æ–∫—Ä–∞—Å —ç–ª–µ–º–µ–Ω—Ç–∞',
  '–í—ã–ø—Ä—è–º–ª–µ–Ω–∏–µ –≤–º—è—Ç–∏–Ω –±–µ–∑ –ø–æ–∫—Ä–∞—Å–∫–∏': '–í—ã–ø—Ä—è–º–ª–µ–Ω–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π –õ–ö–ü –±–µ–∑ –æ–∫—Ä–∞—Å–∞',
  '–†–µ—Å—Ç–∞–≤—Ä–∞—Ü–∏—è –õ–ö–ü': '–†–∞–±–æ—Ç—ã –ø–æ –ª–∞–∫–æ–∫—Ä–∞—Å–æ—á–Ω–æ–º—É –ø–æ–∫—Ä—ã—Ç–∏—é –∞–≤—Ç–æ–º–æ–±–∏–ª—è, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∏ —Å–∫—Ä—ã—Ç–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π',
  '–®—É–º–æ–∏–∑–æ–ª—è—Ü–∏—è': '–†–∞–±–æ—Ç—ã –ø–æ –¥–æ–æ—Å–Ω–∞—â–µ–Ω–∏—é –∞–≤—Ç–æ–º–æ–±–∏–ª—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏, —Å–Ω–∏–∂–∞—é—â–∏–º–∏ –≤–∏–±—Ä–∞—Ü–∏–∏, —à—É–º—ã –∏ –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –∑–≤—É–∫–∏',
  'PPF –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –≤–∫—Ä—É–≥': '–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –≥–ª—è–Ω—Ü–µ–≤—ã—Ö –∫—É–∑–æ–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∞–≤—Ç–æ–º–æ–±–∏–ª—è',
  'PPF —Ü–≤–µ—Ç–Ω–æ–π –≤–∫—Ä—É–≥': '–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –∫—É–∑–æ–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ü–≤–µ—Ç–Ω–æ–π –ø–ª–µ–Ω–∫–æ–π',
  'PPF –º–∞—Ç–æ–≤—ã–π –≤–∫—Ä—É–≥': '–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –∫—É–∑–æ–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–∞—Ç–æ–≤–æ–π –ø–ª–µ–Ω–∫–æ–π',
  '–ü–í–• –ø–æ–ª–Ω–∞—è –æ–∫–ª–µ–π–∫–∞': '–ü–æ–ª–Ω–∞—è –æ–∫–ª–µ–π–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –≤–∏–Ω–∏–ª–æ–≤–æ–π –ø–ª–µ–Ω–∫–æ–π'
};

const partElements = [
  '–ü–µ—Ä–µ–¥–Ω–∏–π –±–∞–º–ø–µ—Ä', '–ó–∞–¥–Ω–∏–π –±–∞–º–ø–µ—Ä', '–ü–µ—Ä–µ–¥–Ω–∏–π –±–∞–º–ø–µ—Ä (–¥–æ–ø)', '–ó–∞–¥–Ω–∏–π –±–∞–º–ø–µ—Ä (–¥–æ–ø)',
  '–ü–µ—Ä–µ–¥–Ω—è—è –æ–ø—Ç–∏–∫–∞', '–ü—Ä–æ—Ç–∏–≤–æ—Ç—É–º–∞–Ω–Ω—ã–µ —Ñ–∞—Ä—ã', '–ó–∞–¥–Ω–∏–µ —Ñ–æ–Ω–∞—Ä–∏', '–†–µ—à–µ—Ç–∫–∞ —Ä–∞–¥–∏–∞—Ç–æ—Ä–∞',
  '–ü–æ–ª–æ—Å–∫–∞ –Ω–∞ –∫–∞–ø–æ—Ç', '–ö–∞–ø–æ—Ç', '–ü–µ—Ä–µ–¥–Ω–µ–µ –∫—Ä—ã–ª–æ', '–î–≤–∞ –ø–µ—Ä–µ–¥–Ω–∏—Ö –∫—Ä—ã–ª–∞',
  '–†–∞—Å—à–∏—Ä–∏—Ç–µ–ª–∏ –∞—Ä–æ–∫', '–°—Ç–æ–π–∫–∏ –≤–æ–∫—Ä—É–≥ –ª–æ–±–æ–≤–æ–≥–æ', '–ü–æ–ª–æ—Å–∫–∞ –Ω–∞ –∫—Ä—ã—à—É', '–ö—Ä—ã—à–∞',
  '–ü–æ—Ä–æ–≥–∏', '–ü–æ—Ä–æ–≥–∏ –¥–æ –∑–∞–º–∫–∞', '–î–≤–µ—Ä–Ω—ã–µ –ø—Ä–æ–µ–º—ã', '–ü–µ—Ä–µ–¥–Ω—è—è –¥–≤–µ—Ä—å',
  '–ü–µ—Ä–µ–¥–Ω–∏–µ –¥–≤–µ—Ä–∏ (2 —à—Ç)', '–ó–æ–Ω–∞ –ø–æ–¥ —Ä—É—á–∫–∞–º–∏ (2 —à—Ç)', '–ó–æ–Ω–∞ –ø–æ–¥ —Ä—É—á–∫–∞–º–∏ (4 —à—Ç)',
  '–ó–∞–¥–Ω—è—è –¥–≤–µ—Ä—å', '–ó–∞–¥–Ω–∏–µ –¥–≤–µ—Ä–∏ (2 —à—Ç)', '–ó–∞–¥–Ω–µ–µ –∫—Ä—ã–ª–æ', '–ó–∞–¥–Ω–∏–µ –∫—Ä—ã–ª—å—è (2 —à—Ç)',
  '–ö—Ä—ã—à–∫–∞ –±–∞–≥–∞–∂–Ω–∏–∫–∞', '–ë–∞–≥–∞–∂–Ω–∏–∫ (–¥–æ–ø)', '–û–∫–ª–µ–π–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞', '–ê–Ω—Ç–∏—Ö—Ä–æ–º'
];

const armServices = ['–î–µ–º–æ–Ω—Ç–∞–∂ —ç–ª–µ–º–µ–Ω—Ç–æ–≤', '–ú–æ–Ω—Ç–∞–∂ —ç–ª–µ–º–µ–Ω—Ç–æ–≤', '–î–µ–º–æ–Ω—Ç–∞–∂ –∏ –º–æ–Ω—Ç–∞–∂'];
const detailServices = [
  '–ú–æ–π–∫–∞ –∫—É–∑–æ–≤–∞ –ø–µ—Ä–µ–¥ –æ–∫–ª–µ–π–∫–æ–π', '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫—É–∑–æ–≤–∞', '–ì–ª—É–±–æ–∫–∞—è —á–∏—Å—Ç–∫–∞ –∫—É–∑–æ–≤–∞',
  '–ü–æ–ª–∏—Ä–æ–≤–∫–∞ –∫—É–∑–æ–≤–∞', '–ù–∞–Ω–µ—Å–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–æ–≤ –Ω–∞ –∫—É–∑–æ–≤', '–•–∏–º—á–∏—Å—Ç–∫–∞ —Å–∞–ª–æ–Ω–∞',
  '–ù–∞–Ω–µ—Å–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–æ–≤ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–∞–ª–æ–Ω–∞', '–ü–æ–ª–∏—Ä–æ–≤–∫–∞ –≥–ª—è–Ω—Ü–µ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤'
];
const glassServices = [
  '–¢–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–Ω–µ–π –ø–æ–ª—É—Å—Ñ–µ—Ä—ã', '–¢–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥–Ω–∏—Ö –±–æ–∫–æ–≤—ã—Ö —Å—Ç–µ–∫–æ–ª',
  '–¢–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–±–æ–≤–æ–≥–æ —Å—Ç–µ–∫–ª–∞', '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–±–æ–≤–æ–≥–æ —Å—Ç–µ–∫–ª–∞'
];
const miscServices = [
  '–ú–∞–ª—è—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã', '–í—ã–ø—Ä—è–º–ª–µ–Ω–∏–µ –≤–º—è—Ç–∏–Ω –±–µ–∑ –ø–æ–∫—Ä–∞—Å–∫–∏',
  '–†–µ—Å—Ç–∞–≤—Ä–∞—Ü–∏—è –õ–ö–ü', '–®—É–º–æ–∏–∑–æ–ª—è—Ü–∏—è'
];

// ========================================
// AUTH & SECURITY
// ========================================

async function checkAuth() {
  try {
    const { data: { session }, error } = await sb.auth.getSession();
    
    if (error || !session) {
      window.location.href = 'welcome.html';
      return false;
    }

    currentUser = session.user;
    
    const { data: profile, error: profileError } = await sb
      .from('profiles')
      .select('*')
      .eq('id', currentUser.id)
      .single();
    
    if (profileError || !profile) {
      console.error('Profile error:', profileError);
      await sb.auth.signOut();
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = 'welcome.html';
      return false;
    }

    currentProfile = profile;

    if (!profile.is_paid) {
      const now = new Date();
      const trialEnds = profile.trial_ends_at ? new Date(profile.trial_ends_at) : null;
      
      if (!trialEnds || trialEnds <= now) {
        alert('‚ö†Ô∏è –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∏—Å—Ç—ë–∫. –û–ø–ª–∞—Ç–∏—Ç–µ –¥–æ—Å—Ç—É–ø.');
        await sb.auth.signOut();
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = 'welcome.html';
        return false;
      }
    }

    displayUserInfo();
    return true;
  } catch (e) {
    console.error('Auth check error:', e);
    window.location.href = 'welcome.html';
    return false;
  }
}
function getLocalDateISO() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}
function displayUserInfo() {
  const userInfo = q('#user-info');
  
  if (!userInfo || !currentProfile) return;

  let statusText = '';
  if (currentProfile.is_paid) {
    statusText = '‚úÖ –û–ø–ª–∞—á–µ–Ω';
  } else if (currentProfile.trial_ends_at) {
    const now = new Date();
    const end = new Date(currentProfile.trial_ends_at);
    const hours = Math.floor((end - now) / (1000 * 60 * 60));
    statusText = hours > 0 ? `üïê –¢—Ä–∏–∞–ª: ${hours}—á` : '‚ö†Ô∏è –ò—Å—Ç—ë–∫';
  }

  userInfo.innerHTML = `<div>${currentProfile.studio_name || '–°—Ç—É–¥–∏—è'}</div><div style="font-size:0.75rem">${statusText}</div>`;
  userInfo.style.display = 'block';
}

function goToDashboard() {
  window.location.href = 'dashboard.html';
}

// ========================================
// RENDER OPTIMIZATION (requestAnimationFrame –±–∞—Ç—á–∏–Ω–≥)
// ========================================

function requestRender() {
  if (renderScheduled) return;
  renderScheduled = true;
  requestAnimationFrame(() => {
    renderScheduled = false;
    renderAll();
    scheduleLocalSave();
  });
}

// ========================================
// DATA COLLECTION
// ========================================

function collectAdditionalCosts(prefix) {
  let total = 0;
  qa(`#${prefix}CostsContent .cost-row`).forEach(row => {
    const input = row.querySelector(`.${prefix}-cost-val`);
    total += numVal(input);
  });
  return total;
}

function collectAll() {
  const sums = {
    pkg: { mat: 0, mot: 0, names: [] },
    impact: { mat: 0, mot: 0, names: [] },
    arm: { mat: 0, mot: 0, names: [], details: [] },
    wrap: { mat: 0, mot: 0, details: [] },
    det: { mat: 0, mot: 0, names: [], details: [] },
    gl: { mat: 0, mot: 0, names: [], details: [] },
    ms: { mat: 0, mot: 0, names: [], details: [] }
  };
  
  // –ü–∞–∫–µ—Ç—ã
  const pkgWrapMat = numVal(q('#pkgWrapMat'));
  const pkgWrapMot = numVal(q('#pkgWrapMot'));
  const pkgPrepMat = numVal(q('#pkgPrepMat'));
  const pkgPrepMot = numVal(q('#pkgPrepMot'));
  const pkgArmMat = numVal(q('#pkgArmMat'));
  const pkgArmMot = numVal(q('#pkgArmMot'));
  const pkgCosts = collectAdditionalCosts('pkg');
  
  if (pkgWrapMat > 0 || pkgWrapMot > 0 || pkgPrepMat > 0 || pkgPrepMot > 0 || pkgArmMat > 0 || pkgArmMot > 0 || pkgCosts > 0) {
    sums.pkg.mat = pkgWrapMat + pkgPrepMat + pkgArmMat + pkgCosts;
    sums.pkg.mot = pkgWrapMot + pkgPrepMot + pkgArmMot;
    sums.pkg.names.push('–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –≤–∫—Ä—É–≥');
  }
  
  const impactWrapMat = numVal(q('#impactWrapMat'));
  const impactWrapMot = numVal(q('#impactWrapMot'));
  const impactPrepMat = numVal(q('#impactPrepMat'));
  const impactPrepMot = numVal(q('#impactPrepMot'));
  const impactArmMat = numVal(q('#impactArmMat'));
  const impactArmMot = numVal(q('#impactArmMot'));
  const impactCosts = collectAdditionalCosts('impact');
  
  if (impactWrapMat > 0 || impactWrapMot > 0 || impactPrepMat > 0 || impactPrepMot > 0 || impactArmMat > 0 || impactArmMot > 0 || impactCosts > 0) {
    sums.impact.mat = impactWrapMat + impactPrepMat + impactArmMat + impactCosts;
    sums.impact.mot = impactWrapMot + impactPrepMot + impactArmMot;
    sums.impact.names.push('–ó–∞—â–∏—Ç–∞ —É–¥–∞—Ä–Ω–æ–π —á–∞—Å—Ç–∏');
  }
  
  // –ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã
  qa('.arm-chk').forEach(c => {
    if (c.checked) {
      const item = c.closest('.service-item');
      const n = item.querySelector('.service-header label')?.textContent?.trim();
      let mat = numVal(item.querySelector('.arm-mat'));
      let mot = numVal(item.querySelector('.arm-mot'));
      if (item.querySelector('.arm-complex')?.checked) { mat *= 1.1; mot *= 1.1; }
      if (n && (mat > 0 || mot > 0)) {
        sums.arm.mat += mat;
        sums.arm.mot += mot;
        sums.arm.names.push(n);
        sums.arm.details.push([n, mat, mot]);
      }
    }
  });
  
  qa('#armDyn .service-item').forEach(item => {
    const c = item.querySelector('input[type=checkbox]');
    if (c?.checked) {
      const n = item.querySelector('input[type=text]')?.value?.trim() || '–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏';
      let mat = numVal(item.querySelector('.arm-mat'));
      let mot = numVal(item.querySelector('.arm-mot'));
      if (item.querySelector('.arm-complex')?.checked) { mat *= 1.1; mot *= 1.1; }
      if (mat > 0 || mot > 0) {
        sums.arm.mat += mat;
        sums.arm.mot += mot;
        sums.arm.names.push(n);
        sums.arm.details.push([n, mat, mot]);
      }
    }
  });
  
  sums.arm.mat += collectAdditionalCosts('arm');
  
  // –û–∫–ª–µ–π–∫–∞ (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –≤ —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏)
  if (q('#ppfClearChk')?.checked) {
    const pr = numVal(q('#ppfClearPrice'));
    let m = numVal(q('#ppfClearM'));
    let mot = numVal(q('#ppfClearMot'));
    if (q('#ppfClearComplex')?.checked) { m *= 1.1; mot *= 1.1; }
    const mat = r100(m * pr);
    sums.wrap.mat += mat;
    sums.wrap.mot += mot;
    sums.wrap.details.push(['PPF –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –≤–∫—Ä—É–≥', m, pr, mat, mot, 0]);
  }
  
  if (q('#ppfColorChk')?.checked) {
    const pr = numVal(q('#ppfColorPrice'));
    let m = numVal(q('#ppfColorM'));
    let mot = numVal(q('#ppfColorMot'));
    if (q('#ppfColorComplex')?.checked) { m *= 1.1; mot *= 1.1; }
    const mat = r100(m * pr);
    sums.wrap.mat += mat;
    sums.wrap.mot += mot;
    sums.wrap.details.push(['PPF —Ü–≤–µ—Ç–Ω–æ–π –≤–∫—Ä—É–≥', m, pr, mat, mot, 0]);
  }
  
  if (q('#ppfMatChk')?.checked) {
    const pr = numVal(q('#ppfMatPrice'));
    let m = numVal(q('#ppfMatM'));
    let mot = numVal(q('#ppfMatMot'));
    if (q('#ppfMatComplex')?.checked) { m *= 1.1; mot *= 1.1; }
    const mat = r100(m * pr);
    sums.wrap.mat += mat;
    sums.wrap.mot += mot;
    sums.wrap.details.push(['PPF –º–∞—Ç–æ–≤—ã–π –≤–∫—Ä—É–≥', m, pr, mat, mot, 0]);
  }
  
  qa('.ppf-part-chk').forEach(c => {
    if (c.checked) {
      const ppfPartMainChk = q('#ppfPartChk');
      if (!ppfPartMainChk || !ppfPartMainChk.checked) return;
      
      const item = c.closest('.service-item');
      const n = item.querySelector('.service-header label')?.textContent?.trim();
      let m = numVal(item.querySelector('.ppf-part-m'));
      const pr = numVal(item.querySelector('.ppf-part-price'));
      let mot = numVal(item.querySelector('.ppf-part-mot'));
      if (item.querySelector('.ppf-part-complex')?.checked) { m *= 1.1; mot *= 1.1; }
      
      if (m > 0 || pr > 0 || mot > 0) {
        const mat = r100(m * pr);
        const itemMarkup = numVal(item.querySelector('.ppf-part-markup'));
        sums.wrap.mat += mat;
        sums.wrap.mot += mot;
        sums.wrap.details.push([`PPF —á–∞—Å—Ç–∏—á–Ω–æ - ${n}`, m, pr, mat, mot, itemMarkup]);
      }
    }
  });
  
  if (q('#pvcFullChk')?.checked) {
    const pr = numVal(q('#pvcFullPrice'));
    let m = numVal(q('#pvcFullM'));
    let mot = numVal(q('#pvcFullMot'));
    if (q('#pvcFullComplex')?.checked) { m *= 1.1; mot *= 1.1; }
    const mat = r100(m * pr);
    sums.wrap.mat += mat;
    sums.wrap.mot += mot;
    sums.wrap.details.push(['–ü–í–• –ø–æ–ª–Ω–∞—è –æ–∫–ª–µ–π–∫–∞', m, pr, mat, mot, 0]);
  }
  
  qa('.pvc-part-chk').forEach(c => {
    if (c.checked) {
      const pvcPartMainChk = q('#pvcPartChk');
      if (!pvcPartMainChk || !pvcPartMainChk.checked) return;
      
      const item = c.closest('.service-item');
      const n = item.querySelector('.service-header label')?.textContent?.trim();
      let m = numVal(item.querySelector('.pvc-part-m'));
      const pr = numVal(item.querySelector('.pvc-part-price'));
      let mot = numVal(item.querySelector('.pvc-part-mot'));
      if (item.querySelector('.pvc-part-complex')?.checked) { m *= 1.1; mot *= 1.1; }
      
      if (m > 0 || pr > 0 || mot > 0) {
        const mat = r100(m * pr);
        const itemMarkup = numVal(item.querySelector('.pvc-part-markup'));
        sums.wrap.mat += mat;
        sums.wrap.mot += mot;
        sums.wrap.details.push([`–ü–í–• —á–∞—Å—Ç–∏—á–Ω–æ - ${n}`, m, pr, mat, mot, itemMarkup]);
      }
    }
  });
  
  qa('#wrapDyn .service-item').forEach(item => {
    const c = item.querySelector('input[type=checkbox]');
    if (c?.checked) {
      const n = item.querySelector('input[type=text]')?.value?.trim() || '–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏';
      let m = numVal(item.querySelectorAll('input[type=number]')[0]);
      const pr = numVal(item.querySelectorAll('input[type=number]')[1]);
      let mot = numVal(item.querySelectorAll('input[type=number]')[2]);
      if (item.querySelector('.wrap-complex')?.checked) { m *= 1.1; mot *= 1.1; }
      
      if (m > 0 || pr > 0 || mot > 0) {
        const mat = r100(m * pr);
        sums.wrap.mat += mat;
        sums.wrap.mot += mot;
        sums.wrap.details.push([n, m, pr, mat, mot, 0]);
      }
    }
  });
  
  sums.wrap.mat += collectAdditionalCosts('wrap');
  
  // –î–µ—Ç–µ–π–ª–∏–Ω–≥, —Å—Ç–µ–∫–ª–∞, –ø—Ä–æ—á–µ–µ
  ['det', 'gl', 'misc'].forEach(tp => {
    const key = tp === 'misc' ? 'ms' : tp;
    
    qa(`.${tp}-chk`).forEach(c => {
      if (c.checked) {
        const item = c.closest('.service-item');
        const n = item.querySelector('.service-header label')?.textContent?.trim();
        let mat = numVal(item.querySelector(`.${tp}-mat`));
        let mot = numVal(item.querySelector(`.${tp}-mot`));
        if (item.querySelector(`.${tp}-complex`)?.checked) { mat *= 1.1; mot *= 1.1; }
        if (n && (mat > 0 || mot > 0)) {
          sums[key].mat += mat;
          sums[key].mot += mot;
          sums[key].names.push(n);
          sums[key].details.push([n, mat, mot]);
        }
      }
    });
    
    qa(`#${tp}Dyn .service-item`).forEach(item => {
      const c = item.querySelector('input[type=checkbox]');
      if (c?.checked) {
        const n = item.querySelector('input[type=text]')?.value?.trim() || '–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏';
        let mat = numVal(item.querySelector(`.${tp}-mat`));
        let mot = numVal(item.querySelector(`.${tp}-mot`));
        if (item.querySelector(`.${tp}-complex`)?.checked) { mat *= 1.1; mot *= 1.1; }
        if (mat > 0 || mot > 0) {
          sums[key].mat += mat;
          sums[key].mot += mot;
          sums[key].names.push(n);
          sums[key].details.push([n, mat, mot]);
        }
      }
    });
    
    sums[key].mat += collectAdditionalCosts(tp);
  });
  
  return sums;
}

function taxCoef() {
  const m = q('input[name=payMode]:checked')?.value;
  return m === 'card' ? 0.13 : m === 'ooo' ? 0.22 : 0;
}

function markups() {
  return {
    pkg: numVal(q('#pkgMarkup')),
    impact: numVal(q('#impactMarkup')),
    arm: numVal(q('#armMarkup')),
    wrap: numVal(q('#wrapMarkup')),
    det: numVal(q('#detMarkup')),
    gl: numVal(q('#glMarkup')),
    ms: numVal(q('#miscMarkup'))
  };
}

// ========================================
// –ï–î–ò–ù–´–ô –ú–û–î–£–õ–¨ –†–ê–°–ß–ï–¢–û–í (compute totals once)
// ========================================

function computeTotals(s, mu, discount, taxK) {
  const baseAll = s.pkg.mat + s.pkg.mot + s.impact.mat + s.impact.mot + 
                  s.arm.mat + s.arm.mot + s.wrap.mat + s.wrap.mot + 
                  s.det.mat + s.det.mot + s.gl.mat + s.gl.mot + s.ms.mat + s.ms.mot;
  
  const pkgMarkupAmt = r100((s.pkg.mat + s.pkg.mot) * (mu.pkg || 0) / 100);
  const impactMarkupAmt = r100((s.impact.mat + s.impact.mot) * (mu.impact || 0) / 100);
  const armMarkupAmt = r100((s.arm.mat + s.arm.mot) * (mu.arm || 0) / 100);
  const detMarkupAmt = r100((s.det.mat + s.det.mot) * (mu.det || 0) / 100);
  const glMarkupAmt = r100((s.gl.mat + s.gl.mot) * (mu.gl || 0) / 100);
  const msMarkupAmt = r100((s.ms.mat + s.ms.mot) * (mu.ms || 0) / 100);
  
  let wrapMarkupAmt = 0;
  if (s.wrap.details && s.wrap.details.length > 0) {
    s.wrap.details.forEach(detail => {
      const [name, meters, price, mat, mot, itemMarkup] = detail;
      const base = mat + mot;
      const markupToUse = (itemMarkup && itemMarkup > 0) ? itemMarkup : mu.wrap;
      wrapMarkupAmt += r100(base * (markupToUse || 0) / 100);
    });
  } else {
    wrapMarkupAmt = r100((s.wrap.mat + s.wrap.mot) * (mu.wrap || 0) / 100);
  }
  
  const totalMarkup = pkgMarkupAmt + impactMarkupAmt + armMarkupAmt + wrapMarkupAmt + detMarkupAmt + glMarkupAmt + msMarkupAmt;
  const markupWithDiscount = r100(totalMarkup * (1 - discount / 100));
  const afterMarkup = baseAll + markupWithDiscount;
  const tax = r100(afterMarkup * taxK);
  const finalTotal = afterMarkup + tax;
  
  return {
    baseAll,
    totalMarkup,
    markupWithDiscount,
    tax,
    finalTotal,
    components: {
      pkg: { markup: pkgMarkupAmt },
      impact: { markup: impactMarkupAmt },
      arm: { markup: armMarkupAmt },
      wrap: { markup: wrapMarkupAmt },
      det: { markup: detMarkupAmt },
      gl: { markup: glMarkupAmt },
      ms: { markup: msMarkupAmt }
    }
  };
}

// ========================================
// –î–í–£–•–£–†–û–í–ù–ï–í–´–ô –ê–í–¢–û–°–ï–ô–í (localStorage —á–∞—Å—Ç–æ, Supabase —Ä–µ–¥–∫–æ)
// ========================================

function buildState() {
  return {
    brand: q('#brand')?.value || '',
    brandManual: q('#brandManual')?.value || '',
    model: q('#model')?.value || '',
    modelManual: q('#modelManual')?.value || '',
    year: q('#year')?.value || '',
    
    pkgWrapMat: q('#pkgWrapMat')?.value || '',
    pkgWrapMot: q('#pkgWrapMot')?.value || '',
    pkgPrepMat: q('#pkgPrepMat')?.value || '',
    pkgPrepMot: q('#pkgPrepMot')?.value || '',
    pkgArmMat: q('#pkgArmMat')?.value || '',
    pkgArmMot: q('#pkgArmMot')?.value || '',
    pkgMarkup: q('#pkgMarkup')?.value || '',
    pkgCustomPrice: q('#pkgCustomPrice')?.value || '',
    
    impactWrapMat: q('#impactWrapMat')?.value || '',
    impactWrapMot: q('#impactWrapMot')?.value || '',
    impactPrepMat: q('#impactPrepMat')?.value || '',
    impactPrepMot: q('#impactPrepMot')?.value || '',
    impactArmMat: q('#impactArmMat')?.value || '',
    impactArmMot: q('#impactArmMot')?.value || '',
    impactMarkup: q('#impactMarkup')?.value || '',
    impactCustomPrice: q('#impactCustomPrice')?.value || '',
    
    payMode: q('input[name=payMode]:checked')?.value || 'cash',
    customDiscount: q('#customDiscount')?.value || '',
    
    timestamp: new Date().toISOString()
  };
}

function scheduleLocalSave() {
  clearTimeout(localSaveTimer);
  localSaveTimer = setTimeout(() => {
    const state = buildState();
    const hash = JSON.stringify(state);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
    if (hash === lastStateHash) return;
    lastStateHash = hash;
    
    // LocalStorage - –±—ã—Å—Ç—Ä–æ –∏ —á–∞—Å—Ç–æ
    if (currentUser) {
      localStorage.setItem(`calc_autosave_${currentUser.id}`, hash);
    }
    
    // Supabase - —Ä–µ–¥–∫–æ (30 —Å–µ–∫—É–Ω–¥ –¥–µ–±–∞—É–Ω—Å)
    scheduleSupaSave(state);
  }, 2000);
}

function scheduleSupaSave(state) {
  clearTimeout(supaSaveTimer);
  supaSaveTimer = setTimeout(() => {
    saveToSupabase(state);
  }, 30000); // 30 —Å–µ–∫—É–Ω–¥
}

async function saveToSupabase(state) {
  if (!currentUser) return;
  
  try {
    const br = q('#brandManual').classList.contains('invis') ? q('#brand').value : q('#brandManual').value;
    const md = q('#modelManual').classList.contains('invis') ? q('#model').value : q('#modelManual').value;
    const yr = q('#year').value || '';
    const carName = `${br || '–ê–≤—Ç–æ'} ${md || ''} ${yr || ''}`.trim();
    
    const s = collectAll();
    const mu = markups();
    const taxK = taxCoef();
    const totals = computeTotals(s, mu, disc, taxK);
    
    const calcData = {
      user_id: currentUser.id,
      car_name: carName,
      total_price: totals.finalTotal,
      calculation_data: state,
      updated_at: new Date().toISOString()
    };
    
    // UPSERT - –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ select+update/insert
    const { error } = await sb
      .from('calculations')
      .upsert(calcData, { 
        onConflict: 'user_id',
        ignoreDuplicates: false 
      });
    
    if (error) {
      console.error('Supabase upsert error:', error);
    } else {
      console.log('‚úÖ Saved to Supabase');
    }
  } catch (e) {
    console.error('Supabase save error:', e);
  }
}

function loadCalculation() {
  if (!currentUser) return;
  
  const saved = localStorage.getItem(`calc_autosave_${currentUser.id}`);
  if (!saved) return;
  
  try {
    const state = JSON.parse(saved);
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if (q('#brand')) q('#brand').value = state.brand || '';
    if (q('#brandManual')) q('#brandManual').value = state.brandManual || '';
    if (q('#model')) q('#model').value = state.model || '';
    if (q('#modelManual')) q('#modelManual').value = state.modelManual || '';
    if (q('#year')) q('#year').value = state.year || '';
    
    if (q('#pkgWrapMat')) q('#pkgWrapMat').value = state.pkgWrapMat || '';
    if (q('#pkgWrapMot')) q('#pkgWrapMot').value = state.pkgWrapMot || '';
    if (q('#pkgPrepMat')) q('#pkgPrepMat').value = state.pkgPrepMat || '';
    if (q('#pkgPrepMot')) q('#pkgPrepMot').value = state.pkgPrepMot || '';
    if (q('#pkgArmMat')) q('#pkgArmMat').value = state.pkgArmMat || '';
    if (q('#pkgArmMot')) q('#pkgArmMot').value = state.pkgArmMot || '';
    if (q('#pkgMarkup')) q('#pkgMarkup').value = state.pkgMarkup || '';
    if (q('#pkgCustomPrice')) q('#pkgCustomPrice').value = state.pkgCustomPrice || '';
    
    if (q('#impactWrapMat')) q('#impactWrapMat').value = state.impactWrapMat || '';
    if (q('#impactWrapMot')) q('#impactWrapMot').value = state.impactWrapMot || '';
    if (q('#impactPrepMat')) q('#impactPrepMat').value = state.impactPrepMat || '';
    if (q('#impactPrepMot')) q('#impactPrepMot').value = state.impactPrepMot || '';
    if (q('#impactArmMat')) q('#impactArmMat').value = state.impactArmMat || '';
    if (q('#impactArmMot')) q('#impactArmMot').value = state.impactArmMot || '';
    if (q('#impactMarkup')) q('#impactMarkup').value = state.impactMarkup || '';
    if (q('#impactCustomPrice')) q('#impactCustomPrice').value = state.impactCustomPrice || '';
    
    if (state.payMode) {
      const radio = document.querySelector(`input[name=payMode][value="${state.payMode}"]`);
      if (radio) {
        radio.checked = true;
        qa('.toggle-btn').forEach(b => b.classList.remove('active'));
        radio.closest('.toggle-btn')?.classList.add('active');
      }
    }
    
    if (q('#customDiscount')) q('#customDiscount').value = state.customDiscount || '';
    
    onBrandChange();
    renderAll();
    
    console.log('‚úÖ Loaded from autosave');
  } catch (e) {
    console.error('Failed to load autosave:', e);
  }
}

// ========================================
// RENDERING (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥ –ö–ü - –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç)
// ========================================

function getServiceDescription(name) {
  return serviceDescriptions[name] || name;
}

function renderKP(s, mu) {
  const tb = q('#kpTable tbody');
  if (!tb) return;
  tb.innerHTML = '';
  
  const taxK = taxCoef();
  let tot = 0;
  
  // –ü–∞–∫–µ—Ç—ã
  const pkgBase = s.pkg.mat + s.pkg.mot;
  if (pkgBase > 0) {
    const markupAmount = r100(pkgBase * (mu.pkg || 0) / 100);
    const markupWithDiscount = r100(markupAmount * (1 - disc / 100));
    let pr = pkgBase + markupWithDiscount;
    pr = r100(pr * (1 + taxK));
    tot += pr;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="text-align:left">–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –≤–∫—Ä—É–≥</td><td style="text-align:left">${getServiceDescription('–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –≤–∫—Ä—É–≥')}</td><td>${fmt(pr)}</td>`;
    tb.appendChild(tr);
  }
  
  const impactBase = s.impact.mat + s.impact.mot;
  if (impactBase > 0) {
    const markupAmount = r100(impactBase * (mu.impact || 0) / 100);
    const markupWithDiscount = r100(markupAmount * (1 - disc / 100));
    let pr = impactBase + markupWithDiscount;
    pr = r100(pr * (1 + taxK));
    tot += pr;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="text-align:left">–ó–∞—â–∏—Ç–∞ —É–¥–∞—Ä–Ω–æ–π —á–∞—Å—Ç–∏</td><td style="text-align:left">${getServiceDescription('–ó–∞—â–∏—Ç–∞ —É–¥–∞—Ä–Ω–æ–π —á–∞—Å—Ç–∏')}</td><td>${fmt(pr)}</td>`;
    tb.appendChild(tr);
  }
  
  // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ë–ê–ì–ê: –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –ø–æ –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–µ
  function addSimpleDetailRows(details, muPercent) {
    if (!details || !details.length) return;
    details.forEach(([name, mat, mot]) => {
      const base = mat + mot;
      if (base <= 0) return;
      
      const markupAmount = r100(base * (muPercent || 0) / 100);
      const markupWithDiscount = r100(markupAmount * (1 - disc / 100));
      let pr = base + markupWithDiscount;
      pr = r100(pr * (1 + taxK));
      tot += pr;
      
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="text-align:left">${name}</td>
                      <td style="text-align:left">${getServiceDescription(name)}</td>
                      <td>${fmt(pr)}</td>`;
      tb.appendChild(tr);
    });
  }
  
  // –ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ, –¥–µ—Ç–µ–π–ª–∏–Ω–≥, —Å—Ç–µ–∫–ª–∞, –ø—Ä–æ—á–µ–µ - –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç
  addSimpleDetailRows(s.arm.details, mu.arm);
  addSimpleDetailRows(s.det.details, mu.det);
  addSimpleDetailRows(s.gl.details, mu.gl);
  addSimpleDetailRows(s.ms.details, mu.ms);
  
  // –û–∫–ª–µ–π–∫–∞ —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Ü–µ–Ω–∫–∞–º–∏
  if (s.wrap.details && s.wrap.details.length > 0) {
    s.wrap.details.forEach(detail => {
      const [name, meters, price, mat, mot, itemMarkup] = detail;
      const base = mat + mot;
      if (base <= 0) return;
      
      const markupToUse = (itemMarkup && itemMarkup > 0) ? itemMarkup : mu.wrap;
      const markupAmount = r100(base * (markupToUse || 0) / 100);
      const markupWithDiscount = r100(markupAmount * (1 - disc / 100));
      let pr = base + markupWithDiscount;
      pr = r100(pr * (1 + taxK));
      tot += pr;
      
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="text-align:left">${name}</td><td style="text-align:left">${getServiceDescription(name)}</td><td>${fmt(pr)}</td>`;
      tb.appendChild(tr);
    });
  }
  
  q('#kpTotal').textContent = fmt(tot);
}

function renderCost(s) {
  const tb = q('#costTable tbody');
  if (!tb) return;
  tb.innerHTML = '';
  
  const rows = [
    { t: '–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –≤–∫—Ä—É–≥', sum: s.pkg },
    { t: '–ó–∞—â–∏—Ç–∞ —É–¥–∞—Ä–Ω–æ–π —á–∞—Å—Ç–∏', sum: s.impact },
    { t: '–ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã', sum: s.arm },
    { t: '–î–µ—Ç–µ–π–ª–∏–Ω–≥', sum: s.det },
    { t: '–°—Ç—ë–∫–ª–∞', sum: s.gl },
    { t: '–ü—Ä–æ—á–∏–µ —Ä–∞–±–æ—Ç—ã', sum: s.ms }
  ];
  
  let totM = 0, totO = 0;
  
  rows.forEach(r => {
    const base = r.sum.mat + r.sum.mot;
    if (base <= 0) return;
    
    totM += r.sum.mat;
    totO += r.sum.mot;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="text-align:left">${r.t}</td><td>${fmt(r.sum.mat)}</td><td>${fmt(r.sum.mot)}</td>`;
    tb.appendChild(tr);
  });
  
  if (s.wrap.details && s.wrap.details.length > 0) {
    s.wrap.details.forEach(detail => {
      const [name, meters, price, mat, mot, itemMarkup] = detail;
      if (mat <= 0 && mot <= 0) return;
      
      totM += mat;
      totO += mot;
      
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="text-align:left">${name}</td><td>${fmt(mat)}</td><td>${fmt(mot)}</td>`;
      tb.appendChild(tr);
    });
  }
  
  q('#cMat').textContent = fmt(totM);
  q('#cMot').textContent = fmt(totO);
  q('#cTotal').textContent = fmt(totM + totO);
}

function renderBlockTotals(s, mu) {
  const taxK = taxCoef();
  
  const blocks = [
    { id: 'pkg', base: s.pkg.mat + s.pkg.mot, markup: mu.pkg },
    { id: 'impact', base: s.impact.mat + s.impact.mot, markup: mu.impact },
    { id: 'arm', base: s.arm.mat + s.arm.mot, markup: mu.arm },
    { id: 'wrap', base: s.wrap.mat + s.wrap.mot, markup: mu.wrap },
    { id: 'det', base: s.det.mat + s.det.mot, markup: mu.det },
    { id: 'gl', base: s.gl.mat + s.gl.mot, markup: mu.gl },
    { id: 'misc', base: s.ms.mat + s.ms.mot, markup: mu.ms }
  ];
  
  blocks.forEach(block => {
    const totalEl = q(`#${block.id}Total .block-total-value`);
    if (!totalEl || block.base <= 0) return;
    
    const markupAmount = r100(block.base * (block.markup || 0) / 100);
    const markupWithDiscount = r100(markupAmount * (1 - disc / 100));
    let finalPrice = block.base + markupWithDiscount;
    finalPrice = r100(finalPrice * (1 + taxK));
    
    totalEl.textContent = fmt(finalPrice);
  });
}

function renderBadges(s, mu) {
  const taxK = taxCoef();
  const totals = computeTotals(s, mu, disc, taxK);
  
  q('#grandMat').textContent = fmt(s.pkg.mat + s.impact.mat + s.arm.mat + s.wrap.mat + s.det.mat + s.gl.mat + s.ms.mat);
  q('#grandMot').textContent = fmt(s.pkg.mot + s.impact.mot + s.arm.mot + s.wrap.mot + s.det.mot + s.gl.mot + s.ms.mot);
  q('#grandBase').textContent = fmt(totals.baseAll);
  q('#grandMarkup').textContent = fmt(totals.markupWithDiscount);
  q('#grandTax').textContent = fmt(totals.tax);
  q('#finalTotal').textContent = fmt(totals.finalTotal);
  
  if (chart) {
    chart.data.datasets[0].data = [
      s.pkg.mat + s.impact.mat + s.arm.mat + s.wrap.mat + s.det.mat + s.gl.mat + s.ms.mat,
      s.pkg.mot + s.impact.mot + s.arm.mot + s.wrap.mot + s.det.mot + s.gl.mot + s.ms.mot,
      totals.markupWithDiscount,
      totals.tax
    ];
    chart.update('none');
  }
}

function renderAll() {
  const s = collectAll();
  const mu = markups();
  renderBadges(s, mu);
  renderKP(s, mu);
  renderCost(s);
  renderExecutors(s);
  renderBlockTotals(s, mu);
  highlightMarkupFields(s, mu);
}

function highlightMarkupFields(s, mu) {
  const checks = [
    { sum: s.pkg.mat + s.pkg.mot, markup: mu.pkg, field: '#pkgMarkup' },
    { sum: s.impact.mat + s.impact.mot, markup: mu.impact, field: '#impactMarkup' },
    { sum: s.arm.mat + s.arm.mot, markup: mu.arm, field: '#armMarkup' },
    { sum: s.wrap.mat + s.wrap.mot, markup: mu.wrap, field: '#wrapMarkup' },
    { sum: s.det.mat + s.det.mot, markup: mu.det, field: '#detMarkup' },
    { sum: s.gl.mat + s.gl.mot, markup: mu.gl, field: '#glMarkup' },
    { sum: s.ms.mat + s.ms.mot, markup: mu.ms, field: '#miscMarkup' }
  ];
  
  checks.forEach(c => {
    const field = q(c.field);
    if (!field) return;
    if (c.sum > 0 && (!c.markup || c.markup === 0)) {
      field.classList.add('markup-warning');
    } else {
      field.classList.remove('markup-warning');
    }
  });
}

// ========================================
// –ò–°–ü–û–õ–ù–ò–¢–ï–õ–ò (–±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ –∏–º–µ–Ω)
// ========================================

function renderExecutors(s) {
  const container = q('#executorsContent');
  if (!container) return;
  
  let execIndex = 0;
  const allServices = [];
  
  const pkgWrapMot = numVal(q('#pkgWrapMot'));
  const pkgPrepMot = numVal(q('#pkgPrepMot'));
  const pkgArmMot = numVal(q('#pkgArmMot'));
  
  if (pkgWrapMot > 0 || pkgPrepMot > 0 || pkgArmMot > 0) {
    if (pkgWrapMot > 0) {
      allServices.push({ name: '–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –≤–∫—Ä—É–≥ - –ò–Ω—Å—Ç–∞–ª–ª—è—Ü–∏—è –ø–ª–µ–Ω–∫–∏', mot: pkgWrapMot, idx: execIndex++ });
    }
    if (pkgPrepMot > 0) {
      allServices.push({ name: '–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –≤–∫—Ä—É–≥ - –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞', mot: pkgPrepMot, idx: execIndex++ });
    }
    if (pkgArmMot > 0) {
      allServices.push({ name: '–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –≤–∫—Ä—É–≥ - –ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã', mot: pkgArmMot, idx: execIndex++ });
    }
  }
  
  const impactWrapMot = numVal(q('#impactWrapMot'));
  const impactPrepMot = numVal(q('#impactPrepMot'));
  const impactArmMot = numVal(q('#impactArmMot'));
  
  if (impactWrapMot > 0 || impactPrepMot > 0 || impactArmMot > 0) {
    if (impactWrapMot > 0) {
      allServices.push({ name: '–ó–∞—â–∏—Ç–∞ —É–¥–∞—Ä–Ω–æ–π —á–∞—Å—Ç–∏ - –ò–Ω—Å—Ç–∞–ª–ª—è—Ü–∏—è –ø–ª–µ–Ω–∫–∏', mot: impactWrapMot, idx: execIndex++ });
    }
    if (impactPrepMot > 0) {
      allServices.push({ name: '–ó–∞—â–∏—Ç–∞ —É–¥–∞—Ä–Ω–æ–π —á–∞—Å—Ç–∏ - –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞', mot: impactPrepMot, idx: execIndex++ });
    }
    if (impactArmMot > 0) {
      allServices.push({ name: '–ó–∞—â–∏—Ç–∞ —É–¥–∞—Ä–Ω–æ–π —á–∞—Å—Ç–∏ - –ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã', mot: impactArmMot, idx: execIndex++ });
    }
  }
  
  if (s.arm.details && s.arm.details.length > 0) {
    s.arm.details.forEach(detail => {
      allServices.push({ name: detail[0], mot: detail[2], idx: execIndex++ });
    });
  }
  
  if (s.wrap.details && s.wrap.details.length > 0) {
    s.wrap.details.forEach(detail => {
      allServices.push({ name: detail[0], mot: detail[4], idx: execIndex++ });
    });
  }
  
  if (s.det.details && s.det.details.length > 0) {
    s.det.details.forEach(detail => {
      allServices.push({ name: detail[0], mot: detail[2], idx: execIndex++ });
    });
  }
  
  if (s.gl.details && s.gl.details.length > 0) {
    s.gl.details.forEach(detail => {
      allServices.push({ name: detail[0], mot: detail[2], idx: execIndex++ });
    });
  }
  
  if (s.ms.details && s.ms.details.length > 0) {
    s.ms.details.forEach(detail => {
      allServices.push({ name: detail[0], mot: detail[2], idx: execIndex++ });
    });
  }
  
  const existingRows = container.querySelectorAll('[data-exec-id]');
  if (existingRows.length === allServices.length) {
    allServices.forEach(srv => {
      const baseId = `exec${srv.idx}`;
      const salaryInput = q(`#${baseId}salary`);
      if (salaryInput && salaryInput.dataset.manuallySet !== 'true') {
        salaryInput.value = srv.mot.toFixed(2);
      }
    });
    return;
  }
  
  let html = '';
  
  allServices.forEach(srv => {
    const baseId = `exec${srv.idx}`;
    
    html += `<div class="executor-row" data-exec-id="${baseId}">
      <div class="executor-row-header">${srv.name}</div>
      <div class="executor-fields-new">
        <div class="executor-field">
          <label>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</label>
          <input type="text" id="${baseId}name" placeholder="–§–ò–û" value="">
        </div>
        <div class="executor-field">
          <label>–ó–∞—Ä–ø–ª–∞—Ç–∞:</label>
          <input type="number" id="${baseId}salary" placeholder="0" value="${srv.mot.toFixed(2)}" step="0.01" data-original-motivation="${srv.mot.toFixed(2)}">
        </div>
        <div class="executor-field">
          <label>–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞:</label>
          <input type="date" id="${baseId}receive" value="">
        </div>
        <div class="executor-field">
          <label>–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏:</label>
          <input type="date" id="${baseId}return" value="">
        </div>
        <div class="executor-field executor-field-note">
          <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</label>
          <input type="text" id="${baseId}note" placeholder="–ó–∞–º–µ—Ç–∫–∏" value="">
        </div>
      </div>
      <div style="margin-top:12px;text-align:center">
        <label style="display:inline-flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9rem;user-select:none">
          <input type="checkbox" class="add-executor-chk" data-exec-base="${baseId}" style="width:20px;height:20px;cursor:pointer;accent-color:var(--primary)">
          <span>+ –î–æ–±–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è</span>
        </label>
      </div>
      <div class="extra-executors" id="${baseId}-extra"></div>
    </div>`;
  });
  
  container.innerHTML = html;
  
  qa('.add-executor-chk').forEach(chk => {
    chk.addEventListener('change', function() {
      if (this.checked) {
        const baseId = this.getAttribute('data-exec-base');
        const extraContainer = q(`#${baseId}-extra`);
        const baseRow = this.closest('.executor-row');
        const baseSalaryInput = baseRow.querySelector(`#${baseId}salary`);
        
        const originalMotivation = parseFloat(baseSalaryInput?.getAttribute('data-original-motivation')) || 0;
        
        const extraCount = extraContainer.querySelectorAll('.extra-executor-row').length;
        const totalExecutors = extraCount + 2;
        const newSalary = r100(originalMotivation / totalExecutors);
        
        const allSalaryInputs = [baseSalaryInput];
        extraContainer.querySelectorAll('.extra-executor-row input[type="number"]').forEach(inp => {
          allSalaryInputs.push(inp);
        });
        
        allSalaryInputs.forEach(inp => {
          if (inp) inp.value = newSalary.toFixed(2);
        });
        
        const newId = `${baseId}-ex${extraCount + 1}`;
        
        const row = document.createElement('div');
        row.className = 'extra-executor-row';
        row.style.cssText = 'margin-top:12px;padding:12px;background:var(--bg-tertiary);border-radius:12px;border:1px solid var(--border)';
        row.innerHTML = `
          <div class="executor-row-header" style="font-size:0.8rem;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
            <span>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å ${extraCount + 2}</span>
            <button type="button" class="btn-remove-executor" style="background:var(--danger);color:#fff;border:none;padding:6px 12px;border-radius:8px;font-size:0.8rem;cursor:pointer;font-weight:600;transition:all 0.3s">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
          </div>
          <div class="executor-fields-new">
            <div class="executor-field">
              <label>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</label>
              <input type="text" id="${newId}name" placeholder="–§–ò–û" value="">
            </div>
            <div class="executor-field">
              <label>–ó–∞—Ä–ø–ª–∞—Ç–∞:</label>
              <input type="number" id="${newId}salary" placeholder="0" value="${newSalary.toFixed(2)}" step="0.01">
            </div>
            <div class="executor-field">
              <label>–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞:</label>
              <input type="date" id="${newId}receive" value="">
            </div>
            <div class="executor-field">
              <label>–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏:</label>
              <input type="date" id="${newId}return" value="">
            </div>
            <div class="executor-field executor-field-note">
              <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</label>
              <input type="text" id="${newId}note" placeholder="–ó–∞–º–µ—Ç–∫–∏" value="">
            </div>
          </div>
        `;
        
        extraContainer.appendChild(row);
        this.checked = false;
        
        row.querySelector('.btn-remove-executor').addEventListener('click', function() {
          if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è?')) {
            row.remove();
            requestRender();
          }
        });
        
        setupSalaryListeners(baseId);
      }
    });
  });
  
  allServices.forEach(srv => setupSalaryListeners(`exec${srv.idx}`));
}

function setupSalaryListeners(baseId) {
  const baseRow = q(`[data-exec-id="${baseId}"]`);
  if (!baseRow) return;
  
  const baseSalaryInput = baseRow.querySelector(`#${baseId}salary`);
  const extraContainer = q(`#${baseId}-extra`);
  
  if (!baseSalaryInput) return;
  
  if (baseSalaryInput.dataset.listenersSet === 'true') return;
  baseSalaryInput.dataset.listenersSet = 'true';
  
  function recalculateSalaries(changedInput) {
    const allSalaryInputs = [baseSalaryInput];
    if (extraContainer) {
      extraContainer.querySelectorAll('input[type="number"]').forEach(inp => allSalaryInputs.push(inp));
    }
    
    const total = allSalaryInputs.reduce((sum, inp) => sum + (numVal(inp) || 0), 0);
    const others = allSalaryInputs.filter(inp => inp !== changedInput);
    
    if (others.length > 0) {
      const remaining = r100(total - (numVal(changedInput) || 0));
      const perOther = r100(remaining / others.length);
      others.forEach(inp => inp.value = perOther.toFixed(2));
    }
  }
  
  baseSalaryInput.addEventListener('input', function() {
    this.dataset.manuallySet = 'true';
    recalculateSalaries(this);
  });
  
  if (extraContainer) {
    extraContainer.querySelectorAll('input[type="number"]').forEach(extraInput => {
      if (extraInput.dataset.listenersSet === 'true') return;
      extraInput.dataset.listenersSet = 'true';
      
      extraInput.addEventListener('input', function() {
        recalculateSalaries(this);
      });
    });
  }
}

// ========================================
// UI FUNCTIONS
// ========================================

window.toggleTheme = function() {
  const body = document.body;
  const icon = q('#themeIcon');
  const currentTheme = body.getAttribute('data-theme');
  
  if (currentTheme === 'light') {
    body.removeAttribute('data-theme');
    icon.textContent = '‚òÄÔ∏è';
    localStorage.setItem('theme', 'dark');
  } else {
    body.setAttribute('data-theme', 'light');
    icon.textContent = 'üåô';
    localStorage.setItem('theme', 'light');
  }
};

function initTheme() {
  const sv = localStorage.getItem('theme');
  const icon = q('#themeIcon');
  const body = document.body;
  
  if (sv === 'light') {
    body.setAttribute('data-theme', 'light');
    icon.textContent = 'üåô';
  } else {
    icon.textContent = '‚òÄÔ∏è';
  }
  
  qa('.toggle-btn').forEach(b => {
    b.addEventListener('click', () => {
      const r = b.querySelector('input[type=radio]');
      if (r) {
        r.checked = true;
        qa('.toggle-btn').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        requestRender();
      }
    });
  });
  
  qa('.card h2.collapsible').forEach(h => {
    h.addEventListener('click', () => {
      h.classList.toggle('collapsed');
      h.nextElementSibling.classList.toggle('collapsed');
    });
  });
}

function fillBrands() {
  const s = q('#brand');
  s.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</option><option value="manual">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</option>';
  Object.keys(carDB).sort().forEach(b => {
    const o = document.createElement('option');
    o.value = b;
    o.textContent = b;
    s.appendChild(o);
  });
  
  const yearInput = q('#year');
  if (yearInput && !yearInput.value) {
    yearInput.value = '2026';
  }
}

function formatYearInput(input) {
  let val = input.value.replace(/\D/g, '');
  if (val.length > 4) val = val.slice(0, 4);
  input.value = val;
}

function onBrandChange() {
  const b = q('#brand').value;
  const m = q('#model');
  const bm = q('#brandManual');
  m.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å</option><option value="manual">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</option>';
  
  if (b && carDB[b]) {
    bm.classList.add('invis');
    carDB[b].forEach(md => {
      const o = document.createElement('option');
      o.value = md;
      o.textContent = md;
      m.appendChild(o);
    });
  } else if (b === 'manual') {
    bm.classList.remove('invis');
    m.innerHTML = '<option value="manual">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</option>';
    const mm = q('#modelManual');
    if (mm) mm.classList.remove('invis');
  }
  requestRender();
}

function onModelChange() {
  const m = q('#model').value;
  const mm = q('#modelManual');
  if (m === 'manual') mm.classList.remove('invis');
  else mm.classList.add('invis');
  requestRender();
}

function renderServiceList(containerId, services, classPrefix) {
  const container = q(containerId);
  let html = '';
  
  services.forEach((name, idx) => {
    html += `<div class="service-item">
      <div class="service-header">
        <input type="checkbox" class="${classPrefix}-chk" id="${classPrefix}${idx + 1}">
        <label for="${classPrefix}${idx + 1}">${name}</label>
      </div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:</label><input type="number" class="${classPrefix}-mat" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è:</label><input type="number" class="${classPrefix}-mot" placeholder="0" step="0.01"></div>
        </div>
        <div class="service-complexity">
          <input type="checkbox" class="${classPrefix}-complex" id="${classPrefix}${idx + 1}c">
          <label for="${classPrefix}${idx + 1}c">–£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ +10%</label>
        </div>
      </div>
    </div>`;
  });
  
  html += `<div id="${classPrefix}Dyn"></div>
    <button type="button" class="btn btn-secondary" id="btnAdd${classPrefix.charAt(0).toUpperCase() + classPrefix.slice(1)}">+ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</button>
    <div class="partial-wrapper">
      <div class="partial-header">
        <input type="checkbox" id="${classPrefix}CostsChk">
        <label for="${classPrefix}CostsChk">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã</label>
      </div>
      <div class="partial-content" id="${classPrefix}CostsContent"></div>
    </div>
    <button type="button" class="btn btn-secondary" id="btnAdd${classPrefix.charAt(0).toUpperCase() + classPrefix.slice(1)}Cost" style="margin-top:10px;display:none">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞—Ç—Ä–∞—Ç—É</button>
    <div style="margin-top:15px">
      <label class="markup-label">‚ö†Ô∏è –ù–∞—Ü–µ–Ω–∫–∞ (%):</label>
      <input type="number" id="${classPrefix}Markup" placeholder="–°–≤–æ—è –Ω–∞—Ü–µ–Ω–∫–∞" step="1">
      <div class="chips">
        <span class="chip" data-markup-target="#${classPrefix}Markup">30</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">50</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">70</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">130</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">150</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">170</span>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;align-items:start">
      <div>
        <label>–°–≤–æ—è —Ü–µ–Ω–∞:</label>
        <input type="number" id="${classPrefix}CustomPrice" placeholder="–ê–≤—Ç–æ—Ä–∞—Å—á–µ—Ç –Ω–∞—Ü–µ–Ω–∫–∏" step="0.01">
      </div>
      <div class="block-total" id="${classPrefix}Total" style="margin:0">
        <div class="block-total-value"></div>
        <div class="block-total-note">—Å —É—á–µ—Ç–æ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏, –Ω–∞—Ü–µ–Ω–∫–∏ –∏ –Ω–∞–ª–æ–≥–æ–≤</div>
      </div>
    </div>`;
  
  container.innerHTML = html;
}

function renderWrapContent() {
  const container = q('#wrapContent');
  let html = `<h3 style="margin-bottom:10px;font-size:1.05rem;font-weight:700">PPF</h3>
    <div class="service-item">
      <div class="service-header"><input type="checkbox" id="ppfClearChk"><label for="ppfClearChk">PPF –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –≤–∫—Ä—É–≥</label></div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>–ú–µ—Ç—Ä—ã (–º):</label><input type="number" id="ppfClearM" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–¶–µ–Ω–∞ –∑–∞ –º–µ—Ç—Ä:</label><input type="number" id="ppfClearPrice" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è:</label><input type="number" id="ppfClearMot" placeholder="0" step="0.01"></div>
        </div>
        <div class="service-complexity"><input type="checkbox" id="ppfClearComplex"><label for="ppfClearComplex">–£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ +10%</label></div>
      </div>
    </div>
    <div class="service-item">
      <div class="service-header"><input type="checkbox" id="ppfColorChk"><label for="ppfColorChk">PPF —Ü–≤–µ—Ç–Ω–æ–π –≤–∫—Ä—É–≥</label></div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>–ú–µ—Ç—Ä—ã (–º):</label><input type="number" id="ppfColorM" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–¶–µ–Ω–∞ –∑–∞ –º–µ—Ç—Ä:</label><input type="number" id="ppfColorPrice" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è:</label><input type="number" id="ppfColorMot" placeholder="0" step="0.01"></div>
        </div>
        <div class="service-complexity"><input type="checkbox" id="ppfColorComplex"><label for="ppfColorComplex">–£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ +10%</label></div>
      </div>
    </div>
    <div class="service-item">
      <div class="service-header"><input type="checkbox" id="ppfMatChk"><label for="ppfMatChk">PPF –º–∞—Ç–æ–≤—ã–π –≤–∫—Ä—É–≥</label></div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>–ú–µ—Ç—Ä—ã (–º):</label><input type="number" id="ppfMatM" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–¶–µ–Ω–∞ –∑–∞ –º–µ—Ç—Ä:</label><input type="number" id="ppfMatPrice" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è:</label><input type="number" id="ppfMatMot" placeholder="0" step="0.01"></div>
        </div>
        <div class="service-complexity"><input type="checkbox" id="ppfMatComplex"><label for="ppfMatComplex">–£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ +10%</label></div>
      </div>
    </div>
    <div class="partial-wrapper">
      <div class="partial-header"><input type="checkbox" id="ppfPartChk"><label for="ppfPartChk">PPF —á–∞—Å—Ç–∏—á–Ω–æ</label></div>
      <div class="partial-content" id="ppfPartContent"></div>
    </div>
    <h3 style="margin:20px 0 10px;font-size:1.05rem;font-weight:700">PVC</h3>
    <div class="service-item">
      <div class="service-header"><input type="checkbox" id="pvcFullChk"><label for="pvcFullChk">–ü–í–• –ø–æ–ª–Ω–∞—è –æ–∫–ª–µ–π–∫–∞</label></div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>–ú–µ—Ç—Ä—ã (–º):</label><input type="number" id="pvcFullM" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–¶–µ–Ω–∞ –∑–∞ –º–µ—Ç—Ä:</label><input type="number" id="pvcFullPrice" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è:</label><input type="number" id="pvcFullMot" placeholder="0" step="0.01"></div>
        </div>
        <div class="service-complexity"><input type="checkbox" id="pvcFullComplex"><label for="pvcFullComplex">–£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ +10%</label></div>
      </div>
    </div>
    <div class="partial-wrapper">
      <div class="partial-header"><input type="checkbox" id="pvcPartChk"><label for="pvcPartChk">–ü–í–• —á–∞—Å—Ç–∏—á–Ω–æ</label></div>
      <div class="partial-content" id="pvcPartContent"></div>
    </div>
    <div id="wrapDyn"></div>
    <button type="button" class="btn btn-secondary" id="btnAddWrap">+ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</button>
    <div class="partial-wrapper">
      <div class="partial-header">
        <input type="checkbox" id="wrapCostsChk">
        <label for="wrapCostsChk">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã</label>
      </div>
      <div class="partial-content" id="wrapCostsContent"></div>
    </div>
    <button type="button" class="btn btn-secondary" id="btnAddWrapCost" style="margin-top:10px;display:none">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞—Ç—Ä–∞—Ç—É</button>
    <div style="margin-top:20px">
      <label class="markup-label">‚ö†Ô∏è –ù–∞—Ü–µ–Ω–∫–∞ –Ω–∞ –æ–∫–ª–µ–π–∫—É (%):</label>
      <input type="number" id="wrapMarkup" placeholder="–°–≤–æ—è –Ω–∞—Ü–µ–Ω–∫–∞" step="1">
      <div class="chips">
        <span class="chip" data-markup-target="#wrapMarkup">30</span>
        <span class="chip" data-markup-target="#wrapMarkup">50</span>
        <span class="chip" data-markup-target="#wrapMarkup">70</span>
        <span class="chip" data-markup-target="#wrapMarkup">130</span>
        <span class="chip" data-markup-target="#wrapMarkup">150</span>
        <span class="chip" data-markup-target="#wrapMarkup">170</span>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;align-items:start">
      <div>
        <label>–°–≤–æ—è —Ü–µ–Ω–∞:</label>
        <input type="number" id="wrapCustomPrice" placeholder="–ê–≤—Ç–æ—Ä–∞—Å—á–µ—Ç –Ω–∞—Ü–µ–Ω–∫–∏" step="0.01">
      </div>
      <div class="block-total" id="wrapTotal" style="margin:0">
        <div class="block-total-value"></div>
        <div class="block-total-note">—Å —É—á–µ—Ç–æ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏, –Ω–∞—Ü–µ–Ω–∫–∏ –∏ –Ω–∞–ª–æ–≥–æ–≤</div>
      </div>
    </div>`;
  
  container.innerHTML = html;
}

function renderPartialLists() {
  const ppf = q('#ppfPartContent');
  const pvc = q('#pvcPartContent');
  let ppfHtml = '', pvcHtml = '';
  
  partElements.forEach((name, idx) => {
    ppfHtml += `<div class="service-item">
      <div class="service-header"><input type="checkbox" class="ppf-part-chk" id="ppfp${idx}"><label for="ppfp${idx}">${name}</label></div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>–ú–µ—Ç—Ä—ã (–º):</label><input type="number" class="ppf-part-m" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–¶–µ–Ω–∞ –∑–∞ –º–µ—Ç—Ä:</label><input type="number" class="ppf-part-price" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è:</label><input type="number" class="ppf-part-mot" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–°–≤–æ—è –Ω–∞—Ü–µ–Ω–∫–∞ (%):</label><input type="number" class="ppf-part-markup" placeholder="0"></div>
        </div>
        <div class="chips" style="margin-top:10px">
          <span class="chip" data-ppf-markup="${idx}">30</span>
          <span class="chip" data-ppf-markup="${idx}">50</span>
          <span class="chip" data-ppf-markup="${idx}">70</span>
          <span class="chip" data-ppf-markup="${idx}">130</span>
          <span class="chip" data-ppf-markup="${idx}">150</span>
          <span class="chip" data-ppf-markup="${idx}">170</span>
        </div>
        <div style="margin-top:10px"><label>–°–≤–æ—è —Ü–µ–Ω–∞:</label><input type="number" class="ppf-part-custom-price" placeholder="–ê–≤—Ç–æ—Ä–∞—Å—á–µ—Ç –Ω–∞—Ü–µ–Ω–∫–∏" step="0.01"></div>
      </div>
    </div>`;
    
    pvcHtml += `<div class="service-item">
      <div class="service-header"><input type="checkbox" class="pvc-part-chk" id="pvcp${idx}"><label for="pvcp${idx}">${name}</label></div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>–ú–µ—Ç—Ä—ã (–º):</label><input type="number" class="pvc-part-m" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–¶–µ–Ω–∞ –∑–∞ –º–µ—Ç—Ä:</label><input type="number" class="pvc-part-price" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è:</label><input type="number" class="pvc-part-mot" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–°–≤–æ—è –Ω–∞—Ü–µ–Ω–∫–∞ (%):</label><input type="number" class="pvc-part-markup" placeholder="0"></div>
        </div>
        <div class="chips" style="margin-top:10px">
          <span class="chip" data-pvc-markup="${idx}">30</span>
          <span class="chip" data-pvc-markup="${idx}">50</span>
          <span class="chip" data-pvc-markup="${idx}">70</span>
          <span class="chip" data-pvc-markup="${idx}">130</span>
          <span class="chip" data-pvc-markup="${idx}">150</span>
          <span class="chip" data-pvc-markup="${idx}">170</span>
        </div>
        <div style="margin-top:10px"><label>–°–≤–æ—è —Ü–µ–Ω–∞:</label><input type="number" class="pvc-part-custom-price" placeholder="–ê–≤—Ç–æ—Ä–∞—Å—á–µ—Ç –Ω–∞—Ü–µ–Ω–∫–∏" step="0.01"></div>
      </div>
    </div>`;
  });
  
  ppf.innerHTML = ppfHtml;
  pvc.innerHTML = pvcHtml;
}

function addCostRow(prefix) {
  costCounter++;
  const container = q(`#${prefix}CostsContent`);
  const row = document.createElement('div');
  row.className = 'cost-row';
  row.innerHTML = `
    <div class="form-group">
      <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã" class="${prefix}-cost-name">
      <input type="number" placeholder="–°—É–º–º–∞" class="${prefix}-cost-val" step="0.01">
    </div>
    <button type="button" onclick="this.closest('.cost-row').remove();window.calcApp.requestRender()">‚ùå</button>
  `;
  container.appendChild(row);
  requestRender();
}

function addDynRow(id, cls) {
  const c = q(id);
  const d = document.createElement('div');
  d.className = 'service-item';
  dynCounter++;
  
  if (cls === 'wrap') {
    d.innerHTML = `<div class="service-header">
      <input type="checkbox" checked id="dyn${cls}${dynCounter}">
      <label for="dyn${cls}${dynCounter}"><input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏" style="border:none;background:transparent;padding:0;font-weight:600;font-size:.95rem;color:var(--text);width:100%"></label>
    </div>
    <div class="service-body open">
      <div class="service-fields">
        <div class="form-group"><label>–ú–µ—Ç—Ä—ã (–º):</label><input type="number" class="${cls}-m" placeholder="0" step="0.01"></div>
        <div class="form-group"><label>–¶–µ–Ω–∞ –∑–∞ –º–µ—Ç—Ä:</label><input type="number" class="${cls}-price" placeholder="0" step="0.01"></div>
        <div class="form-group"><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è:</label><input type="number" class="${cls}-mot" placeholder="0" step="0.01"></div>
      </div>
      <div class="service-complexity">
        <input type="checkbox" class="${cls}-complex" id="dyn${cls}${dynCounter}c">
        <label for="dyn${cls}${dynCounter}c">–£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ +10%</label>
      </div>
    </div>`;
  } else {
    d.innerHTML = `<div class="service-header">
      <input type="checkbox" checked id="dyn${cls}${dynCounter}">
      <label for="dyn${cls}${dynCounter}"><input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏" style="border:none;background:transparent;padding:0;font-weight:600;font-size:.95rem;color:var(--text);width:100%"></label>
    </div>
    <div class="service-body open">
      <div class="service-fields">
        <div class="form-group"><label>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:</label><input type="number" class="${cls}-mat" placeholder="0" step="0.01"></div>
        <div class="form-group"><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è:</label><input type="number" class="${cls}-mot" placeholder="0" step="0.01"></div>
      </div>
      <div class="service-complexity">
        <input type="checkbox" class="${cls}-complex" id="dyn${cls}${dynCounter}c">
        <label for="dyn${cls}${dynCounter}c">–£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ +10%</label>
      </div>
    </div>`;
  }
  c.appendChild(d);
}

function initServiceToggles() {
  qa('.service-item').forEach(item => {
    const chk = item.querySelector('.service-header input[type="checkbox"]');
    const body = item.querySelector('.service-body');
    const header = item.querySelector('.service-header');
    
    if (!chk || !body) return;
    
    header.onclick = function(e) {
      if (e.target === chk || e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL') return;
      chk.click();
    };
    
    chk.onchange = function() {
      if (chk.checked) {
        body.classList.add('open');
      } else {
        body.classList.remove('open');
      }
    };
  });
  
  ['ppfPartChk', 'pvcPartChk', 'pkgCostsChk', 'impactCostsChk', 'armCostsChk', 'wrapCostsChk', 'detCostsChk', 'glCostsChk', 'miscCostsChk'].forEach(id => {
    const chk = q(`#${id}`);
    if (!chk) return;
    const content = q(`#${id.replace('Chk', 'Content')}`);
    
    let btnId = id.replace('Chk', '').replace('Costs', 'Cost');
    btnId = btnId.charAt(0).toUpperCase() + btnId.slice(1);
    const btn = q(`#btnAdd${btnId}`);
    if (!content) return;
    
    chk.onchange = function() {
      if (chk.checked) {
        content.classList.add('open');
        if (btn) btn.style.display = 'block';
      } else {
        content.classList.remove('open');
        if (btn) btn.style.display = 'none';
      }
    };
  });
}

function initDiscounts() {
  qa('.discount-btn').forEach(b => {
    b.addEventListener('click', () => {
      disc = parseInt(b.dataset.discount) || 0;
      qa('.discount-btn').forEach(x => x.classList.toggle('active', parseInt(x.dataset.discount) === disc));
      q('#customDiscount').value = '';
      requestRender();
    });
  });
  
  q('#customDiscount')?.addEventListener('input', e => {
    const v = Math.max(0, Math.min(100, numVal(e.target) || 0));
    disc = v;
    qa('.discount-btn').forEach(b => b.classList.remove('active'));
    requestRender();
  });
}

function initChart() {
  const ctx = q('#pieChart')?.getContext('2d');
  if (!ctx || !window.Chart) return;
  
  chart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['–ú–∞—Ç–µ—Ä–∏–∞–ª—ã', '–ú–æ—Ç–∏–≤–∞—Ü–∏—è', '–ù–∞—Ü–µ–Ω–∫–∞', '–ù–∞–ª–æ–≥'],
      datasets: [{
        data: [0, 0, 0, 0],
        backgroundColor: [
          'rgba(59, 130, 246, 0.8)',
          'rgba(16, 185, 129, 0.8)',
          'rgba(245, 158, 11, 0.8)',
          'rgba(239, 68, 68, 0.8)'
        ],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            font: { size: 11, family: 'Inter' },
            padding: 12,
            color: 'rgba(241, 245, 249, 0.9)',
            usePointStyle: true,
            pointStyle: 'circle'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.95)',
          titleFont: { size: 12, family: 'Inter', weight: '600' },
          bodyFont: { size: 11, family: 'Inter' },
          padding: 12,
          cornerRadius: 8,
          displayColors: true,
          callbacks: {
            label: function(context) {
              return context.label + ': ' + fmt(context.parsed);
            }
          }
        }
      }
    }
  });
}

function setDefaultMarkups() {
  ['#pkgMarkup', '#impactMarkup', '#armMarkup', '#wrapMarkup', '#detMarkup', '#glMarkup', '#miscMarkup'].forEach(id => {
    const field = q(id);
    if (field) field.value = 40;
  });
}

function formatNumberInput(input) {
  const val = numVal(input);
  if (val >= 0) {
    input.value = val.toFixed(2);
  }
}

// ========================================
// CUSTOM PRICE (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –Ω–∞—Ü–µ–Ω–∫–∏)
// ========================================

function handleCustomPrice(prefix) {
  const customPriceField = q(`#${prefix}CustomPrice`);
  const markupField = q(`#${prefix}Markup`);
  
  if (!customPriceField || !markupField) return;
  
  customPriceField.addEventListener('input', function() {
    const customPrice = numVal(this);
    if (customPrice <= 0) {
      markupField.value = '';
      requestRender();
      return;
    }
    
    const s = collectAll();
    let base = 0;
    
    if (prefix === 'pkg') {
      base = s.pkg.mat + s.pkg.mot;
    } else if (prefix === 'impact') {
      base = s.impact.mat + s.impact.mot;
    } else if (prefix === 'arm') {
      base = s.arm.mat + s.arm.mot;
    } else if (prefix === 'wrap') {
      base = s.wrap.mat + s.wrap.mot;
    } else if (prefix === 'det') {
      base = s.det.mat + s.det.mot;
    } else if (prefix === 'gl') {
      base = s.gl.mat + s.gl.mot;
    } else if (prefix === 'misc') {
      base = s.ms.mat + s.ms.mot;
    }
    
    if (base <= 0) {
      alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (–º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –º–æ—Ç–∏–≤–∞—Ü–∏—é)');
      this.value = '';
      return;
    }
    
    const taxK = taxCoef();
    const priceBeforeTax = customPrice / (1 + taxK);
    const priceBeforeDiscount = priceBeforeTax / (1 - disc / 100);
    const markupAmount = priceBeforeDiscount - base;
    const markupPercent = r100((markupAmount / base) * 100);
    
    markupField.value = markupPercent.toFixed(0);
    requestRender();
  });
}
// ========================================
// TRIAL WATERMARK
// ========================================

function showTrialWatermark() {
  const watermarks = ['watermarkKP', 'watermarkCost', 'watermarkExecutors', 'watermarkExecutorsWithSalary'];
  
  if (!currentProfile || !currentProfile.is_paid) {
    watermarks.forEach(id => {
      const el = q(`#${id}`);
      if (el) {
        el.style.display = 'block';
        el.textContent = '–ü–†–û–ë–ù–ê–Ø –í–ï–†–°–ò–Ø';
      }
    });
  } else {
    watermarks.forEach(id => {
      const el = q(`#${id}`);
      if (el) el.style.display = 'none';
    });
  }
}
// ========================================
// PDF EXPORT
// ========================================

async function exportPDF(blockId, filename) {
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF || !window.html2canvas) {
    alert('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ PDF –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...');
    console.error('jsPDF –∏–ª–∏ html2canvas –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
    return;
  }
  
  const holder = q('#pdfTemplates');
  const block = q(blockId);

  if (!holder || !block) {
    console.error('–ù–µ –Ω–∞–π–¥–µ–Ω holder –∏–ª–∏ block:', blockId);
    alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
    return;
  }
  
  console.log('–ù–∞—á–∏–Ω–∞–µ–º —ç–∫—Å–ø–æ—Ä—Ç PDF:', filename);
  
  const orig = holder.style.display;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫
  holder.style.display = 'block';
  holder.style.position = 'absolute';
  holder.style.left = '-9999px';
  
  // –í–†–ï–ú–ï–ù–ù–û –£–ú–ï–ù–¨–®–ê–ï–ú –®–†–ò–§–¢ –í –¢–ê–ë–õ–ò–¶–ê–•
  const tempStyle = document.createElement('style');
  tempStyle.id = 'pdf-temp-style';
  tempStyle.innerHTML = `
    #pdfTemplates table td,
    #pdfTemplates table th {
      font-size: 10px !important;
      padding: 3px 4px !important;
      line-height: 1.2 !important;
    }
    #pdfTemplates table th {
      font-size: 10px !important;
    }
    #pdfTemplates tfoot th {
      font-size: 10px !important;
      padding: 8px !important;
    }
  `;
  document.head.appendChild(tempStyle);
  
try {
    // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ —à—Ä–∏—Ñ—Ç–æ–≤
    await document.fonts.ready;
    await new Promise(resolve => requestAnimationFrame(resolve));
    
    const canvas = await html2canvas(block, {
      scale: 2.5, // –£–≤–µ–ª–∏—á–∏–ª scale –¥–ª—è —á–µ—Ç–∫–æ—Å—Ç–∏ –ø—Ä–∏ –º–µ–ª–∫–æ–º —à—Ä–∏—Ñ—Ç–µ
      useCORS: true, 
      backgroundColor: '#fff',
      logging: false
);
    
    const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
      const pw = pdf.internal.pageSize.getWidth();
      const ph = pdf.internal.pageSize.getHeight();
      const iw = canvas.width;
      const ih = canvas.height;
      const ratio = Math.min(pw / iw, ph / ih);
      const sw = iw * ratio;
      const sh = ih * ratio;
      const x = (pw - sw) / 2;
      const y = 20;
      
      // –†–∞–∑–º–µ—Ä—ã –¥–ª—è –Ω–∞—Ä–µ–∑–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
const pageWidth = pdf.internal.pageSize.getWidth();
const pageHeight = pdf.internal.pageSize.getHeight();
const margin = 20;
const contentHeight = pageHeight - (margin * 2);

const imgWidth = sw;
const imgHeight = sh;

let heightLeft = imgHeight;
let position = y;

// –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
pdf.addImage(canvas.toDataURL('image/png'), 'PNG', x, position, imgWidth, imgHeight);
heightLeft -= contentHeight;

// –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
while (heightLeft > 0) {
  position = -(imgHeight - heightLeft) + margin;
  pdf.addPage();
  pdf.addImage(canvas.toDataURL('image/png'), 'PNG', x, position, imgWidth, imgHeight);
  heightLeft -= contentHeight;
}
      pdf.save(filename);
    } catch (err) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è PDF:', err);
    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è PDF: ' + err.message);
  } finally {
      // –£–ë–ò–†–ê–ï–ú –í–†–ï–ú–ï–ù–ù–´–ï –°–¢–ò–õ–ò
      const tempStyleEl = document.getElementById('pdf-temp-style');
      if (tempStyleEl) tempStyleEl.remove();
      holder.style.display = orig;
  }
}
function prepKP() {
  showTrialWatermark();
  const tb = q('#pdfKPTBody');
  if (!tb) return;
  tb.innerHTML = '';
  
  qa('#kpTable tbody tr').forEach(tr => {
    const t = tr.children[0].textContent.trim();
    const d = tr.children[1].textContent.trim();
    const p = tr.children[2].textContent.trim();
    const r = document.createElement('tr');
    r.innerHTML = `<td style="width:25%">${t}</td><td style="width:50%">${d || '‚Äî'}</td><td style="width:25%">${p}</td>`;
    tb.appendChild(r);
  });
  
  q('#pdfKPTotal').textContent = q('#kpTotal')?.textContent || '0,00';
  
  const br = q('#brandManual').classList.contains('invis') ? q('#brand').value : q('#brandManual').value;
  const md = q('#modelManual').classList.contains('invis') ? q('#model').value : q('#modelManual').value;
  const yr = q('#year').value || '‚Äî';
  const now = new Date();
  const dateStr = now.toLocaleDateString('ru-RU');
  const timeStr = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
  const payMode = q('input[name=payMode]:checked')?.value;
  const payText = payMode === 'cash' ? '–ù–∞–ª–∏—á–Ω—ã–µ' : payMode === 'card' ? '–ö–∞—Ä—Ç–∞ –∏–ª–∏ –ò–ü' : '–û–û–û';
  
  const metaEl = q('#pdfKPMeta');
if (metaEl) {
  metaEl.textContent = ''; // –æ—á–∏—â–∞–µ–º
  
  // –°—Ç—Ä–æ–∫–∞ 1: –ê–≤—Ç–æ–º–æ–±–∏–ª—å
  const line1 = document.createTextNode(`–ê–≤—Ç–æ–º–æ–±–∏–ª—å: ${br || '‚Äî'} ${md || '‚Äî'} ${yr}`);
  metaEl.appendChild(line1);
  metaEl.appendChild(document.createElement('br'));
  
  // –°—Ç—Ä–æ–∫–∞ 2: –î–∞—Ç–∞
  const line2 = document.createTextNode(`–î–∞—Ç–∞: ${dateStr} ${timeStr}`);
  metaEl.appendChild(line2);
  metaEl.appendChild(document.createElement('br'));
  
  // –°—Ç—Ä–æ–∫–∞ 3: –£—Å–ª–æ–≤–∏—è (–∂–∏—Ä–Ω—ã–π + –∫—É—Ä—Å–∏–≤)
  const boldItalic = document.createElement('b');
  const italic = document.createElement('i');
  italic.textContent = `–£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã: ${payText}`;
  boldItalic.appendChild(italic);
  metaEl.appendChild(boldItalic);
}
}

function prepCost() {
  showTrialWatermark();
  const tb = q('#pdfCostTBody');
  if (!tb) return;
  tb.innerHTML = '';
  
  qa('#costTable tbody tr').forEach(tr => {
    const c = tr.children;
    const r = document.createElement('tr');
    r.innerHTML = `<td>${c[0].textContent.trim()}</td><td>${c[1].textContent.trim()}</td><td>${c[2].textContent.trim()}</td>`;
    tb.appendChild(r);
  });
  
  q('#pdfCM').textContent = q('#cMat')?.textContent || '0,00';
  q('#pdfCO').textContent = q('#cMot')?.textContent || '0,00';
  
  const br = q('#brandManual').classList.contains('invis') ? q('#brand').value : q('#brandManual').value;
  const md = q('#modelManual').classList.contains('invis') ? q('#model').value : q('#modelManual').value;
  const yr = q('#year').value || '‚Äî';
  
  q('#pdfCostMeta').textContent = `–ê–≤—Ç–æ–º–æ–±–∏–ª—å: ${br || '‚Äî'} ${md || '‚Äî'} ${yr}`;
}

function prepExecutors() {
  showTrialWatermark();
  const tb = q('#pdfExecutorsTBody');
  if (!tb) return;
  tb.innerHTML = '';
  
const todayStr = getLocalDateISO();
  
  qa('#executorsContent .executor-row').forEach(row => {
    const name = row.querySelector('.executor-row-header')?.textContent?.trim() || '';
    
    const baseId = row.getAttribute('data-exec-id');
    if (baseId) {
      const executor = row.querySelector(`#${baseId}name`)?.value || '';
      const receive = row.querySelector(`#${baseId}receive`)?.value || todayStr;
      const returnDate = row.querySelector(`#${baseId}return`)?.value || '';
      const note = row.querySelector(`#${baseId}note`)?.value || '';
      
      if (executor) {
        const r = document.createElement('tr');
        r.innerHTML = `<td>${name}</td><td>${executor}</td><td>${receive}</td><td>${returnDate}</td><td>${note}</td>`;
        tb.appendChild(r);
      }
    }
    
    const extraContainer = row.querySelector('.extra-executors');
    if (extraContainer) {
      extraContainer.querySelectorAll('.extra-executor-row').forEach(extraRow => {
        const extraName = extraRow.querySelector('input[id*="name"]')?.value || '';
        const extraReceive = extraRow.querySelector('input[id*="receive"]')?.value || todayStr;
        const extraReturn = extraRow.querySelector('input[id*="return"]')?.value || '';
        const extraNote = extraRow.querySelector('input[id*="note"]')?.value || '';
        
        if (extraName) {
          const r = document.createElement('tr');
          r.innerHTML = `<td>${name}</td><td>${extraName}</td><td>${extraReceive}</td><td>${extraReturn}</td><td>${extraNote}</td>`;
          tb.appendChild(r);
        }
      });
    }
  });
  
  const br = q('#brandManual').classList.contains('invis') ? q('#brand').value : q('#brandManual').value;
  const md = q('#modelManual').classList.contains('invis') ? q('#model').value : q('#modelManual').value;
  const yr = q('#year').value || '‚Äî';
  
  q('#pdfExecutorsMeta').textContent = `–ê–≤—Ç–æ–º–æ–±–∏–ª—å: ${br || '‚Äî'} ${md || '‚Äî'} ${yr}`;
}

function prepExecutorsWithSalary() {
  showTrialWatermark();
  const tb = q('#pdfExecutorsWithSalaryTBody');
  if (!tb) return;
  tb.innerHTML = '';
  
const todayStr = getLocalDateISO();
  
  qa('#executorsContent .executor-row').forEach(row => {
    const name = row.querySelector('.executor-row-header')?.textContent?.trim() || '';
    
    const baseId = row.getAttribute('data-exec-id');
    if (baseId) {
      const executor = row.querySelector(`#${baseId}name`)?.value || '';
      const salary = row.querySelector(`#${baseId}salary`)?.value || '0';
      const receive = row.querySelector(`#${baseId}receive`)?.value || todayStr;
      const returnDate = row.querySelector(`#${baseId}return`)?.value || '';
      const note = row.querySelector(`#${baseId}note`)?.value || '';
      
      if (executor) {
        const r = document.createElement('tr');
        r.innerHTML = `<td>${name}</td><td>${executor}</td><td>${fmt(parseFloat(salary))}</td><td>${receive}</td><td>${returnDate}</td><td>${note}</td>`;
        tb.appendChild(r);
      }
    }
    
    const extraContainer = row.querySelector('.extra-executors');
    if (extraContainer) {
      extraContainer.querySelectorAll('.extra-executor-row').forEach(extraRow => {
        const extraName = extraRow.querySelector('input[id*="name"]')?.value || '';
        const extraSalary = extraRow.querySelector('input[id*="salary"]')?.value || '0';
        const extraReceive = extraRow.querySelector('input[id*="receive"]')?.value || todayStr;
        const extraReturn = extraRow.querySelector('input[id*="return"]')?.value || '';
        const extraNote = extraRow.querySelector('input[id*="note"]')?.value || '';
        
        if (extraName) {
          const r = document.createElement('tr');
          r.innerHTML = `<td>${name}</td><td>${extraName}</td><td>${fmt(parseFloat(extraSalary))}</td><td>${extraReceive}</td><td>${extraReturn}</td><td>${extraNote}</td>`;
          tb.appendChild(r);
        }
      });
    }
  });
  
  const br = q('#brandManual').classList.contains('invis') ? q('#brand').value : q('#brandManual').value;
  const md = q('#modelManual').classList.contains('invis') ? q('#model').value : q('#modelManual').value;
  const yr = q('#year').value || '‚Äî';
  
  q('#pdfExecutorsWithSalaryMeta').textContent = `–ê–≤—Ç–æ–º–æ–±–∏–ª—å: ${br || '‚Äî'} ${md || '‚Äî'} ${yr}`;
}

// ========================================
// INITIALIZATION
// ========================================

// Expose for inline handlers
window.calcApp = {
  requestRender,
  addCostRow,
  addDynRow
};

document.addEventListener('DOMContentLoaded', async () => {
  const hasAccess = await checkAuth();
  if (!hasAccess) return;
  
  const dashboardBtn = q('#btn-dashboard');
  if (dashboardBtn) {
    dashboardBtn.addEventListener('click', goToDashboard);
  }
  
  const isTelegram = window.TelegramWebviewProxy !== undefined || navigator.userAgent.includes('Telegram');
  if (isTelegram) {
    const warning = q('#telegramWarning');
    if (warning) warning.style.display = 'block';
  }
  
  initTheme();
  initDiscounts();
  initChart();
  fillBrands();
  
  renderServiceList('#armContent', armServices, 'arm');
  renderWrapContent();
  renderPartialLists();
  renderServiceList('#detContent', detailServices, 'det');
  renderServiceList('#glContent', glassServices, 'gl');
  renderServiceList('#miscContent', miscServices, 'misc');
  initServiceToggles();
  setDefaultMarkups();
  
  q('#brand')?.addEventListener('change', onBrandChange);
  q('#model')?.addEventListener('change', onModelChange);
  
  q('#btnAddPkgCost')?.addEventListener('click', () => addCostRow('pkg'));
  q('#btnAddImpactCost')?.addEventListener('click', () => addCostRow('impact'));
  q('#btnAddArm')?.addEventListener('click', () => { addDynRow('#armDyn', 'arm'); initServiceToggles(); });
  q('#btnAddArmCost')?.addEventListener('click', () => addCostRow('arm'));
  q('#btnAddWrap')?.addEventListener('click', () => { addDynRow('#wrapDyn', 'wrap'); initServiceToggles(); });
  q('#btnAddWrapCost')?.addEventListener('click', () => addCostRow('wrap'));
  q('#btnAddDet')?.addEventListener('click', () => { addDynRow('#detDyn', 'det'); initServiceToggles(); });
  q('#btnAddDetCost')?.addEventListener('click', () => addCostRow('det'));
  q('#btnAddGl')?.addEventListener('click', () => { addDynRow('#glDyn', 'gl'); initServiceToggles(); });
  q('#btnAddGlCost')?.addEventListener('click', () => addCostRow('gl'));
  q('#btnAddMisc')?.addEventListener('click', () => { addDynRow('#miscDyn', 'misc'); initServiceToggles(); });
  q('#btnAddMiscCost')?.addEventListener('click', () => addCostRow('misc'));
  
  qa('input[name=payMode]').forEach(r => r.addEventListener('change', requestRender));
  
  q('#btnRecalc')?.addEventListener('click', renderAll);
  q('#btnReset')?.addEventListener('click', () => {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')) {
      if (currentUser) {
        localStorage.removeItem(`calc_autosave_${currentUser.id}`);
      }
      location.reload();
    }
  });
  
  // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –±–∞—Ç—á–∏–Ω–≥ —á–µ—Ä–µ–∑ requestRender + –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
  document.addEventListener('input', e => {
    if (e.target.id === 'year') {
      formatYearInput(e.target);
      requestRender();
      return;
    }
    
    // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º requestRender –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
    if (e.target.closest('.executor-fields-new') && 
        (e.target.type === 'text' || e.target.type === 'date')) {
      return;
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö —á–∏—Å–µ–ª
    if (e.target.matches('input[type="number"]')) {
      let val = numVal(e.target);
      if (val < 0) {
        e.target.value = '';
      }
    }
    
    if (e.target.matches('input, select')) requestRender();
  });
  
  document.addEventListener('blur', e => {
    if (e.target.matches('input[type="number"]') && e.target.value !== '') {
      formatNumberInput(e.target);
      requestRender();
    }
  }, true);
  
  qa('.chip').forEach(ch => {
    ch.addEventListener('click', () => {
      const sel = ch.getAttribute('data-markup-target');
      const ppfIdx = ch.getAttribute('data-ppf-markup');
      const pvcIdx = ch.getAttribute('data-pvc-markup');
      
      if (sel) {
        const tgt = q(sel);
        if (tgt) {
          tgt.value = ch.textContent.trim();
          requestRender();
        }
      } else if (ppfIdx !== null) {
        const item = ch.closest('.service-item');
        const inp = item.querySelector('.ppf-part-markup');
        if (inp) {
          inp.value = ch.textContent.trim();
          requestRender();
        }
      } else if (pvcIdx !== null) {
        const item = ch.closest('.service-item');
        const inp = item.querySelector('.pvc-part-markup');
        if (inp) {
          inp.value = ch.textContent.trim();
          requestRender();
        }
      }
    });
  });
  
  // Custom price handlers
  handleCustomPrice('pkg');
  handleCustomPrice('impact');
  handleCustomPrice('arm');
  handleCustomPrice('wrap');
  handleCustomPrice('det');
  handleCustomPrice('gl');
  handleCustomPrice('misc');
  
  q('#btnExportKP')?.addEventListener('click', () => {
    prepKP();
    setTimeout(() => exportPDF('#pdfKP', '–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ_–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.pdf'), 100);
  });
  
  q('#btnExportCost')?.addEventListener('click', () => {
    prepCost();
    setTimeout(() => exportPDF('#pdfCost', '–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å.pdf'), 100);
  });
  
  q('#btnExportExecutors')?.addEventListener('click', () => {
    prepExecutors();
    setTimeout(() => exportPDF('#pdfExecutors', '–°–ø–∏—Å–æ–∫_–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π.pdf'), 100);
  });
  
  q('#btnExportExecutorsWithSalary')?.addEventListener('click', () => {
    prepExecutorsWithSalary();
    setTimeout(() => exportPDF('#pdfExecutorsWithSalary', '–°–ø–∏—Å–æ–∫_–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π_–ó–ü.pdf'), 100);
  });
  
  renderAll();
});

})();
</script>
</body>
</html>
