<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ â€” Keep1R CRM</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="nav.css">
<script src="nav.js"></script>
<style>
:root {
  --font:      -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
  --bg:        #eef2f9;
  --surface:   #ffffff;
  --border:    rgba(15,23,42,0.08);
  --text:      #0f172a;
  --muted:     #64748b;
  --dim:       #94a3b8;
  --primary:   #2563eb;
  --primary-dk:#1d4ed8;
  --success:   #059669;
  --danger:    #dc2626;
  --warning:   #d97706;
  --radius:    14px;
  --radius-sm: 9px;
  --shadow:    0 1px 3px rgba(0,0,0,0.04), 0 4px 14px rgba(0,0,0,0.06);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: var(--font);
  -webkit-font-smoothing: antialiased;
  background: var(--bg);
  color: var(--text);
  min-height: 100svh;
}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page-wrap {
  max-width: 760px;
  margin: 0 auto;
  padding: 24px 18px 60px;
}
.page-title {
  font-size: 1.3rem;
  font-weight: 800;
  letter-spacing: -0.5px;
  margin-bottom: 20px;
}

/* â”€â”€ Cards / Sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 22px 24px;
  margin-bottom: 16px;
  box-shadow: var(--shadow);
}
.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 18px;
  gap: 12px;
}
.card-title {
  font-size: 0.9rem;
  font-weight: 800;
  letter-spacing: -0.1px;
  display: flex;
  align-items: center;
  gap: 7px;
}
.card-subtitle {
  font-size: 0.78rem;
  color: var(--muted);
  margin-top: 2px;
}

/* â”€â”€ Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-grid {
  display: grid;
  gap: 14px;
}
.form-grid-2 { grid-template-columns: 1fr 1fr; }
.form-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.form-group label {
  font-size: 0.67rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--muted);
}
.form-group input,
.form-group select,
.form-group textarea {
  padding: 9px 12px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 14px;
  font-family: var(--font);
  color: var(--text);
  outline: none;
  transition: border-color 0.15s, box-shadow 0.15s;
  -webkit-appearance: none;
  width: 100%;
}
.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37,99,235,0.08);
  background: var(--surface);
}
.form-group textarea { min-height: 80px; resize: vertical; }
.form-hint {
  font-size: 0.72rem;
  color: var(--dim);
  margin-top: 2px;
}

/* â”€â”€ Logo upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.logo-upload-wrap {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
}
.logo-preview {
  width: 80px;
  height: 80px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  flex-shrink: 0;
}
.logo-preview img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  padding: 4px;
}
.logo-preview-placeholder {
  font-size: 1.6rem;
  opacity: 0.3;
}
.logo-actions { display: flex; flex-direction: column; gap: 7px; }
.logo-filename {
  font-size: 0.75rem;
  color: var(--muted);
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* â”€â”€ Subscription badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sub-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 700;
  border: 1px solid;
}
.sub-badge.paid   { background: rgba(5,150,105,0.08); color: var(--success); border-color: rgba(5,150,105,0.2); }
.sub-badge.trial  { background: rgba(217,119,6,0.08); color: var(--warning); border-color: rgba(217,119,6,0.2); }
.sub-badge.expired{ background: rgba(220,38,38,0.08); color: var(--danger);  border-color: rgba(220,38,38,0.2); }

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 9px 18px;
  border-radius: var(--radius-sm);
  font-size: 0.82rem;
  font-weight: 700;
  font-family: var(--font);
  cursor: pointer;
  border: none;
  transition: all 0.15s;
  white-space: nowrap;
}
.btn-primary  { background: var(--primary); color: #fff; }
.btn-primary:hover  { background: var(--primary-dk); }
.btn-secondary {
  background: transparent;
  color: var(--muted);
  border: 1px solid var(--border);
}
.btn-secondary:hover { background: var(--bg); color: var(--text); }
.btn-danger   { background: rgba(220,38,38,0.07); color: var(--danger); border: 1px solid rgba(220,38,38,0.15); }
.btn-danger:hover { background: var(--danger); color: #fff; }
.btn-sm       { padding: 6px 12px; font-size: 0.75rem; }

/* â”€â”€ Save toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#saveToast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: #0f172a;
  color: #fff;
  padding: 10px 18px;
  border-radius: 10px;
  font-size: 0.82rem;
  font-weight: 600;
  font-family: var(--font);
  opacity: 0;
  transform: translateY(8px);
  transition: all 0.2s;
  z-index: 100;
  pointer-events: none;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}
#saveToast.show { opacity: 1; transform: translateY(0); }

/* â”€â”€ Members table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.members-table { width: 100%; border-collapse: collapse; }
.members-table th {
  text-align: left;
  font-size: 0.67rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--muted);
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
  background: var(--bg);
}
.members-table td {
  padding: 10px 10px;
  font-size: 0.82rem;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
}
.members-table tr:last-child td { border-bottom: none; }
.member-avatar {
  width: 30px; height: 30px;
  border-radius: 50%;
  background: rgba(37,99,235,0.1);
  color: var(--primary);
  font-size: 0.72rem;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  margin-right: 8px;
}
.role-badge {
  display: inline-flex;
  align-items: center;
  padding: 2px 9px;
  border-radius: 20px;
  font-size: 0.68rem;
  font-weight: 700;
  border: 1px solid;
}
.role-badge.owner   { background: rgba(37,99,235,0.07); color: var(--primary); border-color: rgba(37,99,235,0.2); }
.role-badge.manager { background: rgba(5,150,105,0.07); color: var(--success); border-color: rgba(5,150,105,0.2); }
.role-badge.staff   { background: rgba(148,163,184,0.15); color: var(--muted); border-color: rgba(148,163,184,0.25); }

/* â”€â”€ Divider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.divider { height: 1px; background: var(--border); margin: 16px 0; }

/* â”€â”€ KP Preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kp-preview {
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px;
  background: var(--bg);
  margin-top: 14px;
}
.kp-preview-label {
  font-size: 0.67rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--muted);
  margin-bottom: 10px;
}
.kp-header-preview {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
}
.kp-logo-preview {
  height: 40px;
  max-width: 140px;
  object-fit: contain;
}
.kp-contact-preview {
  text-align: right;
  font-size: 0.75rem;
  color: var(--text);
  line-height: 1.6;
}

/* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading { text-align: center; padding: 60px; color: var(--muted); font-size: 0.9rem; }

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 600px) {
  .page-wrap { padding: 16px 14px 48px; }
  .card { padding: 16px 16px; }
  .form-grid-2 { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div id="topNav"></div>

<div class="page-wrap">
  <div id="mainContent">
    <div class="loading">â³ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº...</div>
  </div>
</div>

<div id="saveToast">âœ… Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾</div>

<script>
(function() {
'use strict';

const SUPABASE_URL      = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window._crmSb = sb;

let currentUser    = null;
let currentProfile = null;  // studio_members row
let studio         = null;  // studios row
let logoBase64     = null;  // current logo as base64 string or null

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'welcome.html'; return false; }
  currentUser = session.user;
  return true;
}

async function loadStudio() {
  const { data: member, error } = await sb
    .from('studio_members')
    .select('studio_id, role')
    .eq('user_id', currentUser.id)
    .eq('is_active', true)
    .single();
  if (error || !member) { showError('Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°'); return false; }
  currentProfile = member;

  const { data: studioData, error: stErr } = await sb
    .from('studios')
    .select('*')
    .eq('id', member.studio_id)
    .single();
  if (stErr || !studioData) { showError('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑÑ‚ÑƒĞ´Ğ¸Ğ¸'); return false; }
  studio = studioData;
  return true;
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderAll() {
  const s = studio;
  const cfg = s.settings || {};
  const isOwner = currentProfile.role === 'owner';

  logoBase64 = cfg.kp_logo || null;

  const subExpires = s.subscription_expires_at ? new Date(s.subscription_expires_at) : null;
  const now = new Date();
  const isPaid = s.is_paid || (subExpires && subExpires > now);
  const tierLabel = isPaid ? 'Pro' : 'Trial';
  const subClass  = isPaid ? 'paid' : (subExpires && subExpires < now ? 'expired' : 'trial');
  const subText   = subExpires
    ? `Ğ´Ğ¾ ${subExpires.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' })}`
    : 'Ğ±ĞµĞ· Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğ¹';

  document.getElementById('mainContent').innerHTML = `
    <div class="page-title">âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸</div>

    <!-- â”€â”€ 1. ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">ğŸ¢ ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ</div>
          <div class="card-subtitle">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ, ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹, Ğ³Ğ¾Ñ€Ğ¾Ğ´</div>
        </div>
        <span class="sub-badge ${subClass}">
          ${isPaid ? 'ğŸ’' : 'ğŸ”“'} ${tierLabel} ${subText}
        </span>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸</label>
          <input id="studioName" type="text" value="${esc(s.name || '')}" placeholder="Ğ”ĞµÑ‚ĞµĞ¹Ğ»Ğ¸Ğ½Ğ³ Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ ĞĞµĞ¹Ğ¼" ${!isOwner ? 'disabled' : ''}>
        </div>
        <div class="form-grid form-grid-2">
          <div class="form-group">
            <label>Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</label>
            <input id="studioPhone" type="tel" value="${esc(cfg.phone || '')}" placeholder="+7 000 000 00 00">
          </div>
          <div class="form-group">
            <label>Ğ“Ğ¾Ñ€Ğ¾Ğ´</label>
            <input id="studioCity" type="text" value="${esc(cfg.city || '')}" placeholder="ĞœĞ¾ÑĞºĞ²Ğ°">
          </div>
        </div>
        <div class="form-grid form-grid-2">
          <div class="form-group">
            <label>Ğ¡Ğ°Ğ¹Ñ‚</label>
            <input id="studioWebsite" type="url" value="${esc(cfg.website || '')}" placeholder="https://mystudio.ru">
          </div>
          <div class="form-group">
            <label>E-mail</label>
            <input id="studioEmail" type="email" value="${esc(cfg.contact_email || '')}" placeholder="info@mystudio.ru">
          </div>
        </div>
        <div class="form-group">
          <label>ĞĞ´Ñ€ĞµÑ</label>
          <input id="studioAddress" type="text" value="${esc(cfg.address || '')}" placeholder="ÑƒĞ». ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ°Ñ, Ğ´. 1">
        </div>
      </div>

      <div style="margin-top:16px;display:flex;justify-content:flex-end">
        <button class="btn btn-primary" onclick="saveMain()">ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
      </div>
    </div>

    <!-- â”€â”€ 2. Ğ‘Ñ€ĞµĞ½Ğ´Ğ¸Ğ½Ğ³ ĞšĞŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">ğŸ¨ Ğ‘Ñ€ĞµĞ½Ğ´Ğ¸Ğ½Ğ³ ĞºĞ¾Ğ¼Ğ¼ĞµÑ€Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹</div>
          <div class="card-subtitle">Ğ›Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿ Ğ¸ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ğ² ÑˆĞ°Ğ¿ĞºĞµ ĞšĞŸ Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²</div>
        </div>
        ${!isPaid ? '<span class="sub-badge trial">Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Pro</span>' : ''}
      </div>

      ${!isPaid ? `
        <div style="padding:24px;text-align:center;color:var(--muted);font-size:0.85rem;background:var(--bg);border-radius:10px">
          ğŸ”’ Ğ›Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸ Ğ² ĞšĞŸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ° Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğµ <strong>Pro</strong>.<br>
          ĞĞ° Trial Ğ²ÑĞµ ĞšĞŸ Ğ²Ñ‹Ğ´Ğ°ÑÑ‚ÑÑ Ñ Ğ±Ñ€ĞµĞ½Ğ´Ğ¸Ğ½Ğ³Ğ¾Ğ¼ Keep1R.
        </div>
      ` : `
        <!-- Ğ›Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿ -->
        <div class="form-group" style="margin-bottom:16px">
          <label>Ğ›Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸</label>
          <div class="logo-upload-wrap">
            <div class="logo-preview" id="logoPreviewBox">
              ${logoBase64
                ? `<img src="${logoBase64}" id="logoPreviewImg" alt="logo">`
                : `<span class="logo-preview-placeholder">ğŸ¢</span>`}
            </div>
            <div class="logo-actions">
              <button class="btn btn-secondary btn-sm" onclick="document.getElementById('logoFileInput').click()">ğŸ“‚ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿</button>
              ${logoBase64 ? '<button class="btn btn-danger btn-sm" onclick="removeLogo()">âœ• Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ</button>' : ''}
              <div class="logo-filename" id="logoFilename">${cfg.kp_logo_name || (logoBase64 ? 'Ğ›Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½' : 'PNG, SVG, WEBP â€” Ğ´Ğ¾ 200KB')}</div>
            </div>
          </div>
          <input type="file" id="logoFileInput" accept="image/*" style="display:none" onchange="handleLogoChange(event)">
        </div>

        <!-- ĞšĞŸ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ -->
        <div class="form-grid form-grid-2">
          <div class="form-group">
            <label>Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ² ĞšĞŸ</label>
            <input id="kpPhone" type="tel" value="${esc(cfg.kp_phone || cfg.phone || '')}" placeholder="+7 000 000 00 00">
          </div>
          <div class="form-group">
            <label>Ğ¡Ğ°Ğ¹Ñ‚ Ğ² ĞšĞŸ</label>
            <input id="kpWebsite" type="url" value="${esc(cfg.kp_website || cfg.website || '')}" placeholder="https://mystudio.ru">
          </div>
        </div>

        <!-- ĞŸÑ€ĞµĞ´Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ ĞšĞŸ-ÑˆĞ°Ğ¿ĞºĞ¸ -->
        <div class="kp-preview" id="kpPreviewBox">
          <div class="kp-preview-label">ĞŸÑ€ĞµĞ´Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ ÑˆĞ°Ğ¿ĞºĞ¸ ĞšĞŸ</div>
          <div class="kp-header-preview">
            ${logoBase64
              ? `<img src="${logoBase64}" class="kp-logo-preview" id="kpLogoPreview" alt="logo">`
              : `<div style="font-size:1.1rem;font-weight:800;color:var(--text)" id="kpNamePreview">${esc(s.name || 'ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸')}</div>`}
            <div class="kp-contact-preview" id="kpContactPreview">
              ${esc(cfg.kp_phone || cfg.phone || '')}${(cfg.kp_phone || cfg.phone) && (cfg.kp_website || cfg.website) ? '<br>' : ''}${esc(cfg.kp_website || cfg.website || '')}
            </div>
          </div>
        </div>
      `}

      ${isPaid ? `
        <div style="margin-top:16px;display:flex;justify-content:flex-end">
          <button class="btn btn-primary" onclick="saveBranding()">ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
        </div>
      ` : ''}
    </div>

    <!-- â”€â”€ 3. Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">ğŸ‘¥ Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸</div>
          <div class="card-subtitle">ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ¾Ğ¼ Ğº CRM</div>
        </div>
      </div>
      <div id="membersBlock">
        <div class="loading" style="padding:20px">â³ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
      </div>
    </div>

    <!-- â”€â”€ 4. Ğ¡Ğ±Ñ€Ğ¾Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ°) â”€â”€â”€â”€â”€â”€â”€â”€ -->
    ${isOwner ? `
      <div class="card" style="border-color:rgba(220,38,38,0.15)">
        <div class="card-title" style="color:var(--danger);margin-bottom:10px">âš ï¸ ĞĞ¿Ğ°ÑĞ½Ğ°Ñ Ğ·Ğ¾Ğ½Ğ°</div>
        <div style="font-size:0.82rem;color:var(--muted);margin-bottom:14px">
          Ğ’Ñ‹Ñ…Ğ¾Ğ´ Ğ¸Ğ· CRM Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ ÑĞµÑÑĞ¸Ñ.
        </div>
        <button class="btn btn-danger" onclick="logout()">ğŸšª Ğ’Ñ‹Ğ¹Ñ‚Ğ¸ Ğ¸Ğ· Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°</button>
      </div>
    ` : ''}
  `;

  // Ğ¡Ğ»ÑƒÑˆĞ°Ñ‚ĞµĞ»Ğ¸ Ğ´Ğ»Ñ live-preview ĞšĞŸ
  if (isPaid) {
    document.getElementById('kpPhone')?.addEventListener('input', updateKPPreview);
    document.getElementById('kpWebsite')?.addEventListener('input', updateKPPreview);
  }

  // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
  await loadMembers();
}

// â”€â”€ KP Preview live update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateKPPreview() {
  const phone   = document.getElementById('kpPhone')?.value || '';
  const website = document.getElementById('kpWebsite')?.value || '';
  const el = document.getElementById('kpContactPreview');
  if (el) el.innerHTML = `${esc(phone)}${phone && website ? '<br>' : ''}${esc(website)}`;
}

// â”€â”€ Logo handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.handleLogoChange = function(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 200 * 1024) {
    alert('âŒ Ğ¤Ğ°Ğ¹Ğ» ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹. ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ â€” 200KB.');
    return;
  }
  const reader = new FileReader();
  reader.onload = function(ev) {
    logoBase64 = ev.target.result;
    const box = document.getElementById('logoPreviewBox');
    if (box) box.innerHTML = `<img src="${logoBase64}" id="logoPreviewImg" alt="logo">`;
    const fn = document.getElementById('logoFilename');
    if (fn) fn.textContent = file.name;
    // Update KP preview
    updateKPLogoPreview();
  };
  reader.readAsDataURL(file);
};

window.removeLogo = function() {
  logoBase64 = null;
  const box = document.getElementById('logoPreviewBox');
  if (box) box.innerHTML = `<span class="logo-preview-placeholder">ğŸ¢</span>`;
  const fn = document.getElementById('logoFilename');
  if (fn) fn.textContent = 'PNG, SVG, WEBP â€” Ğ´Ğ¾ 200KB';
  updateKPLogoPreview();
};

function updateKPLogoPreview() {
  const preview = document.getElementById('kpPreviewBox');
  if (!preview) return;
  const ph = preview.querySelector('.kp-header-preview');
  if (!ph) return;
  // Update left side
  const existing = ph.querySelector('img.kp-logo-preview, #kpNamePreview');
  if (existing) {
    if (logoBase64) {
      existing.outerHTML = `<img src="${logoBase64}" class="kp-logo-preview" id="kpLogoPreview" alt="logo">`;
    } else {
      existing.outerHTML = `<div style="font-size:1.1rem;font-weight:800;color:var(--text)" id="kpNamePreview">${esc(studio.name || 'ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸')}</div>`;
    }
  }
}

// â”€â”€ Members â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMembers() {
  const { data: members, error } = await sb
    .from('studio_members')
    .select('id, role, is_active, user_id')
    .eq('studio_id', studio.id)
    .eq('is_active', true)
    .order('created_at');

  const el = document.getElementById('membersBlock');
  if (error || !members?.length) {
    el.innerHTML = '<div style="color:var(--muted);font-size:0.82rem;padding:10px 0">Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.</div>';
    return;
  }

  const ROLE_LABELS = { owner: 'Ğ’Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ†', manager: 'ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€', staff: 'Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ğº' };
  const ROLE_CLASS  = { owner: 'owner', manager: 'manager', staff: 'staff' };

  el.innerHTML = `
    <table class="members-table">
      <thead>
        <tr>
          <th>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</th>
          <th>Ğ Ğ¾Ğ»ÑŒ</th>
          <th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</th>
        </tr>
      </thead>
      <tbody>
        ${members.map(m => {
          const isMe = m.user_id === currentUser.id;
          const initials = m.user_id.slice(0, 2).toUpperCase();
          const roleClass = ROLE_CLASS[m.role] || 'staff';
          const roleLabel = ROLE_LABELS[m.role] || m.role;
          return `
            <tr>
              <td>
                <div style="display:flex;align-items:center">
                  <span class="member-avatar">${initials}</span>
                  <span style="font-size:0.8rem;color:var(--muted)">${m.user_id.slice(0, 8)}â€¦${isMe ? ' <strong style="color:var(--primary)">(Ğ²Ñ‹)</strong>' : ''}</span>
                </div>
              </td>
              <td><span class="role-badge ${roleClass}">${roleLabel}</span></td>
              <td><span style="font-size:0.75rem;color:var(--success)">â— ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½</span></td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
    <div style="margin-top:12px;font-size:0.75rem;color:var(--muted)">
      Ğ”Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ² Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğ² Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ Keep1R.
    </div>
  `;
}

// â”€â”€ Save main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.saveMain = async function() {
  const name    = document.getElementById('studioName')?.value.trim();
  const phone   = document.getElementById('studioPhone')?.value.trim();
  const city    = document.getElementById('studioCity')?.value.trim();
  const website = document.getElementById('studioWebsite')?.value.trim();
  const email   = document.getElementById('studioEmail')?.value.trim();
  const address = document.getElementById('studioAddress')?.value.trim();

  if (!name) { alert('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸'); return; }

  const newSettings = {
    ...(studio.settings || {}),
    phone, city, website, contact_email: email, address
  };

  const { error } = await sb
    .from('studios')
    .update({ name, settings: newSettings })
    .eq('id', studio.id);

  if (error) { alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.message); return; }

  studio.name = name;
  studio.settings = newSettings;
  toast('âœ… ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ°');
};

// â”€â”€ Save branding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.saveBranding = async function() {
  const kpPhone   = document.getElementById('kpPhone')?.value.trim();
  const kpWebsite = document.getElementById('kpWebsite')?.value.trim();

  const newSettings = {
    ...(studio.settings || {}),
    kp_logo:    logoBase64 || null,
    kp_logo_name: logoBase64 ? (document.getElementById('logoFilename')?.textContent || '') : null,
    kp_phone:   kpPhone,
    kp_website: kpWebsite
  };

  const { error } = await sb
    .from('studios')
    .update({ settings: newSettings })
    .eq('id', studio.id);

  if (error) { alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.message); return; }

  studio.settings = newSettings;
  toast('âœ… Ğ‘Ñ€ĞµĞ½Ğ´Ğ¸Ğ½Ğ³ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½');
};

// â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.logout = async function() {
  if (!confirm('Ğ’Ñ‹Ğ¹Ñ‚Ğ¸ Ğ¸Ğ· Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°?')) return;
  await sb.auth.signOut();
  window.location.href = 'welcome.html';
};

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

let toastTimer = null;
function toast(msg) {
  const el = document.getElementById('saveToast');
  el.textContent = msg;
  el.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2500);
}

function showError(msg) {
  document.getElementById('mainContent').innerHTML = `<div class="loading">âŒ ${msg}</div>`;
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  initNav({ actionHref: 'dashboard.html', actionLabel: 'â† ĞŸĞ°Ğ½ĞµĞ»ÑŒ' });
  if (!await checkAuth()) return;
  if (!await loadStudio()) return;
  await renderAll();
}

init();

})();
</script>

<script src="footer.js"></script>
</body>
</html>
