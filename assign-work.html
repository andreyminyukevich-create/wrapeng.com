<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç</title>
<script>
const savedTheme = localStorage.getItem('theme') || 'dark';
document.documentElement.setAttribute('data-theme', savedTheme);
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

:root {
  --bg-primary: #080f1e;
  --bg-secondary: #0e1829;
  --bg-card: #131f35;
  --bg-input: #1a2844;
  --text: #eef2ff;
  --text-muted: #8aa0c0;
  --text-label: #b0c4de;
  --border: rgba(120, 160, 220, 0.22);
  --border-focus: rgba(99, 160, 255, 0.6);
  --primary: #5b9cf6;
  --primary-dark: #2563eb;
  --success: #22d3a0;
  --success-dark: #059669;
  --success-bg: rgba(34, 211, 160, 0.12);
  --danger: #f87171;
  --danger-bg: rgba(248, 113, 113, 0.14);
  --warning: #fbbf24;
  --warning-bg: rgba(251, 191, 36, 0.12);
  --shadow: 0 4px 24px rgba(0,0,0,0.5);
  --shadow-lg: 0 8px 40px rgba(0,0,0,0.6);
}

[data-theme="light"] {
  --bg-primary: #f0f4fb;
  --bg-secondary: #ffffff;
  --bg-card: #ffffff;
  --bg-input: #f8faff;
  --text: #0f172a;
  --text-muted: #64748b;
  --text-label: #475569;
  --border: rgba(15, 23, 42, 0.1);
  --border-focus: rgba(79, 142, 247, 0.5);
  --shadow: 0 4px 16px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Inter', -apple-system, sans-serif;
  background: var(--bg-primary);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
  font-size: 15px;
}

[data-theme="dark"] body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: 
    radial-gradient(ellipse at 10% 20%, rgba(79, 142, 247, 0.12) 0%, transparent 55%),
    radial-gradient(ellipse at 90% 80%, rgba(34, 211, 160, 0.1) 0%, transparent 55%);
  pointer-events: none;
  z-index: 0;
}

.container {
  max-width: 860px;
  margin: 0 auto;
  padding: 28px 20px;
  position: relative;
  z-index: 1;
}

/* ‚îÄ‚îÄ Top Bar ‚îÄ‚îÄ */
.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 28px;
  padding: 20px 28px;
  background: var(--bg-card);
  border-radius: 18px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
}

.top-bar-left h1 {
  font-size: 1.45rem;
  font-weight: 800;
  background: linear-gradient(120deg, var(--primary), var(--success));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: -0.5px;
}

.top-bar-left .car-subtitle {
  font-size: 0.9rem;
  color: var(--text-muted);
  margin-top: 2px;
  font-weight: 500;
}

.top-bar-right {
  display: flex;
  gap: 10px;
  align-items: center;
}

/* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
.btn {
  background: var(--primary);
  color: #fff;
  border: none;
  padding: 11px 22px;
  border-radius: 12px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 7px;
  text-decoration: none;
  letter-spacing: -0.1px;
}

.btn:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: var(--shadow);
}

.btn-success {
  background: linear-gradient(135deg, var(--success), #0fa882);
  color: #fff;
  font-size: 1rem;
  padding: 13px 28px;
}

.btn-success:hover {
  background: linear-gradient(135deg, #1db890, #0d9072);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(34,211,160,0.3);
}

.btn-secondary {
  background: transparent;
  color: var(--text-muted);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  background: var(--bg-input);
  color: var(--text);
  border-color: var(--border-focus);
}

.btn-danger {
  background: var(--danger-bg);
  color: var(--danger);
  border: 1px solid rgba(248,113,113,0.3);
}

.btn-danger:hover {
  background: var(--danger);
  color: #fff;
}

.btn-sm { padding: 8px 16px; font-size: 0.85rem; }

.theme-toggle {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 1.1rem;
  transition: all 0.2s;
}

/* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
.card {
  background: var(--bg-card);
  border-radius: 18px;
  border: 1px solid var(--border);
  padding: 24px;
  margin-bottom: 16px;
  box-shadow: var(--shadow);
}

.card-title {
  font-size: 1rem;
  font-weight: 700;
  margin-bottom: 20px;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
  letter-spacing: -0.2px;
}

/* ‚îÄ‚îÄ Admin Sale ‚îÄ‚îÄ */
.admin-sale-block {
  background: var(--warning-bg);
  border: 1px solid rgba(251,191,36,0.25);
  border-radius: 14px;
  padding: 18px 22px;
  margin-bottom: 16px;
}

.admin-sale-row {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
}

.toggle-switch {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.95rem;
}

.toggle-switch input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: var(--warning);
  cursor: pointer;
}

.admin-details {
  display: none;
  align-items: flex-end;
  gap: 14px;
  flex-wrap: wrap;
  margin-top: 14px;
  padding-top: 14px;
  border-top: 1px solid rgba(251,191,36,0.2);
}

.admin-details.active { display: flex; }

/* ‚îÄ‚îÄ Form ‚îÄ‚îÄ */
.form-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.form-group label {
  font-size: 0.78rem;
  color: var(--text-label);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.form-group input,
.form-group select {
  padding: 10px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-size: 0.9rem;
  font-family: 'Inter', sans-serif;
  transition: all 0.2s;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: var(--border-focus);
  background: var(--bg-card);
  box-shadow: 0 0 0 3px rgba(79,142,247,0.12);
}

/* ‚îÄ‚îÄ Work Items ‚îÄ‚îÄ */
.work-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.work-item {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 18px 20px;
  transition: border-color 0.2s;
}

[data-theme="dark"] .work-item {
  background: #0e1829;
  border-color: rgba(120, 160, 220, 0.28);
}

.work-item:hover {
  border-color: var(--border-focus);
}

[data-theme="dark"] .executor-select-wrap select,
[data-theme="dark"] .executor-manual-wrap .manual-name-input,
[data-theme="dark"] .salary-input,
[data-theme="dark"] .add-work-row input {
  background: #1a2844;
  border-color: rgba(120, 160, 220, 0.3);
  color: #eef2ff;
}

[data-theme="dark"] .executor-select-wrap select:focus,
[data-theme="dark"] .executor-manual-wrap .manual-name-input:focus,
[data-theme="dark"] .salary-input:focus,
[data-theme="dark"] .add-work-row input:focus {
  background: #1f3055;
  border-color: rgba(99, 160, 255, 0.7);
}

[data-theme="dark"] .mode-btn {
  background: #1a2844;
  border-color: rgba(120, 160, 220, 0.3);
  color: #8aa0c0;
}

[data-theme="dark"] .mode-btn.active {
  background: var(--primary);
  border-color: var(--primary);
  color: #fff;
}

[data-theme="dark"] .work-base-salary {
  background: rgba(34, 211, 160, 0.15);
  border-color: rgba(34, 211, 160, 0.3);
  color: var(--success);
}

[data-theme="dark"] .card {
  background: #131f35;
  border-color: rgba(120, 160, 220, 0.2);
}

[data-theme="dark"] .admin-sale-block {
  background: rgba(251, 191, 36, 0.08);
  border-color: rgba(251, 191, 36, 0.25);
}

[data-theme="dark"] .summary-block {
  background: rgba(34, 211, 160, 0.08);
  border-color: rgba(34, 211, 160, 0.25);
}

.work-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 14px;
  gap: 12px;
}

.work-service-name {
  font-weight: 700;
  font-size: 0.95rem;
  color: var(--text);
  letter-spacing: -0.1px;
}

.work-base-salary {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--success);
  background: var(--success-bg);
  padding: 4px 12px;
  border-radius: 20px;
  white-space: nowrap;
  border: 1px solid rgba(34,211,160,0.2);
}

/* ‚îÄ‚îÄ Executor Row ‚îÄ‚îÄ */
.executor-rows {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.executor-row {
  width: 100%;
}

.executor-input-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.executor-mode-switcher {
  display: flex;
  gap: 6px;
}

.mode-btn {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 5px 14px;
  cursor: pointer;
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--text-muted);
  transition: all 0.2s;
  font-family: 'Inter', sans-serif;
  white-space: nowrap;
}

.mode-btn.active {
  background: var(--primary);
  border-color: var(--primary);
  color: #fff;
}

/* –û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞: [–¥—Ä–æ–ø–¥–∞—É–Ω] [—Å—É–º–º–∞] [√ó] */
.executor-fields-row {
  display: grid;
  grid-template-columns: 1fr 140px 36px;
  gap: 8px;
  align-items: center;
}

.executor-select-wrap select,
.executor-manual-wrap .manual-name-input {
  width: 100%;
  padding: 9px 13px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-size: 0.88rem;
  font-family: 'Inter', sans-serif;
  transition: all 0.2s;
}

.executor-select-wrap,
.executor-manual-wrap {
  min-width: 0;
}

.executor-select-wrap select:focus,
.executor-manual-wrap .manual-name-input:focus {
  outline: none;
  border-color: var(--border-focus);
  box-shadow: 0 0 0 3px rgba(79,142,247,0.1);
}

.executor-manual-save {
  display: flex;
  align-items: center;
  padding-left: 2px;
}

.save-to-list-label {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--success);
  cursor: pointer;
  letter-spacing: 0.1px;
}

.save-to-list-label input[type="checkbox"] {
  accent-color: var(--success);
  width: 13px;
  height: 13px;
  cursor: pointer;
}

.salary-input {
  padding: 9px 13px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-size: 0.88rem;
  font-family: 'Inter', sans-serif;
  transition: all 0.2s;
  width: 100%;
  font-weight: 600;
}

.salary-input:focus {
  outline: none;
  border-color: var(--success);
  box-shadow: 0 0 0 3px rgba(34,211,160,0.1);
}

.btn-remove-exec {
  background: var(--danger-bg);
  border: 1px solid rgba(248,113,113,0.25);
  color: var(--danger);
  border-radius: 9px;
  padding: 0;
  cursor: pointer;
  font-size: 0.8rem;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  height: 36px;
  width: 36px;
}

.btn-remove-exec:hover {
  background: var(--danger);
  color: #fff;
  border-color: var(--danger);
}

.add-executor-btn {
  margin-top: 10px;
  font-size: 0.82rem;
  padding: 7px 14px;
  color: var(--primary);
  background: rgba(79,142,247,0.08);
  border: 1px dashed rgba(79,142,247,0.35);
  border-radius: 9px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  transition: all 0.2s;
  font-weight: 600;
  font-family: 'Inter', sans-serif;
}

.add-executor-btn:hover {
  background: rgba(79,142,247,0.15);
  border-color: var(--primary);
}

/* ‚îÄ‚îÄ Add Manual Work ‚îÄ‚îÄ */
.add-work-row {
  display: grid;
  grid-template-columns: 1fr 160px;
  gap: 12px;
}

.add-work-row input {
  padding: 10px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-size: 0.9rem;
  font-family: 'Inter', sans-serif;
  transition: all 0.2s;
}

.add-work-row input:focus {
  outline: none;
  border-color: var(--border-focus);
  box-shadow: 0 0 0 3px rgba(79,142,247,0.1);
}

/* ‚îÄ‚îÄ Summary ‚îÄ‚îÄ */
.summary-block {
  background: var(--success-bg);
  border: 1px solid rgba(34,211,160,0.25);
  border-radius: 14px;
  padding: 20px 24px;
  overflow: hidden;
}

.summary-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  gap: 20px;
}

.summary-row + .summary-row {
  border-top: 1px solid rgba(34,211,160,0.15);
}

.summary-label {
  color: var(--text-label);
  font-size: 0.9rem;
  font-weight: 500;
  white-space: nowrap;
}

.summary-value {
  font-weight: 700;
  font-size: 1rem;
  text-align: right;
}

.summary-total-value {
  color: var(--success);
  font-size: 1.8rem;
  font-weight: 800;
  letter-spacing: -1px;
  text-align: right;
  line-height: 1.1;
  min-width: 0;
  word-break: break-word;
}

.loading { text-align: center; padding: 60px; color: var(--text-muted); font-size: 1rem; }

@media (max-width: 600px) {
  .executor-row {
    grid-template-columns: 1fr 120px 36px;
  }
  .add-work-row {
    grid-template-columns: 1fr;
  }
  .top-bar {
    flex-direction: column;
    gap: 12px;
    align-items: flex-start;
  }
  .summary-total-value {
    font-size: 1.5rem;
  }
}
</style>
</head>
<body>

<div class="container">
  <!-- Top Bar -->
  <div class="top-bar">
    <div class="top-bar-left">
      <h1>üë• –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç</h1>
      <div class="car-subtitle" id="carSubtitle">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    <div class="top-bar-right">
      <button class="theme-toggle" id="themeToggle">üåô</button>
      <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
  </div>

  <div id="mainContent">
    <div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—á—ë—Ç–∞...</div>
  </div>
</div>

<script>
(function() {
'use strict';

const SUPABASE_URL = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let currentStudio = null;
let calculation = null;
let executors = [];
let calcId = null;

// –ù–∞–∑–≤–∞–Ω–∏—è —É—Å–ª—É–≥
const SERVICE_NAMES = {
  pkg_wrap: '–û–∫–ª–µ–π–∫–∞ (–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞)',
  pkg_prep: '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞)',
  pkg_arm:  '–ê—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ (–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞)',
  impact_wrap: '–û–∫–ª–µ–π–∫–∞ (–£–¥–∞—Ä–Ω–∞—è —á–∞—Å—Ç—å)',
  impact_prep: '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–£–¥–∞—Ä–Ω–∞—è —á–∞—Å—Ç—å)',
  impact_arm:  '–ê—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ (–£–¥–∞—Ä–Ω–∞—è —á–∞—Å—Ç—å)',
  arm: '–ê—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ',
  wrap: '–û–∫–ª–µ–π–∫–∞',
  det: '–î–µ—Ç–µ–π–ª–∏–Ω–≥',
  gl:  '–ü–æ–ª–∏—Ä–æ–≤–∫–∞/–•–∏–º—á–∏—Å—Ç–∫–∞',
  ms:  '–ü—Ä–æ—á–∏–µ —É—Å–ª—É–≥–∏'
};

// Theme
function initTheme() {
  const t = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', t);
  document.getElementById('themeToggle').textContent = t === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}

document.getElementById('themeToggle').addEventListener('click', () => {
  const current = document.documentElement.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  document.getElementById('themeToggle').textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
});

// Format
function fmt(n) {
  return new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n || 0);
}

// Auth
async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'welcome.html'; return false; }
  currentUser = session.user;
  return true;
}

// Get studio
async function getStudio() {
  const { data, error } = await sb
    .from('studio_members')
    .select('studio_id, role')
    .eq('user_id', currentUser.id)
    .eq('is_active', true)
    .single();
  if (error || !data) { alert('‚ùå –°—Ç—É–¥–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); return false; }
  currentStudio = data;
  return true;
}

// Load executors
async function loadExecutors() {
  const { data, error } = await sb
    .from('executors')
    .select('id, full_name, role, is_admin')
    .eq('studio_id', currentStudio.studio_id)
    .eq('is_active', true)
    .order('full_name');
  if (error) { console.error('Executors error:', error); return; }
  executors = data || [];
}

// Build executor dropdown
function executorSelect(selectedId = '') {
  const opts = executors.map(e =>
    `<option value="${e.id}" ${e.id === selectedId ? 'selected' : ''}>${e.full_name} (${roleRu(e.role)})</option>`
  ).join('');
  return `<select><option value="">‚Äî –í—ã–±—Ä–∞—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è ‚Äî</option>${opts}</select>`;
}

function roleRu(r) {
  const m = { wrapper: '–û–∫–ª–µ–π—â–∏–∫', preparer: '–ü–æ–¥–≥–æ—Ç–æ–≤—â–∏–∫', armature: '–ê—Ä–º–∞—Ç—É—Ä—â–∏–∫', detailer: '–î–µ—Ç–µ–π–ª–µ—Ä', universal: '–£–Ω–∏–≤–µ—Ä—Å–∞–ª' };
  return m[r] || r;
}

// Admin executor dropdown
function adminExecutorSelect(selectedId = '') {
  const admins = executors.filter(e => e.is_admin);
  if (admins.length === 0) return '<span style="color:var(--text-muted);font-size:0.9rem">–ù–µ—Ç –ø—Ä–æ–¥–∞–≤—Ü–æ–≤. –î–æ–±–∞–≤—å –≤ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è—Ö.</span>';
  const opts = admins.map(e =>
    `<option value="${e.id}" ${e.id === selectedId ? 'selected' : ''}>${e.full_name}</option>`
  ).join('');
  return `<select id="adminExecutorId"><option value="">‚Äî –í—ã–±—Ä–∞—Ç—å –ø—Ä–æ–¥–∞–≤—Ü–∞ ‚Äî</option>${opts}</select>`;
}

// Extract services from calculation_data
function extractServices(calcData) {
  const services = [];
  const d = calcData;

  function addIfHasMot(key, name, mot) {
    const m = parseFloat(mot) || 0;
    if (m > 0) services.push({ key, name, baseSalary: m });
  }

  // –ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –≤–∫—Ä—É–≥
  if (d.package) {
    addIfHasMot('pkg_wrap', SERVICE_NAMES.pkg_wrap, d.package.wrapMot);
    addIfHasMot('pkg_prep', SERVICE_NAMES.pkg_prep, d.package.prepMot);
    addIfHasMot('pkg_arm',  SERVICE_NAMES.pkg_arm,  d.package.armMot);
  }

  // –£–¥–∞—Ä–Ω–∞—è —á–∞—Å—Ç—å
  if (d.impact) {
    addIfHasMot('impact_wrap', SERVICE_NAMES.impact_wrap, d.impact.wrapMot);
    addIfHasMot('impact_prep', SERVICE_NAMES.impact_prep, d.impact.prepMot);
    addIfHasMot('impact_arm',  SERVICE_NAMES.impact_arm,  d.impact.armMot);
  }

  // –ü—Ä–æ—á–∏–µ —É—Å–ª—É–≥–∏ (arm, wrap, det, gl, ms)
  // –ò—â–µ–º –≤ calculation_data –ø–æ–ª—è –ø–æ —à–∞–±–ª–æ–Ω—É
  const extras = ['arm', 'wrap', 'det', 'gl', 'ms'];
  extras.forEach(key => {
    if (d[key]) {
      addIfHasMot(key, SERVICE_NAMES[key] || key, d[key].mot || d[key].motivation);
    }
  });

  // –£—Å–ª—É–≥–∏ –∏–∑ renderServiceList (ppf, pvc, detail...)
  if (d.services && Array.isArray(d.services)) {
    d.services.forEach((srv, idx) => {
      const m = parseFloat(srv.mot || srv.motivation) || 0;
      if (m > 0) services.push({ key: `service_${idx}`, name: srv.name || `–£—Å–ª—É–≥–∞ ${idx + 1}`, baseSalary: m });
    });
  }

  return services;
}

// Render work item
let workItemCounter = 0;

function renderWorkItem(service, existingAssignments = []) {
  const id = `work_${workItemCounter++}`;
  const execRowsHtml = existingAssignments.length > 0
    ? existingAssignments.map((a, i) => renderExecutorRow(`${id}_exec_${i}`, a.executor_id, a.salary)).join('')
    : renderExecutorRow(`${id}_exec_0`, '', service.baseSalary);

  return `
    <div class="work-item" data-service-key="${service.key}" data-service-name="${service.name}">
      <div class="work-item-header">
        <span class="work-service-name">${service.name}</span>
        <span class="work-base-salary">–ú–æ—Ç–∏–≤–∞—Ü–∏—è: ${fmt(service.baseSalary)} ‚ÇΩ</span>
      </div>
      <div class="executor-rows" id="${id}_rows">
        ${execRowsHtml}
      </div>
      <button class="add-executor-btn" onclick="addExecutorRow('${id}_rows', ${service.baseSalary})">
        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
      </button>
    </div>
  `;
}

function renderExecutorRow(id, executorId = '', salary = 0, manualName = '') {
  const isManual = !executorId && manualName;
  return `
    <div class="executor-row" id="${id}">
      <div class="executor-input-group">
        <div class="executor-mode-switcher">
          <button class="mode-btn ${!isManual ? 'active' : ''}" onclick="setExecutorMode('${id}', 'select')">üìã –ò–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞</button>
          <button class="mode-btn ${isManual ? 'active' : ''}" onclick="setExecutorMode('${id}', 'manual')">‚úèÔ∏è –í—Ä—É—á–Ω—É—é</button>
        </div>
        <div class="executor-fields-row">
          <div class="executor-select-wrap" style="display:${isManual ? 'none' : 'block'}">
            ${executorSelect(executorId)}
          </div>
          <div class="executor-manual-wrap" style="display:${isManual ? 'block' : 'none'}">
            <input type="text" class="manual-name-input" value="${manualName}" placeholder="–§–ò–û –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è">
          </div>
          <input type="number" value="${salary}" placeholder="–°—É–º–º–∞ ‚ÇΩ" step="1" class="salary-input">
          <button class="btn-remove-exec" onclick="removeExecutorRow('${id}')">‚úï</button>
        </div>
        <div class="executor-manual-save" style="display:${isManual ? 'flex' : 'none'}">
          <label class="save-to-list-label">
            <input type="checkbox" class="save-to-list" checked>
            <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫</span>
          </label>
        </div>
      </div>
    </div>
  `;
}

window.setExecutorMode = function(rowId, mode) {
  const row = document.getElementById(rowId);
  if (!row) return;
  const selectWrap = row.querySelector('.executor-select-wrap');
  const manualWrap = row.querySelector('.executor-manual-wrap');
  const manualSave = row.querySelector('.executor-manual-save');
  const btns = row.querySelectorAll('.mode-btn');

  if (mode === 'manual') {
    selectWrap.style.display = 'none';
    manualWrap.style.display = 'block';
    manualSave.style.display = 'flex';
    btns[0].classList.remove('active');
    btns[1].classList.add('active');
  } else {
    selectWrap.style.display = 'block';
    manualWrap.style.display = 'none';
    manualSave.style.display = 'none';
    btns[0].classList.add('active');
    btns[1].classList.remove('active');
  }
};

window.addExecutorRow = function(containerId, defaultSalary = 0) {
  const id = `exec_${Date.now()}`;
  const row = document.createElement('div');
  row.innerHTML = renderExecutorRow(id, '', defaultSalary);
  document.getElementById(containerId).appendChild(row.firstElementChild);
  updateSummary();
};

window.removeExecutorRow = function(rowId) {
  const el = document.getElementById(rowId);
  if (el) el.remove();
  updateSummary();
};

// Update summary
function updateSummary() {
  let total = 0;
  let count = 0;
  document.querySelectorAll('.executor-row').forEach(row => {
    const sal = parseFloat(row.querySelector('input[type="number"]')?.value) || 0;
    const exec = row.querySelector('select')?.value;
    if (exec || sal > 0) { total += sal; count++; }
  });

  document.getElementById('summaryCount').textContent = count;
  document.getElementById('summaryTotal').textContent = fmt(total) + ' ‚ÇΩ';
}

// Render main content
function renderContent(services, existingAssignments = []) {
  const carName = calculation.car_name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
  document.getElementById('carSubtitle').textContent = carName;

  let html = '';

  // Admin sale
  html += `
    <div class="admin-sale-block">
      <div class="admin-sale-row">
        <label class="toggle-switch">
          <input type="checkbox" id="isAdminSale" onchange="toggleAdminSale()">
          <span style="font-weight:600">üëî –ü—Ä–æ–¥–∞–∂—É —Å–¥–µ–ª–∞–ª –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
        </label>
        <div class="admin-details" id="adminDetails">
          <div class="form-group">
            <label>–†–µ–∂–∏–º</label>
            <div style="display:flex;gap:6px">
              <button class="mode-btn active" id="adminModeSelect" onclick="setAdminMode('select')">üìã –ò–∑ —Å–ø–∏—Å–∫–∞</button>
              <button class="mode-btn" id="adminModeManual" onclick="setAdminMode('manual')">‚úèÔ∏è –í—Ä—É—á–Ω—É—é</button>
            </div>
          </div>
          <div class="form-group" id="adminSelectWrap">
            <label>–ü—Ä–æ–¥–∞–≤–µ—Ü</label>
            ${adminExecutorSelect()}
          </div>
          <div class="form-group" id="adminManualWrap" style="display:none">
            <label>–§–ò–û –ø—Ä–æ–¥–∞–≤—Ü–∞</label>
            <input type="text" id="adminManualName" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" style="width:220px">
            <label class="save-to-list-label" style="margin-top:4px">
              <input type="checkbox" id="adminSaveToList" checked>
              <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫</span>
            </label>
          </div>
          <div class="form-group">
            <label>% –æ—Ç —á–µ–∫–∞</label>
            <input type="number" id="adminPercent" value="3" min="0" max="100" step="0.5" style="width:100px">
          </div>
          <div style="font-size:0.85rem;color:var(--text-muted);line-height:1.5">
            –ß–µ–∫: ${fmt(calculation.total_price)} ‚ÇΩ<br>
            <strong id="adminSalaryCalc" style="color:var(--warning)"></strong>
          </div>
        </div>
      </div>
    </div>
  `;

  // Services
  if (services.length > 0) {
    html += `
      <div class="card">
        <div class="card-title">üîß –£—Å–ª—É–≥–∏ –∏–∑ —Ä–∞—Å—á—ë—Ç–∞</div>
        <div class="work-list" id="workList">
          ${services.map(s => renderWorkItem(s, existingAssignments.filter(a => a.service_key === s.key))).join('')}
        </div>
      </div>
    `;
  } else {
    html += `
      <div class="card">
        <div class="card-title">üîß –£—Å–ª—É–≥–∏ –∏–∑ —Ä–∞—Å—á—ë—Ç–∞</div>
        <div style="padding:20px;color:var(--text-muted);text-align:center">
          –í —Ä–∞—Å—á—ë—Ç–µ –Ω–µ—Ç —É—Å–ª—É–≥ —Å –º–æ—Ç–∏–≤–∞—Ü–∏–µ–π. –î–æ–±–∞–≤—å—Ç–µ —É—Å–ª—É–≥–∏ –≤—Ä—É—á–Ω—É—é –Ω–∏–∂–µ.
        </div>
      </div>
    `;
  }

  // Manual work
  html += `
    <div class="card">
      <div class="card-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É –≤—Ä—É—á–Ω—É—é</div>
      <div class="add-work-row">
        <input type="text" id="manualServiceName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã (–Ω–∞–ø—Ä: –ú–æ–π–∫–∞, –ü–æ–ª–∏—Ä–æ–≤–∫–∞)">
        <input type="number" id="manualSalary" placeholder="–°—É–º–º–∞ ‚ÇΩ" min="0" step="1">
      </div>
      <button class="btn btn-secondary btn-sm" style="margin-top:12px" onclick="addManualWork()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  `;

  // Summary + Save
  html += `
    <div class="card">
      <div class="card-title">üìä –ò—Ç–æ–≥–æ –∫ –≤—ã–ø–ª–∞—Ç–µ</div>
      <div class="summary-block">
        <div class="summary-row">
          <span class="summary-label">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –Ω–∞–∑–Ω–∞—á–µ–Ω–æ</span>
          <span class="summary-value" id="summaryCount">0</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">üí∞ –ò—Ç–æ–≥–æ –ó–ü</span>
          <span class="summary-total-value" id="summaryTotal">0 ‚ÇΩ</span>
        </div>
      </div>
      <div style="display:flex;gap:12px;margin-top:20px;justify-content:flex-end;flex-wrap:wrap">
        <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'">‚Üê –û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-success" onclick="saveAssignments()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</button>
      </div>
    </div>
  `;

  document.getElementById('mainContent').innerHTML = html;

  // Listen for changes to update summary
  document.querySelectorAll('.executor-row input, .executor-row select').forEach(el => {
    el.addEventListener('change', updateSummary);
    el.addEventListener('input', updateSummary);
  });

  // Admin percent live calc
  document.getElementById('adminPercent')?.addEventListener('input', calcAdminSalary);
  calcAdminSalary();
  updateSummary();
}

window.toggleAdminSale = function() {
  const isChecked = document.getElementById('isAdminSale').checked;
  const details = document.getElementById('adminDetails');
  details.classList.toggle('active', isChecked);
  calcAdminSalary();
};

window.setAdminMode = function(mode) {
  const selectWrap = document.getElementById('adminSelectWrap');
  const manualWrap = document.getElementById('adminManualWrap');
  const btnSelect = document.getElementById('adminModeSelect');
  const btnManual = document.getElementById('adminModeManual');

  if (mode === 'manual') {
    selectWrap.style.display = 'none';
    manualWrap.style.display = 'block';
    btnSelect.classList.remove('active');
    btnManual.classList.add('active');
  } else {
    selectWrap.style.display = 'block';
    manualWrap.style.display = 'none';
    btnSelect.classList.add('active');
    btnManual.classList.remove('active');
  }
};

function calcAdminSalary() {
  const isChecked = document.getElementById('isAdminSale')?.checked;
  if (!isChecked) return;
  const pct = parseFloat(document.getElementById('adminPercent')?.value) || 0;
  const totalCheck = calculation?.total_price || 0;
  const adminSal = Math.round(totalCheck * pct / 100);
  const el = document.getElementById('adminSalaryCalc');
  if (el) el.textContent = `–ó–ü –ø—Ä–æ–¥–∞–≤—Ü–∞: ${fmt(adminSal)} ‚ÇΩ`;
}

// Add manual work
window.addManualWork = function() {
  const name = document.getElementById('manualServiceName').value.trim();
  const salary = parseFloat(document.getElementById('manualSalary').value) || 0;

  if (!name) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã'); return; }

  const service = { key: `manual_${Date.now()}`, name, baseSalary: salary };
  const item = document.createElement('div');
  item.innerHTML = renderWorkItem(service);

  const workList = document.getElementById('workList');
  if (!workList) {
    // –°–æ–∑–¥–∞—ë–º workList –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç (–Ω–µ—Ç —É—Å–ª—É–≥ –∏–∑ —Ä–∞—Å—á—ë—Ç–∞)
    const card = document.querySelector('.card');
    const div = document.createElement('div');
    div.className = 'work-list';
    div.id = 'workList';
    card.appendChild(div);
    div.appendChild(item.firstElementChild);
  } else {
    workList.appendChild(item.firstElementChild);
  }

  // Listen changes
  item.querySelectorAll('input, select').forEach(el => {
    el.addEventListener('change', updateSummary);
    el.addEventListener('input', updateSummary);
  });

  document.getElementById('manualServiceName').value = '';
  document.getElementById('manualSalary').value = '';
  updateSummary();
};

// Save
window.saveAssignments = async function() {
  const assignments = [];

  // Admin sale
  const isAdminSale = document.getElementById('isAdminSale')?.checked;
  if (isAdminSale) {
    const isManualMode = document.getElementById('adminManualWrap')?.style.display !== 'none';
    const pct = parseFloat(document.getElementById('adminPercent')?.value) || 0;
    const adminSal = Math.round((calculation.total_price || 0) * pct / 100);
    let adminExecId = null;
    let adminExecName = '';

    if (isManualMode) {
      adminExecName = document.getElementById('adminManualName')?.value?.trim();
      const saveToList = document.getElementById('adminSaveToList')?.checked;
      if (adminExecName && saveToList) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫
        const { data: savedAdmin } = await sb.from('executors').insert({
          studio_id: currentStudio.studio_id,
          full_name: adminExecName,
          role: 'universal',
          is_active: true,
          is_admin: true
        }).select().single();
        if (savedAdmin) { adminExecId = savedAdmin.id; executors.push(savedAdmin); }
      }
    } else {
      adminExecId = document.getElementById('adminExecutorId')?.value;
      const adminExec = executors.find(e => e.id === adminExecId);
      adminExecName = adminExec?.full_name || '';
    }

    if ((adminExecId || adminExecName) && adminSal > 0) {
      assignments.push({
        studio_id: currentStudio.studio_id,
        calculation_id: calcId,
        car_name: calculation.car_name,
        service_name: '–ü—Ä–æ–¥–∞–∂–∞ (% –æ—Ç —á–µ–∫–∞)',
        executor_id: adminExecId || null,
        executor_name: adminExecName,
        salary: adminSal,
        is_admin_sale: true,
        admin_percent: pct,
        status: 'pending',
        payment_month: new Date().toISOString().slice(0, 7)
      });
    }
  }

  // Work items
  const newExecutorsToSave = []; // –ù–æ–≤—ã–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –¥–ª—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞

  document.querySelectorAll('.work-item').forEach(item => {
    const serviceName = item.dataset.serviceName;

    item.querySelectorAll('.executor-row').forEach(row => {
      const isManualMode = row.querySelector('.executor-manual-wrap')?.style.display !== 'none';
      let execId = null;
      let execName = '';
      let saveToList = false;

      if (isManualMode) {
        execName = row.querySelector('.manual-name-input')?.value?.trim();
        saveToList = row.querySelector('.save-to-list')?.checked;
        if (!execName) return;
        if (saveToList) newExecutorsToSave.push(execName);
      } else {
        execId = row.querySelector('select')?.value;
        if (!execId) return;
        const exec = executors.find(e => e.id === execId);
        execName = exec?.full_name || '';
      }

      const salary = parseFloat(row.querySelector('.salary-input')?.value) || 0;
      if (salary <= 0) return;

      assignments.push({
        studio_id: currentStudio.studio_id,
        calculation_id: calcId,
        car_name: calculation.car_name,
        service_name: serviceName,
        executor_id: execId || null,
        executor_name: execName,
        salary,
        is_admin_sale: false,
        status: 'pending',
        payment_month: new Date().toISOString().slice(0, 7)
      });
    });
  });

  if (assignments.length === 0) {
    alert('‚ùå –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è —Å —Å—É–º–º–æ–π!');
    return;
  }

  try {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫
    if (newExecutorsToSave.length > 0) {
      const uniqueNames = [...new Set(newExecutorsToSave)];
      const newExecs = uniqueNames.map(name => ({
        studio_id: currentStudio.studio_id,
        full_name: name,
        role: 'universal',
        is_active: true,
        is_admin: false
      }));

      const { data: savedExecs, error: execError } = await sb
        .from('executors')
        .insert(newExecs)
        .select();

      if (!execError && savedExecs) {
        // –û–±–Ω–æ–≤–ª—è–µ–º executor_id –≤ assignments
        savedExecs.forEach(saved => {
          assignments.forEach(a => {
            if (a.executor_name === saved.full_name && !a.executor_id) {
              a.executor_id = saved.id;
            }
          });
        });
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫
        executors.push(...savedExecs);
      }
    }
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞
    await sb.from('work_assignments').delete().eq('calculation_id', calcId);

    // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
    const { error } = await sb.from('work_assignments').insert(assignments);

    if (error) {
      console.error('Save error:', error);
      alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
      return;
    }

    // –ü–æ–º–µ—á–∞–µ–º —Ä–∞—Å—á—ë—Ç –∫–∞–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π
    await sb.from('calculations').update({ work_assigned: true }).eq('id', calcId);

    alert(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ! –ù–∞–∑–Ω–∞—á–µ–Ω–æ ${assignments.length} –∑–∞–ø–∏—Å–µ–π.`);
    window.location.href = 'dashboard.html';

  } catch (e) {
    console.error('Error:', e);
    alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
  }
};

// Init
async function init() {
  initTheme();

  if (!await checkAuth()) return;
  if (!await getStudio()) return;

  // Get calc_id from URL
  const params = new URLSearchParams(window.location.search);
  calcId = params.get('calc_id');

  if (!calcId) {
    document.getElementById('mainContent').innerHTML = '<div class="loading">‚ùå –ù–µ —É–∫–∞–∑–∞–Ω ID —Ä–∞—Å—á—ë—Ç–∞</div>';
    return;
  }

  // Load calculation
  const { data: calcData, error: calcError } = await sb
    .from('calculations')
    .select('*')
    .eq('id', calcId)
    .single();

  if (calcError || !calcData) {
    document.getElementById('mainContent').innerHTML = '<div class="loading">‚ùå –†–∞—Å—á—ë—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
    return;
  }

  calculation = calcData;

  // Load executors
  await loadExecutors();

  // Load existing assignments (–µ—Å–ª–∏ —É–∂–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–ª–∏)
  const { data: existingData } = await sb
    .from('work_assignments')
    .select('*')
    .eq('calculation_id', calcId);

  // Extract services
  const services = extractServices(calcData.calculation_data || {});

  // Render
  renderContent(services, existingData || []);
}

init();

})();
</script>
</body>
</html>
