<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ĞĞºÑ‚ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ĞºĞ¸ â€” Keep1R CRM</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="nav.css">
<script src="nav.js"></script>

<style>
/* â”€â”€ Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
* { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --font: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
  --bg: #eef2f9;
  --card: #fff;
  --border: rgba(15,23,42,0.10);
  --text: #0f172a;
  --muted: #64748b;
  --primary: #2563eb;
  --success: #059669;
  --danger: #dc2626;
  --radius: 12px;
}
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  min-height: 100svh;
  -webkit-font-smoothing: antialiased;
}
.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 24px 20px 60px;
}

/* â”€â”€ Page header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 12px;
}
.page-title {
  font-size: 1.3rem;
  font-weight: 800;
  color: var(--text);
  letter-spacing: -0.3px;
}
.page-sub {
  font-size: 0.8rem;
  color: var(--muted);
  margin-top: 2px;
}
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 9px 18px; border-radius: 9px; border: none;
  font-size: 0.85rem; font-weight: 700; cursor: pointer;
  font-family: var(--font); transition: all 0.15s;
}
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: #1d4ed8; }
.btn-secondary { background: #f1f5f9; color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover { background: #e2e8f0; }
.btn-success { background: var(--success); color: #fff; }
.btn-success:hover { background: #047857; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

/* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: var(--card);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  box-shadow: 0 1px 4px rgba(0,0,0,0.06);
  margin-bottom: 16px;
  overflow: hidden;
}
.card-head {
  padding: 14px 18px 10px;
  border-bottom: 1px solid var(--border);
  font-size: 0.82rem;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--muted);
}
.card-body { padding: 16px 18px; }

/* â”€â”€ Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
  margin-bottom: 12px;
}
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-group label {
  font-size: 0.74rem; font-weight: 700; color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.04em;
}
.form-group input, .form-group textarea, .form-group select {
  padding: 9px 12px;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  font-size: 0.88rem;
  font-family: var(--font);
  color: var(--text);
  background: #f8fafc;
  transition: border-color 0.15s;
  width: 100%;
}
.form-group input:focus, .form-group textarea:focus {
  outline: none;
  border-color: var(--primary);
  background: #fff;
}
.form-group textarea { resize: vertical; min-height: 68px; }

/* â”€â”€ Checkboxes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.check-list { display: flex; flex-direction: column; gap: 8px; }
.check-item {
  display: flex; align-items: flex-start; gap: 10px;
  padding: 10px 14px;
  border-radius: 8px;
  border: 1.5px solid var(--border);
  background: #f8fafc;
  cursor: pointer;
  transition: border-color 0.15s, background 0.15s;
}
.check-item:has(input:checked) {
  border-color: var(--primary);
  background: rgba(37,99,235,0.04);
}
.check-item input[type=checkbox] {
  margin-top: 1px; flex-shrink: 0;
  width: 16px; height: 16px; accent-color: var(--primary);
  cursor: pointer;
}
.check-item-text { font-size: 0.86rem; line-height: 1.45; }
.check-item-text strong { display: block; font-weight: 700; margin-bottom: 1px; }
.check-item-text span { color: var(--muted); font-size: 0.79rem; }

/* â”€â”€ Car diagram â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.diagram-wrap {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 12px;
  background: #f8fafc;
  border-radius: 10px;
  border: 1.5px solid var(--border);
  min-height: 280px;
  cursor: crosshair;
  user-select: none;
}
.diagram-wrap svg {
  max-width: 100%;
  height: auto;
  pointer-events: none;
}
.diagram-hint {
  text-align: center;
  font-size: 0.75rem;
  color: var(--muted);
  margin-top: 8px;
  font-weight: 600;
}

/* Defect markers */
.defect-marker {
  position: absolute;
  width: 24px; height: 24px;
  border-radius: 50%;
  background: var(--danger);
  color: #fff;
  font-size: 0.65rem;
  font-weight: 900;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  border: 2px solid #fff;
  box-shadow: 0 2px 8px rgba(220,38,38,0.4);
  transform: translate(-50%, -50%);
  transition: transform 0.15s;
  z-index: 10;
  font-family: var(--font);
}
.defect-marker:hover { transform: translate(-50%,-50%) scale(1.2); }
.defect-marker.selected { background: var(--primary); box-shadow: 0 2px 8px rgba(37,99,235,0.4); }

/* Defect legend */
.defect-legend {
  margin-top: 12px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.defect-legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.82rem;
}
.defect-legend-num {
  width: 22px; height: 22px; border-radius: 50%;
  background: var(--danger); color: #fff;
  font-size: 0.65rem; font-weight: 900;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.defect-legend-input {
  flex: 1;
  padding: 5px 10px;
  border: 1.5px solid var(--border);
  border-radius: 6px;
  font-size: 0.82rem;
  font-family: var(--font);
  background: #f8fafc;
}
.defect-legend-input:focus { outline: none; border-color: var(--primary); background: #fff; }
.defect-del {
  background: none; border: none; cursor: pointer;
  color: var(--danger); font-size: 1rem; padding: 2px 4px; line-height: 1;
}
.diagram-controls {
  display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;
}

/* â”€â”€ Services table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.services-table {
  width: 100%; border-collapse: collapse;
  font-size: 0.85rem;
}
.services-table th {
  text-align: left;
  padding: 7px 10px;
  font-size: 0.72rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--muted);
  border-bottom: 1.5px solid var(--border);
}
.services-table td {
  padding: 9px 10px;
  border-bottom: 1px solid var(--border);
  vertical-align: top;
}
.services-table tr:last-child td { border-bottom: none; }
.services-table .total-row td {
  font-weight: 800;
  padding-top: 11px;
  border-top: 2px solid var(--border);
  border-bottom: none;
}
.price-cell { text-align: right; white-space: nowrap; font-weight: 700; }

/* â”€â”€ Signature block â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sign-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  margin-top: 4px;
}
.sign-block { display: flex; flex-direction: column; gap: 10px; }
.sign-label { font-size: 0.75rem; color: var(--muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; }
.sign-line {
  border-bottom: 1.5px solid #94a3b8;
  height: 40px;
  position: relative;
}
.sign-caption {
  font-size: 0.73rem;
  color: var(--muted);
  text-align: center;
}

/* â”€â”€ Print â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media print {
  * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  body { background: #fff !important; }
  #navTopBar, .no-print, .page-header .btn-group { display: none !important; }
  .container { padding: 0 !important; max-width: 100% !important; }
  .card { box-shadow: none !important; break-inside: avoid; }
  .page-title { font-size: 1.1rem; }
  .diagram-wrap { border: 1px solid #cbd5e1 !important; }
  .defect-marker {
    position: absolute;
    width: 20px; height: 20px;
    font-size: 0.6rem;
  }
  .check-item { border: 1px solid #cbd5e1 !important; background: #f8fafc !important; }
  .check-item:has(input:checked) { border: 1.5px solid #2563eb !important; background: #eff6ff !important; }
  .form-group input, .form-group textarea {
    border: 1px solid #cbd5e1 !important;
    background: #fff !important;
  }

  /* Print header with studio info */
  #printStudioHeader { display: flex !important; }
}

/* Studio header (print only) */
#printStudioHeader {
  display: none;
  align-items: center;
  justify-content: space-between;
  padding-bottom: 14px;
  border-bottom: 2px solid #0f172a;
  margin-bottom: 18px;
}
#printStudioHeader .studio-logo {
  max-height: 48px;
  max-width: 120px;
  object-fit: contain;
}
#printStudioHeader .studio-name-block {
  text-align: right;
  font-size: 0.78rem;
  line-height: 1.6;
  color: #475569;
}
#printStudioHeader .studio-name-main {
  font-size: 1rem;
  font-weight: 800;
  color: #0f172a;
}

/* â”€â”€ Loading / error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#loadingMsg { text-align: center; padding: 60px 20px; color: var(--muted); font-size: 0.9rem; }
#errorMsg { display: none; text-align: center; padding: 40px 20px; color: var(--danger); }
</style>
</head>
<body>

<div id="navTopBar">
  <a href="board.html" class="nav-brand">Keep1R CRM</a>
  <div class="nav-links">
    <a href="board.html" class="nav-link">â† Ğ”Ğ¾ÑĞºĞ°</a>
    <span class="nav-link active">ğŸ“‹ ĞĞºÑ‚ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ĞºĞ¸</span>
  </div>
  <div class="nav-right"></div>
</div>

<div class="container">

  <!-- Print studio header -->
  <div id="printStudioHeader">
    <img id="psh-logo" src="" alt="" style="display:none" class="studio-logo">
    <div id="psh-title" style="font-size:1.3rem;font-weight:900;letter-spacing:-0.5px">ĞĞšĞ¢ ĞŸĞ Ğ˜ĞĞœĞšĞ˜ ĞĞ’Ğ¢ĞĞœĞĞ‘Ğ˜Ğ›Ğ¯</div>
    <div class="studio-name-block">
      <div class="studio-name-main" id="psh-name"></div>
      <div id="psh-phone"></div>
      <div id="psh-address"></div>
      <div id="psh-site"></div>
    </div>
  </div>

  <div id="loadingMsg">â³ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµâ€¦</div>
  <div id="errorMsg">âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚. <a href="board.html">â† Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğ½Ğ° Ğ´Ğ¾ÑĞºÑƒ</a></div>

  <div id="mainContent" style="display:none">

    <!-- Page header -->
    <div class="page-header no-print">
      <div>
        <div class="page-title">ğŸ“‹ ĞĞºÑ‚ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ĞºĞ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ñ</div>
        <div class="page-sub" id="headerSub">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦</div>
      </div>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="history.back()">â† ĞĞ°Ğ·Ğ°Ğ´</button>
        <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ Ğ Ğ°ÑĞ¿ĞµÑ‡Ğ°Ñ‚Ğ°Ñ‚ÑŒ</button>
      </div>
    </div>

    <!-- â‘  Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ¸ Ğ°Ğ²Ñ‚Ğ¾ -->
    <div class="card">
      <div class="card-head">ğŸš— Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ñ</div>
      <div class="card-body">
        <div class="form-row">
          <div class="form-group">
            <label>Ğ¤Ğ˜Ğ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°</label>
            <input type="text" id="clientName" placeholder="Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ² Ğ˜Ğ²Ğ°Ğ½ Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‡">
          </div>
          <div class="form-group">
            <label>Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</label>
            <input type="tel" id="clientPhone" placeholder="+7 000 000 00 00">
          </div>
          <div class="form-group">
            <label>Ğ”Ğ°Ñ‚Ğ° Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ĞºĞ¸</label>
            <input type="date" id="intakeDate">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>ĞœĞ°Ñ€ĞºĞ° Ğ¸ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ</label>
            <input type="text" id="carName" placeholder="Toyota Camry 2024" readonly>
          </div>
          <div class="form-group">
            <label>Ğ“Ğ¾Ñ. Ğ½Ğ¾Ğ¼ĞµÑ€</label>
            <input type="text" id="carPlate" placeholder="Ğ 000 ĞĞ 000" style="text-transform:uppercase">
          </div>
          <div class="form-group">
            <label>VIN / â„– ĞºÑƒĞ·Ğ¾Ğ²Ğ°</label>
            <input type="text" id="carVin" placeholder="WBAXXXXXXXXXXXXX" style="text-transform:uppercase;font-size:0.8rem">
          </div>
          <div class="form-group">
            <label>ĞŸÑ€Ğ¾Ğ±ĞµĞ³, ĞºĞ¼</label>
            <input type="number" id="carMileage" placeholder="45 000">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Ğ¦Ğ²ĞµÑ‚</label>
            <input type="text" id="carColor" placeholder="Ğ‘ĞµĞ»Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ»Ğ°Ğ¼ÑƒÑ‚Ñ€">
          </div>
          <div class="form-group">
            <label>ĞšĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ (ĞºĞ»ÑÑ‡Ğ¸, ĞºĞ¾Ğ²Ñ€Ğ¸ĞºĞ¸â€¦)</label>
            <input type="text" id="carItems" placeholder="2 ĞºĞ»ÑÑ‡Ğ°, ÑĞµÑ€Ğ²Ğ¸ÑĞ½Ğ°Ñ ĞºĞ½Ğ¸Ğ¶ĞºĞ°">
          </div>
        </div>
      </div>
    </div>

    <!-- â‘¡ Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ°Ğ²Ñ‚Ğ¾ â€” Ñ‡ĞµĞºĞ±Ğ¾ĞºÑÑ‹ -->
    <div class="card">
      <div class="card-head">ğŸ“ Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ĞºĞµ</div>
      <div class="card-body">
        <div class="check-list">
          <label class="check-item">
            <input type="checkbox" id="chkDirty">
            <div class="check-item-text">
              <strong>ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ Ğ·Ğ°Ğ³Ñ€ÑĞ·Ğ½Ñ‘Ğ½</strong>
              <span>Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ½ĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶ĞµĞ½ Ğ±ĞµĞ· Ğ¼Ğ¾Ğ¹ĞºĞ¸. Ğ”ĞµÑ„ĞµĞºÑ‚Ñ‹ Ğ›ĞšĞŸ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ±Ñ‹Ñ‚ÑŒ ÑĞºÑ€Ñ‹Ñ‚Ñ‹ Ğ¿Ğ¾Ğ´ Ğ³Ñ€ÑĞ·ÑŒÑ.</span>
            </div>
          </label>
          <label class="check-item">
            <input type="checkbox" id="chkWashFirst">
            <div class="check-item-text">
              <strong>Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¼Ğ¾Ğ¹ĞºĞ° Ğ¿ĞµÑ€ĞµĞ´ Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¾Ğ¼</strong>
              <span>ĞšĞ»Ğ¸ĞµĞ½Ñ‚ ÑĞ¾Ğ³Ğ»Ğ°ÑĞµĞ½, Ñ‡Ñ‚Ğ¾ Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´ĞµÑ„ĞµĞºÑ‚Ğ¾Ğ² Ğ±ÑƒĞ´ĞµÑ‚ ÑƒÑ‚Ğ¾Ñ‡Ğ½Ñ‘Ğ½ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¼Ğ¾Ğ¹ĞºĞ¸.</span>
            </div>
          </label>
          <label class="check-item">
            <input type="checkbox" id="chkScratchesExist">
            <div class="check-item-text">
              <strong>Ğ˜Ğ¼ĞµÑÑ‚ÑÑ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ñ†Ğ°Ñ€Ğ°Ğ¿Ğ¸Ğ½Ñ‹ / ÑĞºĞ¾Ğ»Ñ‹ / Ğ¿Ğ¾Ğ²Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ</strong>
              <span>Ğ”ĞµÑ„ĞµĞºÑ‚Ñ‹ Ğ·Ğ°Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ½Ğ° ÑÑ…ĞµĞ¼Ğµ Ğ½Ğ¸Ğ¶Ğµ.</span>
            </div>
          </label>
          <label class="check-item">
            <input type="checkbox" id="chkClientAware">
            <div class="check-item-text">
              <strong>ĞšĞ»Ğ¸ĞµĞ½Ñ‚ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»Ñ‘Ğ½ Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ñ</strong>
              <span>Ğ’ÑĞµ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ´ĞµÑ„ĞµĞºÑ‚Ñ‹ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¾Ğ²Ğ°Ğ½Ñ‹ Ğ´Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚. Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ Ğ½Ğµ Ğ½ĞµÑÑ‘Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ·Ğ° Ñ€Ğ°Ğ½ĞµĞµ Ğ¸Ğ¼ĞµĞ²ÑˆĞ¸ĞµÑÑ Ğ¿Ğ¾Ğ²Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ.</span>
            </div>
          </label>
          <label class="check-item">
            <input type="checkbox" id="chkPhotosAttached">
            <div class="check-item-text">
              <strong>Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ° Ñ„Ğ¾Ñ‚Ğ¾Ñ„Ğ¸ĞºÑĞ°Ñ†Ğ¸Ñ</strong>
              <span>Ğ¤Ğ¾Ñ‚Ğ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ñ Ğ´Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ñ‹ / ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹ Ğ² ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞµ.</span>
            </div>
          </label>
        </div>
        <div class="form-group" style="margin-top:12px">
          <label>Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ·Ğ°Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ñ</label>
          <textarea id="intakeNotes" placeholder="ĞÑĞ¾Ğ±Ñ‹Ğµ Ğ¿Ğ¾Ğ¶ĞµĞ»Ğ°Ğ½Ğ¸Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°, Ğ·Ğ°Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ, Ğ¸Ğ½Ñ‹Ğµ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ñ‘Ğ½Ğ½Ğ¾ÑÑ‚Ğ¸â€¦"></textarea>
        </div>
      </div>
    </div>

    <!-- â‘¢ Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´ĞµÑ„ĞµĞºÑ‚Ğ¾Ğ² -->
    <div class="card">
      <div class="card-head">ğŸ—ºï¸ Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´ĞµÑ„ĞµĞºÑ‚Ğ¾Ğ² (ĞºĞ»Ğ¸ĞºĞ½Ğ¸Ñ‚Ğµ Ğ¿Ğ¾ Ğ°Ğ²Ñ‚Ğ¾ â€” Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¼ĞµÑ‚ĞºÑƒ)</div>
      <div class="card-body">
        <div class="diagram-controls no-print">
          <button class="btn btn-secondary" onclick="clearDefects()" style="font-size:0.78rem;padding:6px 12px">ğŸ—‘ï¸ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ¼ĞµÑ‚ĞºĞ¸</button>
          <span style="font-size:0.78rem;color:var(--muted);align-self:center">ĞšĞ»Ğ¸ĞºĞ½Ğ¸Ñ‚Ğµ Ğ½Ğ° ÑÑ…ĞµĞ¼Ñƒ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ´ĞµÑ„ĞµĞºÑ‚. ĞšĞ»Ğ¸ĞºĞ½Ğ¸Ñ‚Ğµ Ğ¿Ğ¾ Ğ¼ĞµÑ‚ĞºĞµ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ.</span>
        </div>

        <!-- Car diagram: top-down SVG -->
        <div class="diagram-wrap" id="diagramWrap" onclick="addDefect(event)">
          <svg id="carSvg" viewBox="0 0 400 700" width="300" height="525" xmlns="http://www.w3.org/2000/svg">
            <!-- Body shadow -->
            <ellipse cx="200" cy="350" rx="115" ry="295" fill="#e2e8f0"/>

            <!-- Main body -->
            <path d="
              M130,120
              Q130,60 200,50
              Q270,60 270,120
              L278,250
              Q285,280 285,350
              L285,500
              Q280,580 260,610
              Q240,640 200,645
              Q160,640 140,610
              Q120,580 115,500
              L115,350
              Q115,280 122,250
              Z"
              fill="#cbd5e1" stroke="#94a3b8" stroke-width="2"/>

            <!-- Windshield front -->
            <path d="M148,130 Q148,90 200,85 Q252,90 252,130 L248,200 Q200,190 152,200 Z"
              fill="#93c5fd" stroke="#64748b" stroke-width="1.5" opacity="0.7"/>

            <!-- Windshield rear -->
            <path d="M148,490 L152,560 Q200,575 248,560 L252,490 Q200,480 148,490 Z"
              fill="#93c5fd" stroke="#64748b" stroke-width="1.5" opacity="0.7"/>

            <!-- Hood lines -->
            <path d="M165,130 L165,210 M235,130 L235,210" stroke="#94a3b8" stroke-width="1" fill="none"/>

            <!-- Trunk lines -->
            <path d="M165,490 L165,575 M235,490 L235,575" stroke="#94a3b8" stroke-width="1" fill="none"/>

            <!-- Doors outline -->
            <path d="M118,240 L118,470 M282,240 L282,470" stroke="#94a3b8" stroke-width="1.5" fill="none"/>
            <path d="M120,355 L280,355" stroke="#94a3b8" stroke-width="1" fill="none" stroke-dasharray="4,3"/>

            <!-- Left mirror -->
            <ellipse cx="108" cy="220" rx="16" ry="10" fill="#94a3b8" stroke="#64748b" stroke-width="1.5"/>

            <!-- Right mirror -->
            <ellipse cx="292" cy="220" rx="16" ry="10" fill="#94a3b8" stroke="#64748b" stroke-width="1.5"/>

            <!-- Front bumper -->
            <path d="M145,70 Q200,55 255,70 L255,95 Q200,80 145,95 Z"
              fill="#94a3b8" stroke="#64748b" stroke-width="1.5"/>

            <!-- Headlights -->
            <path d="M148,72 Q155,62 175,65 L175,85 Q158,88 148,80 Z" fill="#fde68a" stroke="#64748b" stroke-width="1"/>
            <path d="M252,72 Q245,62 225,65 L225,85 Q242,88 252,80 Z" fill="#fde68a" stroke="#64748b" stroke-width="1"/>

            <!-- Rear bumper -->
            <path d="M145,625 Q200,640 255,625 L255,610 Q200,625 145,610 Z"
              fill="#94a3b8" stroke="#64748b" stroke-width="1.5"/>

            <!-- Taillights -->
            <path d="M148,623 Q155,633 175,630 L175,610 Q158,607 148,615 Z" fill="#fca5a5" stroke="#64748b" stroke-width="1"/>
            <path d="M252,623 Q245,633 225,630 L225,610 Q242,607 252,615 Z" fill="#fca5a5" stroke="#64748b" stroke-width="1"/>

            <!-- Wheels -->
            <ellipse cx="128" cy="200" rx="24" ry="32" fill="#475569" stroke="#334155" stroke-width="1.5"/>
            <ellipse cx="128" cy="200" rx="14" ry="20" fill="#64748b"/>
            <ellipse cx="272" cy="200" rx="24" ry="32" fill="#475569" stroke="#334155" stroke-width="1.5"/>
            <ellipse cx="272" cy="200" rx="14" ry="20" fill="#64748b"/>

            <ellipse cx="128" cy="500" rx="24" ry="32" fill="#475569" stroke="#334155" stroke-width="1.5"/>
            <ellipse cx="128" cy="500" rx="14" ry="20" fill="#64748b"/>
            <ellipse cx="272" cy="500" rx="24" ry="32" fill="#475569" stroke="#334155" stroke-width="1.5"/>
            <ellipse cx="272" cy="500" rx="14" ry="20" fill="#64748b"/>

            <!-- Labels -->
            <text x="200" y="165" text-anchor="middle" font-size="11" fill="#64748b" font-family="Arial">ĞŸĞµÑ€Ñ‘Ğ´</text>
            <text x="200" y="540" text-anchor="middle" font-size="11" fill="#64748b" font-family="Arial">Ğ—Ğ°Ğ´</text>
            <text x="88" y="355" text-anchor="middle" font-size="10" fill="#64748b" font-family="Arial" transform="rotate(-90,88,355)">Ğ›ĞµĞ²Ğ¾</text>
            <text x="312" y="355" text-anchor="middle" font-size="10" fill="#64748b" font-family="Arial" transform="rotate(90,312,355)">ĞŸÑ€Ğ°Ğ²Ğ¾</text>
          </svg>
        </div>

        <div class="diagram-hint no-print">â†‘ ĞšĞ»Ğ¸ĞºĞ½Ğ¸Ñ‚Ğµ Ğ¿Ğ¾ ÑÑ…ĞµĞ¼Ğµ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ´ĞµÑ„ĞµĞºÑ‚. ĞšĞ»Ğ¸ĞºĞ½Ğ¸Ñ‚Ğµ Ğ¿Ğ¾ ĞºÑ€Ğ°ÑĞ½Ğ¾Ğ¹ Ğ¼ĞµÑ‚ĞºĞµ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ.</div>

        <!-- Defect legend -->
        <div class="defect-legend" id="defectLegend" style="margin-top:14px;display:none">
          <div style="font-size:0.74rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--muted);margin-bottom:4px">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ´ĞµÑ„ĞµĞºÑ‚Ğ¾Ğ²:</div>
          <div id="defectList"></div>
        </div>
        <div id="noDefectsMsg" style="margin-top:10px;font-size:0.82rem;color:var(--muted);font-style:italic">Ğ”ĞµÑ„ĞµĞºÑ‚Ğ¾Ğ² Ğ½Ğµ Ğ¾Ñ‚Ğ¼ĞµÑ‡ĞµĞ½Ğ¾</div>
      </div>
    </div>

    <!-- â‘£ ĞŸĞµÑ€ĞµÑ‡ĞµĞ½ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚ -->
    <div class="card">
      <div class="card-head">ğŸ”§ ĞŸĞµÑ€ĞµÑ‡ĞµĞ½ÑŒ Ğ·Ğ°Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ€Ğ°Ğ±Ğ¾Ñ‚</div>
      <div class="card-body">
        <table class="services-table">
          <thead>
            <tr>
              <th>â„–</th>
              <th>Ğ£ÑĞ»ÑƒĞ³Ğ°</th>
              <th class="price-cell">Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ</th>
            </tr>
          </thead>
          <tbody id="servicesTbody">
            <tr><td colspan="3" style="color:var(--muted);font-style:italic;padding:12px 10px">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- â‘¤ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ¸ -->
    <div class="card">
      <div class="card-head">âœï¸ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ¸ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½</div>
      <div class="card-body">
        <div class="sign-row">
          <div class="sign-block">
            <div class="sign-label">ĞšĞ»Ğ¸ĞµĞ½Ñ‚</div>
            <div style="font-size:0.84rem;color:var(--muted);margin-bottom:6px" id="signClientName">Ğ¤Ğ˜Ğ: ______________________</div>
            <div class="sign-line"></div>
            <div class="sign-caption">ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑŒ / Ğ´Ğ°Ñ‚Ğ°</div>
          </div>
          <div class="sign-block">
            <div class="sign-label">ĞŸÑ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸</div>
            <div style="font-size:0.84rem;color:var(--muted);margin-bottom:6px" id="signStudioName">______________________</div>
            <div class="sign-line"></div>
            <div class="sign-caption">ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑŒ / Ğ´Ğ°Ñ‚Ğ°</div>
          </div>
        </div>
        <div style="margin-top:18px;padding:12px 14px;background:#fef9c3;border-radius:8px;border:1px solid #fde68a;font-size:0.8rem;color:#78350f;line-height:1.5">
          ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°Ñ Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰Ğ¸Ğ¹ Ğ°ĞºÑ‚, ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°ĞµÑ‚: Ğ¢Ğ¡ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½Ğ¾ Ğ² Ğ´ĞµÑ‚ĞµĞ¹Ğ»Ğ¸Ğ½Ğ³-ÑÑ‚ÑƒĞ´Ğ¸Ñ Ğ² ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸, Ğ²ÑĞµ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ´ĞµÑ„ĞµĞºÑ‚Ñ‹ Ğ·Ğ°Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹. Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ Ğ½Ğµ Ğ½ĞµÑÑ‘Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ·Ğ° Ğ´ĞµÑ„ĞµĞºÑ‚Ñ‹, ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ²ÑˆĞ¸Ğµ Ğ´Ğ¾ Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ĞºĞ¸.
        </div>
      </div>
    </div>

  </div><!-- /mainContent -->
</div><!-- /container -->

<script src="footer.js"></script>
<script>
(function() {
'use strict';

const SUPABASE_URL      = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser  = null;
let calcId       = null;
let defects      = [];   // [{id, x%, y%, desc}]

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'welcome.html'; return false; }
  currentUser = session.user;
  return true;
}

// â”€â”€ Format â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n) {
  return new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n || 0);
}

// â”€â”€ Load studio settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStudio() {
  const { data: member } = await sb.from('studio_members')
    .select('studio_id').eq('user_id', currentUser.id).eq('is_active', true).single();
  if (!member) return {};

  const { data: studio } = await sb.from('studios')
    .select('name, settings').eq('id', member.studio_id).single();
  if (!studio) return {};

  const cfg = studio.settings || {};
  // Populate print header
  document.getElementById('psh-name').textContent   = studio.name || '';
  document.getElementById('psh-phone').textContent  = cfg.phone || cfg.kp_phone || '';
  document.getElementById('psh-address').textContent = [cfg.city, cfg.address].filter(Boolean).join(', ');
  document.getElementById('psh-site').textContent   = cfg.website || cfg.kp_website || '';
  document.getElementById('signStudioName').textContent = studio.name || '______________________';

  if (cfg.kp_logo) {
    const img = document.getElementById('psh-logo');
    img.src = cfg.kp_logo;
    img.style.display = 'block';
  }

  return { studioName: studio.name, cfg };
}

// â”€â”€ Build services list from calculation_data â”€â”€â”€â”€â”€â”€â”€
function buildServicesList(calcData) {
  const services = [];
  const cd = calcData || {};

  const sections = [
    { key: 'pkg',       label: 'ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ²ĞºÑ€ÑƒĞ³',    priceKey: 'pkgTotal' },
    { key: 'impact',    label: 'Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° ÑƒĞ´Ğ°Ñ€Ğ½Ğ¾Ğ¹ Ñ‡Ğ°ÑÑ‚Ğ¸',   priceKey: 'impactTotal' },
    { key: 'arm',       label: 'ĞÑ€Ğ¼Ğ°Ñ‚ÑƒÑ€ĞºĞ°',              priceKey: 'armTotal' },
    { key: 'wrap',      label: 'ĞĞºĞ»ĞµĞ¹ĞºĞ° Ğ¿Ğ»Ñ‘Ğ½ĞºĞ¾Ğ¹',        priceKey: 'wrapTotal' },
    { key: 'det',       label: 'Ğ”ĞµÑ‚ĞµĞ¹Ğ»Ğ¸Ğ½Ğ³',              priceKey: 'detTotal' },
    { key: 'gl',        label: 'ĞĞ½Ñ‚Ğ¸Ğ³Ñ€Ğ°Ğ²Ğ¸Ğ¹Ğ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°',   priceKey: 'glTotal' },
    { key: 'misc',      label: 'ĞŸÑ€Ğ¾Ñ‡Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹',          priceKey: 'miscTotal' },
  ];

  sections.forEach(s => {
    const total = parseFloat(cd[s.priceKey] || 0);
    if (total > 0) services.push({ name: s.label, price: total });
  });

  // Miscellaneous custom items
  if (cd.miscItems && Array.isArray(cd.miscItems)) {
    cd.miscItems.forEach(item => {
      if (item.name && item.price > 0) {
        services.push({ name: item.name, price: parseFloat(item.price) });
      }
    });
  }

  return services;
}

// â”€â”€ Render services table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderServices(calc) {
  const cd = calc.calculation_data || {};
  let services = buildServicesList(cd);

  // Fallback: if no breakdown, just show total
  if (services.length === 0 && calc.total_price) {
    services = [{ name: calc.car_name || 'Ğ Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ğ¿Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ñ', price: calc.total_price }];
  }

  const tbody = document.getElementById('servicesTbody');
  if (services.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" style="color:var(--muted);font-style:italic;padding:12px 10px">ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾ ÑƒÑĞ»ÑƒĞ³Ğ°Ğ¼</td></tr>';
    return;
  }

  const total = services.reduce((s, x) => s + x.price, 0);
  tbody.innerHTML = services.map((s, i) => `
    <tr>
      <td style="color:var(--muted);font-size:0.8rem">${i+1}</td>
      <td>${s.name}</td>
      <td class="price-cell">${fmt(s.price)} â‚½</td>
    </tr>
  `).join('') + `
    <tr class="total-row">
      <td></td>
      <td style="font-weight:800">Ğ˜Ğ¢ĞĞ“Ğ</td>
      <td class="price-cell">${fmt(total)} â‚½</td>
    </tr>
  `;
}

// â”€â”€ Defect markers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addDefect = function(e) {
  const wrap = document.getElementById('diagramWrap');
  if (e.target.closest('.defect-marker')) return; // clicked on marker
  if (e.target.closest('.diagram-controls')) return;

  const rect = wrap.getBoundingClientRect();
  const xPct = ((e.clientX - rect.left) / rect.width * 100).toFixed(1);
  const yPct = ((e.clientY - rect.top) / rect.height * 100).toFixed(1);
  const id   = Date.now();

  defects.push({ id, xPct, yPct, desc: '' });
  renderDefects();
};

window.deleteDefect = function(id) {
  defects = defects.filter(d => d.id !== id);
  renderDefects();
};

window.clearDefects = function() {
  defects = [];
  renderDefects();
};

function renderDefects() {
  const wrap = document.getElementById('diagramWrap');
  // Remove existing markers
  wrap.querySelectorAll('.defect-marker').forEach(el => el.remove());

  // Add markers
  defects.forEach((d, idx) => {
    const el = document.createElement('div');
    el.className = 'defect-marker';
    el.textContent = idx + 1;
    el.style.left = d.xPct + '%';
    el.style.top  = d.yPct + '%';
    el.title = 'ĞšĞ»Ğ¸ĞºĞ½Ğ¸Ñ‚Ğµ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ';
    el.onclick = (e) => { e.stopPropagation(); deleteDefect(d.id); };
    wrap.appendChild(el);
  });

  // Legend
  const legend   = document.getElementById('defectLegend');
  const listEl   = document.getElementById('defectList');
  const noMsg    = document.getElementById('noDefectsMsg');
  const chkBox   = document.getElementById('chkScratchesExist');

  if (defects.length === 0) {
    legend.style.display = 'none';
    noMsg.style.display  = '';
    if (chkBox) chkBox.checked = false;
  } else {
    legend.style.display = '';
    noMsg.style.display  = 'none';
    if (chkBox) chkBox.checked = true;

    listEl.innerHTML = defects.map((d, idx) => `
      <div class="defect-legend-item">
        <div class="defect-legend-num">${idx+1}</div>
        <input class="defect-legend-input" type="text" value="${d.desc}"
          placeholder="ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ´ĞµÑ„ĞµĞºÑ‚Ğ° â„–${idx+1} (Ñ†Ğ°Ñ€Ğ°Ğ¿Ğ¸Ğ½Ğ°, ÑĞºĞ¾Ğ», Ğ²Ğ¼ÑÑ‚Ğ¸Ğ½Ğ°â€¦)"
          oninput="defects[${idx}].desc=this.value"
        >
        <button class="defect-del no-print" onclick="deleteDefect(${d.id})" title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ">âœ•</button>
      </div>
    `).join('');
  }
}

// â”€â”€ Set today's date â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setToday() {
  const today = new Date().toISOString().slice(0, 10);
  document.getElementById('intakeDate').value = today;
}

// â”€â”€ Update signature line â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('clientName').addEventListener('input', function() {
  const v = this.value.trim();
  document.getElementById('signClientName').textContent = v ? 'Ğ¤Ğ˜Ğ: ' + v : 'Ğ¤Ğ˜Ğ: ______________________';
});

// â”€â”€ Main init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function init() {
  const ok = await checkAuth();
  if (!ok) return;

  const params = new URLSearchParams(window.location.search);
  calcId = params.get('calc_id');

  const loading = document.getElementById('loadingMsg');
  const errMsg  = document.getElementById('errorMsg');
  const content = document.getElementById('mainContent');

  if (!calcId) {
    loading.style.display = 'none';
    errMsg.style.display  = '';
    errMsg.textContent    = 'âŒ ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½ ID Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ°. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ°ĞºÑ‚ ÑĞ¾ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ´Ğ¾ÑĞºĞ¸.';
    return;
  }

  // Load studio + calc in parallel
  const [studioInfo, calcResult] = await Promise.all([
    loadStudio(),
    sb.from('calculations').select('*').eq('id', calcId).single()
  ]);

  if (calcResult.error || !calcResult.data) {
    loading.style.display = 'none';
    errMsg.style.display  = '';
    return;
  }

  const calc = calcResult.data;

  // Fill car info
  document.getElementById('carName').value = calc.car_name || '';
  document.getElementById('headerSub').textContent = `${calc.car_name || 'ĞĞ²Ñ‚Ğ¾'} Â· ${new Date().toLocaleDateString('ru-RU')}`;

  setToday();
  renderServices(calc);
  renderDefects(); // empty state

  loading.style.display = 'none';
  content.style.display = '';

  // Init nav
  if (window.initNav) window.initNav({ activePage: 'acceptance-act.html' });

})();

})();
</script>
</body>
</html>
