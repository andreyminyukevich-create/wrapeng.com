<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Keep1R CRM â€” ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="nav.css">
<script src="nav.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  background: #eef2f9;
  color: #0f172a;
  min-height: 100svh;
}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page { max-width: 1600px; margin: 0 auto; padding: 20px 18px 60px; }

/* â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolbar {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 20px; flex-wrap: wrap;
}
.toolbar-title {
  font-size: 1.15rem; font-weight: 800;
  letter-spacing: -0.3px; color: #0f172a;
  margin-right: 6px;
}
.month-nav {
  display: flex; align-items: center; gap: 6px;
}
.month-nav button {
  width: 32px; height: 32px; border-radius: 8px;
  border: 1px solid rgba(15,23,42,0.10);
  background: #fff; cursor: pointer; font-size: 1rem;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s; color: #0f172a;
}
.month-nav button:hover { background: #e8eef8; }
.month-label {
  font-size: 0.9rem; font-weight: 700;
  color: #0f172a; min-width: 130px; text-align: center;
}
.btn-today {
  padding: 6px 14px; border-radius: 8px;
  border: 1px solid rgba(37,99,235,0.3);
  background: rgba(37,99,235,0.06);
  color: #2563eb; font-size: 0.78rem;
  font-weight: 700; cursor: pointer;
  font-family: inherit; transition: all 0.15s;
}
.btn-today:hover { background: #2563eb; color: #fff; }

/* â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.legend {
  display: flex; gap: 14px; flex-wrap: wrap;
  margin-left: auto; align-items: center;
}
.legend-item {
  display: flex; align-items: center; gap: 5px;
  font-size: 0.72rem; color: #64748b; font-weight: 600;
}
.legend-dot { width: 10px; height: 10px; border-radius: 3px; }

/* â”€â”€ Calendar Grid â€” 2 ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.calendar-wrap {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
@media (max-width: 900px) { .calendar-wrap { grid-template-columns: 1fr; } }

/* â”€â”€ Post Block â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.post-block {
  background: #fff;
  border: 1px solid rgba(15,23,42,0.07);
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}
.post-header {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px;
  border-bottom: 1px solid rgba(15,23,42,0.06);
  background: #f8fafc;
}
.post-color-bar {
  width: 4px; height: 20px;
  border-radius: 3px; flex-shrink: 0;
}
.post-name {
  font-size: 0.85rem; font-weight: 800;
  color: #0f172a; letter-spacing: -0.1px;
}
.post-type-badge {
  font-size: 0.65rem; font-weight: 700;
  padding: 2px 7px; border-radius: 20px;
  background: rgba(100,116,139,0.1);
  color: #64748b; border: 1px solid rgba(100,116,139,0.15);
}
.post-cap-badge {
  font-size: 0.65rem; font-weight: 700;
  padding: 2px 7px; border-radius: 20px;
  background: rgba(37,99,235,0.07);
  color: #2563eb; border: 1px solid rgba(37,99,235,0.15);
  margin-left: auto;
}

/* â”€â”€ Month Grid â€” ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ñ‹Ğ¹ ĞºĞ²Ğ°Ğ´Ñ€Ğ°Ñ‚Ğ½Ñ‹Ğ¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.month-grid-wrap { overflow-x: auto; padding: 10px 12px 14px; }
.month-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 3px;
  min-width: 0;
}
.day-header {
  text-align: center; font-size: 0.55rem;
  font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.04em; color: #94a3b8;
  padding: 2px 0 4px;
}
.day-header.weekend { color: #f87171; }

/* â”€â”€ Day Cell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.day-cell {
  aspect-ratio: 1;
  min-height: 0;
  border-radius: 8px;
  border: 1.5px solid rgba(15,23,42,0.06);
  background: #f8fafc;
  position: relative; overflow: hidden;
  cursor: pointer; transition: all 0.15s;
  display: flex; flex-direction: column;
}
.day-cell:hover { border-color: #2563eb; box-shadow: 0 2px 8px rgba(37,99,235,0.12); }
.day-cell.today { border-color: #2563eb; background: rgba(37,99,235,0.04); }
.day-cell.other-month { opacity: 0.25; cursor: default; }
.day-cell.other-month:hover { border-color: rgba(15,23,42,0.06); box-shadow: none; }
.day-cell.weekend-cell { background: #fafbfd; }

.day-num {
  font-size: 0.62rem; font-weight: 700;
  color: #64748b; padding: 3px 5px 1px;
  line-height: 1; flex-shrink: 0;
}
.day-cell.today .day-num {
  color: #2563eb;
}

/* â”€â”€ Booking blocks inside cell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.day-bookings {
  flex: 1; display: flex; flex-direction: column;
  gap: 2px; padding: 0 4px 4px;
  overflow: hidden;
}
.booking-chip {
  border-radius: 5px; padding: 2px 5px;
  font-size: 0.66rem; font-weight: 700;
  white-space: nowrap; overflow: hidden;
  text-overflow: ellipsis; color: #fff;
  line-height: 1.4; cursor: pointer;
  transition: opacity 0.15s;
}
.booking-chip:hover { opacity: 0.85; }
.booking-chip.start { border-left: 3px solid rgba(0,0,0,0.2); }
.booking-chip.mid   { opacity: 0.8; }
.booking-chip.end   { opacity: 0.7; }

/* â”€â”€ Add button in empty cell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.day-add-btn {
  position: absolute; bottom: 4px; right: 4px;
  width: 18px; height: 18px; border-radius: 50%;
  background: rgba(37,99,235,0.12); color: #2563eb;
  font-size: 0.7rem; font-weight: 900;
  display: none; align-items: center;
  justify-content: center; line-height: 1;
  border: none; cursor: pointer;
}
.day-cell:hover .day-add-btn { display: flex; }

/* â”€â”€ Empty posts state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-posts {
  background: #fff; border-radius: 16px;
  border: 1px solid rgba(15,23,42,0.07);
  padding: 60px 20px; text-align: center;
  box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}
.empty-icon { font-size: 2.5rem; margin-bottom: 14px; opacity: 0.4; }
.empty-title { font-size: 1rem; font-weight: 700; color: #0f172a; margin-bottom: 6px; }
.empty-sub { font-size: 0.82rem; color: #64748b; margin-bottom: 20px; }

/* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
  display: none; position: fixed; inset: 0; z-index: 2000;
  background: rgba(15,23,42,0.5); backdrop-filter: blur(5px);
  align-items: center; justify-content: center; padding: 20px;
}
.modal-overlay.active { display: flex; animation: fadein 0.15s ease; }
@keyframes fadein { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideup { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.modal {
  background: #fff; border-radius: 16px;
  border: 1px solid rgba(15,23,42,0.08);
  padding: 24px 26px 22px;
  width: 100%; max-width: 440px;
  box-shadow: 0 16px 60px rgba(0,0,0,0.18);
  animation: slideup 0.18s ease;
}
.modal h3 {
  font-size: 1rem; font-weight: 800;
  margin-bottom: 18px; letter-spacing: -0.2px;
}
.form-group { margin-bottom: 14px; }
.form-group label {
  display: block; font-size: 0.67rem;
  font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.06em; color: #64748b; margin-bottom: 5px;
}
.form-group select,
.form-group input[type="date"],
.form-group input[type="text"] {
  width: 100%; padding: 9px 12px;
  background: #eef2f9; border: 1.5px solid rgba(15,23,42,0.10);
  border-radius: 9px; font-size: 0.88rem;
  font-family: inherit; color: #0f172a; outline: none;
  -webkit-appearance: none; transition: border-color 0.15s;
}
.form-group select:focus,
.form-group input:focus {
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37,99,235,0.08);
  background: #fff;
}
.date-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.modal-actions { display: flex; gap: 8px; margin-top: 20px; }
.modal-actions .btn { flex: 1; padding: 10px; justify-content: center; }

/* â”€â”€ Btn â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 8px 16px; border-radius: 9px;
  font-size: 0.82rem; font-weight: 700;
  font-family: inherit; cursor: pointer;
  border: none; transition: all 0.15s; white-space: nowrap;
  text-decoration: none;
}
.btn-primary { background: #2563eb; color: #fff; }
.btn-primary:hover { background: #1d4ed8; }
.btn-ghost { background: rgba(15,23,42,0.05); color: #64748b; border: 1px solid rgba(15,23,42,0.10); }
.btn-ghost:hover { background: #fee2e2; color: #dc2626; border-color: rgba(220,38,38,0.2); }
.btn-danger { background: rgba(220,38,38,0.07); color: #dc2626; border: 1px solid rgba(220,38,38,0.15); }
.btn-danger:hover { background: #dc2626; color: #fff; }

/* â”€â”€ Warning â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.conflict-warn {
  background: rgba(217,119,6,0.08);
  border: 1px solid rgba(217,119,6,0.25);
  border-radius: 8px; padding: 8px 12px;
  font-size: 0.78rem; color: #92400e;
  font-weight: 600; margin-top: 10px;
  display: none;
}
.conflict-warn.show { display: block; }

/* â”€â”€ Detail: ÑƒÑĞ»ÑƒĞ³Ğ¸ + Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.detail-section-title {
  font-size: 0.65rem; font-weight: 800; text-transform: uppercase;
  letter-spacing: 0.07em; color: #94a3b8; margin: 14px 0 8px;
}
.service-row {
  display: flex; align-items: flex-start; justify-content: space-between;
  padding: 8px 10px; border-radius: 8px;
  background: #f8fafc; border: 1px solid rgba(15,23,42,0.06);
  margin-bottom: 4px; gap: 10px;
}
.service-name  { font-size: 0.82rem; font-weight: 700; color: #0f172a; flex: 1; line-height: 1.3; }
.service-exec  { font-size: 0.7rem; color: #64748b; font-weight: 600; margin-top: 2px; }
.service-price { font-size: 0.8rem; font-weight: 800; color: #7c3aed; white-space: nowrap; }
.exec-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
.exec-tag {
  font-size: 0.68rem; font-weight: 700; padding: 2px 8px;
  border-radius: 20px; background: rgba(37,99,235,0.08);
  color: #2563eb; border: 1px solid rgba(37,99,235,0.15);
}

/* â”€â”€ Booking detail modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.booking-detail-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
  margin-bottom: 16px;
}
.bd-item {
  background: #eef2f9; border-radius: 8px;
  padding: 9px 12px;
}
.bd-label {
  font-size: 0.62rem; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.06em;
  color: #94a3b8; margin-bottom: 2px;
}
.bd-value { font-size: 0.88rem; font-weight: 700; color: #0f172a; }

/* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cal-loading {
  text-align: center; padding: 60px; color: #64748b; font-size: 0.9rem;
}

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 640px) {
  .page { padding: 14px 10px 48px; }
  .toolbar-title { font-size: 1rem; }
  .legend { display: none; }
}
</style>
</head>
<body>

<div class="page">
  <div class="toolbar">
    <span class="toolbar-title">ğŸ—“ ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ</span>
    <div class="month-nav">
      <button onclick="shiftMonth(-1)">â€¹</button>
      <span class="month-label" id="monthLabel">â€”</span>
      <button onclick="shiftMonth(1)">â€º</button>
    </div>
    <button class="btn-today" onclick="goToday()">Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ</button>
    <button class="btn-today" style="background:rgba(245,158,11,0.1);color:#b45309;border-color:rgba(245,158,11,0.3)" onclick="BookingPopup.open({studioId:studioId,onSaved:function(){loadBookings().then(renderCalendar)}})">ğŸ“… Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾</button>
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:#2563eb"></div> Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ</div>
      <div class="legend-item"><div class="legend-dot" style="background:#7c3aed"></div> Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾</div>
      <div class="legend-item"><div class="legend-dot" style="background:#059669"></div> Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ¾</div>
      <div class="legend-item"><div class="legend-dot" style="background:#f59e0b"></div> Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ</div>
      <div class="legend-item"><div class="legend-dot" style="background:#94a3b8"></div> Ğ Ğ°ÑÑ‡Ñ‘Ñ‚</div>
    </div>
  </div>
  <div class="calendar-wrap" id="calendarWrap">
    <div class="cal-loading">â³ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
  </div>
</div>

<!-- ĞœĞ¾Ğ´Ğ°Ğ»: Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ÑŒ Ğ¼Ğ°ÑˆĞ¸Ğ½Ñƒ Ğ½Ğ° Ğ¿Ğ¾ÑÑ‚ -->
<div class="modal-overlay" id="assignModal">
  <div class="modal">
    <h3 id="assignModalTitle">ğŸ“… ĞĞ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ÑŒ Ğ½Ğ° Ğ¿Ğ¾ÑÑ‚</h3>
    <div class="form-group">
      <label>Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ (Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ)</label>
      <select id="assignCalcSelect">
        <option value="">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚...</option>
      </select>
    </div>
    <div class="date-row">
      <div class="form-group">
        <label>Ğ”Ğ°Ñ‚Ğ° Ğ·Ğ°ĞµĞ·Ğ´Ğ°</label>
        <input type="date" id="assignDateFrom">
      </div>
      <div class="form-group">
        <label>Ğ”Ğ°Ñ‚Ğ° Ğ²Ñ‹ĞµĞ·Ğ´Ğ°</label>
        <input type="date" id="assignDateTo">
      </div>
    </div>
    <div class="form-group">
      <label>ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ (Ğ½ĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)</label>
      <input type="text" id="assignNote" placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: ĞºÑƒĞ·Ğ¾Ğ² ÑĞ½Ğ¸Ğ¼Ğ°ĞµÑ‚ÑÑ 5-Ğ³Ğ¾">
    </div>
    <div class="conflict-warn" id="conflictWarn">âš ï¸ ĞĞ° ÑÑ‚Ğ¾Ğ¼ Ğ¿Ğ¾ÑÑ‚Ñƒ Ğ² Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾. Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾ÑÑ‚ Ğ²Ğ¼ĞµÑ‰Ğ°ĞµÑ‚ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ°ÑˆĞ¸Ğ½.</div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeAssignModal()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn btn-primary" onclick="saveAssignment()">âœ… ĞĞ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<!-- ĞœĞ¾Ğ´Ğ°Ğ»: Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ±Ñ€Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ -->
<div class="modal-overlay" id="detailModal">
  <div class="modal">
    <h3 id="detailModalTitle">Ğ—Ğ°ĞºĞ°Ğ·</h3>
    <div id="detailModalContent"></div>
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="removeAssignment()">ğŸ—‘ Ğ£Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸Ğ· Ğ¿Ğ¾ÑÑ‚Ğ°</button>
      <button class="btn btn-primary" onclick="openCalcFromDetail()">ğŸ“‚ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚</button>
    </div>
    <div style="margin-top:8px">
      <button class="btn btn-ghost" style="width:100%;justify-content:center" onclick="closeDetailModal()">Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<script src="footer.js"></script>
<script src="booking-popup.js"></script>
<script>
(function() {
'use strict';

const SUPABASE_URL      = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window._crmSb = sb;

let currentUser  = null;
let studioId     = null;
let posts        = [];
let calcs        = [];      // Ğ²ÑĞµ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸
let bookings     = [];      // calendar_bookings
let viewYear     = new Date().getFullYear();
let viewMonth    = new Date().getMonth(); // 0-11

// Ğ”Ğ»Ñ Ğ¼Ğ¾Ğ´Ğ°Ğ»Ğ¾Ğ²
let activePostId   = null;
let activeDate     = null;
let activeBookingId = null;
let activeCalcId   = null;

// â”€â”€ Ğ¦Ğ²ĞµÑ‚Ğ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STATUS_COLOR = {
  new:         '#94a3b8',
  scheduled:   '#f59e0b',
  in_progress: '#2563eb',
  done:        '#7c3aed',
  delivered:   '#059669',
  cancelled:   '#dc2626',
};

const STATUS_LABEL = {
  new:         'Ğ Ğ°ÑÑ‡Ñ‘Ñ‚',
  scheduled:   'Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ',
  in_progress: 'Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ',
  done:        'Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾',
  delivered:   'Ğ’Ñ‹Ğ´Ğ°Ğ½Ğ¾',
  cancelled:   'ĞÑ‚ĞºĞ°Ğ·',
};

const POST_TYPE_LABEL = {
  wrap:      'ĞĞºĞ»ĞµĞ¹ĞºĞ° / PPF',
  detailing: 'Ğ”ĞµÑ‚ĞµĞ¹Ğ»Ğ¸Ğ½Ğ³',
  wash:      'ĞœĞ¾Ğ¹ĞºĞ°',
  chem:      'Ğ¥Ğ¸Ğ¼Ñ‡Ğ¸ÑÑ‚ĞºĞ°',
  universal: 'Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹',
};

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'welcome.html'; return false; }
  currentUser = session.user;
  return true;
}

// â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStudio() {
  const { data: member } = await sb
    .from('studio_members')
    .select('studio_id')
    .eq('user_id', currentUser.id)
    .eq('is_active', true)
    .single();
  if (!member) return false;
  studioId = member.studio_id;
  return true;
}

async function loadPosts() {
  const { data, error } = await sb
    .from('posts')
    .select('*')
    .eq('studio_id', studioId)
    .eq('is_active', true)
    .order('created_at');
  if (error) { posts = []; return; }
  posts = data || [];
}

async function loadCalcs() {
  const { data } = await sb
    .from('calculations')
    .select('id, car_name, status, final_price, total_price')
    .eq('studio_id', studioId)
    .not('status', 'eq', 'cancelled')
    .order('created_at', { ascending: false });
  calcs = data || [];
}

async function loadBookings() {
  const { data, error } = await sb
    .from('calendar_bookings')
    .select('*')
    .eq('studio_id', studioId);
  if (error) { bookings = []; return; }
  bookings = data || [];
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toISO(d) {
  return d.toISOString().slice(0, 10);
}

function parseDate(s) {
  if (!s) return null;
  const [y, m, d] = s.split('-').map(Number);
  return new Date(y, m - 1, d);
}

function fmt(n) {
  return new Intl.NumberFormat('ru-RU').format(n || 0);
}

function dateRange(from, to) {
  // returns array of ISO date strings [from..to]
  const result = [];
  const cur = parseDate(from);
  const end = parseDate(to);
  if (!cur || !end) return result;
  while (cur <= end) {
    result.push(toISO(new Date(cur)));
    cur.setDate(cur.getDate() + 1);
  }
  return result;
}

function bookingsForPost(postId) {
  return bookings.filter(b => b.post_id === postId && !b.removed);
}

function bookingsForCell(postId, dateStr) {
  return bookingsForPost(postId).filter(b => {
    return dateStr >= b.date_from && dateStr <= b.date_to;
  });
}

function getCalcById(id) {
  return calcs.find(c => c.id === id);
}

// â”€â”€ Render calendar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCalendar() {
  const wrap = document.getElementById('calendarWrap');

  // Month label
  const monthNames = ['Ğ¯Ğ½Ğ²Ğ°Ñ€ÑŒ','Ğ¤ĞµĞ²Ñ€Ğ°Ğ»ÑŒ','ĞœĞ°Ñ€Ñ‚','ĞĞ¿Ñ€ĞµĞ»ÑŒ','ĞœĞ°Ğ¹','Ğ˜ÑĞ½ÑŒ',
                      'Ğ˜ÑĞ»ÑŒ','ĞĞ²Ğ³ÑƒÑÑ‚','Ğ¡ĞµĞ½Ñ‚ÑĞ±Ñ€ÑŒ','ĞĞºÑ‚ÑĞ±Ñ€ÑŒ','ĞĞ¾ÑĞ±Ñ€ÑŒ','Ğ”ĞµĞºĞ°Ğ±Ñ€ÑŒ'];
  document.getElementById('monthLabel').textContent = `${monthNames[viewMonth]} ${viewYear}`;

  if (!posts.length) {
    wrap.innerHTML = `
      <div class="empty-posts">
        <div class="empty-icon">ğŸ”§</div>
        <div class="empty-title">ĞŸĞ¾ÑÑ‚Ñ‹ Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹</div>
        <div class="empty-sub">Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğµ Ğ¿Ğ¾ÑÑ‚Ñ‹ Ğ² Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ñ… ÑÑ‚ÑƒĞ´Ğ¸Ğ¸</div>
        <a href="settings.html" class="btn btn-primary">âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</a>
      </div>`;
    return;
  }

  // Build day headers (Ğ¿Ğ½-Ğ²Ñ)
  const dayNames = ['ĞŸĞ½','Ğ’Ñ‚','Ğ¡Ñ€','Ğ§Ñ‚','ĞŸÑ‚','Ğ¡Ğ±','Ğ’Ñ'];

  // Compute month grid: first day of month, pad to Monday
  const firstDay = new Date(viewYear, viewMonth, 1);
  const lastDay  = new Date(viewYear, viewMonth + 1, 0);
  const today    = toISO(new Date());

  // Start from Monday of the week containing firstDay
  let startPad = firstDay.getDay(); // 0=Sun
  startPad = startPad === 0 ? 6 : startPad - 1; // convert to Mon=0

  const gridStart = new Date(firstDay);
  gridStart.setDate(gridStart.getDate() - startPad);

  // End on Sunday of the week containing lastDay
  let endPad = lastDay.getDay();
  endPad = endPad === 0 ? 0 : 7 - endPad;
  const gridEnd = new Date(lastDay);
  gridEnd.setDate(gridEnd.getDate() + endPad);

  // Collect all dates
  const dates = [];
  const cur = new Date(gridStart);
  while (cur <= gridEnd) {
    dates.push(toISO(new Date(cur)));
    cur.setDate(cur.getDate() + 1);
  }

  // Render each post
  wrap.innerHTML = posts.map(post => {
    const color = post.color || '#2563eb';
    const typeLbl = POST_TYPE_LABEL[post.type] || post.type;
    const cap = post.capacity || 1;

    const headers = dayNames.map((d, i) =>
      `<div class="day-header${i >= 5 ? ' weekend' : ''}">${d}</div>`
    ).join('');

    const cells = dates.map(dateStr => {
      const d = parseDate(dateStr);
      const isThisMonth = d.getMonth() === viewMonth;
      const isWeekend   = d.getDay() === 0 || d.getDay() === 6;
      const isToday     = dateStr === today;

      const dayBookings = bookingsForCell(post.id, dateStr);

      let cls = 'day-cell';
      if (!isThisMonth) cls += ' other-month';
      if (isToday)      cls += ' today';
      if (isWeekend)    cls += ' weekend-cell';

      const chips = dayBookings.slice(0, cap + 1).map(b => {
        const calc  = getCalcById(b.calc_id);
        const bColor = STATUS_COLOR[calc?.status] || color;
        const isStart = dateStr === b.date_from;
        const isEnd   = dateStr === b.date_to;
        const chipCls = isStart ? 'start' : isEnd ? 'end' : 'mid';
        const label   = isStart
          ? (calc?.car_name || 'ĞĞ²Ñ‚Ğ¾') + (isEnd ? '' : ' â†’')
          : (isEnd ? 'â† ' + (calc?.car_name || '') : 'Â·Â·Â·');
        return `<div class="booking-chip ${chipCls}" style="background:${bColor}"
          onclick="event.stopPropagation();openDetail('${b.id}')"
          title="${calc?.car_name || ''}">${label}</div>`;
      }).join('');

      const canAdd = isThisMonth && !d.otherMonth;

      return `<div class="${cls}" onclick="openAssign('${post.id}','${dateStr}')">
        <div class="day-num">${d.getDate()}</div>
        <div class="day-bookings">${chips}</div>
        ${canAdd ? `<button class="day-add-btn" onclick="event.stopPropagation();openAssign('${post.id}','${dateStr}')">+</button>` : ''}
      </div>`;
    }).join('');

    return `
      <div class="post-block">
        <div class="post-header">
          <div class="post-color-bar" style="background:${color}"></div>
          <div class="post-name">${post.name || 'ĞŸĞ¾ÑÑ‚'}</div>
          <span class="post-type-badge">${typeLbl}</span>
          ${cap > 1 ? `<span class="post-cap-badge">Ğ´Ğ¾ ${cap} Ğ°Ğ²Ñ‚Ğ¾</span>` : ''}
        </div>
        <div class="month-grid-wrap">
          <div class="month-grid">
            ${headers}
            ${cells}
          </div>
        </div>
      </div>`;
  }).join('');
}

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.shiftMonth = function(delta) {
  viewMonth += delta;
  if (viewMonth > 11) { viewMonth = 0;  viewYear++; }
  if (viewMonth < 0)  { viewMonth = 11; viewYear--; }
  renderCalendar();
};

window.goToday = function() {
  const now = new Date();
  viewYear  = now.getFullYear();
  viewMonth = now.getMonth();
  renderCalendar();
};

// â”€â”€ Assign modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openAssign = function(postId, dateStr) {
  activePostId = postId;
  activeDate   = dateStr;

  const post = posts.find(p => p.id === postId);
  document.getElementById('assignModalTitle').textContent =
    `ğŸ“… ${post?.name || 'ĞŸĞ¾ÑÑ‚'} â€” Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾`;

  // Fill calc select
  const sel = document.getElementById('assignCalcSelect');
  sel.innerHTML = '<option value="">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚...</option>' +
    calcs.map(c => {
      const status = STATUS_LABEL[c.status] || '';
      return `<option value="${c.id}">${c.car_name || 'Ğ‘ĞµĞ· Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ'} ${status ? '(' + status + ')' : ''}</option>`;
    }).join('');

  document.getElementById('assignDateFrom').value = dateStr;
  document.getElementById('assignDateTo').value   = dateStr;
  document.getElementById('assignNote').value     = '';
  document.getElementById('conflictWarn').classList.remove('show');

  // Watch for conflicts
  ['assignDateFrom','assignDateTo','assignCalcSelect'].forEach(id => {
    document.getElementById(id).addEventListener('change', checkConflict);
  });

  document.getElementById('assignModal').classList.add('active');
};

function checkConflict() {
  const from = document.getElementById('assignDateFrom').value;
  const to   = document.getElementById('assignDateTo').value;
  if (!from || !to) return;

  const dates    = dateRange(from, to);
  const existing = bookingsForPost(activePostId);
  const cap      = (posts.find(p => p.id === activePostId)?.capacity) || 1;

  const hasConflict = dates.some(d =>
    existing.filter(b => d >= b.date_from && d <= b.date_to).length >= cap
  );
  document.getElementById('conflictWarn').classList.toggle('show', hasConflict);
}

window.closeAssignModal = function() {
  document.getElementById('assignModal').classList.remove('active');
};

window.saveAssignment = async function() {
  const calcId  = document.getElementById('assignCalcSelect').value;
  const from    = document.getElementById('assignDateFrom').value;
  const to      = document.getElementById('assignDateTo').value;
  const note    = document.getElementById('assignNote').value.trim();

  if (!calcId) { alert('Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚'); return; }
  if (!from || !to) { alert('Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñ‹'); return; }
  if (from > to) { alert('Ğ”Ğ°Ñ‚Ğ° Ğ·Ğ°ĞµĞ·Ğ´Ğ° Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ·Ğ¶Ğµ Ğ²Ñ‹ĞµĞ·Ğ´Ğ°'); return; }

  const calc = getCalcById(calcId);

  const { error } = await sb.from('calendar_bookings').insert({
    studio_id: studioId,
    post_id:   activePostId,
    calc_id:   calcId,
    car_name:  calc?.car_name || '',
    date_from: from,
    date_to:   to,
    note:      note || null,
  });

  if (error) {
    alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.message);
    return;
  }

  // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ° Ğ½Ğ° scheduled ĞµÑĞ»Ğ¸ Ğ±Ñ‹Ğ» new
  if (calc?.status === 'new') {
    await sb.from('calculations')
      .update({ status: 'scheduled', scheduled_from: from, scheduled_to: to, post_id: activePostId })
      .eq('id', calcId);
    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾
    const c = calcs.find(x => x.id === calcId);
    if (c) c.status = 'scheduled';
  }

  closeAssignModal();
  await loadBookings();
  renderCalendar();
};

// â”€â”€ Helpers Ğ´Ğ»Ñ ÑƒÑĞ»ÑƒĞ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function extractServices(calcData) {
  const d = calcData || {};
  const items = [];
  const seen = new Set();

  function add(key, name, price) {
    const p = parseFloat(price) || 0;
    if (p > 0 && !seen.has(key)) { seen.add(key); items.push({ key, name, price: p }); }
  }

  if (d.package) {
    add('pkg_wrap', 'ĞĞºĞ»ĞµĞ¹ĞºĞ° (Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°)',       d.package.wrapPrice || d.package.wrap);
    add('pkg_prep', 'ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° (Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°)',    d.package.prepPrice || d.package.prep);
    add('pkg_arm',  'ĞÑ€Ğ¼Ğ°Ñ‚ÑƒÑ€Ğ½Ñ‹Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ (Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ)',    d.package.armPrice  || d.package.arm);
  }
  if (d.impact) {
    add('imp_wrap', 'ĞĞºĞ»ĞµĞ¹ĞºĞ° (ÑƒĞ´Ğ°Ñ€Ğ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ)',       d.impact.wrapPrice || d.impact.wrap);
    add('imp_prep', 'ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° (ÑƒĞ´Ğ°Ñ€Ğ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ)',    d.impact.prepPrice || d.impact.prep);
    add('imp_arm',  'ĞÑ€Ğ¼Ğ°Ñ‚ÑƒÑ€Ğ½Ñ‹Ğµ (ÑƒĞ´Ğ°Ñ€Ğ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ)',    d.impact.armPrice  || d.impact.arm);
  }
  if (d.services_detail) {
    const gn = { arm:'ĞÑ€Ğ¼Ğ°Ñ‚ÑƒÑ€Ğ½Ñ‹Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹', det:'Ğ”ĞµÑ‚ĞµĞ¹Ğ»Ğ¸Ğ½Ğ³', gl:'Ğ¡Ñ‚Ñ‘ĞºĞ»Ğ°', ms:'Ğ”Ğ¾Ğ¿. ÑƒÑĞ»ÑƒĞ³Ğ¸', wrap:'ĞĞºĞ»ĞµĞ¹ĞºĞ°' };
    Object.entries(gn).forEach(([key, gName]) => {
      (d.services_detail[key] || []).forEach((item, idx) => {
        const p = parseFloat(item.price || item.cost || 0);
        if (p > 0) add(`${key}_${idx}`, item.name || gName, p);
      });
    });
  }
  // Fallback â€” ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚
  if (!items.length) {
    const cats = { arm:'ĞÑ€Ğ¼Ğ°Ñ‚ÑƒÑ€Ğ½Ñ‹Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹', wrap:'ĞĞºĞ»ĞµĞ¹ĞºĞ°', det:'Ğ”ĞµÑ‚ĞµĞ¹Ğ»Ğ¸Ğ½Ğ³', gl:'Ğ¡Ñ‚Ñ‘ĞºĞ»Ğ°', ms:'ĞŸÑ€Ğ¾Ñ‡Ğ¸Ğµ' };
    Object.entries(cats).forEach(([key, name]) => {
      if (d[key]) add(key, name, d[key].price || d[key].cost || d[key].total);
    });
  }
  return items;
}

// â”€â”€ Detail modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openDetail = async function(bookingId) {
  const b = bookings.find(x => x.id === bookingId);
  if (!b) return;
  activeBookingId = bookingId;
  activeCalcId    = b.calc_id;

  const calc = getCalcById(b.calc_id);
  const post = posts.find(p => p.id === b.post_id);
  const price = fmt(calc?.final_price || calc?.total_price || 0);

  document.getElementById('detailModalTitle').textContent = b.car_name || calc?.car_name || 'ĞĞ²Ñ‚Ğ¾';
  document.getElementById('detailModalContent').innerHTML = `
    <div class="booking-detail-grid">
      <div class="bd-item">
        <div class="bd-label">ĞŸĞ¾ÑÑ‚</div>
        <div class="bd-value">${post?.name || 'â€”'}</div>
      </div>
      <div class="bd-item">
        <div class="bd-label">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</div>
        <div class="bd-value" style="color:${STATUS_COLOR[calc?.status]||'#64748b'}">${STATUS_LABEL[calc?.status]||'â€”'}</div>
      </div>
      <div class="bd-item">
        <div class="bd-label">Ğ—Ğ°ĞµĞ·Ğ´</div>
        <div class="bd-value">${formatDate(b.date_from)}</div>
      </div>
      <div class="bd-item">
        <div class="bd-label">Ğ’Ñ‹ĞµĞ·Ğ´</div>
        <div class="bd-value">${formatDate(b.date_to)}</div>
      </div>
      <div class="bd-item">
        <div class="bd-label">Ğ¡ÑƒĞ¼Ğ¼Ğ° ĞšĞŸ</div>
        <div class="bd-value" style="color:#7c3aed">${price}</div>
      </div>
      <div class="bd-item">
        <div class="bd-label">Ğ”Ğ½ĞµĞ¹</div>
        <div class="bd-value">${daysBetween(b.date_from, b.date_to)}</div>
      </div>
    </div>
    ${b.note ? `<div style="font-size:0.8rem;color:#64748b;background:#f8fafc;border-radius:8px;padding:9px 12px;border:1px solid rgba(15,23,42,0.07);margin-top:12px">ğŸ’¬ ${b.note}</div>` : ''}
    <div class="detail-section-title">Ğ£ÑĞ»ÑƒĞ³Ğ¸ Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ğ¸</div>
    <div id="detailServicesBlock"><div style="color:#94a3b8;font-size:0.8rem;padding:8px 0">â³ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div></div>
  `;
  document.getElementById('detailModal').classList.add('active');

  // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ° + Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ĞµĞ¹
  if (!b.calc_id) {
    document.getElementById('detailServicesBlock').innerHTML =
      '<div style="color:#94a3b8;font-size:0.8rem;padding:8px 0">Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½</div>';
    return;
  }

  const [calcRes, assignRes] = await Promise.all([
    sb.from('calculations').select('calculation_data, final_price, total_price').eq('id', b.calc_id).single(),
    sb.from('work_assignments').select('executor_name, salary, is_admin_sale').eq('calculation_id', b.calc_id),
  ]);

  const calcData = calcRes.data?.calculation_data || {};
  const services = extractServices(calcData);
  const workers  = (assignRes.data || []).filter(a => !a.is_admin_sale);

  const execNames = workers.map(a => a.executor_name).filter(Boolean);

  const block = document.getElementById('detailServicesBlock');
  if (!block) return;

  if (!services.length && !execNames.length) {
    block.innerHTML = '<div style="color:#94a3b8;font-size:0.8rem;padding:4px 0">ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾Ğ± ÑƒÑĞ»ÑƒĞ³Ğ°Ñ…</div>';
    return;
  }

  let html = '';

  if (services.length) {
    html += services.map(s => `
      <div class="service-row">
        <div>
          <div class="service-name">${s.name}</div>
        </div>
        <div class="service-price">${fmt(s.price)} â‚½</div>
      </div>`).join('');
  }

  if (execNames.length) {
    html += `<div class="detail-section-title" style="margin-top:10px">ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ñ‹</div>
      <div class="exec-tags">${execNames.map(n => `<span class="exec-tag">ğŸ‘¤ ${n}</span>`).join('')}</div>`;
  }

  block.innerHTML = html;
};

function formatDate(s) {
  if (!s) return 'â€”';
  const d = parseDate(s);
  return d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
}

function daysBetween(from, to) {
  const f = parseDate(from);
  const t = parseDate(to);
  if (!f || !t) return 'â€”';
  return Math.round((t - f) / 86400000) + 1 + ' Ğ´.';
}

window.closeDetailModal = function() {
  document.getElementById('detailModal').classList.remove('active');
  activeBookingId = null;
  activeCalcId    = null;
};

window.openCalcFromDetail = function() {
  if (activeCalcId) window.open(`calculator.html?load=${activeCalcId}`, '_blank');
};

window.removeAssignment = async function() {
  if (!activeBookingId) return;
  const b = bookings.find(x => x.id === activeBookingId);
  const calc = b ? getCalcById(b.calc_id) : null;
  const name = calc?.car_name || 'ÑÑ‚Ğ¾ Ğ°Ğ²Ñ‚Ğ¾';
  if (!confirm(`Ğ£Ğ±Ñ€Ğ°Ñ‚ÑŒ Â«${name}Â» Ñ Ğ¿Ğ¾ÑÑ‚Ğ°?`)) return;

  const { error } = await sb
    .from('calendar_bookings')
    .delete()
    .eq('id', activeBookingId);

  if (error) { alert('âŒ ' + error.message); return; }

  closeDetailModal();
  await loadBookings();
  renderCalendar();
};

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  initNav({ actionHref: 'calculator.html', actionLabel: 'â• ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚' });

  if (!await checkAuth()) return;
  if (!await loadStudio()) {
    document.getElementById('calendarWrap').innerHTML =
      '<div class="cal-loading">âš ï¸ Ğ¡Ñ‚ÑƒĞ´Ğ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°</div>';
    return;
  }

  const sub = await checkSubscription(studioId);
  if (sub === 'expired' || sub === 'none') {
    showPaywall(sub === 'expired');
    document.getElementById('calendarWrap').innerHTML = '';
    return;
  }

  await Promise.all([loadPosts(), loadCalcs(), loadBookings()]);
  renderCalendar();
}

document.addEventListener('DOMContentLoaded', init);

})();
</script>
</body>
</html>
