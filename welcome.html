<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Keep1R CRM ‚Äî –í—Ö–æ–¥</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --font: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
  --bg:           #f0f4fb;
  --surface:      #ffffff;
  --border:       rgba(15,23,42,0.09);
  --text:         #0f172a;
  --text-muted:   #64748b;
  --text-dim:     #94a3b8;
  --primary:      #2563eb;
  --primary-dark: #1d4ed8;
  --primary-light:rgba(37,99,235,0.08);
  --success:      #059669;
  --danger:       #dc2626;
  --warning:      #d97706;
  --radius:       14px;
  --radius-sm:    10px;
  --shadow:       0 1px 4px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.06);
  --shadow-lg:    0 8px 40px rgba(0,0,0,0.10);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  min-height: 100svh;
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden;
}

/* ‚îÄ‚îÄ –§–æ–Ω–æ–≤—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã ‚îÄ‚îÄ */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0;
  background:
    radial-gradient(ellipse 800px 600px at -5% -5%, rgba(37,99,235,0.06) 0%, transparent 55%),
    radial-gradient(ellipse 600px 500px at 105% 105%, rgba(37,99,235,0.04) 0%, transparent 55%);
  pointer-events: none;
}

/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
.page {
  position: relative; z-index: 1;
  min-height: 100svh;
  display: grid;
  grid-template-columns: 1fr 420px;
}

/* ‚îÄ‚îÄ –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å ‚îÄ‚îÄ */
.brand-panel {
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 60px 56px;
  position: relative;
  overflow: hidden;
}

.brand-name {
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--primary);
  letter-spacing: -0.5px;
  margin-bottom: 6px;
}

.brand-tagline {
  font-size: 1.75rem;
  font-weight: 700;
  color: var(--text);
  line-height: 1.3;
  letter-spacing: -0.5px;
  margin-bottom: 10px;
}

.brand-sub {
  font-size: 0.95rem;
  color: var(--text-muted);
  margin-bottom: 48px;
  line-height: 1.6;
}

/* –§–∏—á–∏ */
.features {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 48px;
  max-width: 440px;
}

.feature {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 16px;
  background: var(--surface);
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  transition: transform 0.15s, box-shadow 0.15s;
}
.feature:hover {
  transform: translateX(3px);
  box-shadow: 0 2px 12px rgba(37,99,235,0.08);
}

.feature-icon {
  width: 38px; height: 38px;
  background: var(--primary-light);
  border-radius: 9px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1rem;
  flex-shrink: 0;
}

.feature-text h4 {
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 2px;
}
.feature-text p {
  font-size: 0.75rem;
  color: var(--text-muted);
  line-height: 1.4;
}

.brand-note {
  font-size: 0.75rem;
  color: var(--text-dim);
}
.brand-note a {
  color: var(--primary);
  text-decoration: none;
  font-weight: 600;
}
.brand-note a:hover { text-decoration: underline; }

/* –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç */
.brand-deco {
  position: absolute;
  bottom: 40px; right: 40px;
  width: 180px; height: 180px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(37,99,235,0.06) 0%, transparent 70%);
  pointer-events: none;
}

/* ‚îÄ‚îÄ –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (auth) ‚îÄ‚îÄ */
.auth-panel {
  background: var(--surface);
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 48px 40px;
  position: relative;
  overflow: hidden;
  box-shadow: -4px 0 32px rgba(0,0,0,0.05);
}

/* ‚îÄ‚îÄ –¢–∞–±—ã ‚îÄ‚îÄ */
.auth-tabs {
  display: flex;
  gap: 3px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 3px;
  margin-bottom: 28px;
}

.auth-tab {
  flex: 1;
  padding: 9px;
  border-radius: 8px;
  border: none;
  font-family: var(--font);
  font-size: 0.83rem;
  font-weight: 700;
  cursor: pointer;
  background: transparent;
  color: var(--text-muted);
  transition: all 0.15s;
}
.auth-tab.active {
  background: var(--primary);
  color: #fff;
  box-shadow: 0 2px 8px rgba(37,99,235,0.25);
}

/* ‚îÄ‚îÄ –≠–∫—Ä–∞–Ω—ã ‚îÄ‚îÄ */
.screen { display: none; }
.screen.active { display: block; animation: fadeUp 0.2s ease; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}

.screen-title {
  font-size: 1.2rem;
  font-weight: 700;
  margin-bottom: 4px;
  color: var(--text);
  letter-spacing: -0.3px;
}
.screen-sub {
  font-size: 0.82rem;
  color: var(--text-muted);
  margin-bottom: 22px;
  line-height: 1.5;
}

/* ‚îÄ‚îÄ –§–æ—Ä–º–∞ ‚îÄ‚îÄ */
.form-group { margin-bottom: 12px; }

.form-group label {
  display: block;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-muted);
  margin-bottom: 5px;
  letter-spacing: 0.02em;
}

.form-group input {
  width: 100%;
  padding: 11px 14px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: var(--font);
  font-size: 16px; /* prevent iOS zoom */
  color: var(--text);
  outline: none;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.form-group input::placeholder { color: var(--text-dim); }
.form-group input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37,99,235,0.10);
  background: var(--surface);
}

/* ‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∏ ‚îÄ‚îÄ */
.btn {
  width: 100%;
  padding: 13px;
  border-radius: var(--radius-sm);
  border: none;
  font-family: var(--font);
  font-size: 0.88rem;
  font-weight: 700;
  cursor: pointer;
  margin-top: 8px;
  transition: all 0.15s;
  display: block;
  text-align: center;
  text-decoration: none;
}
.btn:disabled { opacity: 0.6; cursor: not-allowed; }

.btn-primary {
  background: var(--primary);
  color: #fff;
  box-shadow: 0 2px 10px rgba(37,99,235,0.25);
}
.btn-primary:hover:not(:disabled) {
  background: var(--primary-dark);
  box-shadow: 0 4px 16px rgba(37,99,235,0.35);
  transform: translateY(-1px);
}
.btn-primary:active { transform: translateY(0); }

.btn-outline {
  background: transparent;
  color: var(--text-muted);
  border: 1px solid var(--border);
}
.btn-outline:hover:not(:disabled) {
  background: var(--bg);
  color: var(--text);
}

/* ‚îÄ‚îÄ –û—à–∏–±–∫–∏ ‚îÄ‚îÄ */
.error-msg {
  display: none;
  background: rgba(220,38,38,0.07);
  border: 1px solid rgba(220,38,38,0.2);
  color: var(--danger);
  border-radius: var(--radius-sm);
  padding: 10px 13px;
  font-size: 0.8rem;
  font-weight: 600;
  margin-bottom: 14px;
}

/* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
.auth-footer {
  text-align: center;
  margin-top: 18px;
  font-size: 0.78rem;
  color: var(--text-muted);
}
.auth-footer a {
  color: var(--primary);
  text-decoration: none;
  font-weight: 700;
}
.auth-footer a:hover { text-decoration: underline; }

/* ‚îÄ‚îÄ –°—Ç–∞—Ç—É—Å-–±–æ–∫—Å—ã ‚îÄ‚îÄ */
.status-box {
  border-radius: var(--radius);
  padding: 24px;
  text-align: center;
  margin-bottom: 20px;
  border: 1px solid var(--border);
}
.status-box.blue  { background: var(--primary-light); }
.status-box.amber { background: rgba(217,119,6,0.07); border-color: rgba(217,119,6,0.2); }
.status-box.purple{ background: rgba(124,58,237,0.06); border-color: rgba(124,58,237,0.15); }

.status-icon { font-size: 2.2rem; margin-bottom: 10px; }
.status-title {
  font-size: 1rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 6px;
}
.status-desc {
  font-size: 0.82rem;
  color: var(--text-muted);
  line-height: 1.5;
}

/* ‚îÄ‚îÄ Creds ‚îÄ‚îÄ */
.creds-box {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 14px 16px;
  margin-bottom: 16px;
}
.creds-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 0;
  border-bottom: 1px solid var(--border);
  font-size: 0.82rem;
}
.creds-row:last-child { border-bottom: none; }
.creds-label { color: var(--text-muted); font-weight: 600; }
.creds-value { color: var(--text); font-weight: 700; }

/* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
@media (max-width: 768px) {
  .page {
    grid-template-columns: 1fr;
    grid-template-rows: auto 1fr;
  }

  .brand-panel {
    padding: 32px 24px 24px;
    border-bottom: 1px solid var(--border);
  }

  .brand-tagline { font-size: 1.3rem; }
  .brand-sub { margin-bottom: 20px; font-size: 0.88rem; }

  .features { display: none; } /* –Ω–∞ –º–æ–±–∏–ª–µ —É–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∏—á */

  .brand-note { display: none; }
  .brand-deco { display: none; }

  .auth-panel {
    border-left: none;
    padding: 32px 24px 40px;
    box-shadow: none;
    justify-content: flex-start;
  }
}

@media (max-width: 400px) {
  .brand-panel { padding: 24px 18px 20px; }
  .auth-panel  { padding: 24px 18px 36px; }
}
</style>
</head>
<body>

<div class="page">

  <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å ‚Äî –±—Ä–µ–Ω–¥ -->
  <div class="brand-panel">
    <div class="brand-name">Keep1R CRM</div>
    <div class="brand-tagline">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ<br>–¥–µ—Ç–µ–π–ª–∏–Ω–≥-—Å—Ç—É–¥–∏–µ–π</div>
    <div class="brand-sub">–†–∞—Å—á—ë—Ç—ã, –∑–∞–∫–∞–∑—ã, —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –∏ –∑–∞—Ä–ø–ª–∞—Ç—ã<br>–≤ –æ–¥–Ω–æ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ</div>

    <div class="features">
      <div class="feature">
        <div class="feature-icon">üßÆ</div>
        <div class="feature-text">
          <h4>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–∫–ª–µ–π–∫–∏</h4>
          <p>PPF, PVC, –¥–µ—Ç–µ–π–ª–∏–Ω–≥ ‚Äî –±—ã—Å—Ç—Ä—ã–π —Ä–∞—Å—á—ë—Ç –∏ –ö–ü</p>
        </div>
      </div>
      <div class="feature">
        <div class="feature-icon">üîß</div>
        <div class="feature-text">
          <h4>–î–æ—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤</h4>
          <p>–°—Ç–∞—Ç—É—Å—ã, –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏, –∫–æ–Ω—Ç—Ä–æ–ª—å —Å—Ä–æ–∫–æ–≤</p>
        </div>
      </div>
      <div class="feature">
        <div class="feature-icon">üë•</div>
        <div class="feature-text">
          <h4>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –∏ –∑–∞—Ä–ø–ª–∞—Ç—ã</h4>
          <p>–£—á—ë—Ç –≤—ã–ø–ª–∞—Ç, –º–æ—Ç–∏–≤–∞—Ü–∏—è, –∏—Å—Ç–æ—Ä–∏—è</p>
        </div>
      </div>
      <div class="feature">
        <div class="feature-icon">üìÑ</div>
        <div class="feature-text">
          <h4>–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</h4>
          <p>–ö–ü, —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å, –ª–∏—Å—Ç—ã –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π</p>
        </div>
      </div>
    </div>

    <div class="brand-note">
      –ü—Ä–æ–¥—É–∫—Ç <a href="https://keep1r.ru" target="_blank">keep1r.ru</a> ¬∑ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ <a href="https://t.me/keeper_wrap" target="_blank">@keeper_wrap</a>
    </div>
    <div class="brand-deco"></div>
  </div>

  <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
  <div class="auth-panel">

    <div class="auth-tabs">
      <button class="auth-tab active" onclick="showTab('login')">–í–æ–π—Ç–∏</button>
      <button class="auth-tab" onclick="showTab('register')">–ó–∞—è–≤–∫–∞ –Ω–∞ –¥–æ—Å—Ç—É–ø</button>
    </div>

    <!-- –í–æ–π—Ç–∏ -->
    <div id="screen-login" class="screen active">
      <div class="screen-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å üëã</div>
      <div class="screen-sub">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞</div>
      <div class="error-msg" id="login-error"></div>
      <form id="login-form">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="login-email" placeholder="studio@example.com" required autocomplete="email">
        </div>
        <div class="form-group">
          <label>–ü–∞—Ä–æ–ª—å</label>
          <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
        </div>
        <button type="submit" class="btn btn-primary" id="login-btn">–í–æ–π—Ç–∏ ‚Üí</button>
        <button type="button" class="btn btn-outline" onclick="showTab('forgot')">–ó–∞–±—ã–ª –ø–∞—Ä–æ–ª—å</button>
      </form>
      <div class="auth-footer">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞? <a href="#" onclick="showTab('register')">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</a></div>
    </div>

    <!-- –ó–∞—è–≤–∫–∞ -->
    <div id="screen-register" class="screen">
      <div class="screen-title">–ó–∞—è–≤–∫–∞ –Ω–∞ –¥–æ—Å—Ç—É–ø üìã</div>
      <div class="screen-sub">–°–≤—è–∂–µ–º—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤ –∏ –æ—Ç–∫—Ä–æ–µ–º –¥–æ—Å—Ç—É–ø</div>
      <div class="error-msg" id="reg-error"></div>
      <form id="reg-form">
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—É–¥–∏–∏</label>
          <input type="text" id="reg-studio" placeholder="–°—Ç—É–¥–∏—è –æ–∫–ª–µ–π–∫–∏" required>
        </div>
        <div class="form-group">
          <label>–ì–æ—Ä–æ–¥</label>
          <input type="text" id="reg-city" placeholder="–ú–æ—Å–∫–≤–∞" required>
        </div>
        <div class="form-group">
          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input type="tel" id="reg-phone" placeholder="+7 900 000-00-00" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="reg-email" placeholder="studio@example.com" required autocomplete="email">
        </div>
        <div class="form-group">
          <label>–ü–∞—Ä–æ–ª—å</label>
          <input type="password" id="reg-password" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" required autocomplete="new-password" minlength="6">
        </div>
        <button type="submit" class="btn btn-primary" id="reg-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É ‚Üí</button>
      </form>
      <div class="auth-footer">–ï—Å—Ç—å –¥–æ—Å—Ç—É–ø? <a href="#" onclick="showTab('login')">–í–æ–π—Ç–∏</a></div>
    </div>

    <!-- –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è -->
    <div id="screen-forgot" class="screen">
      <div class="screen-title">–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è üîë</div>
      <div class="screen-sub">–û—Ç–ø—Ä–∞–≤–∏–º —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∞—à email</div>
      <div class="error-msg" id="forgot-error"></div>
      <form id="forgot-form">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="forgot-email" placeholder="studio@example.com" required>
        </div>
        <button type="submit" class="btn btn-primary" id="forgot-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ ‚Üí</button>
        <button type="button" class="btn btn-outline" onclick="showTab('login')">‚Üê –ù–∞–∑–∞–¥</button>
      </form>
    </div>

    <!-- –£—Å–ø–µ—Ö -->
    <div id="screen-success" class="screen">
      <div class="status-box purple">
        <div class="status-icon">üì¨</div>
        <div class="status-title">–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</div>
        <div class="status-desc">–°–≤—è–∂–µ–º—Å—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∏–ª–∏ email<br>–≤ —Ç–µ—á–µ–Ω–∏–µ <strong>24 —á–∞—Å–æ–≤</strong></div>
      </div>
      <div class="creds-box">
        <div class="creds-row">
          <span class="creds-label">Email</span>
          <span class="creds-value" id="success-email">‚Äî</span>
        </div>
        <div class="creds-row">
          <span class="creds-label">–¢–µ–ª–µ—Ñ–æ–Ω</span>
          <span class="creds-value" id="success-phone">‚Äî</span>
        </div>
      </div>
      <a href="https://t.me/PPFKeep1R" target="_blank" class="btn btn-primary">‚úàÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram</a>
      <div class="auth-footer"><a href="#" onclick="showTab('login')">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫–æ –≤—Ö–æ–¥—É</a></div>
    </div>

    <!-- –û–∂–∏–¥–∞–Ω–∏–µ -->
    <div id="screen-pending" class="screen">
      <div class="status-box amber">
        <div class="status-icon">‚è≥</div>
        <div class="status-title">–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</div>
        <div class="status-desc">–û–±—ã—á–Ω–æ –¥–æ 24 —á–∞—Å–æ–≤. –•–æ—Ç–∏—Ç–µ —É—Å–∫–æ—Ä–∏—Ç—å?</div>
      </div>
      <a href="https://t.me/PPFKeep1R" target="_blank" class="btn btn-primary" style="margin-bottom:8px">‚úàÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram</a>
      <button class="btn btn-outline" onclick="logoutPending()">–í—ã–π—Ç–∏</button>
    </div>

  </div>
</div>

<script src="footer.js"></script>
<script>
(function() {
'use strict';
const SB_URL = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';
const sb = window.supabase.createClient(SB_URL, SB_KEY, {auth:{persistSession:true,autoRefreshToken:true}});
window._crmSb = sb;

window.showTab = function(tab) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
  const map = {login:'screen-login',register:'screen-register',forgot:'screen-forgot',success:'screen-success',pending:'screen-pending'};
  document.getElementById(map[tab]||'screen-login')?.classList.add('active');
  if (tab==='login')    document.querySelectorAll('.auth-tab')[0]?.classList.add('active');
  if (tab==='register') document.querySelectorAll('.auth-tab')[1]?.classList.add('active');
};

function err(id, msg) { const e=document.getElementById(id); if(e){e.textContent=msg;e.style.display='block';} }
function clr(id) { const e=document.getElementById(id); if(e) e.style.display='none'; }

async function checkSession() {
  const {data:{session}} = await sb.auth.getSession();
  if (!session) return;
  const {data:m} = await sb.from('studio_members').select('studio_id,studios(subscription_tier)').eq('user_id',session.user.id).eq('is_active',true).single();
  if (!m) return;
  if (m.studios?.subscription_tier === 'pending') { showTab('pending'); return; }
  window.location.href = 'dashboard.html';
}

document.getElementById('login-form').addEventListener('submit', async e => {
  e.preventDefault(); clr('login-error');
  const btn=document.getElementById('login-btn'); btn.disabled=true; btn.textContent='–í—Ö–æ–¥–∏–º...';
  try {
    const {data,error} = await sb.auth.signInWithPassword({
      email: document.getElementById('login-email').value.trim(),
      password: document.getElementById('login-password').value
    });
    if (error) throw error;
    const {data:m} = await sb.from('studio_members').select('studios(subscription_tier)').eq('user_id',data.user.id).eq('is_active',true).single();
    if (m?.studios?.subscription_tier === 'pending') { showTab('pending'); }
    else window.location.href = 'dashboard.html';
  } catch(e) {
    const msgs={'Invalid login credentials':'–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å','Email not confirmed':'–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email'};
    err('login-error', msgs[e.message]||e.message);
  } finally { btn.disabled=false; btn.textContent='–í–æ–π—Ç–∏ ‚Üí'; }
});

document.getElementById('reg-form').addEventListener('submit', async e => {
  e.preventDefault(); clr('reg-error');
  const btn=document.getElementById('reg-btn'); btn.disabled=true; btn.textContent='–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';
  const studio=document.getElementById('reg-studio').value.trim();
  const city=document.getElementById('reg-city').value.trim();
  const phone=document.getElementById('reg-phone').value.trim();
  const email=document.getElementById('reg-email').value.trim();
  const pass=document.getElementById('reg-password').value;
  if (phone.length < 10) { err('reg-error','–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞'); btn.disabled=false; btn.textContent='–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É ‚Üí'; return; }
  try {
    const {data:auth,error:ae} = await sb.auth.signUp({email,password:pass});
    if (ae) throw ae;
    const uid = auth.user?.id;
    if (!uid) throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
    if (auth.user?.identities?.length === 0) {
      throw new Error('–≠—Ç–æ—Ç email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω. –í–æ–π–¥–∏—Ç–µ –∏–ª–∏ —Å–±—Ä–æ—Å—å—Ç–µ –ø–∞—Ä–æ–ª—å.');
    }
    const refCode = Math.random().toString(36).substring(2,10).toUpperCase();
    const {data:studioData,error:se} = await sb.from('studios').insert({
      name: studio, owner_id: uid, subscription_tier: 'pending',
      referral_code: refCode, settings: {phone, city, contact_email: email}
    }).select('id').single();
    if (se) {
      const { error: reqErr } = await sb.from('access_requests').insert({
        studio_name: studio, city, phone, email, supabase_user_id: uid, status: 'new'
      });
      if (reqErr) {
        err('reg-error', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏: ' + (se.message || '–ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑'));
        await sb.auth.signOut(); btn.disabled=false; btn.textContent='–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É ‚Üí'; return;
      }
      await sb.auth.signOut();
      document.getElementById('success-email').textContent = email;
      document.getElementById('success-phone').textContent = phone;
      showTab('success'); return;
    }
    await sb.from('studio_members').insert({studio_id:studioData.id,user_id:uid,role:'owner',is_active:true});
    await sb.auth.signOut();
    document.getElementById('success-email').textContent = email;
    document.getElementById('success-phone').textContent = phone;
    showTab('success');
  } catch(e) {
    err('reg-error', e.message==='User already registered'?'–≠—Ç–æ—Ç email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω':e.message);
  } finally { btn.disabled=false; btn.textContent='–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É ‚Üí'; }
});

document.getElementById('forgot-form').addEventListener('submit', async e => {
  e.preventDefault();
  const btn=document.getElementById('forgot-btn'); btn.disabled=true; btn.textContent='–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';
  try {
    const {error} = await sb.auth.resetPasswordForEmail(document.getElementById('forgot-email').value.trim(),{redirectTo:location.origin+'/welcome.html'});
    if (error) throw error;
    alert('‚úÖ –ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!'); showTab('login');
  } catch(e) { err('forgot-error',e.message); }
  finally { btn.disabled=false; btn.textContent='–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ ‚Üí'; }
});

window.logoutPending = async function() { await sb.auth.signOut(); showTab('login'); };
checkSession();
})();
</script>
</body>
</html>
