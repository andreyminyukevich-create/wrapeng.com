<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ğ—Ğ°ĞºĞ°Ğ·-Ğ½Ğ°Ñ€ÑĞ´ â€” Keep1R CRM</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="nav.css">
<script src="nav.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --font: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
  --bg: #eef2f9;
  --card: #fff;
  --border: rgba(15,23,42,0.10);
  --text: #0f172a;
  --muted: #64748b;
  --primary: #2563eb;
  --success: #059669;
  --radius: 12px;
}
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  min-height: 100svh;
  -webkit-font-smoothing: antialiased;
}
.container { max-width: 900px; margin: 0 auto; padding: 24px 20px 60px; }

/* â”€â”€ Screen UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page-header {
  display: flex; align-items: flex-start; justify-content: space-between;
  margin-bottom: 20px; flex-wrap: wrap; gap: 12px;
}
.page-title { font-size: 1.3rem; font-weight: 800; letter-spacing: -0.3px; }
.page-sub   { font-size: 0.8rem; color: var(--muted); margin-top: 3px; }
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 9px 18px; border-radius: 9px; border: none;
  font-size: 0.85rem; font-weight: 700; cursor: pointer;
  font-family: var(--font); transition: all 0.15s;
}
.btn-primary   { background: var(--primary); color: #fff; }
.btn-primary:hover { background: #1d4ed8; }
.btn-secondary { background: #f1f5f9; color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover { background: #e2e8f0; }
.btn-dark   { background: #0f172a; color: #fff; }
.btn-dark:hover { background: #1e293b; }
.btn-group  { display: flex; gap: 8px; flex-wrap: wrap; }

.card {
  background: var(--card); border-radius: var(--radius);
  border: 1px solid var(--border); box-shadow: 0 1px 4px rgba(0,0,0,0.06);
  margin-bottom: 16px; overflow: hidden;
}
.card-head {
  padding: 12px 18px 10px; border-bottom: 1px solid var(--border);
  font-size: 0.76rem; font-weight: 800; text-transform: uppercase;
  letter-spacing: 0.06em; color: var(--muted);
}
.card-body { padding: 16px 18px; }

/* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.wo-table { width: 100%; border-collapse: collapse; font-size: 0.86rem; }
.wo-table th {
  text-align: left; padding: 8px 12px; background: #f8fafc;
  font-size: 0.71rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.05em; color: var(--muted);
  border-bottom: 1.5px solid var(--border);
}
.wo-table td {
  padding: 10px 12px; border-bottom: 1px solid var(--border);
  vertical-align: top; line-height: 1.4;
}
.wo-table tr:last-child td  { border-bottom: none; }
.wo-table .total-row td {
  font-weight: 800; border-top: 2px solid #0f172a; border-bottom: none;
  background: #f8fafc; padding-top: 11px;
}
.right { text-align: right; white-space: nowrap; }
.execs { display: flex; flex-wrap: wrap; gap: 4px; }
.exec-pill {
  display: inline-flex; align-items: center; gap: 3px;
  padding: 2px 8px; border-radius: 20px;
  background: rgba(37,99,235,0.08); color: #1e40af;
  font-size: 0.75rem; font-weight: 700;
}
.exec-pill.admin { background: rgba(124,58,237,0.08); color: #6d28d9; }

/* â”€â”€ Info grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.info-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 0; border: 1px solid var(--border); border-radius: 8px; overflow: hidden;
}
.info-cell {
  padding: 10px 14px; border-right: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
}
.info-cell:nth-child(3n) { border-right: none; }
.info-cell:nth-last-child(-n+3) { border-bottom: none; }
.info-label { font-size: 0.69rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); margin-bottom: 3px; }
.info-value { font-size: 0.88rem; font-weight: 600; color: var(--text); min-height: 1.2em; }
.info-value.empty { color: var(--muted); font-style: italic; font-weight: 400; }

/* â”€â”€ Sign â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sign-row { display: grid; grid-template-columns: 1fr 1fr; gap: 28px; }
.sign-block { display: flex; flex-direction: column; gap: 8px; }
.sign-label { font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; color: var(--muted); }
.sign-name  { font-size: 0.83rem; color: var(--muted); min-height: 1.1em; }
.sign-line  { border-bottom: 1.5px solid #94a3b8; height: 44px; }
.sign-cap   { font-size: 0.71rem; color: var(--muted); text-align: center; }

/* â”€â”€ Disclaimer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.disclaimer {
  padding: 11px 14px; background: #fef9c3; border: 1px solid #fde68a;
  border-radius: 8px; font-size: 0.78rem; color: #78350f; line-height: 1.5; margin-top: 14px;
}

/* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#loadingMsg { text-align: center; padding: 60px 20px; color: var(--muted); }
#errMsg { display: none; text-align: center; padding: 40px; color: #dc2626; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRINT STYLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media print {
  * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }

  body { background: #fff !important; }
  #navTopBar, .no-print { display: none !important; }
  .container { padding: 0 !important; max-width: 100% !important; }

  .card { box-shadow: none !important; border: 1px solid #e2e8f0 !important; break-inside: avoid; margin-bottom: 10px !important; }
  .card-head { background: #f8fafc !important; }

  .wo-table th { background: #f1f5f9 !important; }
  .exec-pill { border: 1px solid rgba(37,99,235,0.2) !important; }

  /* Studio print header */
  #printHeader { display: flex !important; }

  /* Compact page-title area */
  .page-header { margin-bottom: 12px !important; }
  .page-title { font-size: 1.1rem !important; }
}

/* â”€â”€ Print header (studio branding) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#printHeader {
  display: none;
  align-items: center; justify-content: space-between;
  padding-bottom: 14px; border-bottom: 2.5px solid #0f172a;
  margin-bottom: 18px; gap: 16px;
}
#ph-logo { max-height: 52px; max-width: 130px; object-fit: contain; }
.ph-center { text-align: center; }
.ph-doc-title {
  font-size: 1.2rem; font-weight: 900; letter-spacing: -0.3px; color: #0f172a;
  text-transform: uppercase;
}
.ph-doc-num { font-size: 0.78rem; color: var(--muted); margin-top: 2px; }
.ph-right { text-align: right; }
.ph-studio-name { font-size: 0.96rem; font-weight: 800; color: #0f172a; }
.ph-studio-info { font-size: 0.75rem; color: var(--muted); line-height: 1.6; margin-top: 2px; }
</style>
</head>
<body>

<div id="navTopBar">
  <a href="board.html" class="nav-brand">Keep1R CRM</a>
  <div class="nav-links">
    <a href="board.html" class="nav-link">â† Ğ”Ğ¾ÑĞºĞ°</a>
    <span class="nav-link active">ğŸ–¨ï¸ Ğ—Ğ°ĞºĞ°Ğ·-Ğ½Ğ°Ñ€ÑĞ´</span>
  </div>
  <div class="nav-right"></div>
</div>

<div class="container">

  <!-- Print studio header -->
  <div id="printHeader">
    <img id="ph-logo" src="" alt="" style="display:none">
    <div class="ph-center">
      <div class="ph-doc-title">Ğ—Ğ°ĞºĞ°Ğ·-Ğ½Ğ°Ñ€ÑĞ´</div>
      <div class="ph-doc-num" id="ph-num">â„– â€”</div>
    </div>
    <div class="ph-right">
      <div class="ph-studio-name" id="ph-name"></div>
      <div class="ph-studio-info" id="ph-info"></div>
    </div>
  </div>

  <div id="loadingMsg">â³ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµâ€¦</div>
  <div id="errMsg">âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸. <a href="board.html">â† Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ</a></div>

  <div id="mainContent" style="display:none">

    <!-- Screen page header -->
    <div class="page-header no-print">
      <div>
        <div class="page-title">ğŸ–¨ï¸ Ğ—Ğ°ĞºĞ°Ğ·-Ğ½Ğ°Ñ€ÑĞ´</div>
        <div class="page-sub" id="headerSub"></div>
      </div>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="history.back()">â† ĞĞ°Ğ·Ğ°Ğ´</button>
        <button class="btn btn-dark" onclick="window.print()">ğŸ–¨ï¸ Ğ Ğ°ÑĞ¿ĞµÑ‡Ğ°Ñ‚Ğ°Ñ‚ÑŒ / Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ PDF</button>
      </div>
    </div>

    <!-- â‘  Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ°Ğ²Ñ‚Ğ¾ Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° -->
    <div class="card">
      <div class="card-head">ğŸš— ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚</div>
      <div class="card-body">
        <div class="info-grid" id="carInfoGrid">
          <!-- filled by JS -->
        </div>
      </div>
    </div>

    <!-- â‘¡ ĞŸĞµÑ€ĞµÑ‡ĞµĞ½ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚ + Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ğ¸ -->
    <div class="card">
      <div class="card-head">ğŸ”§ ĞŸĞµÑ€ĞµÑ‡ĞµĞ½ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚ Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ğ¸</div>
      <div class="card-body">
        <table class="wo-table">
          <thead>
            <tr>
              <th style="width:30px">â„–</th>
              <th>ĞĞ°Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹</th>
              <th>Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒ(Ğ¸)</th>
              <th class="right">Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ</th>
            </tr>
          </thead>
          <tbody id="servicesTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- â‘¢ Ğ˜Ñ‚Ğ¾Ğ³ + Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° -->
    <div class="card">
      <div class="card-head">ğŸ’° Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ</div>
      <div class="card-body">
        <div style="display:flex; justify-content:flex-end; gap:32px; align-items:center; flex-wrap:wrap">
          <div style="text-align:right">
            <div style="font-size:0.74rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--muted);margin-bottom:4px">Ğ˜Ñ‚Ğ¾Ğ³Ğ¾ Ğº Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ</div>
            <div id="totalAmount" style="font-size:1.6rem;font-weight:900;letter-spacing:-0.5px;color:#0f172a">â€” â‚½</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:0.74rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--muted);margin-bottom:4px">Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹</div>
            <div id="paymentMethod" style="font-size:0.96rem;font-weight:700">â€”</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:0.74rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--muted);margin-bottom:4px">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹</div>
            <div id="paymentStatus" style="font-size:0.96rem;font-weight:700">â€”</div>
          </div>
        </div>
      </div>
    </div>

    <!-- â‘£ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ¸ -->
    <div class="card">
      <div class="card-head">âœï¸ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ¸ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½</div>
      <div class="card-body">
        <div class="sign-row">
          <div class="sign-block">
            <div class="sign-label">ĞšĞ»Ğ¸ĞµĞ½Ñ‚</div>
            <div class="sign-name" id="signClient">Ğ¤Ğ˜Ğ: ______________________________</div>
            <div class="sign-line"></div>
            <div class="sign-cap">ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑŒ / Ğ´Ğ°Ñ‚Ğ°</div>
          </div>
          <div class="sign-block">
            <div class="sign-label">ĞŸÑ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒ ÑÑ‚ÑƒĞ´Ğ¸Ğ¸</div>
            <div class="sign-name" id="signStudio">______________________________</div>
            <div class="sign-line"></div>
            <div class="sign-cap">ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑŒ / Ğ´Ğ°Ñ‚Ğ°</div>
          </div>
        </div>
        <div class="disclaimer">
          ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°Ñ Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰Ğ¸Ğ¹ Ğ·Ğ°ĞºĞ°Ğ·-Ğ½Ğ°Ñ€ÑĞ´, ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°ĞµÑ‚ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ğµ Ñ Ğ¿ĞµÑ€ĞµÑ‡Ğ½ĞµĞ¼ Ğ¸ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒÑ Ñ€Ğ°Ğ±Ğ¾Ñ‚. 
          ĞŸĞ¾ÑĞ»Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¾Ğ±ÑĞ·ÑƒĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ Ğ¸ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ¸ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñƒ Ğ² Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¼ Ğ¾Ğ±ÑŠÑ‘Ğ¼Ğµ.
        </div>
      </div>
    </div>

  </div><!-- /mainContent -->
</div><!-- /container -->

<script src="footer.js"></script>
<script>
(function() {
'use strict';

const SUPABASE_URL      = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;

function fmt(n) {
  return new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n || 0);
}
function fmtDate(str) {
  if (!str) return 'â€”';
  const d = new Date(str);
  return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
}
function esc(s) {
  return (s || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) { window.location.href = 'welcome.html'; return false; }
  currentUser = session.user;
  return true;
}

// â”€â”€ Load studio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStudio() {
  const { data: member } = await sb.from('studio_members')
    .select('studio_id').eq('user_id', currentUser.id).eq('is_active', true).single();
  if (!member) return null;

  const { data: studio } = await sb.from('studios')
    .select('id, name, settings').eq('id', member.studio_id).single();
  if (!studio) return null;

  const cfg = studio.settings || {};

  // Print header
  document.getElementById('ph-name').textContent = studio.name || '';
  const infoLines = [
    cfg.phone || cfg.kp_phone,
    [cfg.city, cfg.address].filter(Boolean).join(', '),
    cfg.website || cfg.kp_website,
  ].filter(Boolean);
  document.getElementById('ph-info').innerHTML = infoLines.map(esc).join('<br>');

  if (cfg.kp_logo) {
    const img = document.getElementById('ph-logo');
    img.src = cfg.kp_logo;
    img.style.display = 'block';
  }

  document.getElementById('signStudio').textContent = studio.name || '______________________________';

  return studio;
}

// â”€â”€ Build services list with executors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildServicesWithExecutors(calc, assignments) {
  // Group assignments by service_name
  const byService = {};
  const adminSale = [];

  assignments.forEach(a => {
    if (a.is_admin_sale) { adminSale.push(a); return; }
    const key = a.service_name || 'Ğ Ğ°Ğ±Ğ¾Ñ‚Ñ‹';
    if (!byService[key]) byService[key] = { names: [], salary: 0 };
    if (a.executor_name) byService[key].names.push(a.executor_name);
    byService[key].salary += parseFloat(a.salary) || 0;
  });

  // Build rows from calculation_data if exists
  const cd = calc.calculation_data || {};
  const rows = [];

  const SECTION_MAP = [
    { keys: ['pkg_wrap','pkg_prep','pkg_arm'],       label: 'ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ²ĞºÑ€ÑƒĞ³',     priceField: 'pkgSumTotal' },
    { keys: ['impact_wrap','impact_prep','impact_arm'], label: 'Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° ÑƒĞ´Ğ°Ñ€Ğ½Ğ¾Ğ¹ Ñ‡Ğ°ÑÑ‚Ğ¸',  priceField: 'impactSumTotal' },
    { keys: ['arm'],                                  label: 'ĞÑ€Ğ¼Ğ°Ñ‚ÑƒÑ€Ğ½Ñ‹Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹',       priceField: 'armSumTotal' },
    { keys: ['wrap'],                                 label: 'ĞĞºĞ»ĞµĞ¹ĞºĞ° Ğ¿Ğ»Ñ‘Ğ½ĞºĞ¾Ğ¹',         priceField: 'wrapSumTotal' },
    { keys: ['det'],                                  label: 'Ğ”ĞµÑ‚ĞµĞ¹Ğ»Ğ¸Ğ½Ğ³',               priceField: 'detSumTotal' },
    { keys: ['gl'],                                   label: 'ĞĞ½Ñ‚Ğ¸Ğ³Ñ€Ğ°Ğ²Ğ¸Ğ¹Ğ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°',     priceField: 'glSumTotal' },
    { keys: ['misc'],                                 label: 'ĞŸÑ€Ğ¾Ñ‡Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹',            priceField: 'miscSumTotal' },
  ];

  SECTION_MAP.forEach(sec => {
    // Try to get price from calc_data totals
    let price = parseFloat(cd[sec.priceField] || 0);

    // Fallback: try to find matching service price from assignments
    if (!price) {
      sec.keys.forEach(k => {
        const svcName = Object.keys(byService).find(n =>
          n.toLowerCase().includes(sec.label.toLowerCase().slice(0,8)) ||
          n.toLowerCase().includes(k.toLowerCase())
        );
        if (svcName) price = byService[svcName]?.salary || 0;
      });
    }

    if (!price) return;

    // Find executors: try exact match by service name keys
    let execNames = [];
    sec.keys.forEach(k => {
      Object.keys(byService).forEach(svcName => {
        if (svcName.toLowerCase().includes(k)) {
          execNames.push(...byService[svcName].names);
        }
      });
    });
    // Also try matching by section label
    Object.keys(byService).forEach(svcName => {
      if (svcName.toLowerCase().includes(sec.label.toLowerCase().slice(0,6))) {
        execNames.push(...byService[svcName].names);
      }
    });
    execNames = [...new Set(execNames)];

    rows.push({ label: sec.label, price, execNames, isAdmin: false });
  });

  // If no structured data â€” use assignments directly
  if (rows.length === 0) {
    Object.entries(byService).forEach(([name, data]) => {
      rows.push({ label: name, price: 0, execNames: [...new Set(data.names)], isAdmin: false });
    });
  }

  // Add manual misc services from calc_data
  if (cd.miscItems && Array.isArray(cd.miscItems)) {
    cd.miscItems.forEach(item => {
      if (item.name) {
        const svc = byService[item.name] || {};
        rows.push({
          label: item.name,
          price: parseFloat(item.price) || 0,
          execNames: [...new Set(svc.names || [])],
          isAdmin: false
        });
      }
    });
  }

  return { rows, adminSale };
}

// â”€â”€ Render car info grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCarInfo(calc) {
  const cd = calc.calculation_data || {};
  const car = cd.car || {};

  const cells = [
    { label: 'ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ',   value: calc.car_name || 'â€”' },
    { label: 'Ğ“Ğ¾Ğ´ Ğ²Ñ‹Ğ¿ÑƒÑĞºĞ°',  value: car.year || calc.year || 'â€”' },
    { label: 'Ğ”Ğ°Ñ‚Ğ° Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ĞºĞ¸', value: fmtDate(calc.checkin_date || calc.created_at) },
    { label: 'Ğ“Ğ¾Ñ. Ğ½Ğ¾Ğ¼ĞµÑ€',   value: cd.plate || 'â€”' },
    { label: 'VIN',          value: cd.vin   || 'â€”', mono: true },
    { label: 'ĞšĞ»Ğ¸ĞµĞ½Ñ‚',       value: cd.client_name || cd.clientName || 'â€”' },
  ];

  document.getElementById('carInfoGrid').innerHTML = cells.map(c => `
    <div class="info-cell">
      <div class="info-label">${c.label}</div>
      <div class="info-value ${c.value === 'â€”' ? 'empty' : ''}" style="${c.mono ? 'font-size:0.78rem;letter-spacing:0.02em' : ''}">${esc(c.value)}</div>
    </div>
  `).join('');
}

// â”€â”€ Render services table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderServices(calc, assignments) {
  const { rows, adminSale } = buildServicesWithExecutors(calc, assignments);
  const tbody = document.getElementById('servicesTbody');

  if (rows.length === 0 && adminSale.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" style="color:var(--muted);font-style:italic;padding:14px 12px">Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ğ¸ ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ñ‹</td></tr>`;
    return;
  }

  let totalPrice = 0;
  let html = rows.map((r, i) => {
    totalPrice += r.price;
    const execsHtml = r.execNames.length > 0
      ? r.execNames.map(n => `<span class="exec-pill">ğŸ‘¤ ${esc(n)}</span>`).join('')
      : `<span style="color:var(--muted);font-style:italic;font-size:0.8rem">ĞĞµ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½</span>`;

    return `
      <tr>
        <td style="color:var(--muted);font-size:0.78rem">${i+1}</td>
        <td style="font-weight:600">${esc(r.label)}</td>
        <td><div class="execs">${execsHtml}</div></td>
        <td class="right" style="font-weight:700">${r.price > 0 ? fmt(r.price) + ' â‚½' : 'â€”'}</td>
      </tr>`;
  }).join('');

  // Admin sale row
  if (adminSale.length > 0) {
    const a = adminSale[0];
    html += `
      <tr>
        <td style="color:var(--muted);font-size:0.78rem">${rows.length + 1}</td>
        <td style="font-weight:600;color:#7c3aed">ğŸ’¼ ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶Ğ° (${a.admin_percent || 0}% Ğ¾Ñ‚ Ñ‡ĞµĞºĞ°)</td>
        <td><div class="execs"><span class="exec-pill admin">ğŸ‘” ${esc(a.executor_name || 'â€”')}</span></div></td>
        <td class="right" style="font-weight:700;color:#7c3aed">â€”</td>
      </tr>`;
  }

  // Total row
  const displayTotal = calc.final_price || calc.total_price || totalPrice;
  html += `
    <tr class="total-row">
      <td></td>
      <td colspan="2">Ğ˜Ğ¢ĞĞ“Ğ</td>
      <td class="right">${fmt(displayTotal)} â‚½</td>
    </tr>`;

  tbody.innerHTML = html;

  // Update summary block
  document.getElementById('totalAmount').textContent = fmt(displayTotal) + ' â‚½';
}

// â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function init() {
  const ok = await checkAuth();
  if (!ok) return;

  const params = new URLSearchParams(window.location.search);
  const calcId = params.get('calc_id');

  const loading = document.getElementById('loadingMsg');
  const errMsg  = document.getElementById('errMsg');
  const content = document.getElementById('mainContent');

  if (!calcId) {
    loading.style.display = 'none';
    errMsg.style.display  = '';
    errMsg.textContent    = 'âŒ ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½ ID Ğ·Ğ°ĞºĞ°Ğ·Ğ°. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ·Ğ°ĞºĞ°Ğ·-Ğ½Ğ°Ñ€ÑĞ´ ÑĞ¾ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ´Ğ¾ÑĞºĞ¸.';
    return;
  }

  // Load everything in parallel
  const [studioRes, calcRes, assignRes] = await Promise.all([
    loadStudio(),
    sb.from('calculations').select('*').eq('id', calcId).single(),
    sb.from('work_assignments')
      .select('id, executor_name, executor_id, service_name, salary, is_admin_sale, admin_percent, status')
      .eq('calculation_id', calcId)
  ]);

  if (calcRes.error || !calcRes.data) {
    loading.style.display = 'none';
    errMsg.style.display  = '';
    return;
  }

  const calc        = calcRes.data;
  const assignments = assignRes.data || [];

  // Document number: short calc id
  const shortId = calcId.slice(0, 8).toUpperCase();
  document.getElementById('ph-num').textContent   = 'â„– ' + shortId;
  document.getElementById('headerSub').textContent = calc.car_name + ' Â· Ğ·Ğ°ĞºĞ°Ğ·-Ğ½Ğ°Ñ€ÑĞ´ ' + shortId;
  document.title = `Ğ—Ğ°ĞºĞ°Ğ·-Ğ½Ğ°Ñ€ÑĞ´ ${shortId} â€” ${calc.car_name}`;

  // Payment method from calc_data
  const payMethod = {
    cash: 'ğŸ’µ ĞĞ°Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ', card: 'ğŸ’³ ĞšĞ°Ñ€Ñ‚Ğ°', transfer: 'ğŸ¦ ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´'
  }[calc.calculation_data?.paymentMethod || calc.payment_method] || 'â€”';
  document.getElementById('paymentMethod').textContent = payMethod;

  const isPaid = calc.status === 'delivered';
  const payEl  = document.getElementById('paymentStatus');
  payEl.textContent = isPaid ? 'âœ… ĞĞ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾' : 'â³ ĞĞ¶Ğ¸Ğ´Ğ°ĞµÑ‚ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹';
  payEl.style.color = isPaid ? 'var(--success)' : 'var(--muted)';

  renderCarInfo(calc);
  renderServices(calc, assignments);

  loading.style.display = 'none';
  content.style.display = '';

  if (window.initNav) window.initNav({ activePage: 'work-order.html' });
})();

})();
</script>
</body>
</html>
