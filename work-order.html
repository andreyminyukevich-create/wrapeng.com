<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–ó–∞–∫–∞–∑-–Ω–∞—Ä—è–¥ ‚Äî Keep1R CRM</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="nav.css">
<script src="nav.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --font: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
  --bg: #eef2f9; --card: #fff;
  --border: rgba(15,23,42,0.10); --text: #0f172a;
  --muted: #64748b; --primary: #2563eb; --success: #059669; --radius: 12px;
}
body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100svh; -webkit-font-smoothing: antialiased; }
.container { max-width: 900px; margin: 0 auto; padding: 24px 20px 60px; }

.page-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
.page-title  { font-size: 1.3rem; font-weight: 800; letter-spacing: -0.3px; }
.page-sub    { font-size: 0.8rem; color: var(--muted); margin-top: 3px; }
.btn { display: inline-flex; align-items: center; gap: 6px; padding: 9px 18px; border-radius: 9px; border: none; font-size: 0.85rem; font-weight: 700; cursor: pointer; font-family: var(--font); transition: all 0.15s; }
.btn-secondary { background: #f1f5f9; color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover { background: #e2e8f0; }
.btn-dark { background: #0f172a; color: #fff; }
.btn-dark:hover { background: #1e293b; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

.card { background: var(--card); border-radius: var(--radius); border: 1px solid var(--border); box-shadow: 0 1px 4px rgba(0,0,0,0.06); margin-bottom: 14px; overflow: hidden; }
.card-head { padding: 11px 18px 9px; border-bottom: 1px solid var(--border); font-size: 0.74rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); background: #f8fafc; }
.card-body { padding: 16px 18px; }

.info-grid { display: grid; grid-template-columns: repeat(3, 1fr); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
.info-cell { padding: 10px 14px; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); }
.info-cell:nth-child(3n) { border-right: none; }
.info-cell:nth-last-child(-n+3) { border-bottom: none; }
.info-label { font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); margin-bottom: 3px; }
.info-value { font-size: 0.88rem; font-weight: 600; }
.info-value.empty { color: var(--muted); font-weight: 400; font-style: italic; }
@media (max-width: 540px) {
  .info-grid { grid-template-columns: repeat(2, 1fr); }
  .info-cell:nth-child(3n) { border-right: 1px solid var(--border); }
  .info-cell:nth-child(2n) { border-right: none; }
  .info-cell:nth-last-child(-n+3) { border-bottom: 1px solid var(--border); }
  .info-cell:nth-last-child(-n+2) { border-bottom: none; }
}

.wo-table { width: 100%; border-collapse: collapse; font-size: 0.86rem; }
.wo-table th { text-align: left; padding: 8px 12px; background: #f8fafc; font-size: 0.71rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); border-bottom: 1.5px solid var(--border); }
.wo-table td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
.wo-table tr:last-child td { border-bottom: none; }
.total-row td { font-weight: 800; border-top: 2px solid #0f172a !important; border-bottom: none !important; background: #f8fafc; padding-top: 12px; }
.right { text-align: right; white-space: nowrap; }
.exec-pill { display: inline-flex; align-items: center; gap: 3px; padding: 2px 8px; border-radius: 20px; background: rgba(37,99,235,0.08); color: #1e40af; font-size: 0.74rem; font-weight: 700; margin: 2px; }
.exec-pill.admin { background: rgba(124,58,237,0.08); color: #6d28d9; }
.execs { display: flex; flex-wrap: wrap; }

.totals-row { display: flex; justify-content: flex-end; gap: 40px; align-items: center; flex-wrap: wrap; }
.total-item { text-align: right; }
.total-item-label { font-size: 0.71rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); margin-bottom: 4px; }
.total-item-value { font-size: 1.5rem; font-weight: 900; letter-spacing: -0.5px; }
.total-item-value.sm { font-size: 0.95rem; font-weight: 700; }

.sign-row { display: grid; grid-template-columns: 1fr 1fr; gap: 28px; }
.sign-block { display: flex; flex-direction: column; gap: 8px; }
.sign-label { font-size: 0.71rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; color: var(--muted); }
.sign-name  { font-size: 0.83rem; color: var(--muted); min-height: 1.1em; }
.sign-line  { border-bottom: 1.5px solid #94a3b8; height: 44px; }
.sign-cap   { font-size: 0.71rem; color: var(--muted); text-align: center; }
.disclaimer { padding: 11px 14px; background: #fef9c3; border: 1px solid #fde68a; border-radius: 8px; font-size: 0.78rem; color: #78350f; line-height: 1.5; margin-top: 14px; }

#loadingMsg { text-align: center; padding: 60px 20px; color: var(--muted); }
#errMsg     { display: none; text-align: center; padding: 40px; color: #dc2626; }

/* ‚ïê‚ïê PRINT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media print {
  * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  body { background: #fff !important; font-size: 11px !important; }
  #navTopBar, .no-print { display: none !important; }
  .container { padding: 0 !important; max-width: 100% !important; }
  .card { box-shadow: none !important; border: 1px solid #e2e8f0 !important; margin-bottom: 8px !important; break-inside: avoid; }
  .card-head { padding: 7px 12px 6px !important; font-size: 0.67rem !important; background: #f1f5f9 !important; }
  .card-body { padding: 10px 12px !important; }
  .info-cell { padding: 7px 10px !important; }
  .info-label { font-size: 0.62rem !important; }
  .info-value { font-size: 0.82rem !important; }
  .wo-table th { padding: 6px 10px !important; font-size: 0.64rem !important; background: #f1f5f9 !important; }
  .wo-table td { padding: 7px 10px !important; font-size: 0.82rem !important; }
  .exec-pill { font-size: 0.68rem !important; padding: 1px 6px !important; }
  .total-item-value { font-size: 1.2rem !important; }
  .totals-row { gap: 24px !important; }
  .sign-line { height: 32px !important; }
  .disclaimer { font-size: 0.71rem !important; padding: 7px 10px !important; margin-top: 8px !important; }
  #printHeader { display: flex !important; padding-bottom: 10px !important; margin-bottom: 12px !important; }
  @page { margin: 15mm; size: A4; }
}

/* ‚îÄ‚îÄ Print header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#printHeader {
  display: none; align-items: center; justify-content: space-between;
  padding-bottom: 14px; border-bottom: 2.5px solid #0f172a; margin-bottom: 18px; gap: 16px;
}
#ph-logo { max-height: 52px; max-width: 130px; object-fit: contain; }
.ph-center { text-align: center; }
.ph-doc-title { font-size: 1.15rem; font-weight: 900; letter-spacing: 0.5px; color: #0f172a; text-transform: uppercase; }
.ph-doc-num   { font-size: 0.78rem; color: var(--muted); margin-top: 2px; }
.ph-right { text-align: right; }
.ph-studio-name { font-size: 0.95rem; font-weight: 800; color: #0f172a; }
.ph-studio-info { font-size: 0.74rem; color: var(--muted); line-height: 1.6; margin-top: 2px; }
</style>
</head>
<body>

<div id="navTopBar">
  <a href="board.html" class="nav-brand">Keep1R CRM</a>
  <div class="nav-links">
    <a href="board.html" class="nav-link">‚Üê –î–æ—Å–∫–∞</a>
    <span class="nav-link active">üñ®Ô∏è –ó–∞–∫–∞–∑-–Ω–∞—Ä—è–¥</span>
  </div>
  <div class="nav-right"></div>
</div>

<div class="container">

  <!-- Print header (hidden on screen) -->
  <div id="printHeader">
    <img id="ph-logo" src="" alt="" style="display:none">
    <div class="ph-center">
      <div class="ph-doc-title">–ó–∞–∫–∞–∑-–Ω–∞—Ä—è–¥</div>
      <div class="ph-doc-num" id="ph-num">‚Ññ ‚Äî</div>
    </div>
    <div class="ph-right">
      <div class="ph-studio-name" id="ph-name"></div>
      <div class="ph-studio-info" id="ph-info"></div>
    </div>
  </div>

  <div id="loadingMsg">‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶</div>
  <div id="errMsg">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. <a href="board.html">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</a></div>

  <div id="mainContent" style="display:none">

    <div class="page-header no-print">
      <div>
        <div class="page-title">üñ®Ô∏è –ó–∞–∫–∞–∑-–Ω–∞—Ä—è–¥</div>
        <div class="page-sub" id="headerSub"></div>
      </div>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="history.back()">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="btn btn-dark" onclick="window.print()">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å / PDF</button>
      </div>
    </div>

    <!-- ‚ë† –ê–≤—Ç–æ –∏ –∫–ª–∏–µ–Ω—Ç -->
    <div class="card">
      <div class="card-head">üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å –∏ –∫–ª–∏–µ–Ω—Ç</div>
      <div class="card-body">
        <div class="info-grid" id="carInfoGrid"></div>
      </div>
    </div>

    <!-- ‚ë° –ü–µ—Ä–µ—á–µ–Ω—å —Ä–∞–±–æ—Ç -->
    <div class="card">
      <div class="card-head">üîß –ü–µ—Ä–µ—á–µ–Ω—å —Ä–∞–±–æ—Ç –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</div>
      <div class="card-body">
        <table class="wo-table">
          <thead>
            <tr>
              <th style="width:32px">‚Ññ</th>
              <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã</th>
              <th>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å(–∏)</th>
              <th class="right" style="width:110px">–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
            </tr>
          </thead>
          <tbody id="servicesTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- ‚ë¢ –ò—Ç–æ–≥ -->
    <div class="card">
      <div class="card-head">üí∞ –ò—Ç–æ–≥</div>
      <div class="card-body">
        <div class="totals-row">
          <div class="total-item">
            <div class="total-item-label">–§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã</div>
            <div class="total-item-value sm" id="paymentMethod">‚Äî</div>
          </div>
          <div class="total-item">
            <div class="total-item-label">–°—Ç–∞—Ç—É—Å</div>
            <div class="total-item-value sm" id="paymentStatus">‚Äî</div>
          </div>
          <div class="total-item">
            <div class="total-item-label">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</div>
            <div class="total-item-value" id="totalAmount">‚Äî ‚ÇΩ</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ë£ –ü–æ–¥–ø–∏—Å–∏ -->
    <div class="card">
      <div class="card-head">‚úçÔ∏è –ü–æ–¥–ø–∏—Å–∏ —Å—Ç–æ—Ä–æ–Ω</div>
      <div class="card-body">
        <div class="sign-row">
          <div class="sign-block">
            <div class="sign-label">–ö–ª–∏–µ–Ω—Ç</div>
            <div class="sign-name" id="signClient">–§–ò–û: ______________________________</div>
            <div class="sign-line"></div>
            <div class="sign-cap">–ü–æ–¥–ø–∏—Å—å / –¥–∞—Ç–∞</div>
          </div>
          <div class="sign-block">
            <div class="sign-label">–ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å —Å—Ç—É–¥–∏–∏</div>
            <div class="sign-name" id="signStudio">______________________________</div>
            <div class="sign-line"></div>
            <div class="sign-cap">–ü–æ–¥–ø–∏—Å—å / –¥–∞—Ç–∞</div>
          </div>
        </div>
        <div class="disclaimer">
          –ü–æ–¥–ø–∏—Å—ã–≤–∞—è –Ω–∞—Å—Ç–æ—è—â–∏–π –∑–∞–∫–∞–∑-–Ω–∞—Ä—è–¥, –∫–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Å–æ–≥–ª–∞—Å–∏–µ —Å –ø–µ—Ä–µ—á–Ω–µ–º –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç.
          –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç –∫–ª–∏–µ–Ω—Ç –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–∏–Ω—è—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å –∏ –ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –æ–ø–ª–∞—Ç—É –≤ –ø–æ–ª–Ω–æ–º –æ–±—ä—ë–º–µ.
          –°—Ç—É–¥–∏—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç —Å–æ–≥–ª–∞—Å–Ω–æ –¥–µ–π—Å—Ç–≤—É—é—â–∏–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º.
        </div>
      </div>
    </div>

  </div>
</div>

<script src="footer.js"></script>
<script>
(function(){
'use strict';

const SUPABASE_URL      = 'https://hdghijgrrnzmntistdvw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZ2hpamdycm56bW50aXN0ZHZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzMyNzksImV4cCI6MjA3NTYwOTI3OX0.D9EDTmVrFRVp0B8_5tCJM29gbFdtadsom0Ihsf4uQ8Q';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let currentUser = null;

function fmt(n) { return new Intl.NumberFormat('ru-RU').format(Math.round(n||0)); }
function fmtDate(s) { if(!s) return '‚Äî'; return new Date(s).toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit',year:'numeric'}); }
function esc(s)  { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

async function checkAuth() {
  const { data:{session} } = await sb.auth.getSession();
  if (!session) { window.location.href='welcome.html'; return false; }
  currentUser = session.user; return true;
}

async function loadStudio() {
  const { data: m } = await sb.from('studio_members').select('studio_id').eq('user_id',currentUser.id).eq('is_active',true).single();
  if (!m) return;
  const { data: s } = await sb.from('studios').select('name,settings').eq('id',m.studio_id).single();
  if (!s) return;
  const cfg = s.settings||{};
  document.getElementById('ph-name').textContent = s.name||'';
  const lines = [cfg.phone||cfg.kp_phone, [cfg.city,cfg.address].filter(Boolean).join(', '), cfg.website||cfg.kp_website].filter(Boolean);
  document.getElementById('ph-info').innerHTML = lines.map(esc).join('<br>');
  if (cfg.kp_logo) { const img=document.getElementById('ph-logo'); img.src=cfg.kp_logo; img.style.display='block'; }
  document.getElementById('signStudio').textContent = s.name||'______________________________';
}

function renderCarInfo(calc) {
  const cd=calc.calculation_data||{}, car=cd.car||{};
  const cells=[
    {label:'–ê–≤—Ç–æ–º–æ–±–∏–ª—å',     value: calc.car_name||'‚Äî'},
    {label:'–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞',    value: car.year||calc.year||'‚Äî'},
    {label:'–î–∞—Ç–∞',           value: fmtDate(calc.checkin_date||calc.created_at)},
    {label:'–ì–æ—Å. –Ω–æ–º–µ—Ä',     value: cd.plate||'‚Äî'},
    {label:'VIN / ‚Ññ –∫—É–∑–æ–≤–∞', value: cd.vin||'‚Äî'},
    {label:'–ö–ª–∏–µ–Ω—Ç',         value: cd.client_name||cd.clientName||'‚Äî'},
  ];
  document.getElementById('carInfoGrid').innerHTML = cells.map(c=>`
    <div class="info-cell">
      <div class="info-label">${c.label}</div>
      <div class="info-value${c.value==='‚Äî'?' empty':''}">${esc(c.value)}</div>
    </div>`).join('');
}

function renderServices(calc, assignments) {
  const tbody = document.getElementById('servicesTbody');
  const cd    = calc.calculation_data || {};

  // –ö–ª—é—á –≤ formData: paymentMode (cash / card / ooo)
  const PAY = {cash:'üíµ –ù–∞–ª–∏—á–Ω—ã–µ', card:'üí≥ –ö–∞—Ä—Ç–∞ / –ò–ü', ooo:'üè¢ –û–û–û', transfer:'üè¶ –ü–µ—Ä–µ–≤–æ–¥'};
  document.getElementById('paymentMethod').textContent = PAY[cd.paymentMode||''] || '‚Äî';

  const total = calc.final_price || calc.total_price || 0;
  document.getElementById('totalAmount').textContent = fmt(total)+' ‚ÇΩ';
  const isPaid = calc.status==='delivered';
  const payEl = document.getElementById('paymentStatus');
  payEl.textContent = isPaid?'‚úÖ –û–ø–ª–∞—á–µ–Ω–æ':'‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã';
  payEl.style.color = isPaid?'var(--success)':'var(--muted)';

  if (assignments.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" style="color:var(--muted);font-style:italic;padding:14px 12px">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –µ—â—ë –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</td></tr>`;
    return;
  }

  // ‚îÄ‚îÄ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ service_name ‚Üí –∫–ª—é—á —Ü–µ–Ω—ã –≤ calculation_data ‚îÄ‚îÄ
  // –¶–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ formData –ø–æ–¥ —Ç–µ–º–∏ –∂–µ –∫–ª—é—á–∞–º–∏ —á—Ç–æ –∏ –≤ –±–ª–æ–∫–µ block-summary
  const PRICE_KEYS = {
    '–û–∫–ª–µ–π–∫–∞ (–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞)':           'pkgSumTotal',
    '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞)':        'pkgSumTotal',
    '–ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã (–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞)': 'pkgSumTotal',
    '–û–∫–ª–µ–π–∫–∞ (–£–¥–∞—Ä–Ω–∞—è —á–∞—Å—Ç—å)':           'impactSumTotal',
    '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–£–¥–∞—Ä–Ω–∞—è —á–∞—Å—Ç—å)':        'impactSumTotal',
    '–ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã (–£–¥–∞—Ä–Ω–∞—è —á–∞—Å—Ç—å)': 'impactSumTotal',
    '–ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã':  'armSumTotal',
    '–û–∫–ª–µ–π–∫–∞':            'wrapSumTotal',
    '–î–µ—Ç–µ–π–ª–∏–Ω–≥':          'detSumTotal',
    '–ü–æ–ª–∏—Ä–æ–≤–∫–∞/–•–∏–º—á–∏—Å—Ç–∫–∞':'glSumTotal',
  };

  // –ì—Ä—É–ø–ø—ã –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö service_name ‚Üí –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
  const GROUPS = {
    pkgSumTotal:    { label:'–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –≤–∫—Ä—É–≥',  keys:['–û–∫–ª–µ–π–∫–∞ (–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞)','–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞)','–ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã (–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞)'] },
    impactSumTotal: { label:'–ó–∞—â–∏—Ç–∞ —É–¥–∞—Ä–Ω–æ–π —á–∞—Å—Ç–∏', keys:['–û–∫–ª–µ–π–∫–∞ (–£–¥–∞—Ä–Ω–∞—è —á–∞—Å—Ç—å)','–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–£–¥–∞—Ä–Ω–∞—è —á–∞—Å—Ç—å)','–ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã (–£–¥–∞—Ä–Ω–∞—è —á–∞—Å—Ç—å)'] },
  };

  // –°–æ–±–∏—Ä–∞–µ–º map: service_name ‚Üí {names, isAdmin, adminPct}
  const svcMap = new Map();
  assignments.forEach(a => {
    const key = a.service_name || '–†–∞–±–æ—Ç—ã';
    if (!svcMap.has(key)) svcMap.set(key, {names:new Set(), isAdmin:!!a.is_admin_sale, adminPct:a.admin_percent||0});
    const e = svcMap.get(key);
    if (a.executor_name) e.names.add(a.executor_name);
  });

  const rows = [];
  const used = new Set();

  // –ë–ª–æ—á–Ω—ã–µ –≥—Ä—É–ø–ø—ã
  Object.entries(GROUPS).forEach(([priceField, group]) => {
    const present = group.keys.filter(k => svcMap.has(k));
    if (!present.length) return;
    const allNames = new Set();
    present.forEach(k => { svcMap.get(k).names.forEach(n => allNames.add(n)); used.add(k); });
    rows.push({ label: group.label, names: allNames, price: parseFloat(cd[priceField]||0), isAdmin: false });
  });

  // –û–¥–∏–Ω–æ—á–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
  svcMap.forEach((entry, key) => {
    if (used.has(key) || entry.isAdmin) return;
    const pf = PRICE_KEYS[key];
    rows.push({ label: key, names: entry.names, price: pf ? parseFloat(cd[pf]||0) : 0, isAdmin: false });
  });

  const execHtml = names => [...names].length
    ? [...names].map(n => `<span class="exec-pill">üë§ ${esc(n)}</span>`).join('')
    : `<span style="color:var(--muted);font-style:italic;font-size:0.78rem">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>`;

  let html = rows.map((r,i) => `<tr>
    <td style="color:var(--muted);font-size:0.76rem">${i+1}</td>
    <td style="font-weight:600">${esc(r.label)}</td>
    <td><div class="execs">${execHtml(r.names)}</div></td>
    <td class="right">${r.price>0 ? '<strong>'+fmt(r.price)+' ‚ÇΩ</strong>' : '<span style="color:var(--muted)">‚Äî</span>'}</td>
  </tr>`).join('');

  // Admin –ø—Ä–æ–¥–∞–∂–Ω–∏–∫
  svcMap.forEach((entry, key) => {
    if (!entry.isAdmin) return;
    const names = [...entry.names].map(n=>`<span class="exec-pill admin">üëî ${esc(n)}</span>`).join('');
    html += `<tr>
      <td style="color:var(--muted);font-size:0.76rem">${rows.length+1}</td>
      <td style="font-weight:600;color:#7c3aed">üíº –ü—Ä–æ–¥–∞–∂–∞ (${entry.adminPct}% –æ—Ç —á–µ–∫–∞)</td>
      <td><div class="execs">${names||'<span style="color:var(--muted)">‚Äî</span>'}</div></td>
      <td class="right" style="color:#7c3aed">‚Äî</td>
    </tr>`;
  });

  html += `<tr class="total-row">
    <td></td><td colspan="2">–ò–¢–û–ì–û</td>
    <td class="right">${fmt(total)} ‚ÇΩ</td>
  </tr>`;

  tbody.innerHTML = html;
}

(async function init(){
  if (!await checkAuth()) return;
  const params = new URLSearchParams(window.location.search);
  const calcId = params.get('calc_id');
  const loading=document.getElementById('loadingMsg'), errMsg=document.getElementById('errMsg'), content=document.getElementById('mainContent');

  if (!calcId) {
    loading.style.display='none'; errMsg.style.display='';
    errMsg.textContent='‚ùå –ù–µ —É–∫–∞–∑–∞–Ω ID –∑–∞–∫–∞–∑–∞. –û—Ç–∫—Ä–æ–π—Ç–µ –∑–∞–∫–∞–∑-–Ω–∞—Ä—è–¥ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ—Å–∫–∏.'; return;
  }

  const [,calcRes,assignRes] = await Promise.all([
    loadStudio(),
    sb.from('calculations').select('*').eq('id',calcId).single(),
    sb.from('work_assignments').select('executor_name,service_name,salary,is_admin_sale,admin_percent').eq('calculation_id',calcId)
  ]);

  if (calcRes.error || !calcRes.data) { loading.style.display='none'; errMsg.style.display=''; return; }

  const calc = calcRes.data;
  const shortId = calcId.slice(-8).toUpperCase();
  document.getElementById('ph-num').textContent    = '‚Ññ '+shortId;
  document.getElementById('headerSub').textContent = (calc.car_name||'–ê–≤—Ç–æ–º–æ–±–∏–ª—å')+' ¬∑ '+shortId;
  document.title = '–ó–∞–∫–∞–∑-–Ω–∞—Ä—è–¥ '+shortId;

  renderCarInfo(calc);
  renderServices(calc, assignRes.data||[]);

  loading.style.display='none';
  content.style.display='';
  if (window.initNav) window.initNav({activePage:'work-order.html'});
})();

})();
</script>
</body>
</html>
